(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
(function (global){
"use strict";global&&global._babelPolyfill||(require("core-js/es6/symbol"),require("core-js/es6/set"),require("core-js/fn/string/includes"),require("core-js/fn/object/is"),require("core-js/fn/array/of"),require("core-js/fn/array/from"),require("core-js/fn/symbol/iterator"));var Log=require("manticore-log")("root"),SDK=require("./sdk"),m=require("manticore");try{Log.debug("Beginning SDK initialization."),m["export"](require("retail-payment-device")),m["export"](require("./paymentDevice/index")),m["export"](require("./transaction/index")),m["export"](require("paypal-invoicing")),m.ready(SDK),Log.debug("SDK initialization complete.")}catch(error){Log.error("Failed to complete initialization: "+error.message+"\n"+error.stack)}


}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./paymentDevice/index":31,"./sdk":34,"./transaction/index":39,"core-js/es6/set":46,"core-js/es6/symbol":47,"core-js/fn/array/from":48,"core-js/fn/array/of":49,"core-js/fn/object/is":50,"core-js/fn/string/includes":51,"core-js/fn/symbol/iterator":52,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],2:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),manticore=require("manticore"),RetailSDKUtil=require("../common/RetailSDKUtil"),Log=require("manticore-log")("serverBackedFile"),CachedServerFile=function(){function e(r,t){_classCallCheck(this,e),this.url=t,this.fileId=r,this.storageType=RetailSDKUtil.StorageType.Secure}return _createClass(e,[{key:"get",value:function(e){var r=this;this._retrieveCachedFile(function(t,n){var i={url:r.url,format:"json",headers:{}};if(n&&n.headers){var o=n.headers["Last-Modified"],a=n.headers.ETag;o&&(i.headers["If-Modified-Since"]=o),a&&(i.headers["If-None-Match"]=a)}Log.debug(function(){return"GET File "+r.fileId+"\nRequest: "+JSON.stringify(i)}),manticore.http(i,function(t,i){t||i&&i.statusCode>=300?(Log[i&&304===i.statusCode?"debug":"error"](function(){return"Remote file load did not return new file. statusCode: "+i.statusCode+", "+(t?t.message:"undefined")}),e(null,n?n.body:null)):i.body?manticore.setItem(r.fileId,r.storageType,JSON.stringify(i),function(t){Log.debug(function(){return"Using server version of "+r.fileId}),e(null,i.body)}):(Log.debug(function(){return"Using CACHED version of "+r.fileId}),e(null,n?n.body:null))})})}},{key:"_retrieveCachedFile",value:function(e){var r=this;manticore.getItem(this.fileId,this.storageType,function(t,n){t&&(Log.warn("Failed to get cached file with Id "+r.fileId+" from storage Type: '"+r.storageType+"'. Error: "+t),e(t,null));try{e(null,n?JSON.parse(n):null)}catch(t){Log.warn("Unable to parse cached file "+n+" to json. Error : "+t),e(t,null)}})}}]),e}();module.exports=CachedServerFile;


},{"../common/RetailSDKUtil":5,"manticore":125,"manticore-log":123}],3:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var a=0;a<r.length;a++){var t=r[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,a,t){return a&&e(r.prototype,a),t&&e(r,t),r}}(),FeatureMapJson=require("../../resources/feature-map.json"),Log=require("manticore-log")("features"),CachedServerFile=require("./CachedServerFile"),Features=function(){function e(){_classCallCheck(this,e),this.map=FeatureMapJson}return _createClass(e,[{key:"loadRemoteFeatureMap",value:function(){var r=this,a="https://www.paypalobjects.com/webstatic/mobile/retail-sdk/feature-map.json",t=new CachedServerFile(e.FileId,a);t.get(function(e,a){return e||!a?void Log.error("Could not retrieve remote feature. Error: "+e):(Log.info("Version of local feature map: "+r.map.VERSION+" remote/cached: "+a.VERSION),void(parseFloat(r.map.VERSION)<parseFloat(a.VERSION)&&(Log.debug("Replacing local feature map with remote"),r.map=a)))})}}]),e}();Features.FileId="FeatureMapStoreKey",module.exports=new Features;


},{"../../resources/feature-map.json":200,"./CachedServerFile":2,"manticore-log":123}],4:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function resolver(e,r){var t=e.env,n=r.service,i=r.op;if(!t||"live"===t)return simpleUrl("api",n,i);if(0===t.indexOf("stage2")){if("retail"===n)return"https://www."+t+".stage.paypal.com/webapps/hereapi/merchant/v1/"+i;if("auth"===n)return"https://www."+t+".stage.paypal.com/webapps/auth/protocol/openidconnect/v1/"+i;if("payments"===n)return"https://www."+t+".stage.paypal.com:11888/v1/payments/"+i}else if("sandbox"===t)return simpleUrl("api.sandbox",n,i)}function simpleUrl(e,r,t){return"retail"===r?"https://"+e+".paypal.com/retail/merchant/v1/"+t:"auth"===r?"https://"+e+".paypal.com/v1/identity/openidconnect/"+t:"payments"===r?"https://api-m."+e+".paypal.com:11888/v1/payments/"+t:void 0}function makeInvoiceResolver(e){var r=e.resolvers.invoicing;return function(e,t){return t.headers=t.headers||{},t.headers["X-PAYPAL-REQUEST-SOURCE"]="MPA-DEVICE",r(e,t)}}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_get=function(e,r,t){for(var n=!0;n;){var i=e,s=r,o=t;n=!1,null===i&&(i=Function.prototype);var a=Object.getOwnPropertyDescriptor(i,s);if(void 0!==a){if("value"in a)return a.value;var u=a.get;if(void 0===u)return;return u.call(o)}var c=Object.getPrototypeOf(i);if(null===c)return;e=c,r=s,t=o,n=!0,a=c=void 0}},manticore=require("manticore"),Log=require("manticore-log")("merchant"),RestApi=require("paypalrest-manticore"),Invoice=require("paypal-invoicing").Invoice,InvoiceAddress=require("paypal-invoicing").InvoiceAddress,EventEmitter=require("events").EventEmitter,SdkFeature=require("./Features"),async=require("async"),BN=require("bignumber.js"),$$=function(e){return void 0===e||null===e?null:new BN(e)},SdkError=require("./sdkErrors"),Merchant=function(e){function r(){_classCallCheck(this,r),_get(Object.getPrototypeOf(r.prototype),"constructor",this).call(this),this.api=null,this.userInfo={},this.status={},this.cbs=[],this.environment="live"}return _inherits(r,e),_createClass(r,[{key:"initialize",value:function(e,t){var n=this;return require("paypal-invoicing").InvoicingRequester.api=this.api=RestApi.fromToken(e),this.environment=this.api.env,this.api.addResolver("retail",resolver),this.api.addResolver("auth",resolver),this.api.addResolver("invoicing",makeInvoiceResolver(this.api)),this.api.addResolver("payments",resolver),this.api.app&&Log.warn("Using debug-only SDK token with embedded app secret. DO NOT USE IN LIVE APPS."),async.parallel([this._loadMerchantUserInfo.bind(this),this._loadMerchantStatus.bind(this)],function(e){r.active=n,r.events.emit("initialized",e),e&&Log.error("Merchant initialize failed: "+e),t(e,n)}),!0}},{key:"_loadMerchantUserInfo",value:function(e){var r=this;Log.debug("Loading merchant user info..."),this.api.request({service:"auth",op:"userinfo?schema=openid",format:"json"},function(t,n){return t&&400===t.code&&!r._retriedUserInfo?(r._retriedUserInfo=!0,r.api.refresh(function(t){return t?e(t,r):void r._loadMerchantUserInfo(e)})):(delete r._retriedUserInfo,r.userInfo=n?n.body:null,t?e(t,r):r.userInfo?r.userInfo.address&&r.userInfo.address.country&&r.userInfo.email&&r.userInfo.name?(Invoice.DefaultMerchant={emailAddress:r.emailAddress,businessName:r.businessName,address:r.address},Log.info("Successfully loaded merchant user info!"),Log.debug(function(){return"Merchant Info: \n"+JSON.stringify(n.body,null,4)}),void e(t,r)):(Log.error("Failed to load required merchant information like address, country code, email or name. May be the scope used to generate token was not right?"),e(SdkError(new Error,SdkError.MERCHANT.REQUIRED_INFO_NOT_LOADED),null)):(Log.error("Failed to load merchant information. Empty response."),e(SdkError(new Error,SdkError.MERCHANT.FAILED_TO_LOAD),null)))})}},{key:"_loadMerchantStatus",value:function(e){var r=this;Log.debug("Loading merchant status..."),this.api.request({service:"retail",op:"status",format:"json"},function(t,n){return t?e(t,r):(r.status=n.body,Invoice.DefaultCurrency=r.currency,Log.debug(function(){return"Successfully loaded merchant status "+JSON.stringify(n.body,null,4)}),void e(t,r))})}},{key:"request",value:function(e,r){return this.api.request(e,r)}},{key:"signatureRequiredAbove",get:function(){return $$(this._signatureRequiredAbove)||$$(this.cardSettings.signatureRequiredAbove)||$$(0)},set:function(e){this._signatureRequiredAbove=e}},{key:"featureMap",get:function(){return SdkFeature.map[this.country]}},{key:"emailAddress",get:function(){return this.userInfo?this.userInfo.email:null}},{key:"businessName",get:function(){return this.userInfo?this.userInfo.businessName:null}},{key:"currency",get:function(){return this.status.currencyCode}},{key:"country",get:function(){return this.address.country}},{key:"cardSettings",get:function(){return this.status.cardSettings}},{key:"address",get:function(){if(this._address)return this._address;var e=this.userInfo,r=this._address=new InvoiceAddress;return e&&e.address&&(e=e.address,r.country=e.country,r.postalCode=e.postalCode,r.city=e.locality,r.line1=e.street_address,r.state=e.region),r}}]),r}(EventEmitter);Merchant.events=new EventEmitter,module.exports=Merchant;


},{"./Features":3,"./sdkErrors":11,"async":41,"bignumber.js":43,"events":117,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"paypalrest-manticore":175}],5:[function(require,module,exports){
"use strict";var l10n=require("../common/l10n"),FormFactor=require("retail-payment-device").PaymentDevice.FormFactor;module.exports.StorageType={Secure:"S",Blob:"B",String:"V",SecureBlob:"E"},module.exports.hereAPICardDataFromCard=function(e){var r=e.reader.manufacturer.toUpperCase();e.formFactor===FormFactor.MagneticCardSwipe&&"MIURA"===r&&(r=e.isMSRFallbackAllowed?"MIURA_FB_SWIPE":"MIURA_SWIPE");var a={reader:{vendor:r,readerSerialNumber:e.reader.serialNumber,deviceModel:e.reader.model}};if(e.formFactor===FormFactor.MagneticCardSwipe)a.reader.keySerialNumber=e.ksn,a.inputType="swipe",a.track1=e.track1,a.track2=e.track2,a.track3=e.track3;else if(e.formFactor===FormFactor.Chip)a.inputType="chip",a.emvData=e.emvData.apdu.data.toString("hex");else{if(e.formFactor!==FormFactor.EmvCertifiedContactless)throw new Error("Cannot generate HereAPI card data from "+e);a.inputType=e.isContactlessMSD?"contactless_msd":"contactless_chip",a.emvData=e.emvData.apdu.data.toString("hex")}return a};


},{"../common/l10n":8,"retail-payment-device":179}],6:[function(require,module,exports){
"use strict";function calLog(e,t,o,n){if("cal"!==t.name&&(t.calConfig||buildCalConfigMapping(t),!(manticore_log.Ranks[e]<manticore_log.levelFor(t.calConfig)))){n||(n={actionId:"message"}),setDefaultCalLogData(n,e,o);var a={status:n.status,type:"BIZ",name:n.actionId+".CLIENT"};n.result=n.status,delete n.status,"function"==typeof o?n.details=o().toString():n.details=o.toString(),n.logGroup=logGroup,n.invoiceId=logInvoiceId,a.data=stringify(n),manticore.setTimeout(function(){return addCalEvent(a)},0)}}function buildCalConfigMapping(e){for(var t=e.name.split("."),o=RootCalConfig,n=RootCalConfig,a=0;a<t.length;a++)o.children[t[a]]||(o.children[t[a]]={children:{},parent:n}),o=o.children[t[a]],n=o;e.calConfig=o}function setDefaultCalLogData(e,t,o){if(e.actionId||(e.actionId="message"),!e.status)switch(t.toLowerCase()){case"debug":e.status=CAL_LOG_SUCCESS;break;case"info":e.status=CAL_LOG_SUCCESS;break;case"error":e.status=CAL_LOG_FAIL;break;case"warn":e.status=CAL_LOG_FAIL;break;default:e.status=CAL_LOG_FAIL}e.msgId=queueDetails.runCounter+"."+ ++queueDetails.msgCounter+"."+ ++messageRunCounter}function addCalEvent(e){var t=function(){return MAX_CAL_EVENT_LENGTH<=queueDetails.events.length};for(t()&&Log.debug("CAL log overflow. Max messages: "+MAX_CAL_EVENT_LENGTH);t();)queueDetails.events.shift(),queueDetails.saving&&queueDetails.saving--;queueDetails.events.push(e),saveLogStore()}function addMessage(e){queueDetails.events.push(e),saveLogStore()}function saveLogStore(e){return savingLogStore?overlappedSaves.push(e):void manticore.setItem(CAL_LOG_STORE_KEY,RetailSDKUtil.StorageType.SecureBlob,JSON.stringify(queueDetails),function(t){savingLogStore=!1,overlappedSaves.length&&!function(){var e=overlappedSaves;overlappedSaves=[],saveLogStore(function(t){var o=!0,n=!1,a=void 0;try{for(var i,r=e[Symbol.iterator]();!(o=(i=r.next()).done);o=!0){var s=i.value;s&&s(t)}}catch(u){n=!0,a=u}finally{try{!o&&r["return"]&&r["return"]()}finally{if(n)throw a}}})}(),e&&e(t)})}function removePostedLogs(e){Log.debug(function(){return"Removing "+queueDetails.saving+" posted logs."}),queueDetails.events.splice(0,queueDetails.saving),queueDetails.saving=0,saveLogStore(e)}function doHttpPost(e,t){var o=require("../common/Merchant"),n=queueDetails.saving;o.active?o.active.request({service:"retail",op:"cal",method:"POST",headers:{"Content-Type":"application/json"},body:e},function(e){e?(queueDetails.saving=0,t&&t(e)):removePostedLogs(function(e){t&&t(e,n)})}):t&&t(new Error("No merchant available, cannot post CAL logs"))}function newLogGroup(e){return logGroup=e||generateGroupId(),logInvoiceId="",logGroup}function setCurrentInvoiceId(e){logInvoiceId=e}function generateGroupId(){return Date.now()+"-"+Math.random()}var stringify=require("qs/lib/stringify"),RetailSDKUtil=require("../common/RetailSDKUtil"),manticore=require("manticore"),manticore_log=require("manticore-log"),Log=manticore_log("cal"),queueDetails,logGroup=generateGroupId(),logInvoiceId="",savingLogStore=!1,overlappedSaves=[],messageRunCounter=0,MAX_CAL_EVENT_LENGTH=20,CAL_LOG_SUCCESS=0,CAL_LOG_FAIL=-1,MAX_CAL_STORE_LENGTH=5,CAL_LOG_STORE_KEY="CalLogStore",RootCalConfig={level:"INFO",children:{}};module.exports.attach=function(e){manticore.getItem(CAL_LOG_STORE_KEY,RetailSDKUtil.StorageType.Secure,function(t,o){t&&Log.error("Failed to get persisted CAL queue "+t.message),o?(queueDetails=JSON.parse(o),queueDetails.runCounter++):queueDetails={events:[],saving:0,runCounter:1,msgCounter:0},manticore_log.addLogger(calLog),e(t)})},module.exports.configure=function(e){manticore_log.configure(e,RootCalConfig)},module.exports.detach=function(e){saveLogStore(function(t){manticore_log.removeLogger(calLog),e&&e(t)})},module.exports.flush=function(e){if(queueDetails.saving)return void(e&&e(new Error("Save already in progress.")));if(queueDetails.events.length){var t=JSON.stringify({events:queueDetails.events});queueDetails.saving=queueDetails.events.length,Log.debug("Flushing "+queueDetails.saving+" to CAL server."),doHttpPost(t,e)}else e&&e(null,0)},module.exports.newGroup=newLogGroup,module.exports.setInvoiceId=setCurrentInvoiceId;


},{"../common/Merchant":4,"../common/RetailSDKUtil":5,"manticore":125,"manticore-log":123,"qs/lib/stringify":177}],7:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),_get=function(e,t,o){for(var r=!0;r;){var n=e,i=t,s=o;r=!1,null===n&&(n=Function.prototype);var l=Object.getOwnPropertyDescriptor(n,i);if(void 0!==l){if("value"in l)return l.value;var a=l.get;if(void 0===a)return;return a.call(s)}var u=Object.getPrototypeOf(n);if(null===u)return;e=u,t=i,o=s,r=!0,l=u=void 0}},EventEmitter=require("events").EventEmitter,Log=require("manticore-log")("flow"),FACADE=Symbol(),Flow=function(e){function t(e,o){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.owner=e,Array.isArray(o)?this.steps=o:this.steps=Array.prototype.slice.call(arguments,1),this.data={},this[FACADE]=null,this.stepIndex=0,this.previousSteps=[]}return _inherits(t,e),_createClass(t,[{key:"start",value:function(){return this[FACADE]=new FlowFacade(this),this[FACADE]._executeStep(0),this}},{key:"abortFlow",value:function(e){return this[FACADE]?void this[FACADE].abortFlow(e):void Log.error("Abort called on an inactive flow!")}}]),t}(EventEmitter),FlowFacade=function(){function e(t){_classCallCheck(this,e),this.active=!0,this.flow=t}return _createClass(e,[{key:"_prepareForChange",value:function(t){var o=this.flow;t||o.previousSteps.push(o.stepIndex),o[FACADE]&&(o[FACADE].active=!1),o[FACADE]=new e(o)}},{key:"_check",value:function(){return this.active?!0:(Log.error("Flow step completion function called by inactive step "+this.stepName+"!"),this.flow.emit("flowError",new Error("Flow step completion function called by inactive step!")),!1)}},{key:"_executeStep",value:function(e){var t=this,o=e<this.flow.stepIndex?"regressing":"advancing";this.flow.stepIndex=e;var r=this.flow.steps[e];Log.debug(function(){return"Flow "+o+" to "+t.stepName}),r.call(this.flow.owner,this.flow[FACADE])}},{key:"next",value:function(){if(!this._check())return void Log.debug("Flow::next called out of turn!");var e=this.flow;return e.stepIndex+1>=e.steps.length?this.completeFlow():(e.emit("next",e.stepIndex),this._prepareForChange(),void this._executeStep(e.stepIndex+1))}},{key:"back",value:function(){if(!this._check())return void Log.debug("Flow::back called out of turn!");var e=this.flow;return 0===e.previousSteps.length?this.abortFlow():(e.emit("back",e.steps[e.stepIndex],e.steps[e.stepIndex-1]),this._prepareForChange(!0),void this._executeStep(e.previousSteps.pop()))}},{key:"completeFlow",value:function(){var e=this;if(!this._check())return void Log.debug("Flow::complete called out of turn!");Log.debug(function(){return(e.flow.name||"Anonymous")+" Flow completed."});var t=this.flow;this._prepareForChange(),t.stepIndex=null,t[FACADE]=null,t.emit("completed",t.data),t.emit("ended",t.data)}},{key:"abortFlow",value:function(e){if(!this._check())return void Log.debug("Flow::abortFlow called out of order!");Log.debug((this.flow.name||"Anonymous")+" Flow aborted");var t=this.flow;e&&(t.data.error=e),this._prepareForChange(),t.stepIndex=null,t[FACADE]=null,t.emit("aborted",t.data),t.emit("ended",t.data)}},{key:"nextOrAbort",value:function(e){e?this.abortFlow(e):this.next()}},{key:"stepName",get:function(){var e=this.flow.steps[this.flow.stepIndex];return e?e.fnName||e.name:void 0}},{key:"data",get:function(){return this.flow.data}},{key:"stepIndex",get:function(){return this.flow.stepIndex}},{key:"previousSteps",get:function(){return this.flow.previousSteps}}]),e}();module.exports=Flow;


},{"events":117,"manticore-log":123}],8:[function(require,module,exports){
"use strict";module.exports=require("l10n-manticore")({en:require("./localized/en"),jp:require("./localized/jp")});


},{"./localized/en":9,"./localized/jp":10,"l10n-manticore":121}],9:[function(require,module,exports){
"use strict";module.exports={Done:"Done",Cancel:"Cancel",Ok:"OK",Error:"Oops!",Sig:{Title:"Charge ${amount} to ${cardIssuer} *${lastFour}",Here:"Sign Here",Footer:"I agree to pay the amount above according to the terms applicable to my card."},Rcpt:{Title:"${amount}",Prompt:"Would you like a receipt?",EmailPrompt:"Enter your email address:",TextPrompt:"Enter your mobile number:",Email:"Email",Text:"Text Message",No:"No Thanks",Send:"Send Receipt",EmailPH:"me@somewhere.com",TextPH:"+1 (408) 555-1212",Sending:"Sending Receipt..."},Tx:{Alert:{Ready:{Title:"Ready",Msg:"Tap, Insert or Swipe a card when ready."},EnterPin:{Title:"Enter PIN"},ReadyForInsertOrSwipeOnly:{Title:"Ready",Msg:"Insert or swipe a card when ready."},ReadyForSwipeOnly:{Title:"Please Swipe Card",Msg:"Swipe the card at the top of the reader"},ReadyForInsertOnly:{Title:"Ready",Msg:"Insert a card when ready."},Cancel:{Title:"Cancelled",Msg:"Transaction Cancelled"},TimeOut:{Title:"Transaction Timed Out",Msg:"Transaction was not completed.",Button:"Cancel transaction"},NfcNotAllowed:{Title:"Insert or swipe card",Msg:"Card provider requires that you insert or swipe card."},NfcFallback:{Title:"Unable to Read Card",Msg:"Insert or swipe card now, or try a different card."},NfcPaymentDeclined:{Title:"Contactless Transaction Declined",Msg:"Do you want to try again by inserting the card?"},InsertOrSwipe:{Title:"Insert or Swipe Card",Msg:"Card issuer requires\nthat you insert or swipe card",Button:"Cancel transaction"},IncorrectOnlinePin:{Title:"Incorrect PIN",Msg:"The PIN entered was incorrect. Please try again."},GenericError:{Title:"Transaction failed",Msg:"Unable to process payment"},TapDifferentCard:{Title:"Unable to read card",Msg:"Please insert or swipe card now, or press OK and tap a different card"},BlockedCardInserted:{Title:"Declined",Msg:"Please remove the card and contact the card issuer for more information"},BlockedCardTapped:{Title:"Declined",Msg:"Please contact the card issuer for more information"},BlockedCardSwiped:{Title:"Declined",Msg:"Please contact the card issuer for more information"},ChipCardSwiped:{Title:"Chip card detected",Msg:"Please insert card"},UnsuccessfulInsert:{Title:"Unable to read card",Msg:"Please try again. Firmly insert the card, chip first, into the bottom of the reader"}},Retry:"Try again?",CancelledByUser:"Payment Cancelled",TransactionFailed:"Payment Declined",TransactionSuccessful:"Payment Successful",RefundSuccessful:"Refund Complete",RefundFailed:"Refund Failed"},Miura:{P2PE:"Securing Device...",P2PEInit:"Initializing\nDevice...",P2PEFetch:"Generating Keys...",OSUpdate:"Updating OS\n${perc}%",MPIUpdate:"Updating Terminal\n${perc}%",CfgUpdate:"Updating Configuration\n${perc}%",Title:"Updating Reader",UsbMsg:"Do not disconnect your reader.",BtMsg:"Do not disconnect your reader.",UsbUnplug:"Please unplug your USB reader and press OK",UsbWait:"Please wait before plugging in your USB reader.",UsbPlug:"Please reconnect your USB reader."},SwUpgrade:{Title:"Update Required",Reqd:"Your card reader must be updated before you can process transactions.",Opt:"An update is available for your card reader.",Buttons:{Ok:"Update Now",Cancel:"Not Now",Retry:"Try again"},Failed:{Title:"Software Update Failed",Msg:"Sorry, the update could not be completed."}},EMV:{Processing:"Processing...",ProcessingRefund:"Processing Refund...",Auth:"Authorizing...",Finalize:"Completing Payment...",DoNotRemove:"Do not remove the card.",Remove:"Please remove card.",Complete:"${amount} paid",RefundComplete:"${amount} refunded",Failed:"Transaction Failed",Select:"Choose an application:",Device:{RemoveCard:"Please remove card.",DoNotRemove:"Do not remove card."}}};


},{}],10:[function(require,module,exports){
"use strict";module.exports={Sig:{Footer:"カードに適用される利用条件に従い、上の金額を支払うことに同意します。"}};


},{}],11:[function(require,module,exports){
"use strict";var Domain={TRANSACTION:"TRANSACTION",MERCHANT:"MERCHANT"};module.exports=function(e,o,n){return e.domain=o[0],e.code=String(o[1]),e.message=o[2]||e.message,e.debugId=n,e},module.exports.TRANSACTION={CUSTOMER_CANCEL:[Domain.TRANSACTION,1,"Transaction cancelled by customer"],GENERIC_CANCEL:[Domain.TRANSACTION,2,"The transaction was cancelled"],CARD_CANT_CONTINUE:[Domain.TRANSACTION,3,"Cannot continue with specified card."],NO_FUNCTIONAL_DEVICES:[Domain.TRANSACTION,4,"No functional devices."],INVOICE_STATUS_MISMATCH:[Domain.TRANSACTION,5,"The invoice status is not eligible for the given transaction method"]},module.exports.MERCHANT={FAILED_TO_LOAD:[Domain.MERCHANT,1,"Failed to load the merchant information."],REQUIRED_INFO_NOT_LOADED:[Domain.MERCHANT,2,"Failed to load required merchant information"]};


},{}],12:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),Flow=require("../common/flow"),Log=require("manticore-log")("flow.basePayment"),l10n=require("../common/l10n"),Currency=require("paypal-invoicing").Currency,SignatureStep=require("./steps/SignatureStep"),FinalizePaymentStep=require("./steps/FinalizePaymentStep"),MerchantTakePaymentStep=require("./steps/MerchantTakePaymentStep"),ReceiptStep=require("./steps/ReceiptStep"),TransactionRecord=require("../transaction/TransactionRecord"),PaymentDevice=require("retail-payment-device").PaymentDevice,AuthCode=PaymentDevice.authCode,ErrorCode=PaymentDevice.errorCode,PaymentErrorHandler=require("./PaymentErrorHandler"),NetworkError=PaymentErrorHandler.networkError,Cal=require("../common/cal"),manticore=require("manticore"),BaseTransactionFlow=function(){function e(t,o,n){var r=this;_classCallCheck(this,e),this.card=t,this.context=o,this.onCompleteCallback=n;var i=new Error;i.code=ErrorCode.paymentCancelled,this.transactionCancelRequested=function(){Log.info("Transaction cancel was requested from device "+r.card.reader.id),r.card.reader.deactivate(r.context,!1,function(){Log.info("Deactivated card reader "+r.card.reader.id),r.flow.abortFlow(i)})},this.transactionCancelled=function(){Log.info("Transaction on device "+r.card.reader.id+" was cancelled"),r.flow.abortFlow(i)}}return _createClass(e,[{key:"setFlowSteps",value:function(e,t){return this.flowName=e,this.flowSteps=t,this.flow=new Flow(this,this.flowSteps),this}},{key:"addFlowEndedHandler",value:function(e){if(void 0===this.flow)throw new Error("Flow needs to be initialized first");return this.flow.on("ended",e),this}},{key:"setCompletionSteps",value:function(e,t){return this.completionFlowName=e,this.completionFlowSteps=t,this}},{key:"startFlow",value:function(){var e=this;Log.debug(function(){return"Start executing "+e.flowSteps.length+" steps for "+e.flowName+" flow"});this.flow;this.flow.name=this.flowName,this.flow.on("completed",function(t){e.completeTransaction(t)}),this.flow.on("aborted",function(t){e.abortTransaction(t)}),this.flow.start()}},{key:"invokeCompleteCallback",value:function(e,t){e.alert&&e.alert.dismiss(),this.invokeCompleteCallbackWithoutDismissingAlert(e,t)}},{key:"invokeCompleteCallbackWithoutDismissingAlert",value:function(e,t){this.onCompleteCallback(e.error,t,e.tx)}},{key:"completeTransaction",value:function(e){var t=this;Log.debug(function(){return"Starting completion steps for "+t.flowName+" flow"}),this.completionFlowSteps?(this.completionFlow=new Flow(this,this.completionFlowSteps),this.completionFlow.name=this.completionFlowName,this.completionFlow.data=e,this.completionFlow.on("ended",function(e){Log.debug(function(){return"Flow ended. Proceeding to invoke flow complete callback (error: "+e.error+")"}),t.invokeCompleteCallback(e,null)})):(Log.debug(function(){return"Flow ended and completion steps not defined. Proceeding to invoke complete callback"}),this.invokeCompleteCallback(e,null)),this.card&&this.card.reader?this.card.reader.clearTransaction(function(){t.completionFlow&&t.completionFlow.start()}):this.completionFlow&&this.completionFlow.start()}},{key:"abortTransaction",value:function(e){var t=this;this.voidPaymentIfApplicable(e);var o=e.error,n=this.card&&this.card.formFactor,r=this.card&&this.card.reader;return Log.warn("Flow (formFactor: "+n+") aborted with error code: '"+o.code+"'\n"+o),o.code?void new PaymentErrorHandler(this.context).handle(o,n,r,function(o){o===PaymentErrorHandler.action.abort?t.completeTransaction(e):o===PaymentErrorHandler.action.retryWithSwipe?t.invokeCompleteCallbackWithoutDismissingAlert(e,o):t.invokeCompleteCallback(e,o)}):void(r?r.display(PaymentDevice.Message.TransactionCancelled,this.formattedAmount,function(o){t.completeTransaction(e)}):this.completeTransaction(e))}},{key:"voidPaymentIfApplicable",value:function(e){var t=this;e&&e.tx&&e.tx.transactionHandle&&!function(){var o={invoiceId:t.context.invoice.payPalId};e.tx.responseCode&&(o.responseCode=e.tx.responseCode);var n="payment/"+e.tx.transactionHandle+"/void";t.context.merchant.request({service:"retail",op:n,format:"json",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)},function(e,r){return e?Log.error("Void request "+n+" returned an error for payload: "+JSON.stringify(o,null,4)+"\n"+e+" "):void Log.debug(function(){return"Successfully voided invoice id: "+t.context.invoice.payPalId+" \n"+JSON.stringify(r||{},null,4)})})}()}},{key:"saveInvoiceStep",value:function(e){var t=this;this.context.invoice.save(function(o){if(o){Log.error("Unable to save invoice. Error: "+o+"\n"+JSON.stringify(t.context.invoice,null,4));var n=AuthCode.TransactionFailure;o.code===NetworkError.offline&&(n=AuthCode.NoNetwork),Log.debug("Pushing authCode : "+n),t.card.reader.completeTransaction(n,function(t,n){return t&&Log.error("Error response on pushing auth code to terminal "+JSON.stringify(t)),e.abortFlow(o)})}else Cal.setInvoiceId(t.context.invoice.payPalId),e.next()})}},{key:"createFlowMessageStep",value:function(e){var t=this;return function(o){e(t.context,o.data,function(e){o.next()})}}},{key:"stopWatchingForTransactionCancel",value:function(e){this._removeTransactionCancelListener(),e.next()}},{key:"formattedAmount",get:function(){return{amount:Currency.format(this.context.invoice.currency,this.context.invoice.total)}}}]),e}();module.exports=BaseTransactionFlow;


},{"../common/cal":6,"../common/flow":7,"../common/l10n":8,"../transaction/TransactionRecord":38,"./PaymentErrorHandler":14,"./steps/FinalizePaymentStep":18,"./steps/MerchantTakePaymentStep":21,"./steps/ReceiptStep":23,"./steps/SignatureStep":25,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],13:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var a=e,i=t,s=r;n=!1,null===a&&(a=Function.prototype);var o=Object.getOwnPropertyDescriptor(a,i);if(void 0!==o){if("value"in o)return o.value;var c=o.get;if(void 0===c)return;return c.call(s)}var l=Object.getPrototypeOf(a);if(null===l)return;e=l,t=i,r=s,n=!0,o=l=void 0}},manticore=require("manticore"),Log=require("manticore-log")("flow.credit"),messageHelper=require("./messageHelper"),BaseTransactionFlow=require("./BaseTransactionFlow"),PaymentDevice=require("retail-payment-device").PaymentDevice,ReadCardStep=require("./steps/ReadCardStep"),MerchantTakePaymentStep=require("./steps/MerchantTakePaymentStep"),SignatureStep=require("./steps/SignatureStep"),FinalizePaymentStep=require("./steps/FinalizePaymentStep"),UpdateInvoicePaymentStep=require("./steps/UpdateInvoicePaymentStep"),RemoveCardStep=require("./steps/RemoveCardStep"),ReceiptStep=require("./steps/ReceiptStep"),CreditCardFlow=function(e){function t(e,r,n){var a=this;_classCallCheck(this,t),Log.debug("Initializing Credit Flow"),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r,n),_get(Object.getPrototypeOf(t.prototype),"setFlowSteps",this).call(this,"Credit",[function(e){this.card.reader.once(PaymentDevice.Event.cardRemoved,this.transactionCancelRequested),this.card.reader.once(PaymentDevice.Event.cancelRequested,this.transactionCancelRequested),this.card.reader.once(PaymentDevice.Event.disconnected,this.transactionCancelRequested),this.card.reader.once(PaymentDevice.Event.cancelled,this.transactionCancelled),e.next()},this.createFlowMessageStep(messageHelper.showProcessingMessage),new ReadCardStep(r).flowStep,this.saveInvoiceStep,this.createFlowMessageStep(messageHelper.showAuthMessage),new MerchantTakePaymentStep(r,this.voidPaymentIfApplicable).flowStep,new SignatureStep(r).flowStep,this.createFlowMessageStep(messageHelper.showFinalizeMessage),function(e){this._removePaymentCancelListeners(),e.next()},new FinalizePaymentStep(r).flowStep,new UpdateInvoicePaymentStep(r).flowStep,new RemoveCardStep(r).flowStep,this.createFlowMessageStep(messageHelper.showCompleteMessage)]).addFlowEndedHandler(function(){return a._removePaymentCancelListeners()}).setCompletionSteps("Credit-Receipt",[new ReceiptStep(this.context).flowStep]).startFlow()}return _inherits(t,e),_createClass(t,[{key:"_removePaymentCancelListeners",value:function(){this.card.reader.removeListener(PaymentDevice.Event.cardRemoved,this.transactionCancelRequested),this.card.reader.removeListener(PaymentDevice.Event.cancelRequested,this.transactionCancelRequested),this.card.reader.removeListener(PaymentDevice.Event.disconnected,this.transactionCancelRequested),this.card.reader.removeListener(PaymentDevice.Event.cancelled,this.transactionCancelled)}}]),t}(BaseTransactionFlow);module.exports=CreditCardFlow;


},{"./BaseTransactionFlow":12,"./messageHelper":15,"./steps/FinalizePaymentStep":18,"./steps/MerchantTakePaymentStep":21,"./steps/ReadCardStep":22,"./steps/ReceiptStep":23,"./steps/RemoveCardStep":24,"./steps/SignatureStep":25,"./steps/UpdateInvoicePaymentStep":26,"manticore":125,"manticore-log":123,"retail-payment-device":179}],14:[function(require,module,exports){
"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),manticore=require("manticore"),Log=require("manticore-log")("tx.errorHandler"),Currency=require("paypal-invoicing").Currency,l10n=require("../common/l10n"),util=require("manticore-util"),PaymentDevice=require("retail-payment-device").PaymentDevice,DeviceError=PaymentDevice.errorCode,FormFactor=PaymentDevice.FormFactor,Terminal=require("miura-emv").Terminal,PaymentErrorHandler=function(){function e(r){var t,n,i,o,a,c=this;_classCallCheck(this,e),this.context=r,this.formattedAmount={amount:Currency.format(this.context.invoice.currency,this.context.invoice.total)};var l=e.apiErrors,s=e.action,d=void 0,u=void 0,m=function(e,r){r(null)},f=(t={},_defineProperty(t,DeviceError.nfcTimeout,function(e,r){c._display(e,PaymentDevice.Message.NfcTimeOut,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.TimeOut.Title"),message:l10n("Tx.Alert.TimeOut.Msg"),buttons:[l10n("Tx.Retry")],cancel:l10n("Tx.Alert.TimeOut.Button")},function(e,t){0===t?(c.context.promptForPaymentInstrument(),r(s.retry)):r(s.abort)})})}),_defineProperty(t,DeviceError.nfcNotAllowed,function(r,t){c._nfcPaymentDeclineErrorHandler(s,r,function(r){t(r===e.action.retryWithInsertOrSwipe?r:s.OfflineDecline)})}),_defineProperty(t,DeviceError.tryDifferentCard,function(e,r){c._display(e,PaymentDevice.Message.UnableToReadNfcCard,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.TapDifferentCard.Title"),message:l10n("Tx.Alert.TapDifferentCard.Msg"),cancel:l10n("Ok")},function(){c.context.promptForPaymentInstrument(),r(s.retry)})})}),_defineProperty(t,DeviceError.contactIssuer,d=function(e,r){c._display(e,PaymentDevice.Message.ContactIssuer,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.BlockedCardTapped.Title"),message:l10n("Tx.Alert.BlockedCardTapped.Msg"),cancel:l10n("Ok")},function(){return r(s.abort)})})}),_defineProperty(t,DeviceError.contactlessPaymentAbortedByCardInsert,m),_defineProperty(t,DeviceError.contactlessPaymentAbortedByCardSwipe,m),_defineProperty(t,l.nfcPaymentDeclined,function(e,r){c._nfcPaymentDeclineErrorHandler(s,e,r)}),_defineProperty(t,l.onlinePinMaxRetryExceed,d),_defineProperty(t,l.contactIssuer,d),t),y=(n={},_defineProperty(n,DeviceError.cardBlocked,u=function(e,r){e.once(PaymentDevice.Event.cardRemoved,function(){c._dismissAlert(),c._display(e,PaymentDevice.Message.ContactIssuer,null,function(){return r(s.abort)})}),c._display(e,PaymentDevice.Message.BlockedCardInserted,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.BlockedCardInserted.Title"),message:l10n("Tx.Alert.BlockedCardInserted.Msg")})})}),_defineProperty(n,DeviceError.contactIssuer,u),_defineProperty(n,l.contactIssuer,u),_defineProperty(n,l.onlinePinMaxRetryExceed,u),_defineProperty(n,DeviceError.invalidChip,function(e,r){return Log.debug(function(){return"Invalid chip card (Attempt: "+(c.context.retryCountInvalidChip+1)+")"}),c.context.retryCountInvalidChip>=PaymentDevice.constant.InvalidChipRetryCount?(c._alert({title:l10n("Tx.Alert.ReadyForSwipeOnly.Title"),message:l10n("Tx.Alert.ReadyForSwipeOnly.Msg"),imageIcon:"img_emv_swipe"},function(){}),c.context.allowFallBackSwipe=!0,r(s.retryWithSwipe)):(c.context.retryCountInvalidChip+=1,e.once(PaymentDevice.Event.cardRemoved,function(){c.context.promptForPaymentInstrument(new Set([FormFactor.MagneticCardSwipe,FormFactor.Chip]))}),c._alert({title:l10n("Tx.Alert.UnsuccessfulInsert.Title"),message:l10n("Tx.Alert.UnsuccessfulInsert.Msg")},function(){}),void r(s.retryWithInsertOrSwipe))}),n),p=(i={},_defineProperty(i,DeviceError.cannotSwipeChipCard,function(e,r){c._alert({title:l10n("Tx.Alert.ChipCardSwiped.Title"),message:l10n("Tx.Alert.ChipCardSwiped.Msg"),cancel:l10n("Ok")},function(){c.context.promptForPaymentInstrument(new Set([FormFactor.Chip]))}),r(s.retryWithInsert)}),_defineProperty(i,DeviceError.contactIssuer,function(e,r){c._display(e,PaymentDevice.Message.ContactIssuer,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.BlockedCardSwiped.Title"),message:l10n("Tx.Alert.BlockedCardSwiped.Msg"),cancel:l10n("Ok")},function(){return r(s.abort)})})}),i),P=(o={},_defineProperty(o,l.incorrectOnlinePin,function(e,r){c._display(e,PaymentDevice.Message.IncorrectPin,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.IncorrectOnlinePin.Title"),message:l10n("Tx.Alert.IncorrectOnlinePin.Msg"),cancel:l10n("Ok")},function(){c.context.promptForPaymentInstrument(),r(s.retry)})})}),_defineProperty(o,DeviceError.mustSwipeCard,function(e,r){c._alert({title:l10n("Tx.Alert.ReadyForSwipeOnly.Title"),message:l10n("Tx.Alert.ReadyForSwipeOnly.Msg"),imageIcon:"img_emv_swipe"},function(){}),c.context.allowFallBackSwipe=!0,r(s.retryWithSwipe)}),_defineProperty(o,DeviceError.genericError,function(e,r){c._display(e,PaymentDevice.Message.TransactionCancelled,c.formattedAmount,function(){c._alert({title:l10n("Tx.Alert.GenericError.Title"),message:l10n("Tx.Alert.GenericError.Msg"),cancel:l10n("Ok")},function(){return r(s.abort)})})}),_defineProperty(o,DeviceError.paymentCancelled,function(e,r){c._display(e,PaymentDevice.Message.TransactionCancelled,c.formattedAmount,function(){r(s.abort)})}),o);this._errorHandlers=(a={},_defineProperty(a,FormFactor.None,P),_defineProperty(a,FormFactor.EmvCertifiedContactless,util.extend(f,P)),_defineProperty(a,FormFactor.Chip,util.extend(y,P)),_defineProperty(a,FormFactor.MagneticCardSwipe,util.extend(p,P)),a)}return _createClass(e,[{key:"handle",value:function(r,t,n,i){var o=this;return this._errorHandlers[t]&&this._errorHandlers[t][r.code]?void this._errorHandlers[t][r.code](n,i):(Log.warn("No handlers were defined for form factor : "+t+" and Error code "+r.code),void this._display(n,PaymentDevice.Message.TransactionCancelled,this.formattedAmount,function(){o._alert({title:l10n("Tx.Alert.GenericError.Title"),message:l10n("Tx.Alert.GenericError.Msg"),cancel:l10n("Ok")},function(){return i(e.action.abort)})}))}},{key:"_display",value:function(e,r,t,n){e?e.display(r,t,n):n&&n()}},{key:"_alert",value:function(e,r){var t=this;this.alert=manticore.alert(e,function(e,n){t._dismissAlert(),r(e,n)})}},{key:"_dismissAlert",value:function(){this.alert&&this.alert.dismiss()}},{key:"_nfcPaymentDeclineErrorHandler",value:function(e,r,t){var n=this;this._display(r,PaymentDevice.Message.NfcDecline,null,function(){n._alert({title:l10n("Tx.Alert.NfcPaymentDeclined.Title"),message:l10n("Tx.Alert.NfcPaymentDeclined.Msg"),buttons:[l10n("Ok")],cancel:l10n("Cancel")},function(r,i){0===i?(n.context.promptForPaymentInstrument(new Set([FormFactor.Chip,FormFactor.MagneticCardSwipe])),t(e.retryWithInsertOrSwipe)):t(e.abort)})})}}]),e}();PaymentErrorHandler.action={OfflineDecline:"OfflineDecline",abort:"abort",retry:"retry",retryWithInsertOrSwipe:"retryWithInsertOrSwipe",retryWithInsert:"retryWithInsert",retryWithSwipe:"retryWithSwipe"},PaymentErrorHandler.apiErrors={nfcPaymentDeclined:600075,incorrectOnlinePin:6000164,onlinePinMaxRetryExceed:6000165,contactIssuer:580031},PaymentErrorHandler.networkError={offline:-1001},module.exports=PaymentErrorHandler;


},{"../common/l10n":8,"manticore":125,"manticore-log":123,"manticore-util":124,"miura-emv":126,"paypal-invoicing":141,"retail-payment-device":179}],15:[function(require,module,exports){
"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function formattedInvoiceTotal(e){return{amount:Currency.format(e.currency,e.total)}}function displayOrReuseAlert(e,r){return e.alert=manticore.alert(r,function(){}),e.alert}function readerDisplay(e,r,t,n){e.card&&e.card.reader?e.card.reader.display(r,t,n):n()}function showSimpleMessage(e,r,t,n){return displayOrReuseAlert(n,{title:e,message:r,showActivity:t,replace:!0})}var manticore=require("manticore"),Log=require("manticore-log")("flow.messageHelper"),l10n=require("../common/l10n"),Currency=require("paypal-invoicing").Currency,PaymentDevice=require("retail-payment-device").PaymentDevice;module.exports.showSimpleMessage=showSimpleMessage,module.exports.showProcessingMessage=function(e,r,t){var n={title:l10n("EMV.Processing"),showActivity:!0,replace:!0};e.card&&e.card.formFactor===PaymentDevice.FormFactor.Chip&&(n.message=l10n("EMV.DoNotRemove"));var o=manticore.alert(n,function(){});r.alert=o;var a=_defineProperty({},PaymentDevice.FormFactor.Chip,PaymentDevice.Message.ProcessingContact),i=e.card&&a[e.card.formFactor]||PaymentDevice.Message.Processing;readerDisplay(e,i,formattedInvoiceTotal(e.invoice),function(){return t(o)})},module.exports.showAuthMessage=function(e,r,t){return t(showSimpleMessage(l10n("EMV.Auth"),null,!0,r))},module.exports.showFinalizeMessage=function(e,r,t){return t(showSimpleMessage(l10n("EMV.Finalize"),null,!0,r))},module.exports.showRefundProcessingMessage=function(e,r,t){return t(showSimpleMessage(l10n("EMV.ProcessingRefund"),null,!0,r))},module.exports.showRemoveCardMessage=function(e,r,t){var n=formattedInvoiceTotal(e.invoice),o="EMV.Complete",a=PaymentDevice.Message.PaidRemoveCard;e.isRefund()&&(o="EMV.RefundComplete",a=PaymentDevice.Message.RefundRemoveCard);var i=showSimpleMessage(l10n(o,n),l10n("EMV.Remove"),!1,r);readerDisplay(e,a,n,function(){return t(i)})},module.exports.showCompleteMessage=function(e,r,t){var n=formattedInvoiceTotal(e.invoice),o=e.isRefund()?PaymentDevice.Message.Refund:PaymentDevice.Message.Paid;readerDisplay(e,o,n,function(){return t(r)})},module.exports.showSelectApplicationPrompt=function(e,r,t,n){var o=[],a=!0,i=!1,s=void 0;try{for(var l,c=t[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var u=l.value;o.push(u[1]||u[0])}}catch(m){i=!0,s=m}finally{try{!a&&c["return"]&&c["return"]()}finally{if(i)throw s}}return r.alert=manticore.alert({title:l10n("EMV.Select"),buttons:o},function(e,r){var o=t[r][0],a=t[r][1];n&&n(o,a)}),r.alert};


},{"../common/l10n":8,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],16:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var a=e,i=t,o=n;r=!1,null===a&&(a=Function.prototype);var s=Object.getOwnPropertyDescriptor(a,i);if(void 0!==s){if("value"in s)return s.value;var c=s.get;if(void 0===c)return;return c.call(o)}var l=Object.getPrototypeOf(a);if(null===l)return;e=l,t=i,n=o,r=!0,s=l=void 0}},manticore=require("manticore"),Log=require("manticore-log")("flow.credit"),messageHelper=require("./messageHelper"),BaseTransactionFlow=require("./BaseTransactionFlow"),PaymentDevice=require("retail-payment-device").PaymentDevice,ReadCardStep=require("./steps/ReadCardStep"),CheckRefundEligibilityStep=require("./steps/CheckRefundEligibilityStep"),IssueRefundStep=require("./steps/IssueRefundStep"),UpdateInvoicePaymentStep=require("./steps/UpdateInvoicePaymentStep"),RemoveCardStep=require("./steps/RemoveCardStep"),ReceiptStep=require("./steps/ReceiptStep"),RefundFlow=function(e){function t(e,n,r){var a=this;_classCallCheck(this,t),Log.debug("Initializing Refund Flow"),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,n,r),_get(Object.getPrototypeOf(t.prototype),"setFlowSteps",this).call(this,"Refund",[function(e){this.card&&(this.card.reader.once(PaymentDevice.Event.cardRemoved,this.transactionCancelRequested),this.card.reader.once(PaymentDevice.Event.cancelRequested,this.transactionCancelRequested),this.card.reader.once(PaymentDevice.Event.cancelled,this.transactionCancelled)),e.next()},this.createFlowMessageStep(messageHelper.showProcessingMessage),new ReadCardStep(n).flowStep,function(e){this.card?this.card.reader.abortTransaction(function(){e.next()}):e.next()},new CheckRefundEligibilityStep(n).flowStep,this.createFlowMessageStep(messageHelper.showRefundProcessingMessage),function(e){this._removePaymentCancelListeners(),e.next()},new IssueRefundStep(n).flowStep,new UpdateInvoicePaymentStep(n).flowStep,new RemoveCardStep(n).flowStep,this.createFlowMessageStep(messageHelper.showCompleteMessage)]).addFlowEndedHandler(function(){return a._removePaymentCancelListeners()}).setCompletionSteps("Refund-Receipt",[new ReceiptStep(this.context).flowStep]);var i=n.invoice.payments&&n.invoice.payments[0];i&&(this.flow.data.transactionNumber=i.transactionID,this.flow.data.amount=i.amount),this.startFlow()}return _inherits(t,e),_createClass(t,[{key:"_removePaymentCancelListeners",value:function(){this.card&&(this.card.reader.removeListener(PaymentDevice.Event.cardRemoved,this.transactionCancelRequested),this.card.reader.removeListener(PaymentDevice.Event.cancelRequested,this.transactionCancelRequested),this.card.reader.removeListener(PaymentDevice.Event.cancelled,this.transactionCancelled))}}]),t}(BaseTransactionFlow);module.exports=RefundFlow;


},{"./BaseTransactionFlow":12,"./messageHelper":15,"./steps/CheckRefundEligibilityStep":17,"./steps/IssueRefundStep":20,"./steps/ReadCardStep":22,"./steps/ReceiptStep":23,"./steps/RemoveCardStep":24,"./steps/UpdateInvoicePaymentStep":26,"manticore":125,"manticore-log":123,"retail-payment-device":179}],17:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_get=function(e,t,r){for(var o=!0;o;){var n=e,i=t,a=r;o=!1,null===n&&(n=Function.prototype);var c=Object.getOwnPropertyDescriptor(n,i);if(void 0!==c){if("value"in c)return c.value;var l=c.get;if(void 0===l)return;return l.call(a)}var u=Object.getPrototypeOf(n);if(null===u)return;e=u,t=i,r=a,o=!0,c=u=void 0}},Log=require("manticore-log")("flow.checkRefundEligiblity"),l10n=require("../../common/l10n"),FlowStep=require("./FlowStep"),moment=require("moment"),FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,RetailSDKUtil=require("../../common/RetailSDKUtil.js"),TransactionRecord=require("../../transaction/TransactionRecord"),CheckRefundEligibilityFlowStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){if(!this.context.card)return e.next();if(e.data.error)return Log.warn("Skip Issuing refund. Reason: One/more of previous steps logged an error"),e.next();var t=this.context.merchant,r=this._buildRequest(e);t.request({service:"retail",op:"pay/"+e.data.transactionNumber+"/validateCard",format:"json",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},function(t,r){!t&&r.body&&"ELIGIBLE"!==r.body.status&&(t=new Error("Presented card does not card used in original transaction")),e.nextOrAbort(t)})}},{key:"_buildRequest",value:function(e){var t={invoiceId:this.context.invoice.payPalId,dateTime:moment().format("YYYY-MM-DDTHH:mm:ssZZ"),card:RetailSDKUtil.hereAPICardDataFromCard(this.context.card)};return t}}]),t}(FlowStep);module.exports=CheckRefundEligibilityFlowStep;


},{"../../common/RetailSDKUtil.js":5,"../../common/l10n":8,"../../transaction/TransactionRecord":38,"./FlowStep":19,"manticore-log":123,"moment":140,"retail-payment-device":179}],18:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,a=t,i=n;r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(i)}var c=Object.getPrototypeOf(o);if(null===c)return;e=c,t=a,n=i,r=!0,s=c=void 0}},Log=require("manticore-log")("flow.mtp.finalize"),FlowStep=require("./FlowStep"),FinalizePaymentStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e,this.isContaclessMSDTransaction=e.card.isContactlessMSD}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){if(e.data.error)return Log.warn("Skipping Finalize payment. Reason: One/more of previous steps logged an error"),e.next();if(!e.data.signature&&(!e.data.cardResponse||this.isContaclessMSDTransaction))return Log.debug("Skipping Finalize payment"),e.next();var t=this.context.merchant,n=this.buildRequest(e);Log.debug("MFP:\n"+JSON.stringify(n,null,"	")+"\n"),t.request({service:"retail",op:"payment/"+(e.data.tx.transactionNumber||e.data.tx.transactionHandle),format:"json",method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},function(t,n){var r=n||{};return Log[t?"error":"debug"](function(){return"MFP "+(t||"no error")+" "+JSON.stringify(r,null,"	")}),e.data.tx.updateFromFinalize(n.body),t?e.abortFlow(t):void e.next()})}},{key:"buildRequest",value:function(e){var t={invoiceId:this.context.invoice.payPalId};return e.data.cardResponse&&!this.isContaclessMSDTransaction&&(t.emvData=e.data.cardResponse.apdu.data.toString("hex"),t.responseCode=e.data.tx.responseCode),e.data.signature&&(t.signature=e.data.signature.toString("utf-8")),t}}]),t}(FlowStep);module.exports=FinalizePaymentStep;


},{"./FlowStep":19,"manticore-log":123}],19:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),FlowStep=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"execute",value:function(){throw new Error("FlowStep must define execute method.")}},{key:"flowStep",get:function(){var e=this,t=function(t){e.execute(t)};return t.fnName=this.constructor.name,t}}]),e}();module.exports=FlowStep;


},{}],20:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,a=t,u=r;n=!1,null===o&&(o=Function.prototype);var i=Object.getOwnPropertyDescriptor(o,a);if(void 0!==i){if("value"in i)return i.value;var s=i.get;if(void 0===s)return;return s.call(u)}var c=Object.getPrototypeOf(o);if(null===c)return;e=c,t=a,r=u,n=!0,i=c=void 0}},Log=require("manticore-log")("flow.mtp.takePayment"),l10n=require("../../common/l10n"),FlowStep=require("./FlowStep"),TransactionRecord=require("../../transaction/TransactionRecord"),IssueRefundStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){var t=this;if(e.data.error)return Log.warn("Skip Issuing refund. Reason: One/more of previous steps logged an error"),e.next();if(!e.data.transactionNumber)return Log.error("No transaction transactionNumber found. Aborting."),e.abort();var r=this.context.merchant,n=this._buildRequest(e,r);r.request({service:"payments",op:"sale/"+e.data.transactionNumber+"/refund",format:"json",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},function(r,n){t._processResult(e,r,n)})}},{key:"_buildRequest",value:function(e,t){var r={is_non_platform_transaction:"YES"};return this.context.refundAmount&&(r.amount={total:this.context.refundAmount,currency:t.currency}),r}},{key:"_processResult",value:function(e,t,r){r&&r.body&&(e.data.tx=new TransactionRecord(r.body)),t&&(t.message=l10n("Tx.RefundFailed")),e.nextOrAbort(t)}}]),t}(FlowStep);module.exports=IssueRefundStep;


},{"../../common/l10n":8,"../../transaction/TransactionRecord":38,"./FlowStep":19,"manticore-log":123}],21:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_get=function(e,t,r){for(var o=!0;o;){var n=e,a=t,i=r;o=!1,null===n&&(n=Function.prototype);var u=Object.getOwnPropertyDescriptor(n,a);if(void 0!==u){if("value"in u)return u.value;var c=u.get;if(void 0===c)return;return c.call(i)}var s=Object.getPrototypeOf(n);if(null===s)return;e=s,t=a,r=i,o=!0,u=s=void 0}},Log=require("manticore-log")("flow.mtp.takePayment"),l10n=require("../../common/l10n"),FlowStep=require("./FlowStep"),MagneticCard=require("retail-payment-device").MagneticCard,TransactionRecord=require("../../transaction/TransactionRecord"),PaymentDevice=require("retail-payment-device").PaymentDevice,FormFactor=PaymentDevice.FormFactor,AuthCode=PaymentDevice.authCode,RetailSDKUtil=require("../../common/RetailSDKUtil.js"),NetworkError=require("../PaymentErrorHandler").networkError,MerchantTakePaymentStep=function(e){function t(e,r){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e,this.instrument=e.card,this.voidFunc=r}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){var t=this,r=this.context.merchant,o=this.buildRequest(e);Log.debug(function(){return"MTP:\n"+JSON.stringify(o,null,"	")+"\n"}),r.request({service:"retail",op:"payment",format:"json",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)},function(r,n){e.data.tx=n&&n.body?new TransactionRecord(n.body):{};var a=n&&n.body&&n.body.authCode&&"null"!==n.body.authCode?n.body.authCode:null,i=o&&o.card&&o.card.emvData&&(t.instrument.formFactor===FormFactor.Chip||t.instrument.formFactor===FormFactor.EmvCertifiedContactless);Log[r?"error":"debug"](function(){return"MTP "+(r?"Error: "+JSON.stringify(r):"no error")+", isEmv: "+i+", formFactor: "+t.instrument.formFactor+" \n"+JSON.stringify(n||{},null,"	")}),t._processResult(i,a,e,r)})}},{key:"_processResult",value:function(e,t,r,o){var n=this,a=function(e,t){return r.data.cardResponse=t,r.data.error?(Log.info("Voiding tx as flow was aborted when MTP request was in flight with error: "+JSON.stringify(r.data.error)),n.voidFunc&&n.voidFunc(r.data)):void r.nextOrAbort(o||e)};e?(t?r.data.tx.authCode=t:(r.data.tx.authCode=AuthCode.TransactionSuccess,o&&(r.data.tx.authCode=o.code===NetworkError.offline?AuthCode.NoNetwork:AuthCode.TransactionFailure)),this._pushAuthCode(r.data.tx.authCode,a)):a(null,null)}},{key:"_pushAuthCode",value:function(e,t){var r=this;Log.debug("Pushing authCode : "+e+" to "+this.instrument.reader.id),this.instrument.reader.completeTransaction(e,function(o,n){return o?(Log.error("Error response on pushing auth code to terminal"),t(o)):(Log.info("Pushed auth code ("+e+") to reader "+r.instrument.reader.id+". Response template: "+(n.apdu?n.apdu.template:"")),void t(null,n))})}},{key:"buildRequest",value:function(e){var t=RetailSDKUtil.hereAPICardDataFromCard(this.instrument);return this.instrument.formFactor!==FormFactor.MagneticCardSwipe&&(t.pinPresent=!!e.data.pinPresent),t.signatureRequired=this.instrument.isSignatureRequired,{invoiceId:this.context.invoice.payPalId,paymentType:"card",dateTime:this.instrument.timestamp||"MISSING",card:t}}}]),t}(FlowStep);module.exports=MerchantTakePaymentStep;


},{"../../common/RetailSDKUtil.js":5,"../../common/l10n":8,"../../transaction/TransactionRecord":38,"../PaymentErrorHandler":14,"./FlowStep":19,"manticore-log":123,"retail-payment-device":179}],22:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_get=function(e,r,t){for(var n=!0;n;){var a=e,o=r,i=t;n=!1,null===a&&(a=Function.prototype);var c=Object.getOwnPropertyDescriptor(a,o);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(i)}var d=Object.getPrototypeOf(a);if(null===d)return;e=d,r=o,t=i,n=!0,c=d=void 0}},Log=require("manticore-log")("flow.step.readCard"),l10n=require("../../common/l10n"),FlowStep=require("./FlowStep"),manticore=require("manticore"),Utils=require("manticore-util"),messageHelper=require("../messageHelper.js"),PaymentDevice=require("retail-payment-device").PaymentDevice,ReadCardStep=function(e){function r(e){_classCallCheck(this,r),_get(Object.getPrototypeOf(r.prototype),"constructor",this).call(this),this.context=e}return _inherits(r,e),_createClass(r,[{key:"execute",value:function(e){var r=this;Log.debug("Executing ReadCardStep");var t=this.context.card;return t&&t.formFactor===PaymentDevice.FormFactor.Chip?(t.reader.on("pinEvent",function(r){r.correct?e.data.pinPresent=!0:0===r.digits&&e.data.alert.setTitle(l10n("Tx.Alert.EnterPin.Title"))}),this.readCardErrorHandler=function(t){return r._readCardErrorHandler(e,t)},this.cardDataReadListener=function(t,n){return r._cardDataReadListener(e,t,n)},this.decisionRequiredListener=function(t,n){return r._decisionRequiredListener(e,t,n)},t.reader.once(PaymentDevice.Event.error,this.readCardErrorHandler),t.reader.once(PaymentDevice.Event.cardDataRead,this.cardDataReadListener),t.reader.once(PaymentDevice.Event.decisionRequired,this.decisionRequiredListener),void t.reader.startContactTransaction(this.context)):void e.next()}},{key:"_readCardErrorHandler",value:function(e,r){Log.error("Read card flow Error: '"+r.code+"' Device: "+this.context.card.reader.id),r&&r.code===PaymentDevice.errorCode.smartCardNotInSlot||e.abortFlow(r)}},{key:"_decisionRequiredListener",value:function(e,r,t){var n=this;return r?(Log.error("Failed to start ICC transaction: "+r),this.flow.abortFlow(new Error("Failed to start transaction on reader."))):void messageHelper.showSelectApplicationPrompt(this.context,e.data,t.apps,function(r,t){Log.debug(function(){return"Selected application "+t}),messageHelper.showProcessingMessage(n.context,e.data,function(){n.context.card.reader.terminal.selectApplication(r,function(r,t){r?(Log.error("Failed to select payment application with error "+r),e.abortFlow(new Error("Error selecting payment application"))):n._cardDataReadListener(e,null,t)})})})}},{key:"_cardDataReadListener",value:function(e,r,t){return Log.debug(function(){return"ICC "+t}),r?(Log.error("Failed to start ICC transaction: "+r),e.abortFlow(new Error("Failed to start transaction on reader."))):(Utils.extend(this.context.card,this.context.card.reader.parseCardData(this.context.card,t)),void(e.data.pinPresent?this.context.card.reader.display(PaymentDevice.Message.ProcessingWithPin,null,function(){e.next()}):e.next()))}},{key:"abortOrNext",value:function(e,r){var t=this.context.card;t.reader.removeListener(PaymentDevice.Event.error,e.abortFlow),t.reader.removeListener(PaymentDevice.Event.cardInserted,this.cardInsertedListener),t.reader.removeListener(PaymentDevice.Event.decisionRequired,this.decisionRequiredListener),e.nextOrAbort(r)}}]),r}(FlowStep);module.exports=ReadCardStep;


},{"../../common/l10n":8,"../messageHelper.js":15,"./FlowStep":19,"manticore":125,"manticore-log":123,"manticore-util":124,"retail-payment-device":179}],23:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,i=t,a=r;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,i);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(a)}var p=Object.getPrototypeOf(o);if(null===p)return;e=p,t=i,r=a,n=!0,c=p=void 0}},manticore=require("manticore"),Log=require("manticore-log")("flow.mtp.receipt"),l10n=require("../../common/l10n"),Currency=require("paypal-invoicing").Currency,ErrorCode=require("retail-payment-device").PaymentDevice.errorCode,Merchant=require("../../common/Merchant"),TransactionContext=require("../../transaction/TransactionContext"),FlowStep=require("./FlowStep"),ReceiptStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){var t=this,r=this.context.invoice,n=void 0,o=e.data.tx,i=e.data.error,a=Currency.getCurrency(r.currency);n=l10n(this.context.isRefund()?i?"Tx.RefundFailed":"Tx.RefundSuccessful":i&&i.code===ErrorCode.paymentCancelled?"Tx.CancelledByUser":i?"Tx.TransactionFailed":"Tx.TransactionSuccessful"),manticore.offerReceipt({invoice:r,title:l10n("Rcpt.Title",{amount:a.format(r.total)}),message:n,error:e.data.error,titleIcon:i?"ic_x_declined":"check_icon_green",maskedEmail:o&&o.payer&&o.payer.maskedEmail,maskedPhone:o&&o.payer&&o.payer.maskedPhone},function(n,i){if(i){Log.debug("Forward receipt to: "+i);var a=manticore.alert({showActivity:!0,title:l10n("Rcpt.Sending")},function(){}),c={invoiceId:r.payPalId,transactionType:t._transactionType(e)};i.indexOf("@")>0?c.email=i:c.phoneNumber=i,o&&o.payer&&o.payer.customerId&&(c.customerId=o.payer.customerId),o&&o.payer&&o.payer.receiptPreferenceToken&&(c.receiptPreferenceToken=o.payer.receiptPreferenceToken);var u=void 0,p=o&&(o.transactionNumber||o.transactionHandle)||e.data.transactionNumber;u=p?"payment/"+p+"/sendReceipt":"payment/sendReceipt",Log.debug(function(){return"SendReceipt "+JSON.stringify(c)}),Merchant.active.request({service:"retail",op:u,format:"json",method:"POST",debug:!0,headers:{"Content-Type":"application/json"},body:JSON.stringify(c)},function(t,r){a.dismiss(),e.next()})}else Log.debug("Email/SMS receipt forwarding not required. Skipping receipt step. Native response: "+i),e.next()})}},{key:"_transactionType",value:function(e){return e.data.error?e.data.error.code===ErrorCode.paymentCancelled?"VOID":"DECLINE":this.context.type===TransactionContext.Type.Refund?"REFUND":this.context.type===TransactionContext.Type.PartialRefund?"PARTIAL":"SALE"}}]),t}(FlowStep);module.exports=ReceiptStep;


},{"../../common/Merchant":4,"../../common/l10n":8,"../../transaction/TransactionContext":36,"./FlowStep":19,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],24:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_get=function(e,t,r){for(var o=!0;o;){var n=e,a=t,i=r;o=!1,null===n&&(n=Function.prototype);var c=Object.getOwnPropertyDescriptor(n,a);if(void 0!==c){if("value"in c)return c.value;var l=c.get;if(void 0===l)return;return l.call(i)}var s=Object.getPrototypeOf(n);if(null===s)return;e=s,t=a,r=i,o=!0,c=s=void 0}},Log=require("manticore-log")("flow.step.removeCard"),FlowStep=require("./FlowStep"),messageHelper=require("../messageHelper.js"),PaymentDevice=require("retail-payment-device").PaymentDevice,RemoveCardStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){this.context.card&&this.context.card.formFactor===PaymentDevice.FormFactor.Chip?(this.context.card.reader.once(PaymentDevice.Event.cardRemoved,function(){e.data.alert.dismiss(),delete e.data.alert,e.next()}),messageHelper.showRemoveCardMessage(this.context,e.data,function(t){e.data.alert=t})):e.next()}}]),t}(FlowStep);module.exports=RemoveCardStep;


},{"../messageHelper.js":15,"./FlowStep":19,"manticore-log":123,"retail-payment-device":179}],25:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,a=t,i=r;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,a);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(i)}var s=Object.getPrototypeOf(o);if(null===s)return;e=s,t=a,r=i,n=!0,c=s=void 0}},manticore=require("manticore"),Log=require("manticore-log")("flow.mtp.signature"),FlowStep=require("./FlowStep"),Currency=require("paypal-invoicing").Currency,l10n=require("../../common/l10n"),PaymentDevice=require("retail-payment-device").PaymentDevice,CardIssuer=PaymentDevice.CardIssuer,CardDataUtil=require("retail-payment-device").CardDataUtil,FormFactor=PaymentDevice.FormFactor,SignatureStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){var t=this,r=this;if(this.context.card.isSignatureRequired===!1)return Log.debug("Skipping signature step. Reason: Signature not required for this transaction"),e.next();if(this.context.emit("willPresentSignature"),e.data.error)return Log.debug("Skipping signature step. Reason: One/more of previous steps logged an error"),e.next();var n=this.context.card.formFactor===FormFactor.Chip?PaymentDevice.Message.SignatureForContact:PaymentDevice.Message.SignatureForContactless;this.context.card.reader.display(n,null,function(){var n={amount:Currency.format(t.context.invoice.currency,t.context.invoice.total),cardIssuer:t.context.card.cardIssuer&&t.context.card.cardIssuer!==CardIssuer.Unknown?CardDataUtil.getCardIssuerDisplayName(t.context.card.cardIssuer):"",lastFour:t.context.card.lastFourDigits},o={context:t.context,continueWithSignature:function(t){r.context.emit("didCompleteSignature",null),e.data.signature=t,e.next()},cancel:function(){var t=new Error("Failed to get signature");r.context.emit("didCompleteSignature",t),e.abort(t)},acquireSignature:function(){e.data.alert&&e.data.alert.dismiss(),manticore.collectSignature({done:l10n("Done"),footer:l10n("Sig.Footer"),title:l10n("Sig.Title",n),signHere:l10n("Sig.Here")},function(t,n){return r.context.emit("didCompleteSignature",t),t?e.abort(t):(e.data.signature=n,void e.next())})}};t.context._signatureCollector?t.context._signatureCollector(o):o.acquireSignature()})}}]),t}(FlowStep);module.exports=SignatureStep;


},{"../../common/l10n":8,"./FlowStep":19,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],26:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,i=t,a=n;r=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,i);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(a)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,t=i,n=a,r=!0,c=l=void 0}},manticore=require("manticore"),Log=require("manticore-log")("flow.mtp.updateinvoicepayment"),l10n=require("../../common/l10n"),InvoicePayment=require("paypal-invoicing").InvoicePayment,Invoice=require("paypal-invoicing").Invoice,moment=require("moment"),FlowStep=require("./FlowStep"),UpdateInvoicePaymentStep=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e}return _inherits(t,e),_createClass(t,[{key:"execute",value:function(e){if(!e.error){var t=this.context.invoice,n=new InvoicePayment;n.type="EXTERNAL",n.transactionID=e.data.tx.transactionNumber,n.transactionType="SALE",n.date=moment(),n.method="CREDIT_CARD",n.amount=t.total,n.currency=t.currency,t.payments?t.payments.push(n):t.payments=[n],t.status=Invoice.Status.PAID}e.next()}}]),t}(FlowStep);module.exports=UpdateInvoicePaymentStep;


},{"../../common/l10n":8,"./FlowStep":19,"manticore":125,"manticore-log":123,"moment":140,"paypal-invoicing":141}],27:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var i=e,o=t,a=r;n=!1,null===i&&(i=Function.prototype);var c=Object.getOwnPropertyDescriptor(i,o);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(a)}var l=Object.getPrototypeOf(i);if(null===l)return;e=l,t=o,r=a,n=!0,c=l=void 0}},manticore=require("manticore"),EventEmitter=require("events").EventEmitter,l10n=require("../common/l10n"),DeviceUpdate=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.isRequired=!0,this.device=e}return _inherits(t,e),_createClass(t,[{key:"offer",value:function(e){var t=this;return this.device.pendingUpdate&&this.device.pendingUpdate!==this?this.device.pendingUpdate.offer(e):void manticore.alert({title:l10n("SwUpgrade.Title"),message:l10n(this.isRequired?"SwUpgrade.Reqd":"SwUpgrade.Opt"),cancel:l10n("SwUpgrade.Buttons.Cancel"),buttons:[l10n("SwUpgrade.Buttons.Ok")]},function(r,n){return r.dismiss(),0===n?t.begin(!0,e):void e(new Error("Cancelled by user"),!1)})}},{key:"begin",value:function(e,t){throw new Error("Must be implemented in derived class.")}}]),t}(EventEmitter);module.exports=DeviceUpdate;


},{"../common/l10n":8,"events":117,"manticore":125}],28:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function getMagneprint(e,t){e.magneprint={status:t.slice(344,347).toString("hex"),length:t[348]},e.magneprint.length&&(e.magneprint.data=t.slice(349,349+e.magneprint.length).toString("hex"))}function getTracks(e,t){var r=0===(1&t[0]),n=0===(1&t[1]),a=0===(1&t[2]),i=t[3],o=t[4],c=t[5];r&&i&&(e.track1=t.slice(7,7+i).toString("hex")),n&&o&&(e.track2=t.slice(119,119+o).toString("hex")),a&&c&&(e.track3=t.slice(231,231+c).toString("hex"))}function magtekVersion1(e,t){e.counter=t.slice(493,500).toString("hex"),e.crypto={enabled:1===(1&t[501]),keyInjected:2===(2&t[501])},4&t[501]&&(e.crypto.keysExhausted=!0,Log.error("DUKPT keys exhausted on Magtek reader.")),e.ksn=t.slice(555,565).toString("hex")}function magtekVersion2(e,t){e.counter=t.slice(856,858).toString("hex"),e.crypto={enabled:4===(4&t[494]),keyInjected:2===(2&t[494])},1&t[494]&&(e.crypto.keysExhausted=!0,Log.error("DUKPT keys exhausted on Magtek reader.")),e.ksn=t.slice(495,505).toString("hex"),e.counter=t.slice(856,858).toString("hex");var r=t[505];r&&(e.track1masked=t.slice(508,508+r).toString("ascii")),r=t[506],r&&(e.track2masked=t.slice(620,620+r).toString("ascii")),r=t[507],r&&(e.track3masked=t.slice(732,732+r).toString("ascii"))}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var a=e,i=t,o=r;n=!1,null===a&&(a=Function.prototype);var c=Object.getOwnPropertyDescriptor(a,i);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(o)}var l=Object.getPrototypeOf(a);if(null===l)return;e=l,t=i,r=o,n=!0,c=l=void 0}},Log=require("manticore-log")("payment"),FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,MagneticCard=require("retail-payment-device").MagneticCard,MagneticReaderDevice=require("retail-payment-device").MagneticReaderDevice,MagtekRawUsbReaderDevice=function(e){function t(e,r){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r),this.manufacturer="Magtek"}return _inherits(t,e),_createClass(t,[{key:"received",value:function(e){try{var r=new Buffer(e,"base64");if(r.length<565)return Log.error("Invalid MagTek data length: "+r.length),null;var n=new MagneticCard;n.formFactor=FormFactor.MagneticCardSwipe,n.reader=this,getTracks(n,r),getMagneprint(n,r),14===this.productId||565===r.length?magtekVersion1(n,r):17!==this.productId&&887!==r.length||magtekVersion2(n,r),!this.serialNumber&&n.ksn&&(this.serialNumber=n.ksn.substring(0,14)),_get(Object.getPrototypeOf(t.prototype),"received",this).call(this,n)}catch(a){Log.error("Failed to parse Magtek card event: "+a.message+"\n"+a.stack)}}}]),t}(MagneticReaderDevice);module.exports=MagtekRawUsbReaderDevice;


}).call(this,require("buffer").Buffer)
},{"buffer":44,"manticore-log":123,"retail-payment-device":179}],29:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var a=e,i=t,o=r;n=!1,null===a&&(a=Function.prototype);var c=Object.getOwnPropertyDescriptor(a,i);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(o)}var u=Object.getPrototypeOf(a);if(null===u)return;e=u,t=i,r=o,n=!0,c=u=void 0}},manticore=require("manticore"),MiuraTerminal=require("miura-emv").Terminal,MiuraTags=require("miura-emv").Tags,MiuraCardStatus=require("miura-emv").CardStatus,Currency=require("paypal-invoicing").Currency,Tlv=require("tlvlib"),TlvTags=require("tlvlib").Tags,Flow=require("../common/flow"),RetailPaymentDevice=require("retail-payment-device"),EmvDevice=RetailPaymentDevice.EmvDevice,DecisionRequired=RetailPaymentDevice.DecisionRequired,PaymentDevice=RetailPaymentDevice.PaymentDevice,ErrorCode=PaymentDevice.errorCode,PinEvent=RetailPaymentDevice.PinEvent,Card=RetailPaymentDevice.Card,CardDataUtil=RetailPaymentDevice.CardDataUtil,ConnectionFlow=require("./miura/ConnectionFlow"),Merchant=require("../common/Merchant"),TransactionContext=require("../transaction/TransactionContext"),Log=require("manticore-log")("miura"),l10n=require("../common/l10n"),FormFactor=RetailPaymentDevice.PaymentDevice.FormFactor,swipeLastFourRegexMatcher=void 0,MiuraDevice=function(e){function t(e,r,n){var a=this;_classCallCheck(this,t),Log.debug("Starting Miura device."),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r),this.manufacturer="Miura",this.terminal=new MiuraTerminal(function(e,t){return a["native"].send(e,t)},this),this.isUsb=this.terminal.isUsb=n,this.isUsb&&(this.maxSingleSend=5e3),this.terminal.on(MiuraTerminal.Event.deviceEvent,function(e){return a._deviceEvent(e)}),this.terminal.on(MiuraTerminal.Event.cardPresented,function(e){e.reader=a,a.emit(PaymentDevice.Event.cardPresented,e)}),this.terminal.on(MiuraTerminal.Event.cardRemoved,function(){return a.emit(PaymentDevice.Event.cardRemoved)}),this.terminal.on(MiuraTerminal.Event.error,function(e,t){return a.emit(PaymentDevice.Event.error,e,t,a)}),this.model="M010"}return _inherits(t,e),_createClass(t,[{key:"connect",value:function(e){var t=this;return this["native"].isConnected()?(Log.debug(function(){return"Connect called, but "+t.id+" is already connected."}),e?e():null):(Log.debug(function(){return"Connecting to Miura device "+t.id}),void this["native"].connect(function(r){return r?(Log.warn("Connection failed for Miura device "+t.id+": "+r),e?e(r):null):(Log.info("Successfully connected to Miura device "+t.id),t.terminal.didConnect(),void(t.rawConnect?(Log.debug("Bypassing normal connection sequence."),t.ready(),e&&e()):new ConnectionFlow(t).start(e)))}))}},{key:"disconnect",value:function(e){var t=this;this.isConnected()?this["native"].disconnect(function(r){r?Log.error("Disconnect failed with error: "+r):(Log.info("Successfully disconnected from "+t.id),t.onDisconnected()),e&&e(r)}):e&&e(null)}},{key:"activate",value:function(e,r){var n=this;_get(Object.getPrototypeOf(t.prototype),"activate",this).call(this,e),this.terminal.registerForCardEvents(!0,function(t){return t?void Log.error("Failed to register for Miura card events: "+t.message):void n.terminal.registerForKeyboardEvents(!0,function(t){if(t&&Log.error("Failed to register for Miura keyboard events: "+t.message),r.formFactors.has(FormFactor.EmvCertifiedContactless))return void n._startContactlessTx(e);var a=void 0;if(r.formFactors.has(FormFactor.MagneticCardSwipe)&&r.formFactors.has(FormFactor.Chip)?a=PaymentDevice.Message.ReadyForInsertAndSwipePayment:r.formFactors.has(FormFactor.MagneticCardSwipe)?a=PaymentDevice.Message.ReadyForSwipePayment:r.formFactors.has(FormFactor.Chip)&&(a=PaymentDevice.Message.ReadyForInsertPayment),a){var i=e.invoice;n.display(a,{amount:Currency.format(i.currency,i.total)},function(e){e&&Log.error("Unable to push message "+a+" to terminal")})}})})}},{key:"_startContactlessTx",value:function(e){var t=this,r=e.invoice;this.transactionActive=!0;var n=e.type===TransactionContext.Type.Sale?0:20;this.terminal.startContactlessTransaction(0,n,Currency.toCents(r.currency,r.total),Currency.getCurrency(r.currency).iso4217,function(r,n){if(t.transactionActive=!1,r&&(e.type===TransactionContext.Type.Sale||e.type===TransactionContext.Type.Refund&&r.code!==ErrorCode.nfcNotAllowed))return t.emit(PaymentDevice.Event.error,r,FormFactor.EmvCertifiedContactless,t);var a=new MiuraCardStatus(n).getPresentedCard(t);t.transactionActive=!0,t.emit(PaymentDevice.Event.cardPresented,a)})}},{key:"deactivate",value:function(e,r,n){var a=this;Log.info(function(){return"Deactivating "+a.id+". shouldDisconnect: "+r+" abortCommandNeeded: "+a.transactionActive}),this.isConnected()?this.transactionActive?this.terminal.abortTransaction(function(){return _get(Object.getPrototypeOf(t.prototype),"deactivate",a).call(a,e,r,n)}):_get(Object.getPrototypeOf(t.prototype),"deactivate",this).call(this,e,r,function(){a.emit(PaymentDevice.Event.cancelled,null,a),n()}):n&&n()}},{key:"abortTransaction",value:function(e){this.transactionActive?this.terminal.abortTransaction(function(){e&&e()}):e&&e()}},{key:"completeTransaction",value:function(e,t){var r=this;if(this.isConnected())this.terminal.continueTransaction(e,function(e,n){r.transactionActive=!1,t(e,n)});else{var n=new Error;n.code=ErrorCode.deviceNotConnected,t&&t(n)}}},{key:"clearTransaction",value:function(e){this.isConnected()&&this.terminal?this.terminal.softReset(e):e&&e()}},{key:"received",value:function(e){this.terminal.received(e)}},{key:"getBatteryInfo",value:function(e){this.terminal.getBatteryLevel(function(t,r){Log[t?"error":"debug"](function(){return"Received battery info "+r+". Error: "+(t?t.message:null)}),e&&e(t,r)})}},{key:"display",value:function(e,t,r){if(this.isConnected())this.terminal.display(e,t,r);else{var n=new Error;n.code=ErrorCode.deviceNotConnected,r&&r(n)}}},{key:"updateRequired",value:function(e){_get(Object.getPrototypeOf(t.prototype),"updateRequired",this).call(this,e)}},{key:"startContactTransaction",value:function(e){var t=this,r=MiuraTerminal.TransactionType.SALE;e.type===TransactionContext.Type.Refund&&(r=MiuraTerminal.TransactionType.REFUND),this.terminal.startICCTransaction(0,r,Currency.toCents(e.invoice.currency,e.invoice.total).toString(),Currency.getCurrency(e.invoice.currency).iso4217,function(e,r){if(e)return Log.error("Failed to start ICC transaction. Error: "+e),t.emit(PaymentDevice.Event.error,e,FormFactor.Chip,r);if(r instanceof DecisionRequired)return t.emit(PaymentDevice.Event.decisionRequired,e,r);if(228===r.apdu.template)return t.transactionActive=!0,t.emit(PaymentDevice.Event.cardDataRead,e,r);Log.warn("Contact tx Response from device was not handled "+r);var n=new Error;n.code=ErrorCode.badEmvData,t.emit(PaymentDevice.Event.error,n,FormFactor.Chip,r)})}},{key:"parseCardData",value:function(e,r){var n={};try{n={lastFourDigits:t._lastFourDigits(e,r),cardIssuer:t._getCardIssuer(e,r),isSignatureRequired:t._isSignatureCvmRequired(e,r),cardholderName:t._getCardHolderName(e,r),emvData:r}}catch(a){Log.error("Unable to parse card metadata: "+a+" from : "+r)}return n}},{key:"retrieveVersionInfo",value:function(e){var t=this;this.terminal.softReset(function(r,n){if(r)return e(r);var a=n.tlvs&&n.tlvs.find(Tlv.Tags.InterfaceDeviceSerialNumber);if(!a)return e(new Error("Failed to get serial number from "+t.id));t.serialNumber=a.parse();var i=t.serialNumber.substring(0,3);"130"!==i&&"030"!==i||(t.model="M000");var o=!0,c=!1,s=void 0;try{for(var u,l=n.tlvs.values[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var v=u.value;v.tagNumber===MiuraTags.MiuraSoftwareInformation.number&&t._readConfigPair(v)}}catch(d){c=!0,s=d}finally{try{!o&&l["return"]&&l["return"]()}finally{if(c)throw s}}t.pre76=t.os&&(t.os.majorVer<7||7===t.os.majorVer&&t.os.minorVer<=5),Log.info(t.id+" Serial #: "+t.serialNumber+" OS: "+(t.os&&t.os.id+", "+t.os.ver)+" MPI: "+(t.os&&t.mpi.id+", "+t.mpi.ver)+" pre76: "+t.pre76),e(null)})}},{key:"_readConfigPair",value:function(e){var r,n=!0,a=!0,i=!1,o=void 0;try{for(var c,s=e.parse().values[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var u=c.value;u.tagNumber===MiuraTags.MiuraIdentifier.number?r=u.parse():u.tagNumber===MiuraTags.MiuraVersionInformation.number&&(n=u.parse())}}catch(l){i=!0,o=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(i)throw o}}r.indexOf("-MPI")>=0?this.mpi=t._parseVersionInfo(r,n):r.indexOf("OS")>=0&&(this.os=t._parseVersionInfo(r,n))}},{key:"_deviceEvent",value:function(e){if(this.emit("deviceEvent",e),e instanceof MiuraTerminal.EventType.TerminalStatus&&e.changeType===MiuraTerminal.EventType.TerminalStatus.Constants.PinEntryStateChange){var t=new PinEvent;t.digits=e.pinDigits,t.complete=e.pinComplete,t.correct=e.pinCorrect,t.isLastAttempt=e.lastPinAttempt,t.failureReason=e.pinFailureReason,this.emit("pinEvent",t)}27===e.keyCode&&(Log.debug("X button on terminal was tapped. Will try to cancel an ongoing payment"),this.emit(PaymentDevice.Event.cancelRequested))}},{key:"errorOrFailure",value:function(e,t){return e||t.apdu.isSuccess?e:new Error("Miura response indicates failure: 0x"+t.apdu.sw1.toString(16)+" 0x"+t.apdu.sw2.toString(16))}},{key:"formFactors",get:function(){return this.terminal.formFactors}},{key:"cardStatus",get:function(){return this.terminal.cardStatus}},{key:"_isKeyInjectionRequired",get:function(){return this.forceRki?!0:Merchant.active&&"AU"===Merchant.active.country?!(this.p2pe.pin&&this.p2pe.sred):!(this.p2pe.pin||this.p2pe.sred)}}],[{key:"_lastFourDigits",value:function(e,t){var r=void 0,n=t.apdu.data.toString("hex");if(e.formFactor===FormFactor.MagneticCardSwipe&&(swipeLastFourRegexMatcher||(swipeLastFourRegexMatcher=/2a(?!.*2a)(.*)(?=3d)/),r=swipeLastFourRegexMatcher.exec(n),r&&r[1]))return new Buffer(r[1],"hex").toString("utf8");if(e.formFactor===FormFactor.Chip||e.formFactor===FormFactor.EmvCertifiedContactless){var a=this._getLastFourFormEMVChipAndEMVContactlessBlob(t);if(a)return Log.debug("Got last four digits of card as "+a),a}Log.warn("Unable to parse last four digits (formFactor: "+e.formFactor+") from emvData: "+n)}},{key:"_getLastFourFormEMVChipAndEMVContactlessBlob",value:function(e){var t=e.tlvs.find(MiuraTags.MiuraMaskedPan)||e.tlvs.find(MiuraTags.MiuraMaskedICCTrack2)||e.tlvs.find(MiuraTags.MiuraMaskedTrack2)||e.tlvs.find(MiuraTags.MiuraMaskedContactlessTrack2);if(!t)return void Log.warn("Unable to find the any TLV corresponding to masked pan");var r=t.bytes.toString("hex");if(!r)return void Log.warn("lastFourTLV: "+t);for(var n="ffff",a=r.indexOf(n),i=r.substring(a+n.length);i.length>0&&"f"===i.charAt(0);)i=i.substring(1);return i.substring(0,4)}},{key:"_getCardHolderName",value:function(e,t){if(e.formFactor===FormFactor.MagneticCardSwipe)return null;if(e.formFactor===FormFactor.Chip||e.formFactor===FormFactor.EmvCertifiedContactless){var r=t.tlvs.find(TlvTags.CardholderName);return r?r.parse():null}}},{key:"_getCardIssuer",value:function(e,t){if(e.formFactor===FormFactor.MagneticCardSwipe){var r=t.apdu.data.toString("hex"),n=r.toString().lastIndexOf("3b"),a=r.lastIndexOf("2a");if(n>a&&(n=r.indexOf("3b")),0>a)return null;r=r.substring(n+2,a);var i=new Buffer(r,"hex").toString("utf8");return CardDataUtil.getCardIssuerFromCardNumber(i)}if(e.formFactor===FormFactor.Chip||e.formFactor===FormFactor.EmvCertifiedContactless){var o=t.tlvs.find(TlvTags.ApplicationLabel),c=o?o.parse():null;return CardDataUtil.getCardIssuerFromEmvAppLabel(c)}}},{key:"_isSignatureCvmRequired",value:function(e,t){var r,n=t.tlvs.find(MiuraTags.MiuraCardholderVerificationStatus);if(Log.debug(function(){return"Signature data from card: "+(n?n.parse():null)+"(cvmStatus)"}),!n||!(r=n.parse()))return!0;if(r=r[0],e.formFactor===FormFactor.Chip){if(1===r||2===r||4===r||31===r)return!1}else if(0===r||2===r||3===r)return!1;return!0}},{key:"_parseVersionInfo",value:function(e,t){var r=t&&t.match(/(\d+)-(\d+)/),n=r&&parseInt(r[1]),a=r&&parseInt(r[2]);return{id:e,ver:t,majorVer:n,minorVer:a}}}]),t}(EmvDevice);module.exports=MiuraDevice;


}).call(this,require("buffer").Buffer)
},{"../common/Merchant":4,"../common/flow":7,"../common/l10n":8,"../transaction/TransactionContext":36,"./miura/ConnectionFlow":32,"buffer":44,"manticore":125,"manticore-log":123,"miura-emv":126,"paypal-invoicing":141,"retail-payment-device":179,"tlvlib":189}],30:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function wrapCallback(e){return{accept:function(){e&&e()},reject:function(n){e&&e(new Error(n))}}}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),MiuraDevice=require("../paymentDevice/MiuraDevice"),DeviceOperationResultHandler=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"accept",value:function(){throw new Error("Marker class should not be used.")}},{key:"reject",value:function(e){throw new Error("Marker class should not be used.")}}]),e}(),VirtualPaymentDevice=function(){function e(n,t,i,c,a,r){if(_classCallCheck(this,e),"Miura"!==n)throw new Error("Unknown payment deviceType "+n+". Currently only Miura is supported.");this.device=new MiuraDevice(t,this),this._nativeConnect=i,this._nativeSend=c,this.isConnected=a,this._nativeDisconnect=r}return _createClass(e,[{key:"attach",value:function(){MiuraDevice.discovered(this.device),this.device.connect()}},{key:"detach",value:function(){this.device.removed()}},{key:"send",value:function(e,n){"string"==typeof e?this._nativeSend(e,0,3*e.length/4,wrapCallback(n)):this._nativeSend(e.data,e.offset,e.len,wrapCallback(n))}},{key:"disconnect",value:function(e){this._nativeDisconnect(wrapCallback(e))}},{key:"connect",value:function(e){this._nativeConnect(wrapCallback(e))}},{key:"received",value:function(e){this.device.received(e)}},{key:"onDisconnected",value:function(e){this.device.onDisconnected(new Error(e))}}]),e}();module.exports=VirtualPaymentDevice;


},{"../paymentDevice/MiuraDevice":29}],31:[function(require,module,exports){
"use strict";module.exports={MiuraDevice:require("./MiuraDevice"),MagtekRawUsbReaderDevice:require("./MagtekRawUsbReaderDevice"),VirtualPaymentDevice:require("./VirtualPaymentDevice")};


},{"./MagtekRawUsbReaderDevice":28,"./MiuraDevice":29,"./VirtualPaymentDevice":30}],32:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),manticore=require("manticore"),Flow=require("../../common/flow"),MiuraTags=require("miura-emv").Tags,PaymentDevice=require("retail-payment-device").PaymentDevice,SwUpdate=require("./MiuraSoftwareUpdate"),Merchant=require("../../common/Merchant"),Log=require("manticore-log")("device.miura"),ConnectionFlow=function(){function e(t){_classCallCheck(this,e),this.device=t}return _createClass(e,[{key:"start",value:function(e){var t=this,i=new Flow(this,this._retrieveVersionInfo,this._displayReaderConnectingMessage,this._getDeviceCapabilities,this._getDeviceConfig,this._queryBackendForSWModules,this._getP2PEStatus,this._getBatteryLevel);i.name="Miura Connection",i.on("completed",function(){return t._readerConnected(e)}),i.on("aborted",function(t){e&&e(t.error)}),i.start()}},{key:"_retrieveVersionInfo",value:function(e){this.device.retrieveVersionInfo(function(t){e.nextOrAbort(t)})}},{key:"_displayReaderConnectingMessage",value:function(e){this.device.display(PaymentDevice.Message.Connecting,null,function(){return e.next()})}},{key:"_getDeviceCapabilities",value:function(e){var t=this;this.device.terminal.Config.getDeviceCapabilities(function(i,n){n&&n.caps&&(t.device.capabilities=n.caps,Log.debug(function(){return"Device caps: "+JSON.stringify(n.caps,null,"	")})),e.nextOrAbort(i)})}},{key:"_getDeviceConfig",value:function(e){var t=this;this.device.terminal.Config.getConfiguration(function(i,n){i||n.response.apdu.isSuccess?n&&(t.device.swInfo=n.caps,Log.debug(function(){return"Software Info: "+JSON.stringify(t.device.swInfo,null,"	")})):i=new Error("Failed to get terminal configuration."),e.nextOrAbort(i)})}},{key:"_queryBackendForSWModules",value:function(e){this.exSerial===this.device.serialNumber&&this.serverSwInfo||(this.exSerial=this.device.serialNumber,this._fetchSWInfoFromServer(e)),e.next()}},{key:"_getP2PEStatus",value:function(e){var t=this;this.device.terminal.Config.getP2PEStatus(function(i,n){if(i)return e.abort(i);var r=n.apdu.tlvs.find(MiuraTags.MiuraP2PEStatus);return r?(r=r.bytes[0],128&r?t.device.p2pe={error:t._p2peError(r)}:t.device.p2pe={init:!!(1&r),pin:!!(2&r),sred:!!(4&r)},e.data.finishedP2PE=!0,e.data.pendedUpdateInstruction&&t._checkP2PEWithUpdate(e.data.pendedUpdateInstruction),void e.next()):e.abortFlow(new Error("Unable to get encryption status for reader."))})}},{key:"_getBatteryLevel",value:function(e){var t=this;this.device.getBatteryInfo(function(i,n){i||(t.device.batteryStatus=n),e.nextOrAbort(i)})}},{key:"_fetchSWInfoFromServer",value:function(e){var t=this;if(!Merchant.active)return Log.debug(function(){return t.device.id+" Will perform software update check after Merchant initialize"}),void Merchant.events.once("initialized",function(i){return i?Log.warn("Will not check for SW Update for "+t.device.id+" as merchant initialize failed with error: "+i):(Log.debug("Checking software update post Merchant initialization"),void t._fetchSWInfoFromServer(e))});var i=JSON.stringify(this._generateUpdateRequest(this.device));manticore.http({url:this._getSoftwareUpdateUrl(Merchant.active.environment,"m010"),method:"POST",headers:{"Content-Type":"application/json"},body:i,format:"json"},function(i,n){return t.serverSwInfo=n,i||!n&&!n.body?(Log.warn("Could not get update instructions for "+t.device.id),void(n&&n.body&&Log.warn(JSON.stringify(n.body,null,"	")))):e.data.finishedP2PE?304===n.statusCode?Log.debug(t.device.id+" Software update not needed"):void t._checkP2PEWithUpdate(n.body.phases):(Log.debug("Pending update instruction until P2PE is complete."),void(e.data.pendedUpdateInstruction=n.body&&n.body.phases))})}},{key:"_checkP2PEWithUpdate",value:function(e){Log.debug("Checking P2PE with update instructions"),SwUpdate.needsUpdate(this.device,e)&&(this.device.updates=e,SwUpdate.fetchFiles(this.device,function(e){e||Log.debug("Fetched all software update files.")}),this.updateRequired=!0,this._notifyReaderUpdateRequired())}},{key:"_notifyReaderUpdateRequired",value:function(){Log.debug("notifying reader status");var e=this.device;(e.updates||e._isKeyInjectionRequired)&&(Log.info(e.id+" needs update. Updates(Count: "+(e.updates?e.updates.length:0)+") "+JSON.stringify(e.updates)+" KeyInjectionRequired: "+e._isKeyInjectionRequired),e.updateRequired(new SwUpdate(this.device)))}},{key:"_readerConnected",value:function(e){Log.debug("Completed connection sequence.");var t=this.device,i=this.updateRequired?PaymentDevice.Message.SoftwareUpdateRequired:PaymentDevice.Message.Ready;return t.display(i,null,function(){return t.ready(),e&&e()})}},{key:"_generateUpdateRequest",value:function(e){var t=[{name:"Miura_OS",version:e.forceOsUpdate?"0.0":e.os.ver},{name:"Miura_MPI",version:e.forceMpiUpdate?"0.0":e.mpi.ver}];for(var i in e.swInfo){var n=e.forceConfigUpdate?"0.0":e.swInfo[i];t.push({name:i,version:n})}return t}},{key:"_p2peError",value:function(e){switch(e){case 129:return"Root Certificate Error";case 130:return"Product Certificate Error";case 131:return"Terminal Certificate Error";case 132:return"Key Signing Key Error";case 133:return"Internal Error, Contact PayPal";default:return"Unknown Error ("+e+")"}}},{key:"_getSoftwareUpdateUrl",value:function(e,t){var i=void 0,n=void 0,r="https";return"live"===e?i="api.paypal.com":"sandbox"===e?i="api.sandbox.paypal.com":(i="pphstageexternal-vip.ext.external.paypalc3.com/proxy/retaildevicenodeweb9061/443",r="http",n="&variant=dev"),r+"://"+i+"/retail/hereretaildevice/US/miura/"+t+"/configuration?_c="+Date.now()+(n||"")}}]),e}();module.exports=ConnectionFlow;


},{"../../common/Merchant":4,"../../common/flow":7,"./MiuraSoftwareUpdate":33,"manticore":125,"manticore-log":123,"miura-emv":126,"retail-payment-device":179}],33:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function pushModules(e,t){if(e){var i=!0,n=!1,r=void 0;try{for(var o,a=t[Symbol.iterator]();!(i=(o=a.next()).done);i=!0){var s=o.value;e.push([s.url,s.name])}}catch(u){n=!0,r=u}finally{try{!i&&a["return"]&&a["return"]()}finally{if(n)throw r}}}}function miuraLogs(e){var t=require("manticore-log")("miura");e&&switchedOff?(switchedOff=!1,lastMiuraLogState?t.Config.level=lastMiuraLogState:delete t.Config.level,delete Log.Config.level,Log.debug("Re-enabled logs.")):e||switchedOff||(Log.debug("Squelching Miura debug logs."),lastMiuraLogState=t.Config.level,switchedOff=!0,t.Config.level="INFO",Log.Config.level="DEBUG")}function getOne(e,t,i,n){var r=t+":"+e;manticore.getItem(r,RetailSDKUtil.StorageType.Blob,function(o,a){if(a)return manticore.setTimeout(function(){i(null,a)},0);if(Log.debug(function(){return"Fetching terminal update file "+e}),!n){if(isFetching[r])return Log.debug(function(){return"Waiting for existing fetch of "+e}),isFetching[r].push(i);isFetching[r]=[i]}manticore.http({url:e,format:"binary"},function(o,a){if(Log.debug("Done with "+e+": "+(o?"error":"ok")),!o&&e.indexOf("MPI-Dynamic.cfg")>0&&fixMpiDynamic(a),o){if(2>n)return n=n||0,Log.debug(function(){return"Fetch failed for "+e+". Starting retry #{retryCount+1}"}),getOne(e,t,i,(n||0)+1)}else manticore.setItem(r,RetailSDKUtil.StorageType.Blob,a.body,null);var s=!0,u=!1,l=void 0;try{for(var c,d=isFetching[r][Symbol.iterator]();!(s=(c=d.next()).done);s=!0){var f=c.value;f(o,a)}}catch(o){u=!0,l=o}finally{try{!s&&d["return"]&&d["return"]()}finally{if(u)throw l}}delete isFetching[r]})})}function chunkItOut(e,t,i,n,r){n||(n=(new Date).getTime()),i=i||0;var o=3*i/4;if(e.file.length-i>FILE_CHUNK_SIZE){var a=e.file.substring(i,i+FILE_CHUNK_SIZE);Log.debug(function(){return"Pushing chunk of file: "+e.name+" "+3*FILE_CHUNK_SIZE/4+"@"+o+" of "+3*e.file.length/4}),e.device.terminal.Config.streamBinary(a,o,TERMINAL_STREAM_TIMEOUT,!1,function(a,s){return a||!s.apdu.isSuccess?r?(Log.error("Aborting file send early."),s&&Log.warn(s.toString()),t(a,s)):(Log.warn("Failed to push a chunk of file "+e.name+". Will retry. Response: "+s),manticore.setTimeout(function(){return chunkItOut(e,t,i,o,n,!0)},500)):void e.device.display(Message.SoftwareUpdateProgress,{stage:e.message,progress:parseInt(100*(e.done+i+FILE_CHUNK_SIZE)/e.total)},function(){return chunkItOut(e,t,i+FILE_CHUNK_SIZE,n)})})}else{var a=e.file.substring(i);Log.debug(function(){return"Completing transfer of "+e.name}),e.device.terminal.Config.streamBinary(a,o,TERMINAL_STREAM_TIMEOUT,!0,t)}}function fixMpiDynamic(e){var t=new Buffer(e.body,"base64").toString();t.indexOf("[USB]")||(t="[USB]\n	default = serial\n"+t,e.body=new Buffer(t).toString("base64"))}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_get=function(e,t,i){for(var n=!0;n;){var r=e,o=t,a=i;n=!1,null===r&&(r=Function.prototype);var s=Object.getOwnPropertyDescriptor(r,o);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(a)}var l=Object.getPrototypeOf(r);if(null===l)return;e=l,t=o,i=a,n=!0,s=l=void 0}},manticore=require("manticore"),Log=require("manticore-log")("miura.update"),l10n=require("../../common/l10n"),Flow=require("../../common/flow"),RetailSDKUtil=require("../../common/RetailSDKUtil"),Merchant=require("../../common/Merchant"),DeviceUpdate=require("../DeviceUpdate"),Message=require("retail-payment-device").PaymentDevice.Message,async=require("async"),isFetching={},FILE_CHUNK_SIZE=131072,IKSN_BUFFER=new Buffer("IKSN: "),TERMINAL_STREAM_TIMEOUT=255,TERMINAL_CONNECTION_RETRY_LIMIT=20,TERMINAL_CONNECTION_RETRY_TIMEOUT=2e4,TERMINAL_CONNECTION_DEFAULT_RETRY_TIMEOUT=2500,MANTICORE_DEFAULT_SET_TIMEOUT=5e3;if(FILE_CHUNK_SIZE%4)throw new Error("FILE_CHUNK_SIZE MUST BE DIVISIBLE BY 4!!!");var MiuraSoftwareUpdate=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e)}return _inherits(t,e),_createClass(t,[{key:"setupFlows",value:function(){var e=this;this.files={};var t=this.computeSteps();this.flow=new Flow(this,t),this.flow.name="Software Update",this.flow.on("completed",function(){e._closeAlert(),e.device.isUpdating=!1,e.device.pendingUpdate.isRequired=!1,e.emit("completed"),e.emit("ended",null,!0),e.device.isReady||e.device.ready()}),this.flow.on("aborted",function(t){Log.error("Software update failed with Error: "+t.error),e.device.display(Message.SoftwareUpdateFailed,null,function(){e._alert=manticore.alert({title:l10n("SwUpgrade.Failed.Title"),message:l10n("SwUpgrade.Failed.Msg"),buttons:[l10n("SwUpgrade.Buttons.Retry"),l10n("SwUpgrade.Buttons.Cancel")]},function(i,n){return 0===n?e.begin(e._showUi):(e._closeAlert(),e.device.isUpdating=!1,e.emit("failed",t.error),void e.emit("ended",t.error,!1))})})})}},{key:"_closeAlert",value:function(){this._alert&&(this._alert.dismiss(),delete this._alert)}},{key:"computeSteps",value:function(){var e=[];return this.device._isKeyInjectionRequired&&(Log.debug("Should perform RKI."),e.push(this.p2peFlow)),this.device.updates&&(Log.debug("Should perform module updates."),e.push(this.updateFlow)),e}},{key:"begin",value:function(e,t){var i=this;Log.debug("Beginning software update."),this.device.isUpdating=!0,e&&(this._showUi=!0,this._alert=manticore.alert({title:l10n("Miura.Title"),message:l10n(this.device.isUsb?"Miura.UsbMsg":"Miura.BtMsg"),showActivity:!0},function(e,t){})),this.setupFlows(),this.flow.start(),this.once("ended",function(e,n){Log[e?"error":"info"]("Software update completed on "+i.device.id+". Was updated: "+n+". "+(e?"Error: "+e:"")),t(e,n)})}},{key:"p2peFlow",value:function(e){var t=new Flow(this,this.showP2PEMessage,this.initializeP2PE,this.getP2PEMaterial,this.showP2PEFetchMessage,this.fetchKeys,this.copyKeys,this.importKeys,this.showKeysDone,this.checkFurtherFlow);t.name="P2PE Setup",t.on("completed",function(){return e.next()}),t.on("aborted",function(t){return e.abortFlow(t.error)}),t.start()}},{key:"updateFlow",value:function(e){var t=new Flow(this,this.gatherFiles,this.updateOS,this.waitForRestart,this.updateMPI,this.waitForRestart,this.updateConfig,this.waitForRestart);t.name="Software Update",t.on("completed",function(){return e.next()}),t.on("aborted",function(t){return e.abortFlow(t.error)}),t.start()}},{key:"gatherFiles",value:function(e){e.data.updates={};var i=!0,n=!1,r=void 0;try{for(var o,a=this.device.updates[Symbol.iterator]();!(i=(o=a.next()).done);i=!0){var s=o.value;e.data.updates[s.name]=s}}catch(u){n=!0,r=u}finally{try{!i&&a["return"]&&a["return"]()}finally{if(n)throw r}}t.fetchFiles(this.device,function(t){Log.debug("Ready for software update."),e.nextOrAbort(t)})}},{key:"checkFurtherFlow",value:function(e){e.next()}},{key:"sizeFiles",value:function(e,t){var i=this,n=0;async.each(e,function(e,t){var r=e.url,o=e.name;i.getFetchedFile(r,o,function(e,i){i&&(n+=i.length),t()})},function(){return t(n)})}},{key:"writeFiles",value:function(e,t,i){var n=this;if(0===e.length)return Log.error("Attempting to write 0 files to device."),i();Log.info("Writing "+e.length+" software update files to "+this.device.id);var r=0,o=0,a=0,s=!1,u=function l(){var u=e[r].url,c=e[r].name;n.getFetchedFile(u,c,function(d,f){var g=c;g||(g=u.split("/"),g=g[g.length-1]),n.device.terminal.Config.selectFile(g,!0,function(u,c){return(u=n.device.errorOrFailure(u,c))?(Log.error("selectFile command returned an error : "+u),miuraLogs(!0),i(u)):(miuraLogs(!1),void chunkItOut({device:n.device,file:f,name:g,total:o,done:a,message:t},function(t,o){if(t=n.device.errorOrFailure(t,o)){if(Log.error("Failed to write "+e[r].url+" to "+g+": "+t.message+". "+(s?"Will not retry":"Will retry")),s)return miuraLogs(!0),i(t);l()}else s=!1,a+=f.length,++r>=e.length?(miuraLogs(!0),i()):l()}))})})};this.sizeFiles(e,function(e){o=e,u()})}},{key:"updateOS",value:function(e){var t=e.data.updates.Miura_OS;return t||this.device.forceOsUpdate?void this.updateModules(e,t.steps,"OS"):(Log.debug("OS update not needed."),e.next())}},{key:"updateMPI",value:function(e){var t=e.data.updates.Miura_MPI;return t||this.device.forceMpiUpdate?void this.updateModules(e,t.steps,"MPI"):(Log.debug("MPI update not needed."),e.next())}},{key:"updateConfig",value:function(e){var t=e.data.updates.Miura_CONFIG;if(!t||!t.steps)return Log.debug("Config update not needed."),e.next();var i=[],n=!0,r=!1,o=void 0;try{for(var a,s=t.steps[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var u=a.value;i.push(u)}}catch(l){r=!0,o=l}finally{try{!n&&s["return"]&&s["return"]()}finally{if(r)throw o}}return 0===i.length?e.next():(this.device.isUsb&&this.device.mpi&&(this.device.mpi.majorVer<1||1===this.device.mpi.majorVer&&this.device.mpi.minorVer<=34)&&(Log.info("Reader version that requires device plug/unplug detected. "+this.device.mpi.ver+". ShowUI : "+this._showUi),this.promptForUnplug=!0),void this.updateModules(e,i,"Config"))}},{key:"waitForUsbUnplugAndPlug",value:function(e){var t=this;return this._showUi?void(this._alert=manticore.alert({title:l10n("Miura.Title"),message:l10n("Miura.UsbUnplug"),buttons:[l10n("Ok")]},function(){t._alert=manticore.alert({title:l10n("Miura.Title"),message:l10n("Miura.UsbWait")},function(){}),manticore.setTimeout(function(){t._alert=manticore.alert({title:l10n("Miura.Title"),message:l10n("Miura.UsbPlug")},function(){}),e()},MANTICORE_DEFAULT_SET_TIMEOUT)})):(Log.info(this.device.id+" Waiting 20 seconds for USB unplug/replug..."),this.emit("reconnectReader",TERMINAL_CONNECTION_RETRY_TIMEOUT),manticore.setTimeout(e,TERMINAL_CONNECTION_RETRY_TIMEOUT))}},{key:"updateModules",value:function(e,t,i){var n=this;this.device.display(Message.SoftwareUpdateProgress,{stage:i,progress:"0"},function(){n.writeFiles(t,i,function(t){return t?e.abortFlow(t):void n.resetReader(e)})})}},{key:"resetReader",value:function(e){var t=this;Log.debug("Hard Resetting the terminal."),this.device.terminal.hardReset(function(){Log.debug("Reset complete."),e.data.awaitReset=!0,t.device.disconnect(function(){Log.debug("Reader disconnected"),e.next()})})}},{key:"waitForRestart",value:function(e){var t=this;if(!e.data.awaitReset)return e.next();var i=function(){Log.debug("Waiting for reconnect."),manticore.setTimeout(function(){t.waitForConnect(TERMINAL_CONNECTION_RETRY_LIMIT,function(i){t.device.retrieveVersionInfo(function(){e.nextOrAbort(i)})},TERMINAL_CONNECTION_RETRY_TIMEOUT)},MANTICORE_DEFAULT_SET_TIMEOUT),delete e.data.awaitReset};return this.promptForUnplug?void manticore.setTimeout(function(){t.waitForUsbUnplugAndPlug(function(){delete t.promptForUnplug,i()})},MANTICORE_DEFAULT_SET_TIMEOUT):i()}},{key:"waitForConnect",value:function(e,t,i){Log.debug("waitForConnect with retry count "+e),this.device.needsRestart=!0,this.retryConnection(e,t,i),this.fetchBatteryInfo(t)}},{key:"fetchBatteryInfo",value:function(e){var t=this;this.device.getBatteryInfo(function(i,n){Log.debug("Received battery info"),!i&&t.device.needsRestart&&(Log.info(t.device.id+" was successfully connected after restart"),miuraLogs(!0),t.device.isUpdating=!0,delete t.device.needsRestart,manticore.setTimeout(function(){return e()},MANTICORE_DEFAULT_SET_TIMEOUT))})}},{key:"retryConnection",value:function(e,t,i){var n=this;this.device.needsRestart&&(miuraLogs(!1),manticore.setTimeout(function(){Log.debug("Attempting connection with retryCount "+e),n.device.isUpdating=!1;var r=n.device.rawConnect;n.device.rawConnect=!0,n.device.needsRestart&&n.device.connect(function(o){n.device.rawConnect=r,o?Log.warn("Reconnect failed with error "+o+" retry count: "+e):(Log.debug(function(){return"Connected to device with retryCount "+e+". Validating with battery info fetch."}),n.device.getBatteryInfo()),--e<=0?(miuraLogs(!0),Log.debug("Giving up!"),t(o)):n.retryConnection(e,t,i)})},i?i:TERMINAL_CONNECTION_DEFAULT_RETRY_TIMEOUT))}},{key:"showP2PEMessage",value:function(e){this.device.display(Message.SoftwareUpdateProgress,{stage:"EncryptInit"},function(){return e.next()})}},{key:"showP2PEFetchMessage",value:function(e){this.device.display(Message.SoftwareUpdateProgress,{stage:"EncryptGet"},function(){return e.next()})}},{key:"showKeysDone",value:function(e){delete this.device.forceRki,this.device.display(Message.SoftwareUpdateProgress,{stage:"EncryptDone"},function(){return e.next()})}},{key:"initializeP2PE",value:function(e){return this.device.p2pe.init?(Log.debug("P2PE already initialized."),e.data.skippedInit=!0,e.next()):void this.device.terminal.Config.initializeP2PE(function(t,i){t||i.apdu.isSuccess||(t=new Error("Failed to initialize device encryption keys.")),e.nextOrAbort(t)})}},{key:"getFileStep",value:function(e,t){var i=this;return function(n){i.device.terminal.Config.getFile(t,function(t,r){return t?n.abortFlow(t):(i.files[e]=r.toString(),void n.next())})}}},{key:"getP2PEMaterial",value:function(e){var t=this,i=new Flow(this,this.getFileStep("initialKSN","suggested-iksn.txt"),this.getFileStep("signedProductSigningCert","prod-sign.crt"),this.getFileStep("signedTerminalCert","terminal.crt"),this.getFileStep("signedKeyLoadingCert","temp-keyload.crt"));i.name="Get P2PE File",i.on("completed",function(){miuraLogs(!0),e.next()}),i.on("aborted",function(i){return miuraLogs(!0),e.data.skippedInit?(delete e.data.skippedInit,t.device.p2pe.init=!1,Log.warn("P2PE initialization was faulty, retrying."),e.back()):void e.abortFlow(i.error)}),miuraLogs(!1),i.start()}},{key:"fetchKeys",value:function(e){var t=this;this.files.initialKSN=this.files.initialKSN.replace(/\n/g,"").replace("IKSN: ",""),Merchant.active.request({service:"retail",op:"cardReaderDevice/MIURA/"+this.device.model+"/keys",format:"json",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.files)},function(i,n){if(i)return e.abortFlow(i);t.filesToWrite=[],e.data.fileWriteIndex=0;for(var r in n.body)t.filesToWrite.push(n.body[r]);e.next()})}},{key:"copyKeys",value:function(e){var t=this,i=this;if(this.filesToWrite.length>e.data.fileWriteIndex){var n=this.filesToWrite[e.data.fileWriteIndex];this.device.terminal.Config.selectFile(n.filename,!0,function(r,o){if(r)return e.abortFlow(r);var a=new Buffer(n.content,"BASE64"===n.type?"base64":"utf8");n.filename.indexOf("-iksn-")>0&&(a.length<IKSN_BUFFER.length||!a.slice(0,IKSN_BUFFER.length).equals(IKSN_BUFFER))&&(a=Buffer.concat([IKSN_BUFFER,a],IKSN_BUFFER.length+a.length)),t.device.terminal.Config.streamBinary(a,0,255,!0,function(t,n){return t?e.abortFlow(r):n.apdu.isSuccess?(e.data.fileWriteIndex++,void i.copyKeys(e)):e.abortFlow(new Error("Failed to update encryption keys."))})})}else e.next()}},{key:"importKeys",value:function(e){this.device.terminal.Config.importP2PE(function(t,i){t||i.apdu.isSuccess||(t=new Error("Failed to import encryption keys.")),e.nextOrAbort(t)})}},{key:"getFetchedFile",value:function(e,t,i){manticore.getItem(t+":"+e,RetailSDKUtil.StorageType.Blob,function(e,t){return t?i(null,t):void i(new Error("File not found"))})}}],[{key:"fetchFiles",value:function(e,i){var n,r=[],o=0;t.needsUpdate(e,e.updates,!0,r);var a=!0,s=!1,u=void 0;try{for(var l,c=r[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var d=l.value;o++,getOne(d[0],d[1],function(e,t){n=n||e,0===--o&&(Log.debug("Software update files have been fetched."),i&&i(n,r))})}}catch(f){s=!0,u=f}finally{try{!a&&c["return"]&&c["return"]()}finally{if(s)throw u}}0===o?i(null,r):Log.debug("Fetching "+o+" update files")}},{key:"needsUpdate",value:function(e,t,i,n){var r=!1,o=!0,a=!1,s=void 0;try{for(var u,l=t[Symbol.iterator]();!(o=(u=l.next()).done);o=!0){var c=u.value;"Miura_OS"===c.name?(r=!0,i||Log.info(e.id+" OS will be updated from "+e.os.id+"-"+e.os.ver+" to "+c.version),pushModules(n,c.steps)):"Miura_MPI"===c.name?(r=!0,i||Log.info(e.id+" MPI will be updated from "+e.mpi.id+"-"+e.mpi.ver+" to "+c.version),pushModules(n,c.steps)):"Miura_CONFIG"===c.name&&(r=!0,i||Log.info(e.id+" CFG will be updated"),pushModules(n,c.steps))}}catch(d){a=!0,s=d}finally{try{!o&&l["return"]&&l["return"]()}finally{if(a)throw s}}return i||r||Log.debug(e.id+" does not need an upgrade."),r}}]),t}(DeviceUpdate),lastMiuraLogState,switchedOff;module.exports=MiuraSoftwareUpdate;


}).call(this,require("buffer").Buffer)
},{"../../common/Merchant":4,"../../common/RetailSDKUtil":5,"../../common/flow":7,"../../common/l10n":8,"../DeviceUpdate":27,"async":41,"buffer":44,"manticore":125,"manticore-log":123,"retail-payment-device":179}],34:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var i=e,o=t,a=r;n=!1,null===i&&(i=Function.prototype);var c=Object.getOwnPropertyDescriptor(i,o);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(a)}var l=Object.getPrototypeOf(i);if(null===l)return;e=l,t=o,r=a,n=!0,c=l=void 0}},Log=require("manticore-log")("sdk"),RawLogs=require("manticore-log"),EventEmitter=require("events").EventEmitter,PaymentDevice=require("retail-payment-device").PaymentDevice,manticore=require("manticore"),Cal=require("./common/cal"),TransactionContext=require("./transaction/TransactionContext"),Merchant=require("./common/Merchant"),SdkFeatures=require("./common/Features"),SDK=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),PaymentDevice.Events.on(t.Event.deviceDiscovered,function(r){return e.emit(t.Event.deviceDiscovered,r)}),SdkFeatures.loadRemoteFeatureMap(),this.setupCalLogging()}return _inherits(t,e),_createClass(t,[{key:"setupCalLogging",value:function(){var e=function t(){var e=function(){return manticore.setTimeout(t,1e4)};Merchant.active?Cal.flush(function(t,r){(r||t)&&Log.debug(function(){return"Flushed "+(r||0)+" cal log messages. "+(t?"Error: "+t:"")}),e()}):e()};Cal.attach(e)}},{key:"initializeMerchant",value:function(e,t){var r=this;(new Merchant).initialize(e,function(e,n){!e&&n&&(Cal.newGroup(n.email+"-"+Date.now()),r.emit("merchantInitialized",n)),t(e,n)})}},{key:"error",value:function(e){return new Error(e)}},{key:"createTransaction",value:function(e){if(!Merchant.active)throw new Error("You must have an active merchant to create a transaction. Call InitializeMerchant first, and wait for it to complete.");return new TransactionContext(e,Merchant.active)}},{key:"logViaJs",value:function(e,t,r,n){try{RawLogs(t)[e](r)}catch(i){Log.debug("Failed to log native message: "+e+" "+t+" "+r)}}},{key:"discoveredPaymentDevice",value:function(e){PaymentDevice.discovered(e)}}]),t}(EventEmitter);SDK.Event={deviceDiscovered:"deviceDiscovered"};var sdk=module.exports=new SDK;


},{"./common/Features":3,"./common/Merchant":4,"./common/cal":6,"./transaction/TransactionContext":36,"events":117,"manticore":125,"manticore-log":123,"retail-payment-device":179}],35:[function(require,module,exports){
"use strict";function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}var util=require("manticore-util"),Payer=function e(a){_classCallCheck(this,e),a&&util.assignSome(this,a,["customerId","receiptPreferenceToken","maskedEmail","maskedPhone"])};module.exports=Payer;


},{"manticore-util":124}],36:[function(require,module,exports){
"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_get=function(e,r,t){for(var n=!0;n;){var o=e,i=r,a=t;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,i);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(a)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,r=i,t=a,n=!0,c=l=void 0}},manticore=require("manticore"),SdkError=require("../common/sdkErrors"),Log=require("manticore-log")("tx"),l10n=require("../common/l10n"),Invoice=require("paypal-invoicing").Invoice,Currency=require("paypal-invoicing").Currency,PaymentDevice=require("retail-payment-device").PaymentDevice,ErrorCode=PaymentDevice.errorCode,FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,Card=require("retail-payment-device").Card,MagneticCard=require("retail-payment-device").MagneticCard,EventEmitter=require("events").EventEmitter,PaymentErrorHandler=require("../flows/PaymentErrorHandler"),ErrorAction=PaymentErrorHandler.action,async=require("async"),Merchant=require("../common/Merchant"),TxDeviceManager=require("./TransactionDeviceManager"),Flow=require("../common/flow"),TransactionContext=function(e){function r(e,t){var n=this;_classCallCheck(this,r),_get(Object.getPrototypeOf(r.prototype),"constructor",this).call(this),Log.debug(function(){return"Starting new transaction flow for "+e.currency+" "+e.total+" and "+PaymentDevice.devices.length+" connected devices"}),this.invoice=e,this.merchant=t,this.dm=new TxDeviceManager(this),e.status===Invoice.Status.PAID||e.status===Invoice.Status.MARKED_AS_PAID||e.status===Invoice.Status.PARTIALLY_REFUNDED?this.type=r.Type.Refund:this.type=r.Type.Sale,this.cardListener=function(e){if(Log.debug(function(){return"TransactionContext cardPresented (formFactor: "+e.formFactor+")"}),e.chipCard&&e.formFactor===FormFactor.MagneticCardSwipe){if(!n.allowFallBackSwipe){if(n.dm.formFactors.has(FormFactor.Chip)){Log.debug(function(){return"Swipe not allowed for chip card"});var r=new Error;return r.code=ErrorCode.cannotSwipeChipCard,n.errorListener(r,e.formFactor,e.reader)}Log.info("Allow fallback swipes on chip card as chip reader was not enabled")}Log.info("Allowing fallback swipe on the chip card"),e.isMSRFallbackAllowed=!0}n.listeners(PaymentDevice.Event.cardPresented).length?n.emit(PaymentDevice.Event.cardPresented,e):n.continueWithCard(e)},this.txCancelledListener=function(e){Log.warn("Tx cancelled listener was invoked for device : "+e.id),e.display(PaymentDevice.Message.TransactionCancelled,{amount:Currency.format(n.invoice.currency,n.invoice.total)},function(){n.alert=manticore.alert({title:l10n("Tx.Alert.Cancel.Title"),message:l10n("Tx.Alert.Cancel.Msg"),cancel:l10n("Done")},function(){n.alert.dismiss(),n.end(SdkError(new Error,SdkError.TRANSACTION.GENERIC_CANCEL))})})},this.errorListener=function(e,r,t){if(Log[e.code===ErrorCode.contactlessPaymentAbortedByCardInsert||e.code===ErrorCode.contactlessPaymentAbortedByCardSwipe?"debug":"error"]("Transaction failed with error code '"+e.code+"'"),e.code===ErrorCode.paymentCancelled)return n.txCancelledListener(t);var o=new PaymentErrorHandler(n);o.handle(e,r,t,function(t){return n._processErrorHandlerResponse(e,t,r)})}}return _inherits(r,e),_createClass(r,[{key:"_processErrorHandlerResponse",value:function(e,r,t){if(Log.info("Response from error handler for handling the error: "+e.code+" and form factor: "+t+" was '"+r+"' "),r){if(r===ErrorAction.OfflineDecline)return void this.saveInvoiceAndGoToReceipt();var n=this.dm.formFactors;if(r===ErrorAction.abort){var o=SdkError(new Error,SdkError.TRANSACTION.GENERIC_CANCEL);return e.code===ErrorCode.paymentCancelled&&(o=SdkError(new Error,SdkError.TRANSACTION.CUSTOMER_CANCEL)),this.end(o)}r===ErrorAction.retryWithInsertOrSwipe?n["delete"](FormFactor.EmvCertifiedContactless):r===ErrorAction.retryWithSwipe?(n["delete"](FormFactor.EmvCertifiedContactless),n["delete"](FormFactor.Chip)):r===ErrorAction.retryWithInsert&&(n["delete"](FormFactor.EmvCertifiedContactless),n["delete"](FormFactor.MagneticCardSwipe)),this.dm.activateMany([].concat(_toConsumableArray(this.dm.activeDevices)),n)}}},{key:"begin",value:function(e){return this.type!==r.Type.Sale?(this.end(SdkError(new Error,SdkError.TRANSACTION.INVOICE_STATUS_MISMATCH)),this):(this._resetState(),this._activateReaders(e),this)}},{key:"beginRefund",value:function(e,t){return this.type!==r.Type.Refund?(this.end(SdkError(new Error,SdkError.TRANSACTION.INVOICE_STATUS_MISMATCH)),this):(this._resetState(),this.refundAmount=t,e&&this._activateReaders(!0),this)}},{key:"_activateReaders",value:function(e){var r=this,t=this.dm.devices;Log.debug(function(){return"Attempting new transaction on "+t.length+" devices with "+[].concat(_toConsumableArray(new Set([].concat.apply([],t.map(function(e){return e.formFactors})))))+" available form factors"}),this.dm.activateMany(t,null,function(n){return 0===n.size&&t.length>0?(Log.warn("None of the connected devices are functional"),void r.emit("completed",SdkError(new Error,SdkError.TRANSACTION.NO_FUNCTIONAL_DEVICES),null)):(Log.info("Activated "+n.size+" device(s) for invoice total "+r.invoice.currency+" "+r.invoice.total+". Acceptable form factors: ["+[].concat(_toConsumableArray(r.dm.formFactors))+"]"),r.paymentDevices||r.dm.listenAndActivateNewDevices(),void(e&&r.promptForPaymentInstrument()))})}},{key:"isRefund",value:function(){return this.type===r.Type.Refund||this.type===r.Type.PartialRefund}},{key:"promptForPaymentInstrument",value:function(e){var r=this;e=e||this.dm.formFactors;var t=void 0,n=void 0;e.has(FormFactor.EmvCertifiedContactless)&&e.has(FormFactor.MagneticCardSwipe)&&e.has(FormFactor.Chip)?(t="Ready",n="img_emv_insert_tap_swipe"):e.has(FormFactor.MagneticCardSwipe)&&e.has(FormFactor.Chip)?(t="ReadyForInsertOrSwipeOnly",n="img_emv_insert_swipe"):e.has(FormFactor.MagneticCardSwipe)?(t="ReadyForSwipeOnly",n="img_emv_swipe"):e.has(FormFactor.Chip)&&(t="ReadyForInsertOnly",n="img_emv_insert"),t&&(this.alert=manticore.alert({title:l10n("Tx.Alert."+t+".Title"),message:l10n("Tx.Alert."+t+".Msg"),cancel:l10n("Cancel"),imageIcon:n},function(){r.alert.dismiss(),r.cancel()}))}},{key:"end",value:function(e,r){var t=this;Log.info("Ending transaction and removing all listeners from "+this.dm.activeDevices.size+" devices"),this.alert&&this.alert.dismiss(),this.dm.stopSyncingInvoiceTotal(function(){t.dm.removeListeners(t.dm.activeDevices),t.dm.stopListeningForNewDevices(),t._resetState(),async.each([].concat(_toConsumableArray(t.dm.activeDevices)),function(e,r){return e.display(PaymentDevice.Message.Ready,null,r)},function(n){t.emit("completed",e,r)})})}},{key:"_resetState",value:function(){this.retryCountInvalidChip=0,this.allowFallBackSwipe=!1,this.card&&(this.card.isMSRFallbackAllowed=!1)}},{key:"cancel",value:function(){Log.debug("Cancelling current transaction"),this.dm.deactivateMany([].concat(_toConsumableArray(this.dm.activeDevices)),function(){})}},{key:"continueWithCard",value:function(e){var t=this;e?Log.debug(function(){return"Card (type: "+e.constructor.name+") was presented. Form Factor: "+e.formFactor}):Log.debug(function(){return"No card presented."}),this.dm.removeListeners(this.dm.activeDevices);var n=function(r,n,o){Log[r?"error":"info"]("Transaction flow complete handler was invoked with action: '"+n+"' and error "+r),n&&n!==ErrorAction.abort?t._processErrorHandlerResponse(r,n,e.formFactor):t.end(r,o)};if(this.type===r.Type.Sale){this.card=e,e instanceof MagneticCard&&(e.isSignatureRequired=this._isMSRFallbackSignatureRequired(e)||this.invoice.total.greaterThanOrEqualTo(Merchant.active.signatureRequiredAbove));var o=require("./../flows/CreditCardFlow");this.flow=new o(e,this,n)}else this.card=e,this.flow=new(require("./../flows/refundFlow"))(e,this,n)}},{key:"_isMSRFallbackSignatureRequired",value:function(e){return e.isMSRFallbackAllowed&&this.dm.formFactors.has(FormFactor.Chip)}},{key:"setSignatureCollector",value:function(e){this._signatureCollector=e}},{key:"saveInvoiceAndGoToReceipt",value:function(){var e=this;this.invoice.save(function(r){if(r)Log.error("Unable to save invoice. Error: "+r+"\n"+JSON.stringify(e.invoice,null,4)),e.end(r,null);else{var t={message:l10n("Tx.TransactionFailed")},n={invoice:e.invoice},o=new Flow(e,[new require("./../flows/steps/ReceiptStep")(n).flowStep]);o.data={error:t},o.start(),o.on("ended",function(r){e.end(r.error,r.tx)})}})}},{key:"totalDisplayFooter",get:function(){return this._totalDisplayFooter},set:function(e){this._totalDisplayFooter=e,this.emit(TxDeviceManager.event.invoiceDisplayFooterUpdated)}},{key:"formFactors",get:function(){return[].concat(_toConsumableArray(this.dm.formFactors))},set:function(e){this.dm.formFactors=new Set(e)}}]),r}(EventEmitter);TransactionContext.Type={Sale:0,Auth:1,Refund:2,PartialRefund:3},module.exports=TransactionContext;


},{"../common/Merchant":4,"../common/flow":7,"../common/l10n":8,"../common/sdkErrors":11,"../flows/PaymentErrorHandler":14,"./../flows/CreditCardFlow":13,"./../flows/refundFlow":16,"./TransactionDeviceManager":37,"async":41,"events":117,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],37:[function(require,module,exports){
"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(s){i=!0,a=s}finally{try{!n&&c["return"]&&c["return"]()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var i=e,a=t,o=r;n=!1,null===i&&(i=Function.prototype);var c=Object.getOwnPropertyDescriptor(i,a);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(o)}var l=Object.getPrototypeOf(i);if(null===l)return;e=l,t=a,r=o,n=!0,c=l=void 0}},Log=require("manticore-log")("devMan"),manticore=require("manticore"),BatteryInfo=require("retail-payment-device").BatteryInfo,PaymentDevice=require("retail-payment-device").PaymentDevice,FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,Currency=require("paypal-invoicing").Currency,InvoiceEvent=require("paypal-invoicing").Invoice.Event,EventEmitter=require("events").EventEmitter,BN=require("bignumber.js"),$$=function(e){return void 0===e||null===e?null:new BN(e)},async=require("async"),TransactionDeviceManager=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=e,this.activeDevices=new Set,this._preferredFormFactors=new Set,this.syncInvoiceTotal()}return _inherits(t,e),_createClass(t,[{key:"syncInvoiceTotal",value:function(){var e=this;if(!this._q){var r=this.context.invoice;this._q={tasks:[],invoiceSyncInProgress:!1,kill:function(){e._q.tasks=[]},process:function(){if(e._q&&e._q.tasks.length){var t=e._q.tasks.splice(0,e._q.tasks.length),n=t.pop();e._q.invoiceSyncInProgress=!0,async.each(e.devices,function(t,i){var a=!0,o=!1,c=void 0;try{for(var s,l=e.availabilityFilters[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var v=_slicedToArray(s.value,2),u=(v[0],v[1]);if(!u(t))return i()}}catch(y){o=!0,c=y}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw c}}t.display(PaymentDevice.Message.InvoiceTotal,{amount:Currency.format(r.currency,n),footer:e.context.totalDisplayFooter},i)},function(){e.emit("onTaskComplete"),e._q&&(e._q.invoiceSyncInProgress=!1,e._q.tasks.length>0&&manticore.setTimeout(e._q.process,0))})}},push:function(t){e._q.tasks.push(t),e._q.invoiceSyncInProgress||e._q.process()}};var n=function(){return e._q.push(r.total)};n.txContext=this.context,r.on(InvoiceEvent.TotalChanged,n),this.context.on(t.event.invoiceDisplayFooterUpdated,n),this._q.push(r.total)}}},{key:"stopSyncingInvoiceTotal",value:function(e){var r=this,n=this.context.invoice,i=[InvoiceEvent.TotalChanged,t.event.invoiceDisplayFooterUpdated],a=!0,o=!1,c=void 0;try{for(var s,l=i[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var v=s.value,u=!0,y=!1,f=void 0;try{for(var d,h=n.listeners(v)[Symbol.iterator]();!(u=(d=h.next()).done);u=!0){var m=d.value;Object.is(m.txContext,this.context)&&n.removeListener(v,m)}}catch(p){y=!0,f=p}finally{try{!u&&h["return"]&&h["return"]()}finally{if(y)throw f}}}}catch(p){o=!0,c=p}finally{try{!a&&l["return"]&&l["return"]()}finally{if(o)throw c}}return this._q?(this._q.kill(),this._q.invoiceSyncInProgress?void this.once("onTaskComplete",function(){r._q=null,e()}):(this._q=null,e())):e()}},{key:"_addListener",value:function(e,t,r){r.txContext=this.context,e.on(t,r)}},{key:"activateMany",value:function(e,r,n){var i=this,a=function(e,t){var r=t||i.formFactors;Log.debug(function(){return"Activating "+e.id+" with form factors ["+[].concat(_toConsumableArray(r))+"]"}),e.activate(i.context,{formFactors:r}),i.activeDevices.add(e),i._removeListeners(e),i._addListener(e,PaymentDevice.Event.cardPresented,i.context.cardListener),i._addListener(e,PaymentDevice.Event.cancelled,function(){return i.context.txCancelledListener(e)}),i._addListener(e,PaymentDevice.Event.cancelRequested,function(){return i.context.cancel}),i._addListener(e,PaymentDevice.Event.error,i.context.errorListener)};this.stopSyncingInvoiceTotal(function(){async.each(e,function(e,n){var o=!0,c=!1,s=void 0;try{for(var l,v=i.availabilityFilters[Symbol.iterator]();!(o=(l=v.next()).done);o=!0){var u=_slicedToArray(l.value,2),y=u[0],f=u[1];if(!f(e))return Log.warn("Device "+e.id+" failed availability criteria "+y),void(y===t.FilterCriteria.BatteryStatus?(Log.warn("Battery level on "+e.id+" is too low to begin a transaction "+e.batteryStatus),e.display(PaymentDevice.Message.RechargeNow,null,function(){return n()})):y===t.FilterCriteria.SoftwareUpdate?e.pendingUpdate.offer(function(t){Log[t?"error":"info"]("Software update completed. Error: "+(t?t:null)),t||a(e,r),n()}):n())}}catch(d){c=!0,s=d}finally{try{!o&&v["return"]&&v["return"]()}finally{if(c)throw s}}a(e,r),n()},function(){n&&n(i.activeDevices)})})}},{key:"deactivateMany",value:function(e,t){var r=this;async.each(e,function(e,t){e.deactivate(r.context,!1,t)},t)}},{key:"listenAndActivateNewDevices",value:function(){var e=this;this.onNewDevice=function(t){Log.debug("Discovered new device during transaction");var r=e.formFactors,n=!0,i=!1,a=void 0;try{for(var o,c=t.formFactors[Symbol.iterator]();!(n=(o=c.next()).done);n=!0){var s=o.value;r.has(s)||e.context.emit("formFactorAdded",s)}}catch(l){i=!0,a=l}finally{try{!n&&c["return"]&&c["return"]()}finally{if(i)throw a}}e.activateMany([t])},require("../sdk").on("deviceDiscovered",this.onNewDevice)}},{key:"stopListeningForNewDevices",value:function(){this.onNewDevice&&(require("../sdk").removeListener("deviceDiscovered",this.onNewDevice),delete this.onNewDevice)}},{key:"removeListeners",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;this._removeListeners(o)}}catch(c){r=!0,n=c}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}}},{key:"_removeListeners",value:function(e){var t=[PaymentDevice.Event.cardPresented,PaymentDevice.Event.cancelled,PaymentDevice.Event.cancelRequested,PaymentDevice.Event.error],r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var c=a.value,s=!0,l=!1,v=void 0;try{for(var u,y=e.listeners(c)[Symbol.iterator]();!(s=(u=y.next()).done);s=!0){var f=u.value;Object.is(f.txContext,this.context)&&e.removeListener(c,f)}}catch(d){l=!0,v=d}finally{try{!s&&y["return"]&&y["return"]()}finally{if(l)throw v}}}}catch(d){n=!0,i=d}finally{try{!r&&o["return"]&&o["return"]()}finally{if(n)throw i}}}},{key:"devices",get:function(){return this.context.paymentDevices||PaymentDevice.devices}},{key:"formFactors",get:function(){var e=this,t=this.devices.filter(function(t){var r=!0,n=!1,i=void 0;try{for(var a,o=e.availabilityFilters[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var c=_slicedToArray(a.value,2),s=c[1];if(!s(t))return!1}}catch(l){n=!0,i=l}finally{try{!r&&o["return"]&&o["return"]()}finally{if(n)throw i}}return!0}),r=new Set([].concat.apply([],t.map(function(e){return e.formFactors})));r.has(FormFactor.EmvCertifiedContactless)&&!function(){var t=e.context.merchant.featureMap.CONTACTLESS_LIMIT;"*"!==t&&e.context.invoice.total.greaterThan($$(t)||0)&&(Log.debug(function(){return"Cannot perform NFC. Invoice total "+e.context.invoice.total+" is above contactless limit of "+$$(t)}),r["delete"](FormFactor.EmvCertifiedContactless))}();var n=[].concat(_toConsumableArray(this._preferredFormFactors));return n.length>0?new Set(n.filter(function(e){return r.has(e)})):r},set:function(e){this._preferredFormFactors=e}},{key:"availabilityFilters",get:function(){return[[t.FilterCriteria.Ready,function(e){return e.isReady}],[t.FilterCriteria.BatteryStatus,function(e){return!(e.batteryStatus&&!e.batteryStatus.isCharging&&e.batteryStatus.level===BatteryInfo.Level.Critical)}],[t.FilterCriteria.SoftwareUpdate,function(e){return!(e.pendingUpdate&&e.pendingUpdate.isRequired)}]]}}]),t}(EventEmitter);TransactionDeviceManager.FilterCriteria={Ready:"Ready",BatteryStatus:"BatteryStatus",SoftwareUpdate:"SoftwareUpdate"},TransactionDeviceManager.event={invoiceDisplayFooterUpdated:"InvoiceDisplayFooterUpdated"},module.exports=TransactionDeviceManager;


},{"../sdk":34,"async":41,"bignumber.js":43,"events":117,"manticore":125,"manticore-log":123,"paypal-invoicing":141,"retail-payment-device":179}],38:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var a=r[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(r,n,a){return n&&e(r.prototype,n),a&&e(r,a),r}}(),util=require("manticore-util"),Payer=require("./Payer"),TransactionRecord=function(){function e(r){_classCallCheck(this,e),util.assignSome(this,r,["correlationId","transactionNumber","invoiceId","transactionHandle","responseCode","authCode","errorCode"]),r.payerInfo&&(this.payer=new Payer(r.payerInfo)),r.id&&(this.transactionNumber=r.id),r.txnHandle&&!this.transactionHandle&&(this.transactionHandle=r.txnHandle)}return _createClass(e,[{key:"updateFromFinalize",value:function(e){this.transactionNumber=e.transactionNumber,e.correlationId&&this.correlationId?this.correlationId+=","+e.correlationId:e.correlationId&&(this.correlationId=e.correlationId),e.payerInfo&&(this.payer=new Payer(e.payerInfo))}}]),e}();module.exports=TransactionRecord,TransactionRecord.Error={ContactlessNotAcceptable:600075,IncorrectOnlinePin:6000164};


},{"./Payer":35,"manticore-util":124}],39:[function(require,module,exports){
"use strict";module.exports={Payer:require("./Payer"),TransactionRecord:require("./TransactionRecord")};


},{"./Payer":35,"./TransactionRecord":38}],40:[function(require,module,exports){
function replacer(t,e){return util.isUndefined(e)?""+e:util.isNumber(e)&&!isFinite(e)?e.toString():util.isFunction(e)||util.isRegExp(e)?e.toString():e}function truncate(t,e){return util.isString(t)?t.length<e?t:t.slice(0,e):t}function getMessage(t){return truncate(JSON.stringify(t.actual,replacer),128)+" "+t.operator+" "+truncate(JSON.stringify(t.expected,replacer),128)}function fail(t,e,r,i,s){throw new assert.AssertionError({message:r,actual:t,expected:e,operator:i,stackStartFunction:s})}function ok(t,e){t||fail(t,!0,e,"==",assert.ok)}function _deepEqual(t,e){if(t===e)return!0;if(util.isBuffer(t)&&util.isBuffer(e)){if(t.length!=e.length)return!1;for(var r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}return util.isDate(t)&&util.isDate(e)?t.getTime()===e.getTime():util.isRegExp(t)&&util.isRegExp(e)?t.source===e.source&&t.global===e.global&&t.multiline===e.multiline&&t.lastIndex===e.lastIndex&&t.ignoreCase===e.ignoreCase:util.isObject(t)||util.isObject(e)?objEquiv(t,e):t==e}function isArguments(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function objEquiv(t,e){if(util.isNullOrUndefined(t)||util.isNullOrUndefined(e))return!1;if(t.prototype!==e.prototype)return!1;if(util.isPrimitive(t)||util.isPrimitive(e))return t===e;var r=isArguments(t),i=isArguments(e);if(r&&!i||!r&&i)return!1;if(r)return t=pSlice.call(t),e=pSlice.call(e),_deepEqual(t,e);var s,n,a=objectKeys(t),o=objectKeys(e);if(a.length!=o.length)return!1;for(a.sort(),o.sort(),n=a.length-1;n>=0;n--)if(a[n]!=o[n])return!1;for(n=a.length-1;n>=0;n--)if(s=a[n],!_deepEqual(t[s],e[s]))return!1;return!0}function expectedException(t,e){return t&&e?"[object RegExp]"==Object.prototype.toString.call(e)?e.test(t):t instanceof e?!0:e.call({},t)===!0:!1}function _throws(t,e,r,i){var s;util.isString(r)&&(i=r,r=null);try{e()}catch(n){s=n}if(i=(r&&r.name?" ("+r.name+").":".")+(i?" "+i:"."),t&&!s&&fail(s,r,"Missing expected exception"+i),!t&&expectedException(s,r)&&fail(s,r,"Got unwanted exception"+i),t&&s&&r&&!expectedException(s,r)||!t&&s)throw s}var util=require("util/"),pSlice=Array.prototype.slice,hasOwn=Object.prototype.hasOwnProperty,assert=module.exports=ok;assert.AssertionError=function(t){this.name="AssertionError",this.actual=t.actual,this.expected=t.expected,this.operator=t.operator,t.message?(this.message=t.message,this.generatedMessage=!1):(this.message=getMessage(this),this.generatedMessage=!0);var e=t.stackStartFunction||fail;if(Error.captureStackTrace)Error.captureStackTrace(this,e);else{var r=new Error;if(r.stack){var i=r.stack,s=e.name,n=i.indexOf("\n"+s);if(n>=0){var a=i.indexOf("\n",n+1);i=i.substring(a+1)}this.stack=i}}},util.inherits(assert.AssertionError,Error),assert.fail=fail,assert.ok=ok,assert.equal=function(t,e,r){t!=e&&fail(t,e,r,"==",assert.equal)},assert.notEqual=function(t,e,r){t==e&&fail(t,e,r,"!=",assert.notEqual)},assert.deepEqual=function(t,e,r){_deepEqual(t,e)||fail(t,e,r,"deepEqual",assert.deepEqual)},assert.notDeepEqual=function(t,e,r){_deepEqual(t,e)&&fail(t,e,r,"notDeepEqual",assert.notDeepEqual)},assert.strictEqual=function(t,e,r){t!==e&&fail(t,e,r,"===",assert.strictEqual)},assert.notStrictEqual=function(t,e,r){t===e&&fail(t,e,r,"!==",assert.notStrictEqual)},assert["throws"]=function(t,e,r){_throws.apply(this,[!0].concat(pSlice.call(arguments)))},assert.doesNotThrow=function(t,e){_throws.apply(this,[!1].concat(pSlice.call(arguments)))},assert.ifError=function(t){if(t)throw t};var objectKeys=Object.keys||function(t){var e=[];for(var r in t)hasOwn.call(t,r)&&e.push(r);return e};


},{"util/":199}],41:[function(require,module,exports){
(function (process,global){
!function(){function n(){}function t(n){return n}function e(n){return!!n}function r(n){return!n}function u(n){return function(){if(null===n)throw new Error("Callback was already called.");n.apply(this,arguments),n=null}}function i(n){return function(){null!==n&&(n.apply(this,arguments),n=null)}}function o(n){return M(n)||"number"==typeof n.length&&n.length>=0&&n.length%1===0}function c(n,t){for(var e=-1,r=n.length;++e<r;)t(n[e],e,n)}function f(n,t){for(var e=-1,r=n.length,u=Array(r);++e<r;)u[e]=t(n[e],e,n);return u}function a(n){return f(Array(n),function(n,t){return t})}function l(n,t,e){return c(n,function(n,r,u){e=t(e,n,r,u)}),e}function s(n,t){c(W(n),function(e){t(n[e],e)})}function p(n,t){for(var e=0;e<n.length;e++)if(n[e]===t)return e;return-1}function h(n){var t,e,r=-1;return o(n)?(t=n.length,function(){return r++,t>r?r:null}):(e=W(n),t=e.length,function(){return r++,t>r?e[r]:null})}function y(n,t){return t=null==t?n.length-1:+t,function(){for(var e=Math.max(arguments.length-t,0),r=Array(e),u=0;e>u;u++)r[u]=arguments[u+t];switch(t){case 0:return n.call(this,r);case 1:return n.call(this,arguments[0],r)}}}function m(n){return function(t,e,r){return n(t,r)}}function v(t){return function(e,r,o){o=i(o||n),e=e||[];var c=h(e);if(0>=t)return o(null);var f=!1,a=0,l=!1;!function s(){if(f&&0>=a)return o(null);for(;t>a&&!l;){var n=c();if(null===n)return f=!0,void(0>=a&&o(null));a+=1,r(e[n],n,u(function(n){a-=1,n?(o(n),l=!0):s()}))}}()}}function d(n){return function(t,e,r){return n(P.eachOf,t,e,r)}}function g(n){return function(t,e,r,u){return n(v(e),t,r,u)}}function k(n){return function(t,e,r){return n(P.eachOfSeries,t,e,r)}}function b(t,e,r,u){u=i(u||n),e=e||[];var c=o(e)?[]:{};t(e,function(n,t,e){r(n,function(n,r){c[t]=r,e(n)})},function(n){u(n,c)})}function w(n,t,e,r){var u=[];n(t,function(n,t,r){e(n,function(e){e&&u.push({index:t,value:n}),r()})},function(){r(f(u.sort(function(n,t){return n.index-t.index}),function(n){return n.value}))})}function O(n,t,e,r){w(n,t,function(n,t){e(n,function(n){t(!n)})},r)}function S(n,t,e){return function(r,u,i,o){function c(){o&&o(e(!1,void 0))}function f(n,r,u){return o?void i(n,function(r){o&&t(r)&&(o(e(!0,n)),o=i=!1),u()}):u()}arguments.length>3?n(r,u,f,c):(o=i,i=u,n(r,f,c))}}function E(n,t){return t}function L(t,e,r){r=r||n;var u=o(e)?[]:{};t(e,function(n,t,e){n(y(function(n,r){r.length<=1&&(r=r[0]),u[t]=r,e(n)}))},function(n){r(n,u)})}function j(n,t,e,r){var u=[];n(t,function(n,t,r){e(n,function(n,t){u=u.concat(t||[]),r(n)})},function(n){r(n,u)})}function I(t,e,r){function i(t,e,r,u){if(null!=u&&"function"!=typeof u)throw new Error("task callback must be a function");return t.started=!0,M(e)||(e=[e]),0===e.length&&t.idle()?P.setImmediate(function(){t.drain()}):(c(e,function(e){var i={data:e,callback:u||n};r?t.tasks.unshift(i):t.tasks.push(i),t.tasks.length===t.concurrency&&t.saturated()}),void P.setImmediate(t.process))}function o(n,t){return function(){a-=1;var e=!1,r=arguments;c(t,function(n){c(l,function(t,r){t!==n||e||(l.splice(r,1),e=!0)}),n.callback.apply(n,r)}),n.tasks.length+a===0&&n.drain(),n.process()}}if(null==e)e=1;else if(0===e)throw new Error("Concurrency must not be zero");var a=0,l=[],s={tasks:[],concurrency:e,payload:r,saturated:n,empty:n,drain:n,started:!1,paused:!1,push:function(n,t){i(s,n,!1,t)},kill:function(){s.drain=n,s.tasks=[]},unshift:function(n,t){i(s,n,!0,t)},process:function(){for(;!s.paused&&a<s.concurrency&&s.tasks.length;){var n=s.payload?s.tasks.splice(0,s.payload):s.tasks.splice(0,s.tasks.length),e=f(n,function(n){return n.data});0===s.tasks.length&&s.empty(),a+=1,l.push(n[0]);var r=u(o(s,n));t(e,r)}},length:function(){return s.tasks.length},running:function(){return a},workersList:function(){return l},idle:function(){return s.tasks.length+a===0},pause:function(){s.paused=!0},resume:function(){if(s.paused!==!1){s.paused=!1;for(var n=Math.min(s.concurrency,s.tasks.length),t=1;n>=t;t++)P.setImmediate(s.process)}}};return s}function x(n){return y(function(t,e){t.apply(null,e.concat([y(function(t,e){"object"==typeof console&&(t?console.error&&console.error(t):console[n]&&c(e,function(t){console[n](t)}))})]))})}function A(n){return function(t,e,r){n(a(t),e,r)}}function T(n){return y(function(t,e){var r=y(function(e){var r=this,u=e.pop();return n(t,function(n,t,u){n.apply(r,e.concat([u]))},u)});return e.length?r.apply(this,e):r})}function z(n){return y(function(t){var e=t.pop();t.push(function(){var n=arguments;r?P.setImmediate(function(){e.apply(null,n)}):e.apply(null,n)});var r=!0;n.apply(this,t),r=!1})}var q,P={},C="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;null!=C&&(q=C.async),P.noConflict=function(){return C.async=q,P};var H=Object.prototype.toString,M=Array.isArray||function(n){return"[object Array]"===H.call(n)},U=function(n){var t=typeof n;return"function"===t||"object"===t&&!!n},W=Object.keys||function(n){var t=[];for(var e in n)n.hasOwnProperty(e)&&t.push(e);return t},B="function"==typeof setImmediate&&setImmediate,D=B?function(n){B(n)}:function(n){setTimeout(n,0)};"object"==typeof process&&"function"==typeof process.nextTick?P.nextTick=process.nextTick:P.nextTick=D,P.setImmediate=B?D:P.nextTick,P.forEach=P.each=function(n,t,e){return P.eachOf(n,m(t),e)},P.forEachSeries=P.eachSeries=function(n,t,e){return P.eachOfSeries(n,m(t),e)},P.forEachLimit=P.eachLimit=function(n,t,e,r){return v(t)(n,m(e),r)},P.forEachOf=P.eachOf=function(t,e,r){function o(n){a--,n?r(n):null===c&&0>=a&&r(null)}r=i(r||n),t=t||[];for(var c,f=h(t),a=0;null!=(c=f());)a+=1,e(t[c],c,u(o));0===a&&r(null)},P.forEachOfSeries=P.eachOfSeries=function(t,e,r){function o(){var n=!0;return null===f?r(null):(e(t[f],f,u(function(t){if(t)r(t);else{if(f=c(),null===f)return r(null);n?P.setImmediate(o):o()}})),void(n=!1))}r=i(r||n),t=t||[];var c=h(t),f=c();o()},P.forEachOfLimit=P.eachOfLimit=function(n,t,e,r){v(t)(n,e,r)},P.map=d(b),P.mapSeries=k(b),P.mapLimit=g(b),P.inject=P.foldl=P.reduce=function(n,t,e,r){P.eachOfSeries(n,function(n,r,u){e(t,n,function(n,e){t=e,u(n)})},function(n){r(n,t)})},P.foldr=P.reduceRight=function(n,e,r,u){var i=f(n,t).reverse();P.reduce(i,e,r,u)},P.transform=function(n,t,e,r){3===arguments.length&&(r=e,e=t,t=M(n)?[]:{}),P.eachOf(n,function(n,r,u){e(t,n,r,u)},function(n){r(n,t)})},P.select=P.filter=d(w),P.selectLimit=P.filterLimit=g(w),P.selectSeries=P.filterSeries=k(w),P.reject=d(O),P.rejectLimit=g(O),P.rejectSeries=k(O),P.any=P.some=S(P.eachOf,e,t),P.someLimit=S(P.eachOfLimit,e,t),P.all=P.every=S(P.eachOf,r,r),P.everyLimit=S(P.eachOfLimit,r,r),P.detect=S(P.eachOf,t,E),P.detectSeries=S(P.eachOfSeries,t,E),P.detectLimit=S(P.eachOfLimit,t,E),P.sortBy=function(n,t,e){function r(n,t){var e=n.criteria,r=t.criteria;return r>e?-1:e>r?1:0}P.map(n,function(n,e){t(n,function(t,r){t?e(t):e(null,{value:n,criteria:r})})},function(n,t){return n?e(n):void e(null,f(t.sort(r),function(n){return n.value}))})},P.auto=function(t,e,r){function u(n){g.unshift(n)}function o(n){var t=p(g,n);t>=0&&g.splice(t,1)}function f(){h--,c(g.slice(0),function(n){n()})}"function"==typeof arguments[1]&&(r=e,e=null),r=i(r||n);var a=W(t),h=a.length;if(!h)return r(null);e||(e=h);var m={},v=0,d=!1,g=[];u(function(){h||r(null,m)}),c(a,function(n){function i(){return e>v&&l(k,function(n,t){return n&&m.hasOwnProperty(t)},!0)&&!m.hasOwnProperty(n)}function c(){i()&&(v++,o(c),h[h.length-1](g,m))}if(!d){for(var a,h=M(t[n])?t[n]:[t[n]],g=y(function(t,e){if(v--,e.length<=1&&(e=e[0]),t){var u={};s(m,function(n,t){u[t]=n}),u[n]=e,d=!0,r(t,u)}else m[n]=e,P.setImmediate(f)}),k=h.slice(0,h.length-1),b=k.length;b--;){if(!(a=t[k[b]]))throw new Error("Has nonexistent dependency in "+k.join(", "));if(M(a)&&p(a,n)>=0)throw new Error("Has cyclic dependencies")}i()?(v++,h[h.length-1](g,m)):u(c)}})},P.retry=function(n,t,e){function r(n,t){if("number"==typeof t)n.times=parseInt(t,10)||i;else{if("object"!=typeof t)throw new Error("Unsupported argument type for 'times': "+typeof t);n.times=parseInt(t.times,10)||i,n.interval=parseInt(t.interval,10)||o}}function u(n,t){function e(n,e){return function(r){n(function(n,t){r(!n||e,{err:n,result:t})},t)}}function r(n){return function(t){setTimeout(function(){t(null)},n)}}for(;f.times;){var u=!(f.times-=1);c.push(e(f.task,u)),!u&&f.interval>0&&c.push(r(f.interval))}P.series(c,function(t,e){e=e[e.length-1],(n||f.callback)(e.err,e.result)})}var i=5,o=0,c=[],f={times:i,interval:o},a=arguments.length;if(1>a||a>3)throw new Error("Invalid arguments - must be either (task), (task, callback), (times, task) or (times, task, callback)");return 2>=a&&"function"==typeof n&&(e=t,t=n),"function"!=typeof n&&r(f,n),f.callback=e,f.task=t,f.callback?u():u},P.waterfall=function(t,e){function r(n){return y(function(t,u){if(t)e.apply(null,[t].concat(u));else{var i=n.next();i?u.push(r(i)):u.push(e),z(n).apply(null,u)}})}if(e=i(e||n),!M(t)){var u=new Error("First argument to waterfall must be an array of functions");return e(u)}return t.length?void r(P.iterator(t))():e()},P.parallel=function(n,t){L(P.eachOf,n,t)},P.parallelLimit=function(n,t,e){L(v(t),n,e)},P.series=function(n,t){L(P.eachOfSeries,n,t)},P.iterator=function(n){function t(e){function r(){return n.length&&n[e].apply(null,arguments),r.next()}return r.next=function(){return e<n.length-1?t(e+1):null},r}return t(0)},P.apply=y(function(n,t){return y(function(e){return n.apply(null,t.concat(e))})}),P.concat=d(j),P.concatSeries=k(j),P.whilst=function(t,e,r){if(r=r||n,t()){var u=y(function(n,i){n?r(n):t.apply(this,i)?e(u):r.apply(null,[null].concat(i))});e(u)}else r(null)},P.doWhilst=function(n,t,e){var r=0;return P.whilst(function(){return++r<=1||t.apply(this,arguments)},n,e)},P.until=function(n,t,e){return P.whilst(function(){return!n.apply(this,arguments)},t,e)},P.doUntil=function(n,t,e){return P.doWhilst(n,function(){return!t.apply(this,arguments)},e)},P.during=function(t,e,r){r=r||n;var u=y(function(n,e){n?r(n):(e.push(i),t.apply(this,e))}),i=function(n,t){n?r(n):t?e(u):r(null)};t(i)},P.doDuring=function(n,t,e){var r=0;P.during(function(n){r++<1?n(null,!0):t.apply(this,arguments)},n,e)},P.queue=function(n,t){var e=I(function(t,e){n(t[0],e)},t,1);return e},P.priorityQueue=function(t,e){function r(n,t){return n.priority-t.priority}function u(n,t,e){for(var r=-1,u=n.length-1;u>r;){var i=r+(u-r+1>>>1);e(t,n[i])>=0?r=i:u=i-1}return r}function i(t,e,i,o){if(null!=o&&"function"!=typeof o)throw new Error("task callback must be a function");return t.started=!0,M(e)||(e=[e]),0===e.length?P.setImmediate(function(){t.drain()}):void c(e,function(e){var c={data:e,priority:i,callback:"function"==typeof o?o:n};t.tasks.splice(u(t.tasks,c,r)+1,0,c),t.tasks.length===t.concurrency&&t.saturated(),P.setImmediate(t.process)})}var o=P.queue(t,e);return o.push=function(n,t,e){i(o,n,t,e)},delete o.unshift,o},P.cargo=function(n,t){return I(n,1,t)},P.log=x("log"),P.dir=x("dir"),P.memoize=function(n,e){var r={},u={},i=Object.prototype.hasOwnProperty;e=e||t;var o=y(function(t){var o=t.pop(),c=e.apply(null,t);i.call(r,c)?P.setImmediate(function(){o.apply(null,r[c])}):i.call(u,c)?u[c].push(o):(u[c]=[o],n.apply(null,t.concat([y(function(n){r[c]=n;var t=u[c];delete u[c];for(var e=0,i=t.length;i>e;e++)t[e].apply(null,n)})])))});return o.memo=r,o.unmemoized=n,o},P.unmemoize=function(n){return function(){return(n.unmemoized||n).apply(null,arguments)}},P.times=A(P.map),P.timesSeries=A(P.mapSeries),P.timesLimit=function(n,t,e,r){return P.mapLimit(a(n),t,e,r)},P.seq=function(){var t=arguments;return y(function(e){var r=this,u=e[e.length-1];"function"==typeof u?e.pop():u=n,P.reduce(t,e,function(n,t,e){t.apply(r,n.concat([y(function(n,t){e(n,t)})]))},function(n,t){u.apply(r,[n].concat(t))})})},P.compose=function(){return P.seq.apply(null,Array.prototype.reverse.call(arguments))},P.applyEach=T(P.eachOf),P.applyEachSeries=T(P.eachOfSeries),P.forever=function(t,e){function r(n){return n?i(n):void o(r)}var i=u(e||n),o=z(t);r()},P.ensureAsync=z,P.constant=y(function(n){var t=[null].concat(n);return function(n){return n.apply(this,t)}}),P.wrapSync=P.asyncify=function(n){return y(function(t){var e,r=t.pop();try{e=n.apply(this,t)}catch(u){return r(u)}U(e)&&"function"==typeof e.then?e.then(function(n){r(null,n)})["catch"](function(n){r(n.message?n:new Error(n))}):r(null,e)})},"object"==typeof module&&module.exports?module.exports=P:"function"==typeof define&&define.amd?define([],function(){return P}):C.async=P}();


}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"_process":176}],42:[function(require,module,exports){
var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(t){"use strict";function r(t){var r=t.charCodeAt(0);return r===h||r===u?62:r===c||r===f?63:o>r?-1:o+10>r?r-o+26+26:i+26>r?r-i:A+26>r?r-A+26:void 0}function e(t){function e(t){i[f++]=t}var n,h,c,o,A,i;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var u=t.length;A="="===t.charAt(u-2)?2:"="===t.charAt(u-1)?1:0,i=new a(3*t.length/4-A),c=A>0?t.length-4:t.length;var f=0;for(n=0,h=0;c>n;n+=4,h+=3)o=r(t.charAt(n))<<18|r(t.charAt(n+1))<<12|r(t.charAt(n+2))<<6|r(t.charAt(n+3)),e((16711680&o)>>16),e((65280&o)>>8),e(255&o);return 2===A?(o=r(t.charAt(n))<<2|r(t.charAt(n+1))>>4,e(255&o)):1===A&&(o=r(t.charAt(n))<<10|r(t.charAt(n+1))<<4|r(t.charAt(n+2))>>2,e(o>>8&255),e(255&o)),i}function n(t){function r(t){return lookup.charAt(t)}function e(t){return r(t>>18&63)+r(t>>12&63)+r(t>>6&63)+r(63&t)}var n,a,h,c=t.length%3,o="";for(n=0,h=t.length-c;h>n;n+=3)a=(t[n]<<16)+(t[n+1]<<8)+t[n+2],o+=e(a);switch(c){case 1:a=t[t.length-1],o+=r(a>>2),o+=r(a<<4&63),o+="==";break;case 2:a=(t[t.length-2]<<8)+t[t.length-1],o+=r(a>>10),o+=r(a>>4&63),o+=r(a<<2&63),o+="="}return o}var a="undefined"!=typeof Uint8Array?Uint8Array:Array,h="+".charCodeAt(0),c="/".charCodeAt(0),o="0".charCodeAt(0),A="a".charCodeAt(0),i="A".charCodeAt(0),u="-".charCodeAt(0),f="_".charCodeAt(0);t.toByteArray=e,t.fromByteArray=n}("undefined"==typeof exports?this.base64js={}:exports);


},{}],43:[function(require,module,exports){
!function(e){"use strict";function n(e){function E(e,n){var t,r,i,o,u,s,f=this;if(!(f instanceof E))return j&&L(26,"constructor call without new",e),new E(e,n);if(null!=n&&H(n,2,64,M,"base")){if(n=0|n,s=e+"",10==n)return f=new E(e instanceof E?e:s),U(f,P+f.e+1,k);if((o="number"==typeof e)&&0*e!=0||!new RegExp("^-?"+(t="["+N.slice(0,n)+"]+")+"(?:\\."+t+")?$",37>n?"i":"").test(s))return h(f,s,o,n);o?(f.s=0>1/e?(s=s.slice(1),-1):1,j&&s.replace(/^0\.0*|\./,"").length>15&&L(M,v,e),o=!1):f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1,s=D(s,10,n,f.s)}else{if(e instanceof E)return f.s=e.s,f.e=e.e,f.c=(e=e.c)?e.slice():e,void(M=0);if((o="number"==typeof e)&&0*e==0){if(f.s=0>1/e?(e=-e,-1):1,e===~~e){for(r=0,i=e;i>=10;i/=10,r++);return f.e=r,f.c=[e],void(M=0)}s=e+""}else{if(!g.test(s=e+""))return h(f,s,o);f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1}}for((r=s.indexOf("."))>-1&&(s=s.replace(".","")),(i=s.search(/e/i))>0?(0>r&&(r=i),r+=+s.slice(i+1),s=s.substring(0,i)):0>r&&(r=s.length),i=0;48===s.charCodeAt(i);i++);for(u=s.length;48===s.charCodeAt(--u););if(s=s.slice(i,u+1))if(u=s.length,o&&j&&u>15&&L(M,v,f.s*e),r=r-i-1,r>z)f.c=f.e=null;else if(G>r)f.c=[f.e=0];else{if(f.e=r,f.c=[],i=(r+1)%O,0>r&&(i+=O),u>i){for(i&&f.c.push(+s.slice(0,i)),u-=O;u>i;)f.c.push(+s.slice(i,i+=O));s=s.slice(i),i=O-s.length}else i-=u;for(;i--;s+="0");f.c.push(+s)}else f.c=[f.e=0];M=0}function D(e,n,t,i){var o,u,f,c,a,h,g,p=e.indexOf("."),d=P,m=k;for(37>t&&(e=e.toLowerCase()),p>=0&&(f=J,J=0,e=e.replace(".",""),g=new E(t),a=g.pow(e.length-p),J=f,g.c=s(l(r(a.c),a.e),10,n),g.e=g.c.length),h=s(e,t,n),u=f=h.length;0==h[--f];h.pop());if(!h[0])return"0";if(0>p?--u:(a.c=h,a.e=u,a.s=i,a=C(a,g,d,m,n),h=a.c,c=a.r,u=a.e),o=u+d+1,p=h[o],f=n/2,c=c||0>o||null!=h[o+1],c=4>m?(null!=p||c)&&(0==m||m==(a.s<0?3:2)):p>f||p==f&&(4==m||c||6==m&&1&h[o-1]||m==(a.s<0?8:7)),1>o||!h[0])e=c?l("1",-d):"0";else{if(h.length=o,c)for(--n;++h[--o]>n;)h[o]=0,o||(++u,h.unshift(1));for(f=h.length;!h[--f];);for(p=0,e="";f>=p;e+=N.charAt(h[p++]));e=l(e,u)}return e}function F(e,n,t,i){var o,u,s,c,a;if(t=null!=t&&H(t,0,8,i,w)?0|t:k,!e.c)return e.toString();if(o=e.c[0],s=e.e,null==n)a=r(e.c),a=19==i||24==i&&B>=s?f(a,s):l(a,s);else if(e=U(new E(e),n,t),u=e.e,a=r(e.c),c=a.length,19==i||24==i&&(u>=n||B>=u)){for(;n>c;a+="0",c++);a=f(a,u)}else if(n-=s,a=l(a,u),u+1>c){if(--n>0)for(a+=".";n--;a+="0");}else if(n+=u-c,n>0)for(u+1==c&&(a+=".");n--;a+="0");return e.s<0&&o?"-"+a:a}function _(e,n){var t,r,i=0;for(u(e[0])&&(e=e[0]),t=new E(e[0]);++i<e.length;){if(r=new E(e[i]),!r.s){t=r;break}n.call(t,r)&&(t=r)}return t}function x(e,n,t,r,i){return(n>e||e>t||e!=c(e))&&L(r,(i||"decimal places")+(n>e||e>t?" out of range":" not an integer"),e),!0}function I(e,n,t){for(var r=1,i=n.length;!n[--i];n.pop());for(i=n[0];i>=10;i/=10,r++);return(t=r+t*O-1)>z?e.c=e.e=null:G>t?e.c=[e.e=0]:(e.e=t,e.c=n),e}function L(e,n,t){var r=new Error(["new BigNumber","cmp","config","div","divToInt","eq","gt","gte","lt","lte","minus","mod","plus","precision","random","round","shift","times","toDigits","toExponential","toFixed","toFormat","toFraction","pow","toPrecision","toString","BigNumber"][e]+"() "+n+": "+t);throw r.name="BigNumber Error",M=0,r}function U(e,n,t,r){var i,o,u,s,f,l,c,a=e.c,h=S;if(a){e:{for(i=1,s=a[0];s>=10;s/=10,i++);if(o=n-i,0>o)o+=O,u=n,f=a[l=0],c=f/h[i-u-1]%10|0;else if(l=p((o+1)/O),l>=a.length){if(!r)break e;for(;a.length<=l;a.push(0));f=c=0,i=1,o%=O,u=o-O+1}else{for(f=s=a[l],i=1;s>=10;s/=10,i++);o%=O,u=o-O+i,c=0>u?0:f/h[i-u-1]%10|0}if(r=r||0>n||null!=a[l+1]||(0>u?f:f%h[i-u-1]),r=4>t?(c||r)&&(0==t||t==(e.s<0?3:2)):c>5||5==c&&(4==t||r||6==t&&(o>0?u>0?f/h[i-u]:0:a[l-1])%10&1||t==(e.s<0?8:7)),1>n||!a[0])return a.length=0,r?(n-=e.e+1,a[0]=h[(O-n%O)%O],e.e=-n||0):a[0]=e.e=0,e;if(0==o?(a.length=l,s=1,l--):(a.length=l+1,s=h[O-o],a[l]=u>0?d(f/h[i-u]%h[u])*s:0),r)for(;;){if(0==l){for(o=1,u=a[0];u>=10;u/=10,o++);for(u=a[0]+=s,s=1;u>=10;u/=10,s++);o!=s&&(e.e++,a[0]==b&&(a[0]=1));break}if(a[l]+=s,a[l]!=b)break;a[l--]=0,s=1}for(o=a.length;0===a[--o];a.pop());}e.e>z?e.c=e.e=null:e.e<G&&(e.c=[e.e=0])}return e}var C,M=0,T=E.prototype,q=new E(1),P=20,k=4,B=-7,$=21,G=-1e7,z=1e7,j=!0,H=x,V=!1,W=1,J=100,X={decimalSeparator:".",groupSeparator:",",groupSize:3,secondaryGroupSize:0,fractionGroupSeparator:" ",fractionGroupSize:0};return E.another=n,E.ROUND_UP=0,E.ROUND_DOWN=1,E.ROUND_CEIL=2,E.ROUND_FLOOR=3,E.ROUND_HALF_UP=4,E.ROUND_HALF_DOWN=5,E.ROUND_HALF_EVEN=6,E.ROUND_HALF_CEIL=7,E.ROUND_HALF_FLOOR=8,E.EUCLID=9,E.config=function(){var e,n,t=0,r={},i=arguments,s=i[0],f=s&&"object"==typeof s?function(){return s.hasOwnProperty(n)?null!=(e=s[n]):void 0}:function(){return i.length>t?null!=(e=i[t++]):void 0};return f(n="DECIMAL_PLACES")&&H(e,0,A,2,n)&&(P=0|e),r[n]=P,f(n="ROUNDING_MODE")&&H(e,0,8,2,n)&&(k=0|e),r[n]=k,f(n="EXPONENTIAL_AT")&&(u(e)?H(e[0],-A,0,2,n)&&H(e[1],0,A,2,n)&&(B=0|e[0],$=0|e[1]):H(e,-A,A,2,n)&&(B=-($=0|(0>e?-e:e)))),r[n]=[B,$],f(n="RANGE")&&(u(e)?H(e[0],-A,-1,2,n)&&H(e[1],1,A,2,n)&&(G=0|e[0],z=0|e[1]):H(e,-A,A,2,n)&&(0|e?G=-(z=0|(0>e?-e:e)):j&&L(2,n+" cannot be zero",e))),r[n]=[G,z],f(n="ERRORS")&&(e===!!e||1===e||0===e?(M=0,H=(j=!!e)?x:o):j&&L(2,n+m,e)),r[n]=j,f(n="CRYPTO")&&(e===!!e||1===e||0===e?(V=!(!e||!a),e&&!V&&j&&L(2,"crypto unavailable",a)):j&&L(2,n+m,e)),r[n]=V,f(n="MODULO_MODE")&&H(e,0,9,2,n)&&(W=0|e),r[n]=W,f(n="POW_PRECISION")&&H(e,0,A,2,n)&&(J=0|e),r[n]=J,f(n="FORMAT")&&("object"==typeof e?X=e:j&&L(2,n+" not an object",e)),r[n]=X,r},E.max=function(){return _(arguments,T.lt)},E.min=function(){return _(arguments,T.gt)},E.random=function(){var e=9007199254740992,n=Math.random()*e&2097151?function(){return d(Math.random()*e)}:function(){return 8388608*(1073741824*Math.random()|0)+(8388608*Math.random()|0)};return function(e){var t,r,i,o,u,s=0,f=[],l=new E(q);if(e=null!=e&&H(e,0,A,14)?0|e:P,o=p(e/O),V)if(a&&a.getRandomValues){for(t=a.getRandomValues(new Uint32Array(o*=2));o>s;)u=131072*t[s]+(t[s+1]>>>11),u>=9e15?(r=a.getRandomValues(new Uint32Array(2)),t[s]=r[0],t[s+1]=r[1]):(f.push(u%1e14),s+=2);s=o/2}else if(a&&a.randomBytes){for(t=a.randomBytes(o*=7);o>s;)u=281474976710656*(31&t[s])+1099511627776*t[s+1]+4294967296*t[s+2]+16777216*t[s+3]+(t[s+4]<<16)+(t[s+5]<<8)+t[s+6],u>=9e15?a.randomBytes(7).copy(t,s):(f.push(u%1e14),s+=7);s=o/7}else j&&L(14,"crypto unavailable",a);if(!s)for(;o>s;)u=n(),9e15>u&&(f[s++]=u%1e14);for(o=f[--s],e%=O,o&&e&&(u=S[O-e],f[s]=d(o/u)*u);0===f[s];f.pop(),s--);if(0>s)f=[i=0];else{for(i=-1;0===f[0];f.shift(),i-=O);for(s=1,u=f[0];u>=10;u/=10,s++);O>s&&(i-=O-s)}return l.e=i,l.c=f,l}}(),C=function(){function e(e,n,t){var r,i,o,u,s=0,f=e.length,l=n%R,c=n/R|0;for(e=e.slice();f--;)o=e[f]%R,u=e[f]/R|0,r=c*o+u*l,i=l*o+r%R*R+s,s=(i/t|0)+(r/R|0)+c*u,e[f]=i%t;return s&&e.unshift(s),e}function n(e,n,t,r){var i,o;if(t!=r)o=t>r?1:-1;else for(i=o=0;t>i;i++)if(e[i]!=n[i]){o=e[i]>n[i]?1:-1;break}return o}function r(e,n,t,r){for(var i=0;t--;)e[t]-=i,i=e[t]<n[t]?1:0,e[t]=i*r+e[t]-n[t];for(;!e[0]&&e.length>1;e.shift());}return function(i,o,u,s,f){var l,c,a,h,g,p,m,w,v,N,y,S,R,A,D,F,_,x=i.s==o.s?1:-1,I=i.c,L=o.c;if(!(I&&I[0]&&L&&L[0]))return new E(i.s&&o.s&&(I?!L||I[0]!=L[0]:L)?I&&0==I[0]||!L?0*x:x/0:NaN);for(w=new E(x),v=w.c=[],c=i.e-o.e,x=u+c+1,f||(f=b,c=t(i.e/O)-t(o.e/O),x=x/O|0),a=0;L[a]==(I[a]||0);a++);if(L[a]>(I[a]||0)&&c--,0>x)v.push(1),h=!0;else{for(A=I.length,F=L.length,a=0,x+=2,g=d(f/(L[0]+1)),g>1&&(L=e(L,g,f),I=e(I,g,f),F=L.length,A=I.length),R=F,N=I.slice(0,F),y=N.length;F>y;N[y++]=0);_=L.slice(),_.unshift(0),D=L[0],L[1]>=f/2&&D++;do{if(g=0,l=n(L,N,F,y),0>l){if(S=N[0],F!=y&&(S=S*f+(N[1]||0)),g=d(S/D),g>1)for(g>=f&&(g=f-1),p=e(L,g,f),m=p.length,y=N.length;1==n(p,N,m,y);)g--,r(p,m>F?_:L,m,f),m=p.length,l=1;else 0==g&&(l=g=1),p=L.slice(),m=p.length;if(y>m&&p.unshift(0),r(N,p,y,f),y=N.length,-1==l)for(;n(L,N,F,y)<1;)g++,r(N,y>F?_:L,y,f),y=N.length}else 0===l&&(g++,N=[0]);v[a++]=g,N[0]?N[y++]=I[R]||0:(N=[I[R]],y=1)}while((R++<A||null!=N[0])&&x--);h=null!=N[0],v[0]||v.shift()}if(f==b){for(a=1,x=v[0];x>=10;x/=10,a++);U(w,u+(w.e=a+c*O-1)+1,s,h)}else w.e=c,w.r=+h;return w}}(),h=function(){var e=/^(-?)0([xbo])(?=\w[\w.]*$)/i,n=/^([^.]+)\.$/,t=/^\.([^.]+)$/,r=/^-?(Infinity|NaN)$/,i=/^\s*\+(?=[\w.])|^\s+|\s+$/g;return function(o,u,s,f){var l,c=s?u:u.replace(i,"");if(r.test(c))o.s=isNaN(c)?null:0>c?-1:1;else{if(!s&&(c=c.replace(e,function(e,n,t){return l="x"==(t=t.toLowerCase())?16:"b"==t?2:8,f&&f!=l?e:n}),f&&(l=f,c=c.replace(n,"$1").replace(t,"0.$1")),u!=c))return new E(c,l);j&&L(M,"not a"+(f?" base "+f:"")+" number",u),o.s=null}o.c=o.e=null,M=0}}(),T.absoluteValue=T.abs=function(){var e=new E(this);return e.s<0&&(e.s=1),e},T.ceil=function(){return U(new E(this),this.e+1,2)},T.comparedTo=T.cmp=function(e,n){return M=1,i(this,new E(e,n))},T.decimalPlaces=T.dp=function(){var e,n,r=this.c;if(!r)return null;if(e=((n=r.length-1)-t(this.e/O))*O,n=r[n])for(;n%10==0;n/=10,e--);return 0>e&&(e=0),e},T.dividedBy=T.div=function(e,n){return M=3,C(this,new E(e,n),P,k)},T.dividedToIntegerBy=T.divToInt=function(e,n){return M=4,C(this,new E(e,n),0,1)},T.equals=T.eq=function(e,n){return M=5,0===i(this,new E(e,n))},T.floor=function(){return U(new E(this),this.e+1,3)},T.greaterThan=T.gt=function(e,n){return M=6,i(this,new E(e,n))>0},T.greaterThanOrEqualTo=T.gte=function(e,n){return M=7,1===(n=i(this,new E(e,n)))||0===n},T.isFinite=function(){return!!this.c},T.isInteger=T.isInt=function(){return!!this.c&&t(this.e/O)>this.c.length-2},T.isNaN=function(){return!this.s},T.isNegative=T.isNeg=function(){return this.s<0},T.isZero=function(){return!!this.c&&0==this.c[0]},T.lessThan=T.lt=function(e,n){return M=8,i(this,new E(e,n))<0},T.lessThanOrEqualTo=T.lte=function(e,n){return M=9,-1===(n=i(this,new E(e,n)))||0===n},T.minus=T.sub=function(e,n){var r,i,o,u,s=this,f=s.s;if(M=10,e=new E(e,n),n=e.s,!f||!n)return new E(NaN);if(f!=n)return e.s=-n,s.plus(e);var l=s.e/O,c=e.e/O,a=s.c,h=e.c;if(!l||!c){if(!a||!h)return a?(e.s=-n,e):new E(h?s:NaN);if(!a[0]||!h[0])return h[0]?(e.s=-n,e):new E(a[0]?s:3==k?-0:0)}if(l=t(l),c=t(c),a=a.slice(),f=l-c){for((u=0>f)?(f=-f,o=a):(c=l,o=h),o.reverse(),n=f;n--;o.push(0));o.reverse()}else for(i=(u=(f=a.length)<(n=h.length))?f:n,f=n=0;i>n;n++)if(a[n]!=h[n]){u=a[n]<h[n];break}if(u&&(o=a,a=h,h=o,e.s=-e.s),n=(i=h.length)-(r=a.length),n>0)for(;n--;a[r++]=0);for(n=b-1;i>f;){if(a[--i]<h[i]){for(r=i;r&&!a[--r];a[r]=n);--a[r],a[i]+=b}a[i]-=h[i]}for(;0==a[0];a.shift(),--c);return a[0]?I(e,a,c):(e.s=3==k?-1:1,e.c=[e.e=0],e)},T.modulo=T.mod=function(e,n){var t,r,i=this;return M=11,e=new E(e,n),!i.c||!e.s||e.c&&!e.c[0]?new E(NaN):!e.c||i.c&&!i.c[0]?new E(i):(9==W?(r=e.s,e.s=1,t=C(i,e,0,3),e.s=r,t.s*=r):t=C(i,e,0,W),i.minus(t.times(e)))},T.negated=T.neg=function(){var e=new E(this);return e.s=-e.s||null,e},T.plus=T.add=function(e,n){var r,i=this,o=i.s;if(M=12,e=new E(e,n),n=e.s,!o||!n)return new E(NaN);if(o!=n)return e.s=-n,i.minus(e);var u=i.e/O,s=e.e/O,f=i.c,l=e.c;if(!u||!s){if(!f||!l)return new E(o/0);if(!f[0]||!l[0])return l[0]?e:new E(f[0]?i:0*o)}if(u=t(u),s=t(s),f=f.slice(),o=u-s){for(o>0?(s=u,r=l):(o=-o,r=f),r.reverse();o--;r.push(0));r.reverse()}for(o=f.length,n=l.length,0>o-n&&(r=l,l=f,f=r,n=o),o=0;n;)o=(f[--n]=f[n]+l[n]+o)/b|0,f[n]%=b;return o&&(f.unshift(o),++s),I(e,f,s)},T.precision=T.sd=function(e){var n,t,r=this,i=r.c;if(null!=e&&e!==!!e&&1!==e&&0!==e&&(j&&L(13,"argument"+m,e),e!=!!e&&(e=null)),!i)return null;if(t=i.length-1,n=t*O+1,t=i[t]){for(;t%10==0;t/=10,n--);for(t=i[0];t>=10;t/=10,n++);}return e&&r.e+1>n&&(n=r.e+1),n},T.round=function(e,n){var t=new E(this);return(null==e||H(e,0,A,15))&&U(t,~~e+this.e+1,null!=n&&H(n,0,8,15,w)?0|n:k),t},T.shift=function(e){var n=this;return H(e,-y,y,16,"argument")?n.times("1e"+c(e)):new E(n.c&&n.c[0]&&(-y>e||e>y)?n.s*(0>e?0:1/0):n)},T.squareRoot=T.sqrt=function(){var e,n,i,o,u,s=this,f=s.c,l=s.s,c=s.e,a=P+4,h=new E("0.5");if(1!==l||!f||!f[0])return new E(!l||0>l&&(!f||f[0])?NaN:f?s:1/0);if(l=Math.sqrt(+s),0==l||l==1/0?(n=r(f),(n.length+c)%2==0&&(n+="0"),l=Math.sqrt(n),c=t((c+1)/2)-(0>c||c%2),l==1/0?n="1e"+c:(n=l.toExponential(),n=n.slice(0,n.indexOf("e")+1)+c),i=new E(n)):i=new E(l+""),i.c[0])for(c=i.e,l=c+a,3>l&&(l=0);;)if(u=i,i=h.times(u.plus(C(s,u,a,1))),r(u.c).slice(0,l)===(n=r(i.c)).slice(0,l)){if(i.e<c&&--l,n=n.slice(l-3,l+1),"9999"!=n&&(o||"4999"!=n)){+n&&(+n.slice(1)||"5"!=n.charAt(0))||(U(i,i.e+P+2,1),e=!i.times(i).eq(s));break}if(!o&&(U(u,u.e+P+2,0),u.times(u).eq(s))){i=u;break}a+=4,l+=4,o=1}return U(i,i.e+P+1,k,e)},T.times=T.mul=function(e,n){var r,i,o,u,s,f,l,c,a,h,g,p,d,m,w,v=this,N=v.c,y=(M=17,e=new E(e,n)).c;if(!(N&&y&&N[0]&&y[0]))return!v.s||!e.s||N&&!N[0]&&!y||y&&!y[0]&&!N?e.c=e.e=e.s=null:(e.s*=v.s,N&&y?(e.c=[0],e.e=0):e.c=e.e=null),e;for(i=t(v.e/O)+t(e.e/O),e.s*=v.s,l=N.length,h=y.length,h>l&&(d=N,N=y,y=d,o=l,l=h,h=o),o=l+h,d=[];o--;d.push(0));for(m=b,w=R,o=h;--o>=0;){for(r=0,g=y[o]%w,p=y[o]/w|0,s=l,u=o+s;u>o;)c=N[--s]%w,a=N[s]/w|0,f=p*c+a*g,c=g*c+f%w*w+d[u]+r,r=(c/m|0)+(f/w|0)+p*a,d[u--]=c%m;d[u]=r}return r?++i:d.shift(),I(e,d,i)},T.toDigits=function(e,n){var t=new E(this);return e=null!=e&&H(e,1,A,18,"precision")?0|e:null,n=null!=n&&H(n,0,8,18,w)?0|n:k,e?U(t,e,n):t},T.toExponential=function(e,n){return F(this,null!=e&&H(e,0,A,19)?~~e+1:null,n,19)},T.toFixed=function(e,n){return F(this,null!=e&&H(e,0,A,20)?~~e+this.e+1:null,n,20)},T.toFormat=function(e,n){var t=F(this,null!=e&&H(e,0,A,21)?~~e+this.e+1:null,n,21);if(this.c){var r,i=t.split("."),o=+X.groupSize,u=+X.secondaryGroupSize,s=X.groupSeparator,f=i[0],l=i[1],c=this.s<0,a=c?f.slice(1):f,h=a.length;if(u&&(r=o,o=u,u=r,h-=r),o>0&&h>0){for(r=h%o||o,f=a.substr(0,r);h>r;r+=o)f+=s+a.substr(r,o);u>0&&(f+=s+a.slice(r)),c&&(f="-"+f)}t=l?f+X.decimalSeparator+((u=+X.fractionGroupSize)?l.replace(new RegExp("\\d{"+u+"}\\B","g"),"$&"+X.fractionGroupSeparator):l):f}return t},T.toFraction=function(e){var n,t,i,o,u,s,f,l,c,a=j,h=this,g=h.c,p=new E(q),d=t=new E(q),m=f=new E(q);if(null!=e&&(j=!1,s=new E(e),j=a,(a=s.isInt())&&!s.lt(q)||(j&&L(22,"max denominator "+(a?"out of range":"not an integer"),e),e=!a&&s.c&&U(s,s.e+1,1).gte(q)?s:null)),!g)return h.toString();for(c=r(g),o=p.e=c.length-h.e-1,p.c[0]=S[(u=o%O)<0?O+u:u],e=!e||s.cmp(p)>0?o>0?p:d:s,u=z,z=1/0,s=new E(c),f.c[0]=0;l=C(s,p,0,1),i=t.plus(l.times(m)),1!=i.cmp(e);)t=m,m=i,d=f.plus(l.times(i=d)),f=i,p=s.minus(l.times(i=p)),s=i;return i=C(e.minus(t),m,0,1),f=f.plus(i.times(d)),t=t.plus(i.times(m)),f.s=d.s=h.s,o*=2,n=C(d,m,o,k).minus(h).abs().cmp(C(f,t,o,k).minus(h).abs())<1?[d.toString(),m.toString()]:[f.toString(),t.toString()],z=u,n},T.toNumber=function(){return+this},T.toPower=T.pow=function(e){var n,t,r=d(0>e?-e:+e),i=this;if(!H(e,-y,y,23,"exponent")&&(!isFinite(e)||r>y&&(e/=0)||parseFloat(e)!=e&&!(e=NaN)))return new E(Math.pow(+i,e));for(n=J?p(J/O+2):0,t=new E(q);;){if(r%2){if(t=t.times(i),!t.c)break;n&&t.c.length>n&&(t.c.length=n)}if(r=d(r/2),!r)break;i=i.times(i),n&&i.c&&i.c.length>n&&(i.c.length=n)}return 0>e&&(t=q.div(t)),n?U(t,J,k):t},T.toPrecision=function(e,n){return F(this,null!=e&&H(e,1,A,24,"precision")?0|e:null,n,24)},T.toString=function(e){var n,t=this,i=t.s,o=t.e;return null===o?i?(n="Infinity",0>i&&(n="-"+n)):n="NaN":(n=r(t.c),n=null!=e&&H(e,2,64,25,"base")?D(l(n,o),0|e,10,i):B>=o||o>=$?f(n,o):l(n,o),0>i&&t.c[0]&&(n="-"+n)),n},T.truncated=T.trunc=function(){return U(new E(this),this.e+1,1)},T.valueOf=T.toJSON=function(){var e,n=this,t=n.e;return null===t?n.toString():(e=r(n.c),e=B>=t||t>=$?f(e,t):l(e,t),n.s<0?"-"+e:e)},null!=e&&E.config(e),E}function t(e){var n=0|e;return e>0||e===n?n:n-1}function r(e){for(var n,t,r=1,i=e.length,o=e[0]+"";i>r;){for(n=e[r++]+"",t=O-n.length;t--;n="0"+n);o+=n}for(i=o.length;48===o.charCodeAt(--i););return o.slice(0,i+1||1)}function i(e,n){var t,r,i=e.c,o=n.c,u=e.s,s=n.s,f=e.e,l=n.e;if(!u||!s)return null;if(t=i&&!i[0],r=o&&!o[0],t||r)return t?r?0:-s:u;if(u!=s)return u;if(t=0>u,r=f==l,!i||!o)return r?0:!i^t?1:-1;if(!r)return f>l^t?1:-1;for(s=(f=i.length)<(l=o.length)?f:l,u=0;s>u;u++)if(i[u]!=o[u])return i[u]>o[u]^t?1:-1;return f==l?0:f>l^t?1:-1}function o(e,n,t){return(e=c(e))>=n&&t>=e}function u(e){return"[object Array]"==Object.prototype.toString.call(e)}function s(e,n,t){for(var r,i,o=[0],u=0,s=e.length;s>u;){for(i=o.length;i--;o[i]*=n);for(o[r=0]+=N.indexOf(e.charAt(u++));r<o.length;r++)o[r]>t-1&&(null==o[r+1]&&(o[r+1]=0),o[r+1]+=o[r]/t|0,o[r]%=t)}return o.reverse()}function f(e,n){return(e.length>1?e.charAt(0)+"."+e.slice(1):e)+(0>n?"e":"e+")+n}function l(e,n){var t,r;if(0>n){for(r="0.";++n;r+="0");e=r+e}else if(t=e.length,++n>t){for(r="0",n-=t;--n;r+="0");e+=r}else t>n&&(e=e.slice(0,n)+"."+e.slice(n));return e}function c(e){return e=parseFloat(e),0>e?p(e):d(e)}var a,h,g=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,p=Math.ceil,d=Math.floor,m=" not a boolean or binary digit",w="rounding mode",v="number type has more than 15 significant digits",N="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_",b=1e14,O=14,y=9007199254740991,S=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],R=1e7,A=1e9;if("undefined"!=typeof crypto&&(a=crypto),"function"==typeof define&&define.amd)define(function(){return n()});else if("undefined"!=typeof module&&module.exports){if(module.exports=n(),!a)try{a=require("crypto")}catch(E){}}else e||(e="undefined"!=typeof self?self:Function("return this")()),e.BigNumber=n()}(this);


},{"crypto":undefined}],44:[function(require,module,exports){
(function (global){
"use strict";function typedArraySupport(){function t(){}try{var e=new Uint8Array(1);return e.foo=function(){return 42},e.constructor=t,42===e.foo()&&e.constructor===t&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(r){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Buffer(t){return this instanceof Buffer?(Buffer.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof t?fromNumber(this,t):"string"==typeof t?fromString(this,t,arguments.length>1?arguments[1]:"utf8"):fromObject(this,t)):arguments.length>1?new Buffer(t,arguments[1]):new Buffer(t)}function fromNumber(t,e){if(t=allocate(t,0>e?0:0|checked(e)),!Buffer.TYPED_ARRAY_SUPPORT)for(var r=0;e>r;r++)t[r]=0;return t}function fromString(t,e,r){"string"==typeof r&&""!==r||(r="utf8");var n=0|byteLength(e,r);return t=allocate(t,n),t.write(e,r),t}function fromObject(t,e){if(Buffer.isBuffer(e))return fromBuffer(t,e);if(isArray(e))return fromArray(t,e);if(null==e)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(e.buffer instanceof ArrayBuffer)return fromTypedArray(t,e);if(e instanceof ArrayBuffer)return fromArrayBuffer(t,e)}return e.length?fromArrayLike(t,e):fromJsonObject(t,e)}function fromBuffer(t,e){var r=0|checked(e.length);return t=allocate(t,r),e.copy(t,0,0,r),t}function fromArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;r>n;n+=1)t[n]=255&e[n];return t}function fromTypedArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;r>n;n+=1)t[n]=255&e[n];return t}function fromArrayBuffer(t,e){return Buffer.TYPED_ARRAY_SUPPORT?(e.byteLength,t=Buffer._augment(new Uint8Array(e))):t=fromTypedArray(t,new Uint8Array(e)),t}function fromArrayLike(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;r>n;n+=1)t[n]=255&e[n];return t}function fromJsonObject(t,e){var r,n=0;"Buffer"===e.type&&isArray(e.data)&&(r=e.data,n=0|checked(r.length)),t=allocate(t,n);for(var f=0;n>f;f+=1)t[f]=255&r[f];return t}function allocate(t,e){Buffer.TYPED_ARRAY_SUPPORT?(t=Buffer._augment(new Uint8Array(e)),t.__proto__=Buffer.prototype):(t.length=e,t._isBuffer=!0);var r=0!==e&&e<=Buffer.poolSize>>>1;return r&&(t.parent=rootParent),t}function checked(t){if(t>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|t}function SlowBuffer(t,e){if(!(this instanceof SlowBuffer))return new SlowBuffer(t,e);var r=new Buffer(t,e);return delete r.parent,r}function byteLength(t,e){"string"!=typeof t&&(t=""+t);var r=t.length;if(0===r)return 0;for(var n=!1;;)switch(e){case"ascii":case"binary":case"raw":case"raws":return r;case"utf8":case"utf-8":return utf8ToBytes(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return base64ToBytes(t).length;default:if(n)return utf8ToBytes(t).length;e=(""+e).toLowerCase(),n=!0}}function slowToString(t,e,r){var n=!1;if(e=0|e,r=void 0===r||r===1/0?this.length:0|r,t||(t="utf8"),0>e&&(e=0),r>this.length&&(r=this.length),e>=r)return"";for(;;)switch(t){case"hex":return hexSlice(this,e,r);case"utf8":case"utf-8":return utf8Slice(this,e,r);case"ascii":return asciiSlice(this,e,r);case"binary":return binarySlice(this,e,r);case"base64":return base64Slice(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function hexWrite(t,e,r,n){r=Number(r)||0;var f=t.length-r;n?(n=Number(n),n>f&&(n=f)):n=f;var i=e.length;if(i%2!==0)throw new Error("Invalid hex string");n>i/2&&(n=i/2);for(var o=0;n>o;o++){var u=parseInt(e.substr(2*o,2),16);if(isNaN(u))throw new Error("Invalid hex string");t[r+o]=u}return o}function utf8Write(t,e,r,n){return blitBuffer(utf8ToBytes(e,t.length-r),t,r,n)}function asciiWrite(t,e,r,n){return blitBuffer(asciiToBytes(e),t,r,n)}function binaryWrite(t,e,r,n){return asciiWrite(t,e,r,n)}function base64Write(t,e,r,n){return blitBuffer(base64ToBytes(e),t,r,n)}function ucs2Write(t,e,r,n){return blitBuffer(utf16leToBytes(e,t.length-r),t,r,n)}function base64Slice(t,e,r){return 0===e&&r===t.length?base64.fromByteArray(t):base64.fromByteArray(t.slice(e,r))}function utf8Slice(t,e,r){r=Math.min(t.length,r);for(var n=[],f=e;r>f;){var i=t[f],o=null,u=i>239?4:i>223?3:i>191?2:1;if(r>=f+u){var s,a,h,c;switch(u){case 1:128>i&&(o=i);break;case 2:s=t[f+1],128===(192&s)&&(c=(31&i)<<6|63&s,c>127&&(o=c));break;case 3:s=t[f+1],a=t[f+2],128===(192&s)&&128===(192&a)&&(c=(15&i)<<12|(63&s)<<6|63&a,c>2047&&(55296>c||c>57343)&&(o=c));break;case 4:s=t[f+1],a=t[f+2],h=t[f+3],128===(192&s)&&128===(192&a)&&128===(192&h)&&(c=(15&i)<<18|(63&s)<<12|(63&a)<<6|63&h,c>65535&&1114112>c&&(o=c))}}null===o?(o=65533,u=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),f+=u}return decodeCodePointsArray(n)}function decodeCodePointsArray(t){var e=t.length;if(MAX_ARGUMENTS_LENGTH>=e)return String.fromCharCode.apply(String,t);for(var r="",n=0;e>n;)r+=String.fromCharCode.apply(String,t.slice(n,n+=MAX_ARGUMENTS_LENGTH));return r}function asciiSlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;r>f;f++)n+=String.fromCharCode(127&t[f]);return n}function binarySlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;r>f;f++)n+=String.fromCharCode(t[f]);return n}function hexSlice(t,e,r){var n=t.length;(!e||0>e)&&(e=0),(!r||0>r||r>n)&&(r=n);for(var f="",i=e;r>i;i++)f+=toHex(t[i]);return f}function utf16leSlice(t,e,r){for(var n=t.slice(e,r),f="",i=0;i<n.length;i+=2)f+=String.fromCharCode(n[i]+256*n[i+1]);return f}function checkOffset(t,e,r){if(t%1!==0||0>t)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function checkInt(t,e,r,n,f,i){if(!Buffer.isBuffer(t))throw new TypeError("buffer must be a Buffer instance");if(e>f||i>e)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range")}function objectWriteUInt16(t,e,r,n){0>e&&(e=65535+e+1);for(var f=0,i=Math.min(t.length-r,2);i>f;f++)t[r+f]=(e&255<<8*(n?f:1-f))>>>8*(n?f:1-f)}function objectWriteUInt32(t,e,r,n){0>e&&(e=4294967295+e+1);for(var f=0,i=Math.min(t.length-r,4);i>f;f++)t[r+f]=e>>>8*(n?f:3-f)&255}function checkIEEE754(t,e,r,n,f,i){if(e>f||i>e)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range");if(0>r)throw new RangeError("index out of range")}function writeFloat(t,e,r,n,f){return f||checkIEEE754(t,e,r,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(t,e,r,n,23,4),r+4}function writeDouble(t,e,r,n,f){return f||checkIEEE754(t,e,r,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(t,e,r,n,52,8),r+8}function base64clean(t){if(t=stringtrim(t).replace(INVALID_BASE64_RE,""),t.length<2)return"";for(;t.length%4!==0;)t+="=";return t}function stringtrim(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function toHex(t){return 16>t?"0"+t.toString(16):t.toString(16)}function utf8ToBytes(t,e){e=e||1/0;for(var r,n=t.length,f=null,i=[],o=0;n>o;o++){if(r=t.charCodeAt(o),r>55295&&57344>r){if(!f){if(r>56319){(e-=3)>-1&&i.push(239,191,189);continue}if(o+1===n){(e-=3)>-1&&i.push(239,191,189);continue}f=r;continue}if(56320>r){(e-=3)>-1&&i.push(239,191,189),f=r;continue}r=(f-55296<<10|r-56320)+65536}else f&&(e-=3)>-1&&i.push(239,191,189);if(f=null,128>r){if((e-=1)<0)break;i.push(r)}else if(2048>r){if((e-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(65536>r){if((e-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(1114112>r))throw new Error("Invalid code point");if((e-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function asciiToBytes(t){for(var e=[],r=0;r<t.length;r++)e.push(255&t.charCodeAt(r));return e}function utf16leToBytes(t,e){for(var r,n,f,i=[],o=0;o<t.length&&!((e-=2)<0);o++)r=t.charCodeAt(o),n=r>>8,f=r%256,i.push(f),i.push(n);return i}function base64ToBytes(t){return base64.toByteArray(base64clean(t))}function blitBuffer(t,e,r,n){for(var f=0;n>f&&!(f+r>=e.length||f>=t.length);f++)e[f+r]=t[f];return f}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var rootParent={};Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT?(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array):(Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0),Buffer.isBuffer=function(t){return!(null==t||!t._isBuffer)},Buffer.compare=function(t,e){if(!Buffer.isBuffer(t)||!Buffer.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var r=t.length,n=e.length,f=0,i=Math.min(r,n);i>f&&t[f]===e[f];)++f;return f!==i&&(r=t[f],n=e[f]),n>r?-1:r>n?1:0},Buffer.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(t,e){if(!isArray(t))throw new TypeError("list argument must be an Array of Buffers.");if(0===t.length)return new Buffer(0);var r;if(void 0===e)for(e=0,r=0;r<t.length;r++)e+=t[r].length;var n=new Buffer(e),f=0;for(r=0;r<t.length;r++){var i=t[r];i.copy(n,f),f+=i.length}return n},Buffer.byteLength=byteLength,Buffer.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?utf8Slice(this,0,t):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:0===Buffer.compare(this,t)},Buffer.prototype.inspect=function(){var t="",e=exports.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,e).match(/.{2}/g).join(" "),this.length>e&&(t+=" ... ")),"<Buffer "+t+">"},Buffer.prototype.compare=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?0:Buffer.compare(this,t)},Buffer.prototype.indexOf=function(t,e){function r(t,e,r){for(var n=-1,f=0;r+f<t.length;f++)if(t[r+f]===e[-1===n?0:f-n]){if(-1===n&&(n=f),f-n+1===e.length)return r+n}else n=-1;return-1}if(e>2147483647?e=2147483647:-2147483648>e&&(e=-2147483648),e>>=0,0===this.length)return-1;if(e>=this.length)return-1;if(0>e&&(e=Math.max(this.length+e,0)),"string"==typeof t)return 0===t.length?-1:String.prototype.indexOf.call(this,t,e);if(Buffer.isBuffer(t))return r(this,t,e);if("number"==typeof t)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,t,e):r(this,[t],e);throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.get=function(t){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(t)},Buffer.prototype.set=function(t,e){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(t,e)},Buffer.prototype.write=function(t,e,r,n){if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else if(isFinite(e))e=0|e,isFinite(r)?(r=0|r,void 0===n&&(n="utf8")):(n=r,r=void 0);else{var f=n;n=e,e=0|r,r=f}var i=this.length-e;if((void 0===r||r>i)&&(r=i),t.length>0&&(0>r||0>e)||e>this.length)throw new RangeError("attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return hexWrite(this,t,e,r);case"utf8":case"utf-8":return utf8Write(this,t,e,r);case"ascii":return asciiWrite(this,t,e,r);case"binary":return binaryWrite(this,t,e,r);case"base64":return base64Write(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(t,e){var r=this.length;t=~~t,e=void 0===e?r:~~e,0>t?(t+=r,0>t&&(t=0)):t>r&&(t=r),0>e?(e+=r,0>e&&(e=0)):e>r&&(e=r),t>e&&(e=t);var n;if(Buffer.TYPED_ARRAY_SUPPORT)n=Buffer._augment(this.subarray(t,e));else{var f=e-t;n=new Buffer(f,void 0);for(var i=0;f>i;i++)n[i]=this[i+t]}return n.length&&(n.parent=this.parent||this),n},Buffer.prototype.readUIntLE=function(t,e,r){t=0|t,e=0|e,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return n},Buffer.prototype.readUIntBE=function(t,e,r){t=0|t,e=0|e,r||checkOffset(t,e,this.length);for(var n=this[t+--e],f=1;e>0&&(f*=256);)n+=this[t+--e]*f;return n},Buffer.prototype.readUInt8=function(t,e){return e||checkOffset(t,1,this.length),this[t]},Buffer.prototype.readUInt16LE=function(t,e){return e||checkOffset(t,2,this.length),this[t]|this[t+1]<<8},Buffer.prototype.readUInt16BE=function(t,e){return e||checkOffset(t,2,this.length),this[t]<<8|this[t+1]},Buffer.prototype.readUInt32LE=function(t,e){return e||checkOffset(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},Buffer.prototype.readUInt32BE=function(t,e){return e||checkOffset(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},Buffer.prototype.readIntLE=function(t,e,r){t=0|t,e=0|e,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return f*=128,n>=f&&(n-=Math.pow(2,8*e)),n},Buffer.prototype.readIntBE=function(t,e,r){t=0|t,e=0|e,r||checkOffset(t,e,this.length);for(var n=e,f=1,i=this[t+--n];n>0&&(f*=256);)i+=this[t+--n]*f;return f*=128,i>=f&&(i-=Math.pow(2,8*e)),i},Buffer.prototype.readInt8=function(t,e){return e||checkOffset(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},Buffer.prototype.readInt16LE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt16BE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt32LE=function(t,e){return e||checkOffset(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},Buffer.prototype.readInt32BE=function(t,e){return e||checkOffset(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},Buffer.prototype.readFloatLE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!0,23,4)},Buffer.prototype.readFloatBE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!1,23,4)},Buffer.prototype.readDoubleLE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!0,52,8)},Buffer.prototype.readDoubleBE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!1,52,8)},Buffer.prototype.writeUIntLE=function(t,e,r,n){t=+t,e=0|e,r=0|r,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=1,i=0;for(this[e]=255&t;++i<r&&(f*=256);)this[e+i]=t/f&255;return e+r},Buffer.prototype.writeUIntBE=function(t,e,r,n){t=+t,e=0|e,r=0|r,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=r-1,i=1;for(this[e+f]=255&t;--f>=0&&(i*=256);)this[e+f]=t/i&255;return e+r},Buffer.prototype.writeUInt8=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},Buffer.prototype.writeUInt16LE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeUInt16BE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeUInt32LE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeUInt32BE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeIntLE=function(t,e,r,n){if(t=+t,e=0|e,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=0,o=1,u=0>t?1:0;for(this[e]=255&t;++i<r&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeIntBE=function(t,e,r,n){if(t=+t,e=0|e,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=r-1,o=1,u=0>t?1:0;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeInt8=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),0>t&&(t=255+t+1),this[e]=255&t,e+1},Buffer.prototype.writeInt16LE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeInt16BE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeInt32LE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeInt32BE=function(t,e,r){return t=+t,e=0|e,r||checkInt(this,t,e,4,2147483647,-2147483648),0>t&&(t=4294967295+t+1),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeFloatLE=function(t,e,r){return writeFloat(this,t,e,!0,r)},Buffer.prototype.writeFloatBE=function(t,e,r){return writeFloat(this,t,e,!1,r)},Buffer.prototype.writeDoubleLE=function(t,e,r){return writeDouble(this,t,e,!0,r)},Buffer.prototype.writeDoubleBE=function(t,e,r){return writeDouble(this,t,e,!1,r)},Buffer.prototype.copy=function(t,e,r,n){if(r||(r=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&r>n&&(n=r),n===r)return 0;if(0===t.length||0===this.length)return 0;if(0>e)throw new RangeError("targetStart out of bounds");if(0>r||r>=this.length)throw new RangeError("sourceStart out of bounds");if(0>n)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r);var f,i=n-r;if(this===t&&e>r&&n>e)for(f=i-1;f>=0;f--)t[f+e]=this[f+r];else if(1e3>i||!Buffer.TYPED_ARRAY_SUPPORT)for(f=0;i>f;f++)t[f+e]=this[f+r];else t._set(this.subarray(r,r+i),e);return i},Buffer.prototype.fill=function(t,e,r){if(t||(t=0),e||(e=0),r||(r=this.length),e>r)throw new RangeError("end < start");if(r!==e&&0!==this.length){if(0>e||e>=this.length)throw new RangeError("start out of bounds");if(0>r||r>this.length)throw new RangeError("end out of bounds");var n;if("number"==typeof t)for(n=e;r>n;n++)this[n]=t;else{var f=utf8ToBytes(t.toString()),i=f.length;for(n=e;r>n;n++)this[n]=f[n%i]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var t=new Uint8Array(this.length),e=0,r=t.length;r>e;e+=1)t[e]=this[e];return t.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(t){return t.constructor=Buffer,t._isBuffer=!0,t._set=t.set,t.get=BP.get,t.set=BP.set,t.write=BP.write,t.toString=BP.toString,t.toLocaleString=BP.toString,t.toJSON=BP.toJSON,t.equals=BP.equals,t.compare=BP.compare,t.indexOf=BP.indexOf,t.copy=BP.copy,t.slice=BP.slice,t.readUIntLE=BP.readUIntLE,t.readUIntBE=BP.readUIntBE,t.readUInt8=BP.readUInt8,t.readUInt16LE=BP.readUInt16LE,t.readUInt16BE=BP.readUInt16BE,t.readUInt32LE=BP.readUInt32LE,t.readUInt32BE=BP.readUInt32BE,t.readIntLE=BP.readIntLE,t.readIntBE=BP.readIntBE,t.readInt8=BP.readInt8,t.readInt16LE=BP.readInt16LE,t.readInt16BE=BP.readInt16BE,t.readInt32LE=BP.readInt32LE,t.readInt32BE=BP.readInt32BE,t.readFloatLE=BP.readFloatLE,t.readFloatBE=BP.readFloatBE,t.readDoubleLE=BP.readDoubleLE,t.readDoubleBE=BP.readDoubleBE,t.writeUInt8=BP.writeUInt8,t.writeUIntLE=BP.writeUIntLE,t.writeUIntBE=BP.writeUIntBE,t.writeUInt16LE=BP.writeUInt16LE,t.writeUInt16BE=BP.writeUInt16BE,t.writeUInt32LE=BP.writeUInt32LE,t.writeUInt32BE=BP.writeUInt32BE,t.writeIntLE=BP.writeIntLE,t.writeIntBE=BP.writeIntBE,t.writeInt8=BP.writeInt8,t.writeInt16LE=BP.writeInt16LE,t.writeInt16BE=BP.writeInt16BE,t.writeInt32LE=BP.writeInt32LE,t.writeInt32BE=BP.writeInt32BE,t.writeFloatLE=BP.writeFloatLE,t.writeFloatBE=BP.writeFloatBE,t.writeDoubleLE=BP.writeDoubleLE,t.writeDoubleBE=BP.writeDoubleBE,t.fill=BP.fill,t.inspect=BP.inspect,t.toArrayBuffer=BP.toArrayBuffer,t};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;


}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"base64-js":42,"ieee754":118,"isarray":45}],45:[function(require,module,exports){
var toString={}.toString;module.exports=Array.isArray||function(r){return"[object Array]"==toString.call(r)};


},{}],46:[function(require,module,exports){
require("../modules/es6.object.to-string"),require("../modules/es6.string.iterator"),require("../modules/web.dom.iterable"),require("../modules/es6.set"),module.exports=require("../modules/$.core").Set;


},{"../modules/$.core":60,"../modules/es6.object.to-string":108,"../modules/es6.set":109,"../modules/es6.string.iterator":111,"../modules/web.dom.iterable":113}],47:[function(require,module,exports){
require("../modules/es6.symbol"),require("../modules/es6.object.to-string"),module.exports=require("../modules/$.core").Symbol;


},{"../modules/$.core":60,"../modules/es6.object.to-string":108,"../modules/es6.symbol":112}],48:[function(require,module,exports){
require("../../modules/es6.string.iterator"),require("../../modules/es6.array.from"),module.exports=require("../../modules/$.core").Array.from;


},{"../../modules/$.core":60,"../../modules/es6.array.from":104,"../../modules/es6.string.iterator":111}],49:[function(require,module,exports){
require("../../modules/es6.array.of"),module.exports=require("../../modules/$.core").Array.of;


},{"../../modules/$.core":60,"../../modules/es6.array.of":106}],50:[function(require,module,exports){
require("../../modules/es6.object.is"),module.exports=require("../../modules/$.core").Object.is;


},{"../../modules/$.core":60,"../../modules/es6.object.is":107}],51:[function(require,module,exports){
require("../../modules/es6.string.includes"),module.exports=require("../../modules/$.core").String.includes;


},{"../../modules/$.core":60,"../../modules/es6.string.includes":110}],52:[function(require,module,exports){
require("../../modules/es6.string.iterator"),require("../../modules/web.dom.iterable"),module.exports=require("../../modules/$.wks")("iterator");


},{"../../modules/$.wks":102,"../../modules/es6.string.iterator":111,"../../modules/web.dom.iterable":113}],53:[function(require,module,exports){
module.exports=function(o){if("function"!=typeof o)throw TypeError(o+" is not a function!");return o};


},{}],54:[function(require,module,exports){
var UNSCOPABLES=require("./$.wks")("unscopables"),ArrayProto=Array.prototype;void 0==ArrayProto[UNSCOPABLES]&&require("./$.hide")(ArrayProto,UNSCOPABLES,{}),module.exports=function(r){ArrayProto[UNSCOPABLES][r]=!0};


},{"./$.hide":72,"./$.wks":102}],55:[function(require,module,exports){
var isObject=require("./$.is-object");module.exports=function(e){if(!isObject(e))throw TypeError(e+" is not an object!");return e};


},{"./$.is-object":76}],56:[function(require,module,exports){
var cof=require("./$.cof"),TAG=require("./$.wks")("toStringTag"),ARG="Arguments"==cof(function(){return arguments}());module.exports=function(e){var n,r,t;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=(n=Object(e))[TAG])?r:ARG?cof(n):"Object"==(t=cof(n))&&"function"==typeof n.callee?"Arguments":t};


},{"./$.cof":57,"./$.wks":102}],57:[function(require,module,exports){
var toString={}.toString;module.exports=function(t){return toString.call(t).slice(8,-1)};


},{}],58:[function(require,module,exports){
"use strict";var $=require("./$"),hide=require("./$.hide"),redefineAll=require("./$.redefine-all"),ctx=require("./$.ctx"),strictNew=require("./$.strict-new"),defined=require("./$.defined"),forOf=require("./$.for-of"),$iterDefine=require("./$.iter-define"),step=require("./$.iter-step"),ID=require("./$.uid")("id"),$has=require("./$.has"),isObject=require("./$.is-object"),setSpecies=require("./$.set-species"),DESCRIPTORS=require("./$.descriptors"),isExtensible=Object.isExtensible||isObject,SIZE=DESCRIPTORS?"_s":"size",id=0,fastKey=function(e,t){if(!isObject(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!$has(e,ID)){if(!isExtensible(e))return"F";if(!t)return"E";hide(e,ID,++id)}return"O"+e[ID]},getEntry=function(e,t){var r,i=fastKey(t);if("F"!==i)return e._i[i];for(r=e._f;r;r=r.n)if(r.k==t)return r};module.exports={getConstructor:function(e,t,r,i){var n=e(function(e,s){strictNew(e,n,t),e._i=$.create(null),e._f=void 0,e._l=void 0,e[SIZE]=0,void 0!=s&&forOf(s,r,e[i],e)});return redefineAll(n.prototype,{clear:function(){for(var e=this,t=e._i,r=e._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete t[r.i];e._f=e._l=void 0,e[SIZE]=0},"delete":function(e){var t=this,r=getEntry(t,e);if(r){var i=r.n,n=r.p;delete t._i[r.i],r.r=!0,n&&(n.n=i),i&&(i.p=n),t._f==r&&(t._f=i),t._l==r&&(t._l=n),t[SIZE]--}return!!r},forEach:function(e){for(var t,r=ctx(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.n:this._f;)for(r(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!getEntry(this,e)}}),DESCRIPTORS&&$.setDesc(n.prototype,"size",{get:function(){return defined(this[SIZE])}}),n},def:function(e,t,r){var i,n,s=getEntry(e,t);return s?s.v=r:(e._l=s={i:n=fastKey(t,!0),k:t,v:r,p:i=e._l,n:void 0,r:!1},e._f||(e._f=s),i&&(i.n=s),e[SIZE]++,"F"!==n&&(e._i[n]=s)),e},getEntry:getEntry,setStrong:function(e,t,r){$iterDefine(e,t,function(e,t){this._t=e,this._k=t,this._l=void 0},function(){for(var e=this,t=e._k,r=e._l;r&&r.r;)r=r.p;return e._t&&(e._l=r=r?r.n:e._t._f)?"keys"==t?step(0,r.k):"values"==t?step(0,r.v):step(0,[r.k,r.v]):(e._t=void 0,step(1))},r?"entries":"values",!r,!0),setSpecies(t)}};


},{"./$":84,"./$.ctx":61,"./$.defined":62,"./$.descriptors":63,"./$.for-of":68,"./$.has":71,"./$.hide":72,"./$.is-object":76,"./$.iter-define":80,"./$.iter-step":82,"./$.redefine-all":88,"./$.set-species":91,"./$.strict-new":94,"./$.uid":101}],59:[function(require,module,exports){
"use strict";var global=require("./$.global"),$export=require("./$.export"),redefine=require("./$.redefine"),redefineAll=require("./$.redefine-all"),forOf=require("./$.for-of"),strictNew=require("./$.strict-new"),isObject=require("./$.is-object"),fails=require("./$.fails"),$iterDetect=require("./$.iter-detect"),setToStringTag=require("./$.set-to-string-tag");module.exports=function(e,t,r,i,n,o){var c=global[e],s=c,u=n?"set":"add",f=s&&s.prototype,l={},a=function(e){var t=f[e];redefine(f,e,"delete"==e?function(e){return o&&!isObject(e)?!1:t.call(this,0===e?0:e)}:"has"==e?function(e){return o&&!isObject(e)?!1:t.call(this,0===e?0:e)}:"get"==e?function(e){return o&&!isObject(e)?void 0:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,r){return t.call(this,0===e?0:e,r),this})};if("function"==typeof s&&(o||f.forEach&&!fails(function(){(new s).entries().next()}))){var d,$=new s,p=$[u](o?{}:-0,1)!=$,g=fails(function(){$.has(1)}),h=$iterDetect(function(e){new s(e)});h||(s=t(function(t,r){strictNew(t,s,e);var i=new c;return void 0!=r&&forOf(r,n,i[u],i),i}),s.prototype=f,f.constructor=s),o||$.forEach(function(e,t){d=1/t===-(1/0)}),(g||d)&&(a("delete"),a("has"),n&&a("get")),(d||p)&&a(u),o&&f.clear&&delete f.clear}else s=i.getConstructor(t,e,n,u),redefineAll(s.prototype,r);return setToStringTag(s,e),l[e]=s,$export($export.G+$export.W+$export.F*(s!=c),l),o||i.setStrong(s,e,n),s};


},{"./$.export":65,"./$.fails":67,"./$.for-of":68,"./$.global":70,"./$.is-object":76,"./$.iter-detect":81,"./$.redefine":89,"./$.redefine-all":88,"./$.set-to-string-tag":92,"./$.strict-new":94}],60:[function(require,module,exports){
var core=module.exports={version:"1.2.6"};"number"==typeof __e&&(__e=core);


},{}],61:[function(require,module,exports){
var aFunction=require("./$.a-function");module.exports=function(n,r,t){if(aFunction(n),void 0===r)return n;switch(t){case 1:return function(t){return n.call(r,t)};case 2:return function(t,u){return n.call(r,t,u)};case 3:return function(t,u,e){return n.call(r,t,u,e)}}return function(){return n.apply(r,arguments)}};


},{"./$.a-function":53}],62:[function(require,module,exports){
module.exports=function(o){if(void 0==o)throw TypeError("Can't call method on  "+o);return o};


},{}],63:[function(require,module,exports){
module.exports=!require("./$.fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a});


},{"./$.fails":67}],64:[function(require,module,exports){
var $=require("./$");module.exports=function(e){var r=$.getKeys(e),t=$.getSymbols;if(t)for(var u,l=t(e),n=$.isEnum,o=0;l.length>o;)n.call(e,u=l[o++])&&r.push(u);return r};


},{"./$":84}],65:[function(require,module,exports){
var global=require("./$.global"),core=require("./$.core"),hide=require("./$.hide"),redefine=require("./$.redefine"),ctx=require("./$.ctx"),PROTOTYPE="prototype",$export=function(e,r,o){var t,l,x,$,p=e&$export.F,i=e&$export.G,c=e&$export.S,a=e&$export.P,n=e&$export.B,P=i?global:c?global[r]||(global[r]={}):(global[r]||{})[PROTOTYPE],u=i?core:core[r]||(core[r]={}),b=u[PROTOTYPE]||(u[PROTOTYPE]={});i&&(o=r);for(t in o)l=!p&&P&&t in P,x=(l?P:o)[t],$=n&&l?ctx(x,global):a&&"function"==typeof x?ctx(Function.call,x):x,P&&!l&&redefine(P,t,x),u[t]!=x&&hide(u,t,$),a&&b[t]!=x&&(b[t]=x)};global.core=core,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,module.exports=$export;


},{"./$.core":60,"./$.ctx":61,"./$.global":70,"./$.hide":72,"./$.redefine":89}],66:[function(require,module,exports){
var MATCH=require("./$.wks")("match");module.exports=function(r){var t=/./;try{"/./"[r](t)}catch(c){try{return t[MATCH]=!1,!"/./"[r](t)}catch(e){}}return!0};


},{"./$.wks":102}],67:[function(require,module,exports){
module.exports=function(r){try{return!!r()}catch(t){return!0}};


},{}],68:[function(require,module,exports){
var ctx=require("./$.ctx"),call=require("./$.iter-call"),isArrayIter=require("./$.is-array-iter"),anObject=require("./$.an-object"),toLength=require("./$.to-length"),getIterFn=require("./core.get-iterator-method");module.exports=function(e,r,t,i){var o,a,n,l=getIterFn(e),c=ctx(t,i,r?2:1),u=0;if("function"!=typeof l)throw TypeError(e+" is not iterable!");if(isArrayIter(l))for(o=toLength(e.length);o>u;u++)r?c(anObject(a=e[u])[0],a[1]):c(e[u]);else for(n=l.call(e);!(a=n.next()).done;)call(n,c,a.value,r)};


},{"./$.an-object":55,"./$.ctx":61,"./$.is-array-iter":74,"./$.iter-call":78,"./$.to-length":99,"./core.get-iterator-method":103}],69:[function(require,module,exports){
var toIObject=require("./$.to-iobject"),getNames=require("./$").getNames,toString={}.toString,windowNames="object"==typeof window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],getWindowNames=function(e){try{return getNames(e)}catch(t){return windowNames.slice()}};module.exports.get=function(e){return windowNames&&"[object Window]"==toString.call(e)?getWindowNames(e):getNames(toIObject(e))};


},{"./$":84,"./$.to-iobject":98}],70:[function(require,module,exports){
var global=module.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=global);


},{}],71:[function(require,module,exports){
var hasOwnProperty={}.hasOwnProperty;module.exports=function(r,e){return hasOwnProperty.call(r,e)};


},{}],72:[function(require,module,exports){
var $=require("./$"),createDesc=require("./$.property-desc");module.exports=require("./$.descriptors")?function(e,r,t){return $.setDesc(e,r,createDesc(1,t))}:function(e,r,t){return e[r]=t,e};


},{"./$":84,"./$.descriptors":63,"./$.property-desc":87}],73:[function(require,module,exports){
var cof=require("./$.cof");module.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==cof(e)?e.split(""):Object(e)};


},{"./$.cof":57}],74:[function(require,module,exports){
var Iterators=require("./$.iterators"),ITERATOR=require("./$.wks")("iterator"),ArrayProto=Array.prototype;module.exports=function(r){return void 0!==r&&(Iterators.Array===r||ArrayProto[ITERATOR]===r)};


},{"./$.iterators":83,"./$.wks":102}],75:[function(require,module,exports){
var cof=require("./$.cof");module.exports=Array.isArray||function(r){return"Array"==cof(r)};


},{"./$.cof":57}],76:[function(require,module,exports){
module.exports=function(o){return"object"==typeof o?null!==o:"function"==typeof o};


},{}],77:[function(require,module,exports){
var isObject=require("./$.is-object"),cof=require("./$.cof"),MATCH=require("./$.wks")("match");module.exports=function(e){var r;return isObject(e)&&(void 0!==(r=e[MATCH])?!!r:"RegExp"==cof(e))};


},{"./$.cof":57,"./$.is-object":76,"./$.wks":102}],78:[function(require,module,exports){
var anObject=require("./$.an-object");module.exports=function(r,t,e,a){try{return a?t(anObject(e)[0],e[1]):t(e)}catch(c){var n=r["return"];throw void 0!==n&&anObject(n.call(r)),c}};


},{"./$.an-object":55}],79:[function(require,module,exports){
"use strict";var $=require("./$"),descriptor=require("./$.property-desc"),setToStringTag=require("./$.set-to-string-tag"),IteratorPrototype={};require("./$.hide")(IteratorPrototype,require("./$.wks")("iterator"),function(){return this}),module.exports=function(r,t,e){r.prototype=$.create(IteratorPrototype,{next:descriptor(1,e)}),setToStringTag(r,t+" Iterator")};


},{"./$":84,"./$.hide":72,"./$.property-desc":87,"./$.set-to-string-tag":92,"./$.wks":102}],80:[function(require,module,exports){
"use strict";var LIBRARY=require("./$.library"),$export=require("./$.export"),redefine=require("./$.redefine"),hide=require("./$.hide"),has=require("./$.has"),Iterators=require("./$.iterators"),$iterCreate=require("./$.iter-create"),setToStringTag=require("./$.set-to-string-tag"),getProto=require("./$").getProto,ITERATOR=require("./$.wks")("iterator"),BUGGY=!([].keys&&"next"in[].keys()),FF_ITERATOR="@@iterator",KEYS="keys",VALUES="values",returnThis=function(){return this};module.exports=function(e,r,t,i,n,s,u){$iterCreate(t,r,i);var o,a,T=function(e){if(!BUGGY&&e in E)return E[e];switch(e){case KEYS:return function(){return new t(this,e)};case VALUES:return function(){return new t(this,e)}}return function(){return new t(this,e)}},R=r+" Iterator",h=n==VALUES,A=!1,E=e.prototype,$=E[ITERATOR]||E[FF_ITERATOR]||n&&E[n],f=$||T(n);if($){var I=getProto(f.call(new e));setToStringTag(I,R,!0),!LIBRARY&&has(E,FF_ITERATOR)&&hide(I,ITERATOR,returnThis),h&&$.name!==VALUES&&(A=!0,f=function(){return $.call(this)})}if(LIBRARY&&!u||!BUGGY&&!A&&E[ITERATOR]||hide(E,ITERATOR,f),Iterators[r]=f,Iterators[R]=returnThis,n)if(o={values:h?f:T(VALUES),keys:s?f:T(KEYS),entries:h?T("entries"):f},u)for(a in o)a in E||redefine(E,a,o[a]);else $export($export.P+$export.F*(BUGGY||A),r,o);return o};


},{"./$":84,"./$.export":65,"./$.has":71,"./$.hide":72,"./$.iter-create":79,"./$.iterators":83,"./$.library":86,"./$.redefine":89,"./$.set-to-string-tag":92,"./$.wks":102}],81:[function(require,module,exports){
var ITERATOR=require("./$.wks")("iterator"),SAFE_CLOSING=!1;try{var riter=[7][ITERATOR]();riter["return"]=function(){SAFE_CLOSING=!0},Array.from(riter,function(){throw 2})}catch(e){}module.exports=function(r,t){if(!t&&!SAFE_CLOSING)return!1;var n=!1;try{var e=[7],i=e[ITERATOR]();i.next=function(){n=!0},e[ITERATOR]=function(){return i},r(e)}catch(u){}return n};


},{"./$.wks":102}],82:[function(require,module,exports){
module.exports=function(e,n){return{value:n,done:!!e}};


},{}],83:[function(require,module,exports){
module.exports={};


},{}],84:[function(require,module,exports){
var $Object=Object;module.exports={create:$Object.create,getProto:$Object.getPrototypeOf,isEnum:{}.propertyIsEnumerable,getDesc:$Object.getOwnPropertyDescriptor,setDesc:$Object.defineProperty,setDescs:$Object.defineProperties,getKeys:$Object.keys,getNames:$Object.getOwnPropertyNames,getSymbols:$Object.getOwnPropertySymbols,each:[].forEach};


},{}],85:[function(require,module,exports){
var $=require("./$"),toIObject=require("./$.to-iobject");module.exports=function(e,t){for(var r,o=toIObject(e),i=$.getKeys(o),u=i.length,c=0;u>c;)if(o[r=i[c++]]===t)return r};


},{"./$":84,"./$.to-iobject":98}],86:[function(require,module,exports){
module.exports=!1;


},{}],87:[function(require,module,exports){
module.exports=function(e,r){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:r}};


},{}],88:[function(require,module,exports){
var redefine=require("./$.redefine");module.exports=function(e,r){for(var n in r)redefine(e,n,r[n]);return e};


},{"./$.redefine":89}],89:[function(require,module,exports){
var global=require("./$.global"),hide=require("./$.hide"),SRC=require("./$.uid")("src"),TO_STRING="toString",$toString=Function[TO_STRING],TPL=(""+$toString).split(TO_STRING);require("./$.core").inspectSource=function(t){return $toString.call(t)},(module.exports=function(t,e,i,n){"function"==typeof i&&(i.hasOwnProperty(SRC)||hide(i,SRC,t[e]?""+t[e]:TPL.join(String(e))),i.hasOwnProperty("name")||hide(i,"name",e)),t===global?t[e]=i:(n||delete t[e],hide(t,e,i))})(Function.prototype,TO_STRING,function(){return"function"==typeof this&&this[SRC]||$toString.call(this)});


},{"./$.core":60,"./$.global":70,"./$.hide":72,"./$.uid":101}],90:[function(require,module,exports){
module.exports=Object.is||function(e,t){return e===t?0!==e||1/e===1/t:e!=e&&t!=t};


},{}],91:[function(require,module,exports){
"use strict";var global=require("./$.global"),$=require("./$"),DESCRIPTORS=require("./$.descriptors"),SPECIES=require("./$.wks")("species");module.exports=function(e){var r=global[e];DESCRIPTORS&&r&&!r[SPECIES]&&$.setDesc(r,SPECIES,{configurable:!0,get:function(){return this}})};


},{"./$":84,"./$.descriptors":63,"./$.global":70,"./$.wks":102}],92:[function(require,module,exports){
var def=require("./$").setDesc,has=require("./$.has"),TAG=require("./$.wks")("toStringTag");module.exports=function(e,r,a){e&&!has(e=a?e:e.prototype,TAG)&&def(e,TAG,{configurable:!0,value:r})};


},{"./$":84,"./$.has":71,"./$.wks":102}],93:[function(require,module,exports){
var global=require("./$.global"),SHARED="__core-js_shared__",store=global[SHARED]||(global[SHARED]={});module.exports=function(o){return store[o]||(store[o]={})};


},{"./$.global":70}],94:[function(require,module,exports){
module.exports=function(e,r,o){if(!(e instanceof r))throw TypeError(o+": use the 'new' operator!");return e};


},{}],95:[function(require,module,exports){
var toInteger=require("./$.to-integer"),defined=require("./$.defined");module.exports=function(e){return function(r,t){var n,i,d=String(defined(r)),o=toInteger(t),u=d.length;return 0>o||o>=u?e?"":void 0:(n=d.charCodeAt(o),55296>n||n>56319||o+1===u||(i=d.charCodeAt(o+1))<56320||i>57343?e?d.charAt(o):n:e?d.slice(o,o+2):(n-55296<<10)+(i-56320)+65536)}};


},{"./$.defined":62,"./$.to-integer":97}],96:[function(require,module,exports){
var isRegExp=require("./$.is-regexp"),defined=require("./$.defined");module.exports=function(e,r,i){if(isRegExp(r))throw TypeError("String#"+i+" doesn't accept regex!");return String(defined(e))};


},{"./$.defined":62,"./$.is-regexp":77}],97:[function(require,module,exports){
var ceil=Math.ceil,floor=Math.floor;module.exports=function(o){return isNaN(o=+o)?0:(o>0?floor:ceil)(o)};


},{}],98:[function(require,module,exports){
var IObject=require("./$.iobject"),defined=require("./$.defined");module.exports=function(e){return IObject(defined(e))};


},{"./$.defined":62,"./$.iobject":73}],99:[function(require,module,exports){
var toInteger=require("./$.to-integer"),min=Math.min;module.exports=function(e){return e>0?min(toInteger(e),9007199254740991):0};


},{"./$.to-integer":97}],100:[function(require,module,exports){
var defined=require("./$.defined");module.exports=function(e){return Object(defined(e))};


},{"./$.defined":62}],101:[function(require,module,exports){
var id=0,px=Math.random();module.exports=function(o){return"Symbol(".concat(void 0===o?"":o,")_",(++id+px).toString(36))};


},{}],102:[function(require,module,exports){
var store=require("./$.shared")("wks"),uid=require("./$.uid"),Symbol=require("./$.global").Symbol;module.exports=function(r){return store[r]||(store[r]=Symbol&&Symbol[r]||(Symbol||uid)("Symbol."+r))};


},{"./$.global":70,"./$.shared":93,"./$.uid":101}],103:[function(require,module,exports){
var classof=require("./$.classof"),ITERATOR=require("./$.wks")("iterator"),Iterators=require("./$.iterators");module.exports=require("./$.core").getIteratorMethod=function(r){return void 0!=r?r[ITERATOR]||r["@@iterator"]||Iterators[classof(r)]:void 0};


},{"./$.classof":56,"./$.core":60,"./$.iterators":83,"./$.wks":102}],104:[function(require,module,exports){
"use strict";var ctx=require("./$.ctx"),$export=require("./$.export"),toObject=require("./$.to-object"),call=require("./$.iter-call"),isArrayIter=require("./$.is-array-iter"),toLength=require("./$.to-length"),getIterFn=require("./core.get-iterator-method");$export($export.S+$export.F*!require("./$.iter-detect")(function(e){Array.from(e)}),"Array",{from:function(e){var r,t,o,i,n=toObject(e),a="function"==typeof this?this:Array,c=arguments,l=c.length,u=l>1?c[1]:void 0,$=void 0!==u,f=0,g=getIterFn(n);if($&&(u=ctx(u,l>2?c[2]:void 0,2)),void 0==g||a==Array&&isArrayIter(g))for(r=toLength(n.length),t=new a(r);r>f;f++)t[f]=$?u(n[f],f):n[f];else for(i=g.call(n),t=new a;!(o=i.next()).done;f++)t[f]=$?call(i,u,[o.value,f],!0):o.value;return t.length=f,t}});


},{"./$.ctx":61,"./$.export":65,"./$.is-array-iter":74,"./$.iter-call":78,"./$.iter-detect":81,"./$.to-length":99,"./$.to-object":100,"./core.get-iterator-method":103}],105:[function(require,module,exports){
"use strict";var addToUnscopables=require("./$.add-to-unscopables"),step=require("./$.iter-step"),Iterators=require("./$.iterators"),toIObject=require("./$.to-iobject");module.exports=require("./$.iter-define")(Array,"Array",function(e,t){this._t=toIObject(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,s=this._i++;return!e||s>=e.length?(this._t=void 0,step(1)):"keys"==t?step(0,s):"values"==t?step(0,e[s]):step(0,[s,e[s]])},"values"),Iterators.Arguments=Iterators.Array,addToUnscopables("keys"),addToUnscopables("values"),addToUnscopables("entries");


},{"./$.add-to-unscopables":54,"./$.iter-define":80,"./$.iter-step":82,"./$.iterators":83,"./$.to-iobject":98}],106:[function(require,module,exports){
"use strict";var $export=require("./$.export");$export($export.S+$export.F*require("./$.fails")(function(){function r(){}return!(Array.of.call(r)instanceof r)}),"Array",{of:function(){for(var r=0,t=arguments,e=t.length,n=new("function"==typeof this?this:Array)(e);e>r;)n[r]=t[r++];return n.length=e,n}});


},{"./$.export":65,"./$.fails":67}],107:[function(require,module,exports){
var $export=require("./$.export");$export($export.S,"Object",{is:require("./$.same-value")});


},{"./$.export":65,"./$.same-value":90}],108:[function(require,module,exports){
"use strict";var classof=require("./$.classof"),test={};test[require("./$.wks")("toStringTag")]="z",test+""!="[object z]"&&require("./$.redefine")(Object.prototype,"toString",function(){return"[object "+classof(this)+"]"},!0);


},{"./$.classof":56,"./$.redefine":89,"./$.wks":102}],109:[function(require,module,exports){
"use strict";var strong=require("./$.collection-strong");require("./$.collection")("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return strong.def(this,t=0===t?0:t,t)}},strong);


},{"./$.collection":59,"./$.collection-strong":58}],110:[function(require,module,exports){
"use strict";var $export=require("./$.export"),context=require("./$.string-context"),INCLUDES="includes";$export($export.P+$export.F*require("./$.fails-is-regexp")(INCLUDES),"String",{includes:function(e){return!!~context(this,e,INCLUDES).indexOf(e,arguments.length>1?arguments[1]:void 0)}});


},{"./$.export":65,"./$.fails-is-regexp":66,"./$.string-context":96}],111:[function(require,module,exports){
"use strict";var $at=require("./$.string-at")(!0);require("./$.iter-define")(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,i=this._t,e=this._i;return e>=i.length?{value:void 0,done:!0}:(t=$at(i,e),this._i+=t.length,{value:t,done:!1})});


},{"./$.iter-define":80,"./$.string-at":95}],112:[function(require,module,exports){
"use strict";var $=require("./$"),global=require("./$.global"),has=require("./$.has"),DESCRIPTORS=require("./$.descriptors"),$export=require("./$.export"),redefine=require("./$.redefine"),$fails=require("./$.fails"),shared=require("./$.shared"),setToStringTag=require("./$.set-to-string-tag"),uid=require("./$.uid"),wks=require("./$.wks"),keyOf=require("./$.keyof"),$names=require("./$.get-names"),enumKeys=require("./$.enum-keys"),isArray=require("./$.is-array"),anObject=require("./$.an-object"),toIObject=require("./$.to-iobject"),createDesc=require("./$.property-desc"),getDesc=$.getDesc,setDesc=$.setDesc,_create=$.create,getNames=$names.get,$Symbol=global.Symbol,$JSON=global.JSON,_stringify=$JSON&&$JSON.stringify,setter=!1,HIDDEN=wks("_hidden"),isEnum=$.isEnum,SymbolRegistry=shared("symbol-registry"),AllSymbols=shared("symbols"),useNative="function"==typeof $Symbol,ObjectProto=Object.prototype,setSymbolDesc=DESCRIPTORS&&$fails(function(){return 7!=_create(setDesc({},"a",{get:function(){return setDesc(this,"a",{value:7}).a}})).a})?function(e,t,r){var s=getDesc(ObjectProto,t);s&&delete ObjectProto[t],setDesc(e,t,r),s&&e!==ObjectProto&&setDesc(ObjectProto,t,s)}:setDesc,wrap=function(e){var t=AllSymbols[e]=_create($Symbol.prototype);return t._k=e,DESCRIPTORS&&setter&&setSymbolDesc(ObjectProto,e,{configurable:!0,set:function(t){has(this,HIDDEN)&&has(this[HIDDEN],e)&&(this[HIDDEN][e]=!1),setSymbolDesc(this,e,createDesc(1,t))}}),t},isSymbol=function(e){return"symbol"==typeof e},$defineProperty=function(e,t,r){return r&&has(AllSymbols,t)?(r.enumerable?(has(e,HIDDEN)&&e[HIDDEN][t]&&(e[HIDDEN][t]=!1),r=_create(r,{enumerable:createDesc(0,!1)})):(has(e,HIDDEN)||setDesc(e,HIDDEN,createDesc(1,{})),e[HIDDEN][t]=!0),setSymbolDesc(e,t,r)):setDesc(e,t,r)},$defineProperties=function(e,t){anObject(e);for(var r,s=enumKeys(t=toIObject(t)),o=0,i=s.length;i>o;)$defineProperty(e,r=s[o++],t[r]);return e},$create=function(e,t){return void 0===t?_create(e):$defineProperties(_create(e),t)},$propertyIsEnumerable=function(e){var t=isEnum.call(this,e);return t||!has(this,e)||!has(AllSymbols,e)||has(this,HIDDEN)&&this[HIDDEN][e]?t:!0},$getOwnPropertyDescriptor=function(e,t){var r=getDesc(e=toIObject(e),t);return!r||!has(AllSymbols,t)||has(e,HIDDEN)&&e[HIDDEN][t]||(r.enumerable=!0),r},$getOwnPropertyNames=function(e){for(var t,r=getNames(toIObject(e)),s=[],o=0;r.length>o;)has(AllSymbols,t=r[o++])||t==HIDDEN||s.push(t);return s},$getOwnPropertySymbols=function(e){for(var t,r=getNames(toIObject(e)),s=[],o=0;r.length>o;)has(AllSymbols,t=r[o++])&&s.push(AllSymbols[t]);return s},$stringify=function(e){if(void 0!==e&&!isSymbol(e)){for(var t,r,s=[e],o=1,i=arguments;i.length>o;)s.push(i[o++]);return t=s[1],"function"==typeof t&&(r=t),!r&&isArray(t)||(t=function(e,t){return r&&(t=r.call(this,e,t)),isSymbol(t)?void 0:t}),s[1]=t,_stringify.apply($JSON,s)}},buggyJSON=$fails(function(){var e=$Symbol();return"[null]"!=_stringify([e])||"{}"!=_stringify({a:e})||"{}"!=_stringify(Object(e))});useNative||($Symbol=function(){if(isSymbol(this))throw TypeError("Symbol is not a constructor");return wrap(uid(arguments.length>0?arguments[0]:void 0))},redefine($Symbol.prototype,"toString",function(){return this._k}),isSymbol=function(e){return e instanceof $Symbol},$.create=$create,$.isEnum=$propertyIsEnumerable,$.getDesc=$getOwnPropertyDescriptor,$.setDesc=$defineProperty,$.setDescs=$defineProperties,$.getNames=$names.get=$getOwnPropertyNames,$.getSymbols=$getOwnPropertySymbols,DESCRIPTORS&&!require("./$.library")&&redefine(ObjectProto,"propertyIsEnumerable",$propertyIsEnumerable,!0));var symbolStatics={"for":function(e){return has(SymbolRegistry,e+="")?SymbolRegistry[e]:SymbolRegistry[e]=$Symbol(e)},keyFor:function(e){return keyOf(SymbolRegistry,e)},useSetter:function(){setter=!0},useSimple:function(){setter=!1}};$.each.call("hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),function(e){var t=wks(e);symbolStatics[e]=useNative?t:wrap(t)}),setter=!0,$export($export.G+$export.W,{Symbol:$Symbol}),$export($export.S,"Symbol",symbolStatics),$export($export.S+$export.F*!useNative,"Object",{create:$create,defineProperty:$defineProperty,defineProperties:$defineProperties,getOwnPropertyDescriptor:$getOwnPropertyDescriptor,getOwnPropertyNames:$getOwnPropertyNames,getOwnPropertySymbols:$getOwnPropertySymbols}),$JSON&&$export($export.S+$export.F*(!useNative||buggyJSON),"JSON",{stringify:$stringify}),setToStringTag($Symbol,"Symbol"),setToStringTag(Math,"Math",!0),setToStringTag(global.JSON,"JSON",!0);


},{"./$":84,"./$.an-object":55,"./$.descriptors":63,"./$.enum-keys":64,"./$.export":65,"./$.fails":67,"./$.get-names":69,"./$.global":70,"./$.has":71,"./$.is-array":75,"./$.keyof":85,"./$.library":86,"./$.property-desc":87,"./$.redefine":89,"./$.set-to-string-tag":92,"./$.shared":93,"./$.to-iobject":98,"./$.uid":101,"./$.wks":102}],113:[function(require,module,exports){
require("./es6.array.iterator");var global=require("./$.global"),hide=require("./$.hide"),Iterators=require("./$.iterators"),ITERATOR=require("./$.wks")("iterator"),NL=global.NodeList,HTC=global.HTMLCollection,NLProto=NL&&NL.prototype,HTCProto=HTC&&HTC.prototype,ArrayValues=Iterators.NodeList=Iterators.HTMLCollection=Iterators.Array;NLProto&&!NLProto[ITERATOR]&&hide(NLProto,ITERATOR,ArrayValues),HTCProto&&!HTCProto[ITERATOR]&&hide(HTCProto,ITERATOR,ArrayValues);


},{"./$.global":70,"./$.hide":72,"./$.iterators":83,"./$.wks":102,"./es6.array.iterator":105}],114:[function(require,module,exports){
function isUndefinedOrNull(e){return null===e||void 0===e}function isBuffer(e){return e&&"object"==typeof e&&"number"==typeof e.length?"function"!=typeof e.copy||"function"!=typeof e.slice?!1:!(e.length>0&&"number"!=typeof e[0]):!1}function objEquiv(e,t,r){var n,i;if(isUndefinedOrNull(e)||isUndefinedOrNull(t))return!1;if(e.prototype!==t.prototype)return!1;if(isArguments(e))return isArguments(t)?(e=pSlice.call(e),t=pSlice.call(t),deepEqual(e,t,r)):!1;if(isBuffer(e)){if(!isBuffer(t))return!1;if(e.length!==t.length)return!1;for(n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}try{var u=objectKeys(e),o=objectKeys(t)}catch(f){return!1}if(u.length!=o.length)return!1;for(u.sort(),o.sort(),n=u.length-1;n>=0;n--)if(u[n]!=o[n])return!1;for(n=u.length-1;n>=0;n--)if(i=u[n],!deepEqual(e[i],t[i],r))return!1;return typeof e==typeof t}var pSlice=Array.prototype.slice,objectKeys=require("./lib/keys.js"),isArguments=require("./lib/is_arguments.js"),deepEqual=module.exports=function(e,t,r){return r||(r={}),e===t?!0:e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():!e||!t||"object"!=typeof e&&"object"!=typeof t?r.strict?e===t:e==t:objEquiv(e,t,r)};


},{"./lib/is_arguments.js":115,"./lib/keys.js":116}],115:[function(require,module,exports){
function supported(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function unsupported(t){return t&&"object"==typeof t&&"number"==typeof t.length&&Object.prototype.hasOwnProperty.call(t,"callee")&&!Object.prototype.propertyIsEnumerable.call(t,"callee")||!1}var supportsArgumentsClass="[object Arguments]"==function(){return Object.prototype.toString.call(arguments)}();exports=module.exports=supportsArgumentsClass?supported:unsupported,exports.supported=supported,exports.unsupported=unsupported;


},{}],116:[function(require,module,exports){
function shim(e){var s=[];for(var t in e)s.push(t);return s}exports=module.exports="function"==typeof Object.keys?Object.keys:shim,exports.shim=shim;


},{}],117:[function(require,module,exports){
function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(e){return"function"==typeof e}function isNumber(e){return"number"==typeof e}function isObject(e){return"object"==typeof e&&null!==e}function isUndefined(e){return void 0===e}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(e){if(!isNumber(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},EventEmitter.prototype.emit=function(e){var t,n,i,s,r,o;if(this._events||(this._events={}),"error"===e&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(n=this._events[e],isUndefined(n))return!1;if(isFunction(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,s=new Array(i-1),r=1;i>r;r++)s[r-1]=arguments[r];n.apply(this,s)}else if(isObject(n)){for(i=arguments.length,s=new Array(i-1),r=1;i>r;r++)s[r-1]=arguments[r];for(o=n.slice(),i=o.length,r=0;i>r;r++)o[r].apply(this,s)}return!0},EventEmitter.prototype.addListener=function(e,t){var n;if(!isFunction(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,isFunction(t.listener)?t.listener:t),this._events[e]?isObject(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,isObject(this._events[e])&&!this._events[e].warned){var n;n=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(e,t){function n(){this.removeListener(e,n),i||(i=!0,t.apply(this,arguments))}if(!isFunction(t))throw TypeError("listener must be a function");var i=!1;return n.listener=t,this.on(e,n),this},EventEmitter.prototype.removeListener=function(e,t){var n,i,s,r;if(!isFunction(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,i=-1,n===t||isFunction(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(isObject(n)){for(r=s;r-- >0;)if(n[r]===t||n[r].listener&&n[r].listener===t){i=r;break}if(0>i)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],isFunction(n))this.removeListener(e,n);else for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},EventEmitter.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?isFunction(this._events[e])?[this._events[e]]:this._events[e].slice():[]},EventEmitter.listenerCount=function(e,t){var n;return n=e._events&&e._events[t]?isFunction(e._events[t])?1:e._events[t].length:0};


},{}],118:[function(require,module,exports){
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:(s?-1:1)*(1/0);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=0>o||0===o&&0>1/o?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),o+=p+N>=1?n/f:n*Math.pow(2,1-N),o*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};


},{}],119:[function(require,module,exports){
"function"==typeof Object.create?module.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};


},{}],120:[function(require,module,exports){
module.exports=function(r){return!(null==r||!(r._isBuffer||r.constructor&&"function"==typeof r.constructor.isBuffer&&r.constructor.isBuffer(r)))};


},{}],121:[function(require,module,exports){
"use strict";function subst(t,r){for(var e=parse(t),s=e.literals,u=[],n=0,l=s.length-1;l>n;n++){u.push(s[n]);var o=null===e.substitutions[n]||void 0===e.substitutions[n]?"":e.substitutions[n];o=0===o.indexOf("l10n(")?module.exports(o.match(fnPattern)[1],r):null===r[o]||void 0===r[o]?"":r[o],u.push(o)}return u.push(s[s.length-1]),u.join("")}var parse=require("es6-template-strings/compile"),Log=require("manticore-log")("l10n"),cultureOrder=["en-US","en"];module.exports=function(t){return function(r,e){for(var s=r.split("."),u=r,n=0;n<cultureOrder.length;n++){var l=t[cultureOrder[n]];if(l){var o=l,i=0;for(i=0;i<s.length&&o;i++)o=o[s[i]];if(i===s.length&&o){u=o;break}}}return e?subst(u,e):u}};var fnPattern=/^\s*l10n\s*\(\s*['"](.*)['"]\s*\)\s*$/;module.exports.setCultures=function(t){cultureOrder=t},module.exports.subst=subst;


},{"es6-template-strings/compile":122,"manticore-log":123}],122:[function(require,module,exports){
"use strict";var current,literals,substitutions,sOut,sEscape,sAhead,sIn,sInEscape;sOut=function(t){return"\\"===t?sEscape:"$"===t?sAhead:(current+=t,sOut)},sEscape=function(t){return"\\"!==t&&"$"!==t&&(current+="\\"),current+=t,sOut},sAhead=function(t){return"{"===t?(literals.push(current),current="",sIn):"$"===t?(current+="$",sAhead):(current+="$"+t,sOut)},sIn=function(t){return"\\"===t?sInEscape:"}"===t?(substitutions.push(current),current="",sOut):(current+=t,sIn)},sInEscape=function(t){return"\\"!==t&&"}"!==t&&(current+="\\"),current+=t,sIn},module.exports=function(t){var s,r,u,n;for(current="",literals=[],substitutions=[],t=String(t),s=t.length,r=sOut,u=0;s>u;++u)r=r(t[u]);return r===sOut?literals.push(current):r===sEscape?literals.push(current+"\\"):r===sAhead?literals.push(current+"$"):r===sIn?literals[literals.length-1]+="${"+current:r===sInEscape&&(literals[literals.length-1]+="${"+current+"\\"),n={literals:literals,substitutions:substitutions},literals=substitutions=null,n};


},{}],123:[function(require,module,exports){
"use strict";function manticoreLogger(e,o,n,r){manticore.log(e,o.name,n,r)}function componentLogger(e){for(var o,n=e.split("."),r=RootLogger,t=RootLogger,g=0;g<n.length;g++)o?o+="."+n[g]:o=n[g],r.children[n[g]]||(r.children[n[g]]={name:o,children:{},parent:t}),r=r.children[n[g]],t=r;var i={debug:function(e,o){log(Ranks.DEBUG,r,e,o)},info:function(e,o){log(Ranks.INFO,r,e,o)},warn:function(e,o){log(Ranks.WARN,r,e,o)},error:function(e,o){log(Ranks.ERROR,r,e,o)},withContext:function(e){return makeContextualLogger(i,e)},Config:r,Root:RootLogger};return i}function makeContextualLogger(e,o){var n={context:o,debug:function(n,r){e.debug(n,extend(r,o))},info:function(n,r){e.info(n,extend(r,o))},warn:function(n,r){e.warn(n,extend(r,o))},error:function(n,r){e.error(n,extend(r,o))},withContext:function(e){return makeContextualLogger(n,e)},Config:e.Config,Root:RootLogger};return n}function extend(e,o){if(!e&&!o)return null;if(!e||!o)return e||o;for(var n in o)Object.prototype.hasOwnProperty.call(e,n)||(e[n]=o[n]);return e}function configLogging(e,o){o=o||RootLogger;for(var n in e){var r=e[n],t=o.children[n];t||(t=o.children[n]={}),t.name=r.name||n,t.parent=o,t.children=t.children||{},r.level?t.level=r.level:delete t.level,r.children&&configLogging(r.children,t)}}function log(e,o,n,r){var t=levelFor(o);if(e>=t){"function"==typeof n&&(n=n()),n=n.toString();for(var g=Names[e],i=0,l=LogWriters.length;l>i;i++)LogWriters[i](g,o,n,r)}}function levelFor(e){for(var o,n=e;n&&!(o=n.level);)n=n.parent;return Ranks[o||RootLogger.level]||0}var manticore=require("manticore"),Level={DEBUG:"DEBUG",INFO:"INFO",WARN:"WARN",ERROR:"ERROR"},Ranks={DEBUG:1,INFO:2,WARN:3,ERROR:4,QUIET:5},Names={1:"DEBUG",2:"INFO",3:"WARN",4:"ERROR",5:"QUIET"},RootLogger={name:"*",level:"DEBUG",children:{}},LogWriters=[manticoreLogger];module.exports=componentLogger,module.exports.configure=configLogging,module.exports.Config=module.exports.Root=RootLogger,module.exports.Level=Level,module.exports.Ranks=Ranks,module.exports.addLogger=function(e){LogWriters.push(e)},module.exports.removeLogger=function(e){var o=LogWriters.indexOf(e);o>=0&&LogWriters.splice(o,1)},module.exports.levelFor=levelFor;


},{"manticore":125}],124:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),manticore=require("manticore"),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"extend",value:function(e,r){for(var n in r)Object.prototype.hasOwnProperty.call(e,n)||(e[n]=r[n]);return e}},{key:"assignSome",value:function(e,r,n){var t=!0,o=!1,a=void 0;try{for(var i,u=n[Symbol.iterator]();!(t=(i=u.next()).done);t=!0){var f=i.value;r.hasOwnProperty(f)&&(e[f]=r[f])}}catch(l){o=!0,a=l}finally{try{!t&&u["return"]&&u["return"]()}finally{if(o)throw a}}return e}},{key:"assignExcept",value:function(e,r,n){for(var t in r)"_"!==t[0]&&r.hasOwnProperty(t)&&0>n.indexOf(t)&&(e[t]=r[t]);return e}},{key:"reverseKeysAndValues",value:function(e){if(!e)return e;var r={};for(var n in e)e.hasOwnProperty(n)&&(r[e[n]]=n);return r}},{key:"clone",value:function(r){var n;if(null===r||"object"!=typeof r)return r;if(r instanceof Date)return n=new Date,n.setTime(r.getTime()),n;if(r instanceof Array){n=[];for(var t=0,o=r.length;o>t;t++)n[t]=e.clone(r[t]);return n}if(r instanceof Object){n={};for(var a in r)r.hasOwnProperty(a)&&(n[a]=e.clone(r[a]));return n}throw new Error("Unable to copy obj! Its type isn't supported.")}},{key:"deepToJSON",value:function(r){if(null===r||"object"!=typeof r)return r;if(r&&"function"==typeof r.toJSON)return e.deepToJSON(r.toJSON());var n;if(r instanceof Array){n=[];for(var t=0,o=r.length;o>t;t++)n[t]=e.deepToJSON(r[t]);return n}if(r instanceof Object){n={};for(var a in r)r.hasOwnProperty(a)&&(n[a]=e.deepToJSON(r[a]));return n}throw new Error("Unable to deepToJSON obj! Its type isn't supported.")}}]),e}();module.exports=Utils;


},{"manticore":125}],125:[function(require,module,exports){
module.exports=manticore;


},{}],126:[function(require,module,exports){
"use strict";module.exports={Terminal:require("./lib/Terminal"),TerminalDisplay:require("./lib/TerminalDisplay"),Tags:require("./lib/MiuraTags"),CardStatus:require("./lib/messages/CardStatus")};


},{"./lib/MiuraTags":127,"./lib/Terminal":130,"./lib/TerminalDisplay":132,"./lib/messages/CardStatus":135}],127:[function(require,module,exports){
"use strict";var DefinedTag=require("tlvlib").DefinedTag,ValueFormat=require("tlvlib").ValueFormat;module.exports={MiuraFileLength:new DefinedTag("MiuraFileLength",128,ValueFormat.Numeric),MiuraCommandData:new DefinedTag("MiuraCommandData",224,ValueFormat.TypeLengthValueList),MiuraConfigurationInformation:new DefinedTag("MiuraConfigurationInformation",237,ValueFormat.TypeLengthValueList),MiuraSoftwareInformation:new DefinedTag("MiuraSoftwareInformation",239,ValueFormat.TypeLengthValueList),MiuraIdentifier:new DefinedTag("MiuraIdentifier",57101,ValueFormat.Alpha),MiuraVersionInformation:new DefinedTag("MiuraVersionInformation",57215,ValueFormat.Alpha),MiuraStateChangeReason:new DefinedTag("MiuraStateChangeReason",195,ValueFormat.Binary,1),MiuraStateChangeText:new DefinedTag("MiuraStateChangeText",196,ValueFormat.Alpha),MiuraCardStatusInfo:new DefinedTag("MiuraCardStatusInfo",72,ValueFormat.Binary,2),MiuraSREDData:new DefinedTag("MiuraSREDData",14659074,ValueFormat.Binary),MiuraKSN:new DefinedTag("MiuraKSN",14659075,ValueFormat.Binary),MiuraMaskedICCTrack2:new DefinedTag("MiuraMaskedICCTrack2",14659159,ValueFormat.CompressedAlpha),MiuraMaskedPan:new DefinedTag("MiuraMaskedPan",14659162,ValueFormat.AlphaNumeric),MiuraMaskedTrack2:new DefinedTag("MiuraMaskedTrack2",14659106,ValueFormat.Alpha),MiuraMaskedContactlessTrack2:new DefinedTag("MiuraMaskedContactlessTrack2",14659179,ValueFormat.Alpha),MiuraKeyboardData:new DefinedTag("MiuraKeyboardData",14656005,ValueFormat.Binary,1),MiuraNumericData:new DefinedTag("MiuraNumericData",14656008,ValueFormat.AlphaNumeric),MiuraCardholderVerificationStatus:new DefinedTag("MiuraCardholderVerificationStatus",57128,ValueFormat.Binary,1),MiuraDigitsInPinBuffer:new DefinedTag("MiuraDigitsInPinBuffer",14655745,ValueFormat.Numeric),MiuraPinEntryStatus:new DefinedTag("MiuraPinEntryStatus",14655746,ValueFormat.Binary,1),MiuraP2PEStatus:new DefinedTag("MiuraP2PEStatus",14659073,ValueFormat.Binary,1),MiuraFileWriteOffset:new DefinedTag("MiuraFileWriteOffset",14656257,ValueFormat.Binary),MiuraFileWriteLength:new DefinedTag("MiuraFileWriteLength",14656258,ValueFormat.Binary),MiuraFileWriteTimeout:new DefinedTag("MiuraFileWriteTimeout",14656259,ValueFormat.Binary,1),MiuraContactlessType:new DefinedTag("MiuraContactlessType",57136,ValueFormat.Binary,2),MiuraBatteryData:new DefinedTag("MiuraBatteryData",14656009,ValueFormat.Binary,1),MiuraImageData:new DefinedTag("MiuraImageData",14658563,ValueFormat.AlphaNumeric),MiuraTextData:new DefinedTag("MiuraTextData",14658562,ValueFormat.AlphaNumeric),MiuraMediaCoordinates:new DefinedTag("MiuraMediaCoordinates",14658561,ValueFormat.Numeric,2)};


},{"tlvlib":189}],128:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function verifyLrc(e){for(var t=0,r=0;r<e.length-1;r++)t^=e[r];if(t=255&t,t!==e[e.length-1])throw Log.warn("LRC did not match. Expected "+t.toString(16)+", got "+e[e.length-1].toString(16)+"\n"+e.toString("hex")),new Error("Miura packet error checking failed.")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var i=e,a=t,o=r;n=!1,null===i&&(i=Function.prototype);var s=Object.getOwnPropertyDescriptor(i,a);if(void 0!==s){if("value"in s)return s.value;var l=s.get;if(void 0===l)return;return l.call(o)}var u=Object.getPrototypeOf(i);if(null===u)return;e=u,t=a,r=o,n=!0,s=u=void 0}},manticore=require("manticore"),EventEmitter=require("events").EventEmitter,Log=require("manticore-log")("miura.parser"),Tlv=require("tlvlib"),MiuraTags=require("./MiuraTags"),ResponsePacket=require("./ResponsePacket"),ParserEvent={unsolicited:"unsolicited",response:"response"},MiuraParser=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.partial=null}return _inherits(t,e),_createClass(t,[{key:"reset",value:function(){this.partial=null}},{key:"received",value:function(e){try{var t=Buffer.isBuffer(e)?e:new Buffer(e,"base64");if(this.incompletePacket&&(t=Buffer.concat([this.incompletePacket,t]),delete this.incompletePacket),t.length<3||t.length<t[2]+4)return this.incompletePacket=t,void Log.debug("Incomplete packet received.");this._completePacket(t)}catch(r){throw Log.error("Failed processing Miura packet: "+r.message+"\n"+r.stack),r}}},{key:"_completePacket",value:function(e){var t=null;try{t=this._readResponse(e)}catch(r){Log.error(function(){return"Failed to read terminal response: "+r.message+"\n"+r.stack})}t&&(Log.debug(function(){return"Emitting "+(t.unsolicited?"unsolicited":"responsive")+" terminal message"}),t.unsolicited?this.emit(ParserEvent.unsolicited,t):this.emit(ParserEvent.response,t))}},{key:"_readResponse",value:function(e){var t=new ResponsePacket;if(e=this._validateBuffer(t,e),1===e[1])return void this._processPartial(e);t.length=e[2],e=this._applyPartial(t,e),t.raw=e,t.length+4!==e.length&&Log.warn(function(){return"Received response packet with non-matching length bytes. Expected "+(t.length+4)+", got "+e.length});var r=t.unsolicited?!1:this.expectRawBytes;try{t.apdu=new Tlv.ApduResponse(e,3,t.length,r),Log.debug(function(){return"Miura response template: "+(t.apdu.template?t.apdu.template.toString(16):"<empty>")+" SW1: "+t.apdu.sw1.toString(16)+" SW2: "+t.apdu.sw2.toString(16)+" Raw: "+e.toString("hex")})}catch(n){Log.error("Failed to parse APDU from raw response: "+e.toString("hex")+"\nError: "+n.message)}return t}},{key:"_processPartial",value:function(e){Log.debug(function(){return"Received partial packet of "+(e.length-4)+" bytes "+e.toString("hex")}),null===this.partial&&(this.partial=[],this.partialLen=0,this.partial.push(new Buffer("000000","hex"))),this.partialLen+=e[2],this.partial.push(e.slice(3,e.length-1))}},{key:"_applyPartial",value:function(e,t){return this.partial&&(this.partial.push(t.slice(3,t.length-1)),this.partial.push(new Buffer("00","hex")),Log.debug(function(){return"Final packet of partial "+t.toString("hex")}),t=Buffer.concat(this.partial),e.length+=this.partialLen,Log.debug(function(){return"Reassembled "+t.length+" bytes ("+e.length+")."}),this.partial=null,this.partialLen=0),t}},{key:"_validateBuffer",value:function(e,t){var r=this;if(1!==t[0]&&Log.warn(function(){return"Received response packet with non-standard NAD byte: "+t[0]}),0!==t[1]&&64!==t[1]&&1!==t[1]&&Log.warn(function(){return"Received response packet with non-standard PCB byte: "+t[1]}),64===t[1]&&(e.unsolicited=!0),t.length>t[2]+4){var n=t.slice(t[2]+4,t.length);t=t.slice(0,t[2]+4),manticore.setTimeout(function(){r.received(n)},0)}return verifyLrc(t),t}}]),t}(EventEmitter);module.exports=MiuraParser,module.exports.Event=ParserEvent;


}).call(this,require("buffer").Buffer)
},{"./MiuraTags":127,"./ResponsePacket":129,"buffer":44,"events":117,"manticore":125,"manticore-log":123,"tlvlib":189}],129:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),ResponsePacket=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"toString",value:function(e){var n=["<----\nMiura Response: ",this.apdu?this.apdu.toString(e):"blank","\n"];return n.push("---->"),n.join("")}},{key:"tlvs",get:function(){return this.apdu.tlvs}}]),e}();module.exports=ResponsePacket;


},{}],130:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}function startTxCommon(e,r,t,a){var n=new Tlv.TlvList,i=new Date;return n.add(Tlv.Tags.TransactionSequenceCounter,e),n.add(Tlv.Tags.TransactionDate,i),n.add(Tlv.Tags.TransactionTime,i),n.add(Tlv.Tags.TransactionType,r),n.add(Tlv.Tags.AmountAuthorized,Tlv.Tags.AmountAuthorized.format.toBytes(t,6)),n.add(Tlv.Tags.TransactionCurrencyCode,a),n}function buildApps(e,r){for(var t,a,n=0;n<r.tlvs.values.length;n++){var i=r.tlvs.values[n];i.tag===Tlv.Tags.TerminalApplicationIdentifier?(t&&(e.apps.push([t,a]),a=null),t=i.parse()):i.tag===Tlv.Tags.ApplicationLabel&&(a&&t&&(e.apps.push([t,a]),t=null),a=i.parse())}t&&e.apps.push([t,a])}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(r,t,a){return t&&e(r.prototype,t),a&&e(r,a),r}}(),_get=function(e,r,t){for(var a=!0;a;){var n=e,i=r,s=t;a=!1,null===n&&(n=Function.prototype);var o=Object.getOwnPropertyDescriptor(n,i);if(void 0!==o){if("value"in o)return o.value;var d=o.get;if(void 0===d)return;return d.call(s)}var u=Object.getPrototypeOf(n);if(null===u)return;e=u,r=i,t=s,a=!0,o=u=void 0}},EventEmitter=require("events").EventEmitter,Tlv=require("tlvlib"),MiuraTags=require("./MiuraTags"),Parser=require("./Parser"),Writer=require("./Writer"),BatteryStatus=require("./messages/BatteryStatus"),TerminalStatus=require("./messages/TerminalStatus"),CardStatus=require("./messages/CardStatus"),KeyStatus=require("./messages/KeyStatus"),PaymentDevice=require("retail-payment-device").PaymentDevice,ErrorCode=PaymentDevice.errorCode,FormFactor=PaymentDevice.FormFactor,EmvDevice=require("retail-payment-device").EmvDevice,DecisionRequired=require("retail-payment-device").DecisionRequired,TerminalConfig=require("./TerminalConfig"),TerminalDisplay=require("./TerminalDisplay"),Log=require("manticore-log")("miura.terminal"),TerminalEvent={unsolicited:Parser.Event.unsolicited,deviceEvent:"deviceEvent",cardPresented:"cardPresented",cardRemoved:"cardRemoved",error:"error"},imageMatcherRegex=void 0,Terminal=function(e){function r(e,t){var a=this;_classCallCheck(this,r),_get(Object.getPrototypeOf(r.prototype),"constructor",this).call(this),this.reader=t,this.parser=new Parser,this.parser.on(TerminalEvent.unsolicited,function(e){return a._emitUnsolicited(e)}),this.writer=new Writer(this,e),this.Config=new TerminalConfig(this),this.displayController=new TerminalDisplay("M010")}return _inherits(r,e),_createClass(r,[{key:"didConnect",value:function(){this.parser.reset()}},{key:"received",value:function(e){this.parser.received(e)}},{key:"injectResponders",value:function(e){this.writer.responders=e.concat(this.writer.responders)}},{key:"_emitUnsolicited",value:function(e){this.emit(TerminalEvent.unsolicited,e);var r=e,t=e.apdu.template;230===e.apdu.template?r=new TerminalStatus(e):225===e.apdu.template&&(e.tlvs&&e.tlvs.find(MiuraTags.MiuraCardStatusInfo)?(r=new CardStatus(e),this._reflectCardStatus(r)):e.tlvs&&e.tlvs.find(MiuraTags.MiuraKeyboardData)&&(r=new KeyStatus(e))),Log.debug(function(){return"Unsolicited message: "+r}),this.emit(TerminalEvent.deviceEvent,r),t&&this.emit(TerminalEvent.deviceEvent+"."+t.toString(16),r),r instanceof CardStatus&&1===(1&r.magstripeFlags)&&(Log.debug(function(){return"EMV Card Swiped "+e.raw.toString("hex")}),this.emit(TerminalEvent.cardPresented,r.getPresentedCard(this.reader)))}},{key:"_reflectCardStatus",value:function(e){var r=this,t=this.cardStatus||EmvDevice.CardStatus.None;if(3===(3&e.chipFlags)?this.cardStatus=EmvDevice.CardStatus.EmvCard:1===(1&e.chipFlags)?this.cardStatus=EmvDevice.CardStatus.NonEmvCard:this.cardStatus=EmvDevice.CardStatus.None,Log.debug(function(){return"Previous card status "+t+". New Status "+r.cardStatus}),t!==this.cardStatus&&(3&this.cardStatus)>0){var a=e.getPresentedCard(this.reader);if(a.failed&&a.formFactor===FormFactor.Chip){var n=new Error;return n.code=ErrorCode.invalidChip,this.emit(TerminalEvent.error,n,a.formFactor)}this.emit(TerminalEvent.cardPresented,a)}else t!==this.cardStatus&&this.cardStatus===EmvDevice.CardStatus.None&&this.emit(TerminalEvent.cardRemoved)}},{key:"display",value:function(e,r,t){var a=this.displayController.formatMessage(e,r),n=this._parseMedia(a);return a?n?this.displayImageAndText(n.imageId,n.msg,t):void this.showMessage(a,t):t(new Error("Empty message."))}},{key:"_parseMedia",value:function(e){imageMatcherRegex||(imageMatcherRegex=/\$image\((.+)\)(?:\n)*(.*)/);var r=imageMatcherRegex.exec(e);return r?{imageId:r[1],msg:r[2]}:null}},{key:"displayImage",value:function(e,t){var a=new Tlv.ApduCommand(210,210);a.appendString(r.Images[e]),this.writer.sendAndReceive(a,t)}},{key:"displayImageAndText",value:function(e,r,t){var a=0,n=50,i=0,s=0,o=new Tlv.TlvList,d=[MiuraTags.MiuraMediaCoordinates.valueToBytes(i),MiuraTags.MiuraMediaCoordinates.valueToBytes(s)];o.add(MiuraTags.MiuraMediaCoordinates,Buffer.concat(d)),o.add(MiuraTags.MiuraImageData,MiuraTags.MiuraImageData.valueToBytes(e));var u=[MiuraTags.MiuraMediaCoordinates.valueToBytes(a),MiuraTags.MiuraMediaCoordinates.valueToBytes(n)];o.add(MiuraTags.MiuraMediaCoordinates,Buffer.concat(u)),o.add(MiuraTags.MiuraTextData,MiuraTags.MiuraTextData.valueToBytes(r));var l=new Tlv.TlvList;l.add(MiuraTags.MiuraCommandData,o);var c=new Tlv.ApduCommand(210,32,0,0);c.appendBytes(l.toBytes()),this.writer.sendAndReceive(c,t)}},{key:"softReset",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(208,0),e)}},{key:"hardReset",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(208,0,1),e)}},{key:"abortTransaction",value:function(e){this.writer.sendAndAwaitResponse(new Tlv.ApduCommand(208,255),function(r,t){return t&&t.apdu&&144===t.apdu.sw1&&0===t.apdu.sw2?(e(r,t),!0):!1})}},{key:"getBatteryLevel",value:function(e){this.writer.sendAndAwaitResponse(new Tlv.ApduCommand(208,98),function(r,t){try{if(t&&t.apdu&&159===t.apdu.sw1&&255===t.apdu.sw2)return Log.debug("Unable to retrieve battery information at this time. Device probably in transaction state"),e(r),!0;if(t&&t.tlvs&&t.tlvs.find(MiuraTags.MiuraBatteryData))return e(r,new BatteryStatus(t)),!0}catch(a){Log.debug("Battery data parsing erred : "+a)}return!1})}},{key:"disconnectUsb",value:function(e){this.writer.sendApdu(new Tlv.ApduCommand(208,192),e)}},{key:"registerForCardEvents",value:function(e,r){this.writer.sendApdu(new Tlv.ApduCommand(208,96,e?15:0),r)}},{key:"registerForKeyboardEvents",value:function(e,r){this.writer.sendAndReceive(new Tlv.ApduCommand(208,97,e?1:0),r)}},{key:"showMessage",value:function(e,r){var t=new Tlv.ApduCommand(210,1,0,128);t.appendString(e),this.writer.sendAndReceive(t,r)}},{key:"promptForNumericEntry",value:function(e,r,t,a){var n=new Buffer(e,"hex"),i=new Buffer(r,"hex");if(4!==n.length&&6!==n.length)throw new Error("Prompt index array must be 4 or 6 hex bytes (8 or 12 characters) referencing the prompts.txt file.");if(2!==i.length)throw new Error("Number format must be 2 hex bytes (4 characters)");var s=new Tlv.ApduCommand(210,4,0,1),o=new Tlv.TlvList;o.add(14656006,n),o.add(14656007,i),t&&o.add(14656008,new Buffer(t.toString(),"utf8"));var d=new Tlv.TlvList;d.add(224,o.toBytes()),s.appendBytes(d.toBytes()),this.writer.sendAndReceive(s,function(e,r){if(!r.tlvs)return a(new Error("Numeric entry failed."),null);var t=r.tlvs.find(MiuraTags.MiuraNumericData);return a(null,t.parse())})}},{key:"promptForSecureAccountNumber",value:function(e,r){var t=new Buffer(e,"hex");if(4!==t.length&&6!==t.length)throw new Error("Prompt index array must be 4 or 6 hex bytes (8 or 12 characters) referencing the prompts.txt file.");var a=new Tlv.ApduCommand(210,90,0,1),n=new Tlv.TlvList;n.add(14656006,t);var i=new Tlv.TlvList;i.add(224,n.toBytes()),a.appendBytes(i.toBytes()),this.writer.sendAndReceive(a,function(e,t){if(!t.tlvs)return r(new Error("Secure entry failed."),null);var a=t.tlvs.find(MiuraTags.MiuraNumericData);return r(null,a.parse())})}},{key:"startICCTransaction",value:function(e,t,a,n,i){Log.debug("Currency code "+n);var s=startTxCommon(e,t,a,n),o=new Tlv.TlvList;o.add(MiuraTags.MiuraCommandData,s);var d=new Tlv.ApduCommand(222,209);d.appendBytes(o.toBytes()),this.writer.sendAndReceive(d,function(e,t){var a=e||r.parseContactError(t);if(a)return i(a,t);if(226===t.apdu.template&&t.tlvs.find(Tlv.Tags.TerminalApplicationIdentifier)){var n=new DecisionRequired(t);buildApps(n,t),n.apdu=t.apdu,i(null,n)}else i(null,t)})}},{key:"startContactlessTransaction",value:function(e,t,a,n,i){var s=startTxCommon(e,t,a,n),o=new Tlv.TlvList;o.add(MiuraTags.MiuraCommandData,s);var d=new Tlv.ApduCommand(222,193);d.appendBytes(o.toBytes()),this.writer.sendAndReceive(d,function(e,t){var a=e||r.parseContactlessError(t);return a?i(a,t):void i(e,t)})}},{key:"continueTransaction",value:function(e,r){var t=new Tlv.ApduCommand(222,210);t.expectNoBytes=!0;var a=new Tlv.TlvList;a.add(224,new Buffer(e,"hex")),t.appendBytes(a.toBytes()),this.writer.sendAndReceive(t,function(e,t){var a=void 0;!t.apdu||229!==t.apdu.template&&t.apdu.data&&159!==t.apdu.sw1||(a=new Error,a.code=ErrorCode.contactIssuer),r(a||e,t)})}},{key:"selectApplication",value:function(e,r){var t=new Tlv.ApduCommand(222,210);t.expectNoBytes=!0;var a=new Tlv.TlvList;a.add(Tlv.Tags.TerminalApplicationIdentifier,e);var n=new Tlv.TlvList;n.add(224,a.toBytes()),t.appendBytes(n.toBytes()),this.writer.sendAndReceive(t,r)}},{key:"formFactors",get:function(){return this.Config._factors||[FormFactor.Chip,FormFactor.MagneticCardSwipe]}}],[{key:"parseContactError",value:function(e){var r=new Error;if(!e||!e.apdu)return r.code=ErrorCode.badEmvData,r;var t=e.apdu;if(229===t.template)return r.code=ErrorCode.contactIssuer,r;var a={65:ErrorCode.paymentCancelled,35:ErrorCode.smartCardNotInSlot,37:ErrorCode.cardBlocked,40:ErrorCode.mustSwipeCard};return 159===t.sw1&&a[t.sw2]?(r.code=a[t.sw2],r):void 0}},{key:"parseContactlessError",value:function(e){var r=new Error;if(!e||!e.apdu)return r.code=ErrorCode.badEmvData,r;var t=e.apdu;if(229===t.template)return r.code=ErrorCode.nfcNotAllowed,r;var a={65:ErrorCode.paymentCancelled,66:ErrorCode.nfcTimeout,67:ErrorCode.contactlessPaymentAbortedByCardInsert,68:ErrorCode.contactlessPaymentAbortedByCardSwipe,193:ErrorCode.nfcNotAllowed,194:ErrorCode.tryDifferentCard,195:ErrorCode.mustInsertCard,207:ErrorCode.hardwareError};return 159===t.sw1&&a[t.sw2]?(r.code=a[t.sw2],r):t.isSuccess?void 0:(r.code=ErrorCode.genericError,r)}}]),r}(EventEmitter);module.exports=Terminal,module.exports.Event=TerminalEvent,module.exports.EventType={TerminalStatus:require("./messages/TerminalStatus")},module.exports.TransactionType={SALE:0,REFUND:20};


}).call(this,require("buffer").Buffer)
},{"./MiuraTags":127,"./Parser":128,"./TerminalConfig":131,"./TerminalDisplay":132,"./Writer":133,"./messages/BatteryStatus":134,"./messages/CardStatus":135,"./messages/KeyStatus":137,"./messages/TerminalStatus":138,"buffer":44,"events":117,"manticore-log":123,"retail-payment-device":179,"tlvlib":189}],131:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function buf24(e){var i=new Buffer(3);return i[0]=e>>16&255,i[1]=e>>8&255,i[2]=255&e,i}var _createClass=function(){function e(e,i){for(var n=0;n<i.length;n++){var t=i[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(i,n,t){return n&&e(i.prototype,n),t&&e(i,t),i}}(),EventEmitter=require("events").EventEmitter,Tlv=require("tlvlib"),MiuraTags=require("./MiuraTags"),DeviceCaps=require("./messages/DeviceCaps"),Writer=require("./Writer"),FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,Log=require("manticore-log")("miura.terminal.config"),TerminalConfig=function(){function e(i){_classCallCheck(this,e),this.device=i,this.writer=i.writer}return _createClass(e,[{key:"removeLogs",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(208,225,1),e)}},{key:"archiveLogs",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(208,225),e)}},{key:"selectFile",value:function(e,i,n){var t=new Tlv.ApduCommand(0,164,i?1:0);t.appendString(e),Log.debug(function(){return"Miura Sending selectFile ("+e+") ApduCommand: "+t}),this.writer.sendAndReceive(t,n)}},{key:"readBinary",value:function(e,i,n){var t;e>32767?(t=new Tlv.ApduCommand(0,176,128|e>>16&127,e>>8&255),t.appendBytes(new Buffer([255&e]))):t=new Tlv.ApduCommand(0,176,e>>8&127,255&e),t.le=i,this.writer.sendAndReceive(t,n,!0)}},{key:"getConfiguration",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(208,1),function(i,n){n&&(n=new DeviceCaps(n)),e(i,n)})}},{key:"getDeviceCapabilities",value:function(e){var i=this;this.writer.sendAndReceive(new Tlv.ApduCommand(208,2),function(n,t){t&&t.apdu.isSuccess?(t=new DeviceCaps(t),i._factors=[],t.caps.Smartcard&&i._factors.push(FormFactor.Chip),t.caps.Contactless&&i._factors.push(FormFactor.EmvCertifiedContactless),t.caps.Mag&&i._factors.push(FormFactor.MagneticCardSwipe)):Log.debug("Miura device does not support getDeviceCapabilities - proceeding with default capabilities."),e(n,t)})}},{key:"getP2PEStatus",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(238,224),e)}},{key:"initializeP2PE",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(238,225),e)}},{key:"importP2PE",value:function(e){this.writer.sendAndReceive(new Tlv.ApduCommand(238,226),e)}},{key:"getFile",value:function(e,i){var n=this;this.selectFile(e,0,function(t,r){if(t||!r.apdu.isSuccess)return i(t||new Error("Could not select file "+e),null);var a=r.tlvs.find(MiuraTags.MiuraFileLength);if(!a||!a.bytes)return i(new Error("Empty or missing file length for "+e));var u=a.parse();Log.debug("Fetching "+u+" bytes of "+e);var s=0,o=[],c=function d(){n.readBinary(s,250,function(e,n){return e?i(e):(u-=n.apdu.data.length,s+=n.apdu.data.length,o.push(n.apdu.data),u>0?d():void i(null,Buffer.concat(o)))})};c()})}},{key:"streamBinary",value:function(e,i,n,t,r){var a=new Tlv.ApduCommand(0,215,t?1:0),u=new Tlv.TlvList,s=Buffer.isBuffer(e),o=s?e.length:Writer.base64ByteLength(e);u.add(MiuraTags.MiuraFileWriteOffset,buf24(i)),u.add(MiuraTags.MiuraFileWriteLength,buf24(o)),u.add(MiuraTags.MiuraFileWriteTimeout,new Buffer([255&n]));var c=new Tlv.TlvList;c.add(MiuraTags.MiuraCommandData,u),a.appendBytes(c.toBytes()),Log.debug(function(){return"Miura sending binary stream of "+o+" bytes with offset "+i}),this.writer.sendAndReceive(a,r),this.writer.send(e)}}]),e}();module.exports=TerminalConfig;


}).call(this,require("buffer").Buffer)
},{"./MiuraTags":127,"./Writer":133,"./messages/DeviceCaps":136,"buffer":44,"events":117,"manticore-log":123,"retail-payment-device":179,"tlvlib":189}],132:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function centerLine(e,n){return e.length>=n-1||0===e.length?e:Array(Math.floor((n-e.length)/2)+1).join(" ")+e}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),Message=require("retail-payment-device").PaymentDevice.Message,TerminalDisplay=function(){function e(n){_classCallCheck(this,e),this.model=n,"M010"===n&&(this.lines=4,this.lineWidth=21,this.l10n=require("l10n-manticore")({en:require("../strings/m010/en")}))}return _createClass(e,[{key:"formatMessage",value:function(e,n){var t=arguments.length<=2||void 0===arguments[2]?!0:arguments[2];e===Message.SoftwareUpdateProgress&&n&&(e="SwUpdate."+n.stage);var r=this.l10n(e,n);return r!==e?this.centerString(r.split("\n"),t).join("\n"):""}},{key:"centerString",value:function(e,n){if("string"==typeof e){if(!this.lines)return[centerLine(e,this.lineWidth)];e=[e]}var t=[],r=!0,i=!1,a=void 0;try{for(var l,s=e[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var o=l.value;t.push(centerLine(o,this.lineWidth))}}catch(u){i=!0,a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw a}}if(!n)return t;for(var c=this.lines;c&&c-- >t.length+1;)t.unshift("");return t}}]),e}();module.exports=TerminalDisplay;


},{"../strings/m010/en":139,"l10n-manticore":121,"retail-payment-device":179}],133:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function buildCommandBytes(e){var t=0,n=new Buffer(3);n.writeUInt8(1,0),t^=1,n.writeUInt8(0,1);var r=e.toBytes();if(r.length>255)throw new Error("Miura command is too long, max 255 bytes, got "+r.length);n.writeUInt8(r.length,2),t^=r.length;for(var s=0;s<r.length;s++)t^=r[s];var a=new Buffer(1);return a.writeUInt8(255&t,0),Buffer.concat([n,r,a])}function base64ByteLength(e){var t=3*e.length/4;return"="===e[e.length-1]&&t--,"="===e[e.length-2]&&t--,t}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),manticore=require("manticore"),Parser=require("./Parser"),Log=require("manticore-log")("miura.writer"),Writer=function(){function e(t,n){var r=this;_classCallCheck(this,e),this.terminal=t,this.sendFn=n,this.parser=this.terminal.parser,this.parser.on(Parser.Event.response,function(e){return r._responseHandler(e)}),this.requestQueue=[],this.awaitResponders=[]}return _createClass(e,[{key:"_responseHandler",value:function(t){for(var n=0;n<this.awaitResponders.length;n++){var r=this.awaitResponders[n];if(r(null,t))return void this.awaitResponders.splice(n,1)}if(!(this.requestQueue.length>0&&this.requestQueue[0].status===e.CommandStatus.AwaitingResponse))throw new Error("Received unexpected response: "+t.toString());var s=this.requestQueue.shift();s.callback(null,t),this._sendNext()}},{key:"send",value:function(e,t,n){var r=this,s=Buffer.isBuffer(e),a=s?e.length:base64ByteLength(e);t=t||0;var i=a-t;this.terminal.reader.pre76&&this.terminal.isUsb&&i>this.terminal.reader.maxSingleSend&&!function(){var s=t+r.terminal.reader.maxSingleSend,a=n;n=null,manticore.setTimeout(function(){r.send(e,s,a)},10),i=r.terminal.reader.maxSingleSend}();var u=void 0;u=t||a>i?s?e.slice(t,t+i).toString("base64"):{data:e,offset:t,len:i}:s?e.toString("base64"):e,this.sendFn(u,n)}},{key:"sendApdu",value:function(e,t){var n=buildCommandBytes(e);Log.debug(function(){return"Miura Sending "+e.toString(!0)}),this.send(n),t()}},{key:"sendAndAwaitResponse",value:function(e,t){var n=this;this.awaitResponders.push(t),this.sendApdu(e,function(e){e&&(Log.error("sendAndAwaitResponse failure: "+e.message),n.awaitResponders.pop(),t(e,null))})}},{key:"sendAndReceive",value:function(t,n,r){this.requestQueue.push({apdu:t,callback:n,isExpectingRaw:r,status:e.CommandStatus.Queued}),this._sendNext()}},{key:"_sendNext",value:function(){var t=this;if(0!==this.requestQueue.length&&this.requestQueue[0].status!==e.CommandStatus.AwaitingResponse){var n=this.requestQueue[0];n.status=e.CommandStatus.AwaitingResponse,this.parser.expectRawBytes=n.isExpectingRaw,this.sendApdu(n.apdu,function(e){e&&(Log.error("_sendNext failure: "+e+" "+e.message),t.requestQueue.shift(),n.callback&&n.callback(e))})}}}]),e}();Writer.CommandStatus={Queued:0,AwaitingResponse:1},module.exports=Writer,module.exports.buildCommandBytes=buildCommandBytes,module.exports.base64ByteLength=base64ByteLength;


}).call(this,require("buffer").Buffer)
},{"./Parser":128,"buffer":44,"manticore":125,"manticore-log":123}],134:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),BatteryStatus=function(){function t(e){_classCallCheck(this,t),this.response=e;var a=!0,r=!1,s=void 0;try{for(var n,o=this.response.tlvs.values[Symbol.iterator]();!(a=(n=o.next()).done);a=!0){var i=n.value;14656009===i.tagNumber?this.readStatus(i):14656010===i.tagNumber&&(this.batteryPercentage=i.bytes[0])}}catch(u){r=!0,s=u}finally{try{!a&&o["return"]&&o["return"]()}finally{if(r)throw s}}}return _createClass(t,[{key:"readStatus",value:function(e){switch(e.bytes[0]){case 0:this.status=t.DRAINING,this.connectedToPower=!1;break;case 1:this.status=t.CHARGING,this.connectedToPower=!0;break;case 2:this.status=t.CHARGED,this.connectedToPower=!0;break;case 255:this.status=t.DRAINED,this.connectedToPower=!1;break;default:this.status=t.UNKNOWN,this.connectedToPower=!1}}},{key:"toString",value:function(){return"Battery Status: "+this.status+" ("+this.batteryPercentage+"%), ConnectedToPower? "+this.connectedToPower}}]),t}();BatteryStatus.DRAINING="Draining",BatteryStatus.DRAINED="Drained",BatteryStatus.CHARGING="Charging",BatteryStatus.CHARGED="Charged",BatteryStatus.UNKNOWN="Unknown",module.exports=BatteryStatus;


},{}],135:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),Card=require("retail-payment-device").Card,Log=require("manticore-log")("miura"),Utils=require("manticore-util"),FormFactor=require("retail-payment-device").PaymentDevice.FormFactor,MagneticCard=require("retail-payment-device").MagneticCard,CardStatus=function(){function e(t){_classCallCheck(this,e),this.response=t;var r=!0,a=!1,s=void 0;try{for(var i,n=this.response.tlvs.values[Symbol.iterator]();!(r=(i=n.next()).done);r=!0){var o=i.value;if(72===o.tagNumber)this.chipFlags=o.bytes[0],this.magstripeFlags=o.bytes[1];else if(14659075===o.tagNumber)this.ksn=o.parse();else if(14659074===o.tagNumber)this.sredData=o.parse();else if(14659106===o.tagNumber)this.maskedTrack2=o.parse();else if(24354===o.tagNumber)this.track2=o.parse();else if(57136===o.tagNumber){this.formFactor=FormFactor.EmvCertifiedContactless;var c=o.bytes[1];this.emv=!(0===c||2===c)}}}catch(h){a=!0,s=h}finally{try{!r&&n["return"]&&n["return"]()}finally{if(a)throw s}}this.p2pe=t.apdu.data.slice(1).toString("hex")}return _createClass(e,[{key:"getPresentedCard",value:function(e){var t;return 1===(1&this.magstripeFlags)?this._magstripe(e):3===(3&this.chipFlags)?(t=new Card,t.formFactor=FormFactor.Chip,t.reader=e,Log.debug("EMV Card Inserted"),t):1===(1&this.chipFlags)?(t=new Card,t.formFactor=FormFactor.Chip,t.reader=e,t.failed=!0,Log.warn("EMV Chip Invalid"),t):this.formFactor===FormFactor.EmvCertifiedContactless?(t=new Card,t.formFactor=this.formFactor,t.emvData=this.response,t.isEmv=this.emv,t.reader=e,t.failed=229===this.response.apdu.template,t.isContactlessMSD=!this.emv,Utils.extend(t,e.parseCardData(t,this.response)),t):void 0}},{key:"_magstripe",value:function(e){var t=new MagneticCard;t.formFactor=FormFactor.MagneticCardSwipe,t.ksn=this.ksn?this.ksn.toString("hex"):"",t.reader=e;var r=this.maskedTrack2||this.track2;if(!r&&!r.length)return Log.debug("Missing track 2 data"),t.failed=!0,t;var a=r.indexOf("=");if(6>a)return Log.debug("Missing track2 = sentinel."),t.failed=!0,t;var s=r.substring(a+5,a+6);return"2"!==s&&"6"!==s||(t.chipCard=!0),t.track2=this.response.apdu.data.toString("hex"),Utils.assignExcept(t,e.parseCardData(t,this.response),"isSignatureRequired"),t}},{key:"toString",value:function(){var e=[this.response.toString(),"\nChip flags ",this.chipFlags.toString(16)," Magstripe flags ",this.magstripeFlags.toString(16)];return this.ksn&&(e.push("\nKSN: "),e.push(this.ksn.toString("hex"))),this.track2&&(e.push("\nTrack 2: "),e.push(this.track2.toString("hex"))),this.maskedTrack2&&(e.push("\nMasked Track 2: "),e.push(this.maskedTrack2)),this.sredData&&(e.push("\nSRED: "),e.push(this.sredData.toString("hex"))),e.join("")}}]),e}();module.exports=CardStatus;


},{"manticore-log":123,"manticore-util":124,"retail-payment-device":179}],136:[function(require,module,exports){
"use strict";function _classCallCheck(r,a){if(!(r instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function r(r,a){for(var e=0;e<a.length;e++){var t=a[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(r,t.key,t)}}return function(a,e,t){return e&&r(a.prototype,e),t&&r(a,t),a}}(),Tags=require("../MiuraTags"),DeviceCaps=function(){function r(a){_classCallCheck(this,r),this.response=a,this.caps={};var e=!0,t=!1,n=void 0;try{for(var i,s=this.response.tlvs.values[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var o=i.value;o.tagNumber===Tags.MiuraConfigurationInformation.number&&this.readPair(o.parse())}}catch(u){t=!0,n=u}finally{try{!e&&s["return"]&&s["return"]()}finally{if(t)throw n}}}return _createClass(r,[{key:"readPair",value:function(r){var a,e=!0,t=!0,n=!1,i=void 0;try{for(var s,o=r.values[Symbol.iterator]();!(t=(s=o.next()).done);t=!0){var u=s.value;u.tagNumber===Tags.MiuraIdentifier.number?a=u.parse():u.tagNumber===Tags.MiuraVersionInformation.number&&(e=u.parse())}}catch(l){n=!0,i=l}finally{try{!t&&o["return"]&&o["return"]()}finally{if(n)throw i}}a&&(this.caps[a]=e)}},{key:"toString",value:function(){var r=[this.response.toString(),"\nCapabilities: "],a=!0,e=!1,t=void 0;try{for(var n,i=this.caps[Symbol.iterator]();!(a=(n=i.next()).done);a=!0){var s=n.value;r.push("  "),r.push(s),this.caps[s]&&this.caps[s]!==!0&&(r.push(": "),r.push(this.caps[s]))}}catch(o){e=!0,t=o}finally{try{!a&&i["return"]&&i["return"]()}finally{if(e)throw t}}return r.join("")}}]),r}();module.exports=DeviceCaps;


},{"../MiuraTags":127}],137:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),KeyStatus=function(){function e(t){_classCallCheck(this,e),this.response=t;var r=!0,n=!1,a=void 0;try{for(var o,s=this.response.tlvs.values[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var i=o.value;14656005===i.tagNumber&&(this.keyCode=i.bytes[0])}}catch(l){n=!0,a=l}finally{try{!r&&s["return"]&&s["return"]()}finally{if(n)throw a}}}return _createClass(e,[{key:"toString",value:function(){return this.response.toString()+"\nKeyCode 0x"+this.keyCode.toString(16)}}]),e}();module.exports=KeyStatus;


},{}],138:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function getTerminalStatus(t){switch(t){case 1:return TerminalStatus.Constants.PoweringOn;case 2:return TerminalStatus.Constants.PinEntryStateChange;case 3:return TerminalStatus.Constants.ApplicationSelection;case 10:return TerminalStatus.Constants.PoweringOff;case 11:return TerminalStatus.Constants.Rebooting;case 12:return TerminalStatus.Constants.MpiRestarting;default:return Log.error("Received unknown terminal status tag (0xC3) value "+t),"Unknown"}}function readOutcome(t,e){1===e?t.lastPinAttempt=!0:2===e?(t.pinCorrect=!0,t.pinComplete=!0):3===e?(t.pinCorrect=!1,t.pinComplete=!0,t.pinFailureReason="Incorrect PIN"):4===e?(t.pinCorrect=!1,t.pinComplete=!0,t.pinFailureReason="Entry Error"):5===e&&(t.pinComplete=!0)}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),Tags=require("../MiuraTags"),Log=require("manticore-log")("device.miura"),TerminalStatus=function(){function t(e){_classCallCheck(this,t);var n=this;this.response=e,this.response.tlvs.values.forEach(function(t){if(t.tag===Tags.MiuraStateChangeReason)n.changeType=getTerminalStatus(t.bytes[0]);else if(t.tag===Tags.MiuraStateChangeText)n.description=t.parse();else if(t.tag===Tags.MiuraDigitsInPinBuffer)n.pinDigits=t.parse();else if(t.tag===Tags.MiuraPinEntryStatus){var e=t.bytes[0];readOutcome(n,e)}})}return _createClass(t,[{key:"toString",value:function(){var t=[this.response.toString()+"\nChange Type: "+this.changeType+" ("+this.description+")"];return this.hasOwnProperty("pinDigits")&&(t.push("\nPIN digits: "),t.push(this.pinDigits)),this.hasOwnProperty("pinComplete")&&(t.push("\nPIN entry complete."),this.hasOwnProperty("pinCorrect")&&(t.push("Correct? "+(this.pinCorrect?"yes":"no")),this.pinCorrect||(t.push("\nPIN failure reason: "),t.push(this.pinFailureReason))),this.lastPinAttempt&&t.push("\n*** LAST PIN ATTEMPT ***")),t.join("")}}]),t}();TerminalStatus.Constants={PoweringOn:"PoweringOn",PinEntryStateChange:"PinEntryStateChange",ApplicationSelection:"ApplicationSelection",PoweringOff:"PoweringOff",Rebooting:"Rebooting",MpiRestarting:"MpiRestarting"},module.exports=TerminalStatus;


},{"../MiuraTags":127,"manticore-log":123}],139:[function(require,module,exports){
"use strict";module.exports={Connecting:"\nConnecting to\nApplication",Ready:"Ready to accept\npayments.",NfcTimeout:"${amount}\nTransaction timed out",GeneralNfcFallback:"Unable to read card.\nInsert or swipe\ncard now or try\n a different card",TransactionCancelled:"${amount}\nTransaction cancelled",ReadyForInsertAndSwipePayment:"$image(insertswipe.bmp)\n${amount}",ReadyForInsertPayment:"$image(Insert.bmp)\n${amount}",ReadyForSwipePayment:"$image(Swipe.bmp)\n${amount}",ContactIssuer:"Please contact your\ncard issuer.",InvoiceTotal:"${amount}${footer}",RechargeNow:"Recharge now.",SwUpdate:{EncryptInit:"Initializing\nDevice",EncryptGet:"Validating\nSecurity\nKeys",EncryptDone:"Security\nKeys\nInstalled",Required:"Software\nUpdate\nRequired",OS:"Updating OS\n${progress}%",MPI:"Updating Terminal\n${progress}%",Config:"Updating\nConfiguration\n${progress}%",Failed:"Software update\nfailed."},Processing:{Tap:"Processing...",Contact:"${amount}\nDo not remove card.\nProcessing...",PinOk:"\nDo not remove card.\nProcessing...\nPIN OK"},Paid:{RemoveCard:"${amount} paid.\nPlease remove card.",Successful:"${amount} paid.\nThank you!"},Refund:{RemoveCard:"${amount} refunded.\nPlease remove card.",Successful:"${amount} refunded.\nThank you!"},Declined:{BlockedCardInserted:"Declined.\nPlease remove card.",UnableToReadNfcCard:"Unable to read card.\nInsert, swipe, or\npress OK on the app and tap another card.",NfcDecline:"Declined.\nRetry with\ninsert or swipe?",IncorrectPin:"Incorrect PIN\nPlease try again."},Signature:{Contact:"Signature Required.\nDo not remove card.",Contactless:"Signature Required."}};


},{}],140:[function(require,module,exports){
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.moment=e()}(this,function(){"use strict";function t(){return $n.apply(null,arguments)}function e(t){$n=t}function n(t){return"[object Array]"===Object.prototype.toString.call(t)}function i(t){return t instanceof Date||"[object Date]"===Object.prototype.toString.call(t)}function s(t,e){var n,i=[];for(n=0;n<t.length;++n)i.push(e(t[n],n));return i}function r(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function a(t,e){for(var n in e)r(e,n)&&(t[n]=e[n]);return r(e,"toString")&&(t.toString=e.toString),r(e,"valueOf")&&(t.valueOf=e.valueOf),t}function o(t,e,n,i){return Wt(t,e,n,i,!0).utc()}function u(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(t){return null==t._pf&&(t._pf=u()),t._pf}function h(t){if(null==t._isValid){var e=d(t);t._isValid=!(isNaN(t._d.getTime())||!(e.overflow<0)||e.empty||e.invalidMonth||e.invalidWeekday||e.nullInput||e.invalidFormat||e.userInvalidated),t._strict&&(t._isValid=t._isValid&&0===e.charsLeftOver&&0===e.unusedTokens.length&&void 0===e.bigHour)}return t._isValid}function l(t){var e=o(NaN);return null!=t?a(d(e),t):d(e).userInvalidated=!0,e}function c(t){return void 0===t}function f(t,e){var n,i,s;if(c(e._isAMomentObject)||(t._isAMomentObject=e._isAMomentObject),c(e._i)||(t._i=e._i),c(e._f)||(t._f=e._f),c(e._l)||(t._l=e._l),c(e._strict)||(t._strict=e._strict),c(e._tzm)||(t._tzm=e._tzm),c(e._isUTC)||(t._isUTC=e._isUTC),c(e._offset)||(t._offset=e._offset),c(e._pf)||(t._pf=d(e)),c(e._locale)||(t._locale=e._locale),Jn.length>0)for(n in Jn)i=Jn[n],s=e[i],c(s)||(t[i]=s);return t}function m(e){f(this,e),this._d=new Date(null!=e._d?e._d.getTime():NaN),Bn===!1&&(Bn=!0,t.updateOffset(this),Bn=!1)}function _(t){return t instanceof m||null!=t&&null!=t._isAMomentObject}function y(t){return 0>t?Math.ceil(t):Math.floor(t)}function g(t){var e=+t,n=0;return 0!==e&&isFinite(e)&&(n=y(e)),n}function p(t,e,n){var i,s=Math.min(t.length,e.length),r=Math.abs(t.length-e.length),a=0;for(i=0;s>i;i++)(n&&t[i]!==e[i]||!n&&g(t[i])!==g(e[i]))&&a++;return a+r}function v(){}function D(t){return t?t.toLowerCase().replace("_","-"):t}function M(t){for(var e,n,i,s,r=0;r<t.length;){for(s=D(t[r]).split("-"),e=s.length,n=D(t[r+1]),n=n?n.split("-"):null;e>0;){if(i=Y(s.slice(0,e).join("-")))return i;if(n&&n.length>=e&&p(s,n,!0)>=e-1)break;e--}r++}return null}function Y(t){var e=null;if(!Qn[t]&&"undefined"!=typeof module&&module&&module.exports)try{e=qn._abbr,require("./locale/"+t),S(e)}catch(n){}return Qn[t]}function S(t,e){var n;return t&&(n=c(e)?k(t):w(t,e),n&&(qn=n)),qn._abbr}function w(t,e){return null!==e?(e.abbr=t,Qn[t]=Qn[t]||new v,Qn[t].set(e),S(t),Qn[t]):(delete Qn[t],null)}function k(t){var e;if(t&&t._locale&&t._locale._abbr&&(t=t._locale._abbr),!t)return qn;if(!n(t)){if(e=Y(t))return e;t=[t]}return M(t)}function T(t,e){var n=t.toLowerCase();Xn[n]=Xn[n+"s"]=Xn[e]=t}function b(t){return"string"==typeof t?Xn[t]||Xn[t.toLowerCase()]:void 0}function O(t){var e,n,i={};for(n in t)r(t,n)&&(e=b(n),e&&(i[e]=t[n]));return i}function W(t){return t instanceof Function||"[object Function]"===Object.prototype.toString.call(t)}function x(e,n){return function(i){return null!=i?(G(this,e,i),t.updateOffset(this,n),this):U(this,e)}}function U(t,e){return t.isValid()?t._d["get"+(t._isUTC?"UTC":"")+e]():NaN}function G(t,e,n){t.isValid()&&t._d["set"+(t._isUTC?"UTC":"")+e](n)}function P(t,e){var n;if("object"==typeof t)for(n in t)this.set(n,t[n]);else if(t=b(t),W(this[t]))return this[t](e);return this}function C(t,e,n){var i=""+Math.abs(t),s=e-i.length,r=t>=0;return(r?n?"+":"":"-")+Math.pow(10,Math.max(0,s)).toString().substr(1)+i}function F(t,e,n,i){var s=i;"string"==typeof i&&(s=function(){return this[i]()}),t&&(ni[t]=s),e&&(ni[e[0]]=function(){return C(s.apply(this,arguments),e[1],e[2])}),n&&(ni[n]=function(){return this.localeData().ordinal(s.apply(this,arguments),t)})}function H(t){return t.match(/\[[\s\S]/)?t.replace(/^\[|\]$/g,""):t.replace(/\\/g,"")}function V(t){var e,n,i=t.match(Kn);for(e=0,n=i.length;n>e;e++)ni[i[e]]?i[e]=ni[i[e]]:i[e]=H(i[e]);return function(s){var r="";for(e=0;n>e;e++)r+=i[e]instanceof Function?i[e].call(s,t):i[e];return r}}function L(t,e){return t.isValid()?(e=I(e,t.localeData()),ei[e]=ei[e]||V(e),ei[e](t)):t.localeData().invalidDate()}function I(t,e){function n(t){return e.longDateFormat(t)||t}var i=5;for(ti.lastIndex=0;i>=0&&ti.test(t);)t=t.replace(ti,n),ti.lastIndex=0,i-=1;return t}function N(t,e,n){Di[t]=W(e)?e:function(t,i){return t&&n?n:e}}function A(t,e){return r(Di,t)?Di[t](e._strict,e._locale):new RegExp(R(t))}function R(t){return E(t.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(t,e,n,i,s){return e||n||i||s}))}function E(t){return t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function z(t,e){var n,i=e;for("string"==typeof t&&(t=[t]),"number"==typeof e&&(i=function(t,n){n[e]=g(t)}),n=0;n<t.length;n++)Mi[t[n]]=i}function Z(t,e){z(t,function(t,n,i,s){i._w=i._w||{},e(t,i._w,i,s)})}function j(t,e,n){null!=e&&r(Mi,t)&&Mi[t](e,n._a,n,t)}function $(t,e){return new Date(Date.UTC(t,e+1,0)).getUTCDate()}function q(t,e){return n(this._months)?this._months[t.month()]:this._months[Ui.test(e)?"format":"standalone"][t.month()]}function J(t,e){return n(this._monthsShort)?this._monthsShort[t.month()]:this._monthsShort[Ui.test(e)?"format":"standalone"][t.month()]}function B(t,e,n){var i,s,r;for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),i=0;12>i;i++){if(s=o([2e3,i]),n&&!this._longMonthsParse[i]&&(this._longMonthsParse[i]=new RegExp("^"+this.months(s,"").replace(".","")+"$","i"),this._shortMonthsParse[i]=new RegExp("^"+this.monthsShort(s,"").replace(".","")+"$","i")),n||this._monthsParse[i]||(r="^"+this.months(s,"")+"|^"+this.monthsShort(s,""),this._monthsParse[i]=new RegExp(r.replace(".",""),"i")),n&&"MMMM"===e&&this._longMonthsParse[i].test(t))return i;if(n&&"MMM"===e&&this._shortMonthsParse[i].test(t))return i;if(!n&&this._monthsParse[i].test(t))return i}}function Q(t,e){var n;return t.isValid()?"string"==typeof e&&(e=t.localeData().monthsParse(e),"number"!=typeof e)?t:(n=Math.min(t.date(),$(t.year(),e)),t._d["set"+(t._isUTC?"UTC":"")+"Month"](e,n),t):t}function X(e){return null!=e?(Q(this,e),t.updateOffset(this,!0),this):U(this,"Month")}function K(){return $(this.year(),this.month())}function tt(t){return this._monthsParseExact?(r(this,"_monthsRegex")||nt.call(this),t?this._monthsShortStrictRegex:this._monthsShortRegex):this._monthsShortStrictRegex&&t?this._monthsShortStrictRegex:this._monthsShortRegex}function et(t){return this._monthsParseExact?(r(this,"_monthsRegex")||nt.call(this),t?this._monthsStrictRegex:this._monthsRegex):this._monthsStrictRegex&&t?this._monthsStrictRegex:this._monthsRegex}function nt(){function t(t,e){return e.length-t.length}var e,n,i=[],s=[],r=[];for(e=0;12>e;e++)n=o([2e3,e]),i.push(this.monthsShort(n,"")),s.push(this.months(n,"")),r.push(this.months(n,"")),r.push(this.monthsShort(n,""));for(i.sort(t),s.sort(t),r.sort(t),e=0;12>e;e++)i[e]=E(i[e]),s[e]=E(s[e]),r[e]=E(r[e]);this._monthsRegex=new RegExp("^("+r.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+s.join("|")+")$","i"),this._monthsShortStrictRegex=new RegExp("^("+i.join("|")+")$","i")}function it(t){var e,n=t._a;return n&&-2===d(t).overflow&&(e=n[Si]<0||n[Si]>11?Si:n[wi]<1||n[wi]>$(n[Yi],n[Si])?wi:n[ki]<0||n[ki]>24||24===n[ki]&&(0!==n[Ti]||0!==n[bi]||0!==n[Oi])?ki:n[Ti]<0||n[Ti]>59?Ti:n[bi]<0||n[bi]>59?bi:n[Oi]<0||n[Oi]>999?Oi:-1,d(t)._overflowDayOfYear&&(Yi>e||e>wi)&&(e=wi),d(t)._overflowWeeks&&-1===e&&(e=Wi),d(t)._overflowWeekday&&-1===e&&(e=xi),d(t).overflow=e),t}function st(e){t.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+e)}function rt(t,e){var n=!0;return a(function(){return n&&(st(t+"\nArguments: "+Array.prototype.slice.call(arguments).join(", ")+"\n"+(new Error).stack),n=!1),e.apply(this,arguments)},e)}function at(t,e){Hi[t]||(st(e),Hi[t]=!0)}function ot(t){var e,n,i,s,r,a,o=t._i,u=Vi.exec(o)||Li.exec(o);if(u){for(d(t).iso=!0,e=0,n=Ni.length;n>e;e++)if(Ni[e][1].exec(u[1])){s=Ni[e][0],i=Ni[e][2]!==!1;break}if(null==s)return void(t._isValid=!1);if(u[3]){for(e=0,n=Ai.length;n>e;e++)if(Ai[e][1].exec(u[3])){r=(u[2]||" ")+Ai[e][0];break}if(null==r)return void(t._isValid=!1)}if(!i&&null!=r)return void(t._isValid=!1);if(u[4]){if(!Ii.exec(u[4]))return void(t._isValid=!1);a="Z"}t._f=s+(r||"")+(a||""),Yt(t)}else t._isValid=!1}function ut(e){var n=Ri.exec(e._i);return null!==n?void(e._d=new Date(+n[1])):(ot(e),void(e._isValid===!1&&(delete e._isValid,t.createFromInputFallback(e))))}function dt(t,e,n,i,s,r,a){var o=new Date(t,e,n,i,s,r,a);return 100>t&&t>=0&&isFinite(o.getFullYear())&&o.setFullYear(t),o}function ht(t){var e=new Date(Date.UTC.apply(null,arguments));return 100>t&&t>=0&&isFinite(e.getUTCFullYear())&&e.setUTCFullYear(t),e}function lt(t){return ct(t)?366:365}function ct(t){return t%4===0&&t%100!==0||t%400===0}function ft(){return ct(this.year())}function mt(t,e,n){var i=7+e-n,s=(7+ht(t,0,i).getUTCDay()-e)%7;return-s+i-1}function _t(t,e,n,i,s){var r,a,o=(7+n-i)%7,u=mt(t,i,s),d=1+7*(e-1)+o+u;return 0>=d?(r=t-1,a=lt(r)+d):d>lt(t)?(r=t+1,a=d-lt(t)):(r=t,a=d),{year:r,dayOfYear:a}}function yt(t,e,n){var i,s,r=mt(t.year(),e,n),a=Math.floor((t.dayOfYear()-r-1)/7)+1;return 1>a?(s=t.year()-1,i=a+gt(s,e,n)):a>gt(t.year(),e,n)?(i=a-gt(t.year(),e,n),s=t.year()+1):(s=t.year(),i=a),{week:i,year:s}}function gt(t,e,n){var i=mt(t,e,n),s=mt(t+1,e,n);return(lt(t)-i+s)/7}function pt(t,e,n){return null!=t?t:null!=e?e:n}function vt(e){var n=new Date(t.now());return e._useUTC?[n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()]:[n.getFullYear(),n.getMonth(),n.getDate()]}function Dt(t){var e,n,i,s,r=[];if(!t._d){for(i=vt(t),t._w&&null==t._a[wi]&&null==t._a[Si]&&Mt(t),t._dayOfYear&&(s=pt(t._a[Yi],i[Yi]),t._dayOfYear>lt(s)&&(d(t)._overflowDayOfYear=!0),n=ht(s,0,t._dayOfYear),t._a[Si]=n.getUTCMonth(),t._a[wi]=n.getUTCDate()),e=0;3>e&&null==t._a[e];++e)t._a[e]=r[e]=i[e];for(;7>e;e++)t._a[e]=r[e]=null==t._a[e]?2===e?1:0:t._a[e];24===t._a[ki]&&0===t._a[Ti]&&0===t._a[bi]&&0===t._a[Oi]&&(t._nextDay=!0,t._a[ki]=0),t._d=(t._useUTC?ht:dt).apply(null,r),null!=t._tzm&&t._d.setUTCMinutes(t._d.getUTCMinutes()-t._tzm),t._nextDay&&(t._a[ki]=24)}}function Mt(t){var e,n,i,s,r,a,o,u;e=t._w,null!=e.GG||null!=e.W||null!=e.E?(r=1,a=4,n=pt(e.GG,t._a[Yi],yt(xt(),1,4).year),i=pt(e.W,1),s=pt(e.E,1),(1>s||s>7)&&(u=!0)):(r=t._locale._week.dow,a=t._locale._week.doy,n=pt(e.gg,t._a[Yi],yt(xt(),r,a).year),i=pt(e.w,1),null!=e.d?(s=e.d,(0>s||s>6)&&(u=!0)):null!=e.e?(s=e.e+r,(e.e<0||e.e>6)&&(u=!0)):s=r),1>i||i>gt(n,r,a)?d(t)._overflowWeeks=!0:null!=u?d(t)._overflowWeekday=!0:(o=_t(n,i,s,r,a),t._a[Yi]=o.year,t._dayOfYear=o.dayOfYear)}function Yt(e){if(e._f===t.ISO_8601)return void ot(e);e._a=[],d(e).empty=!0;var n,i,s,r,a,o=""+e._i,u=o.length,h=0;for(s=I(e._f,e._locale).match(Kn)||[],n=0;n<s.length;n++)r=s[n],i=(o.match(A(r,e))||[])[0],i&&(a=o.substr(0,o.indexOf(i)),a.length>0&&d(e).unusedInput.push(a),o=o.slice(o.indexOf(i)+i.length),h+=i.length),ni[r]?(i?d(e).empty=!1:d(e).unusedTokens.push(r),j(r,i,e)):e._strict&&!i&&d(e).unusedTokens.push(r);d(e).charsLeftOver=u-h,o.length>0&&d(e).unusedInput.push(o),d(e).bigHour===!0&&e._a[ki]<=12&&e._a[ki]>0&&(d(e).bigHour=void 0),e._a[ki]=St(e._locale,e._a[ki],e._meridiem),Dt(e),it(e)}function St(t,e,n){var i;return null==n?e:null!=t.meridiemHour?t.meridiemHour(e,n):null!=t.isPM?(i=t.isPM(n),i&&12>e&&(e+=12),i||12!==e||(e=0),e):e}function wt(t){var e,n,i,s,r;if(0===t._f.length)return d(t).invalidFormat=!0,void(t._d=new Date(NaN));for(s=0;s<t._f.length;s++)r=0,e=f({},t),null!=t._useUTC&&(e._useUTC=t._useUTC),e._f=t._f[s],Yt(e),h(e)&&(r+=d(e).charsLeftOver,r+=10*d(e).unusedTokens.length,d(e).score=r,(null==i||i>r)&&(i=r,n=e));a(t,n||e)}function kt(t){if(!t._d){var e=O(t._i);t._a=s([e.year,e.month,e.day||e.date,e.hour,e.minute,e.second,e.millisecond],function(t){return t&&parseInt(t,10)}),Dt(t)}}function Tt(t){var e=new m(it(bt(t)));return e._nextDay&&(e.add(1,"d"),e._nextDay=void 0),e}function bt(t){var e=t._i,s=t._f;return t._locale=t._locale||k(t._l),null===e||void 0===s&&""===e?l({nullInput:!0}):("string"==typeof e&&(t._i=e=t._locale.preparse(e)),_(e)?new m(it(e)):(n(s)?wt(t):s?Yt(t):i(e)?t._d=e:Ot(t),h(t)||(t._d=null),t))}function Ot(e){var r=e._i;void 0===r?e._d=new Date(t.now()):i(r)?e._d=new Date(+r):"string"==typeof r?ut(e):n(r)?(e._a=s(r.slice(0),function(t){return parseInt(t,10)}),Dt(e)):"object"==typeof r?kt(e):"number"==typeof r?e._d=new Date(r):t.createFromInputFallback(e)}function Wt(t,e,n,i,s){var r={};return"boolean"==typeof n&&(i=n,n=void 0),r._isAMomentObject=!0,r._useUTC=r._isUTC=s,r._l=n,r._i=t,r._f=e,r._strict=i,Tt(r)}function xt(t,e,n,i){return Wt(t,e,n,i,!1)}function Ut(t,e){var i,s;if(1===e.length&&n(e[0])&&(e=e[0]),!e.length)return xt();for(i=e[0],s=1;s<e.length;++s)e[s].isValid()&&!e[s][t](i)||(i=e[s]);return i}function Gt(){var t=[].slice.call(arguments,0);return Ut("isBefore",t)}function Pt(){var t=[].slice.call(arguments,0);return Ut("isAfter",t)}function Ct(t){var e=O(t),n=e.year||0,i=e.quarter||0,s=e.month||0,r=e.week||0,a=e.day||0,o=e.hour||0,u=e.minute||0,d=e.second||0,h=e.millisecond||0;this._milliseconds=+h+1e3*d+6e4*u+36e5*o,this._days=+a+7*r,this._months=+s+3*i+12*n,this._data={},this._locale=k(),this._bubble()}function Ft(t){return t instanceof Ct}function Ht(t,e){F(t,0,0,function(){var t=this.utcOffset(),n="+";return 0>t&&(t=-t,n="-"),n+C(~~(t/60),2)+e+C(~~t%60,2)})}function Vt(t,e){var n=(e||"").match(t)||[],i=n[n.length-1]||[],s=(i+"").match($i)||["-",0,0],r=+(60*s[1])+g(s[2]);return"+"===s[0]?r:-r}function Lt(e,n){var s,r;return n._isUTC?(s=n.clone(),r=(_(e)||i(e)?+e:+xt(e))-+s,s._d.setTime(+s._d+r),t.updateOffset(s,!1),s):xt(e).local()}function It(t){return 15*-Math.round(t._d.getTimezoneOffset()/15)}function Nt(e,n){var i,s=this._offset||0;return this.isValid()?null!=e?("string"==typeof e?e=Vt(gi,e):Math.abs(e)<16&&(e=60*e),!this._isUTC&&n&&(i=It(this)),this._offset=e,this._isUTC=!0,null!=i&&this.add(i,"m"),s!==e&&(!n||this._changeInProgress?ne(this,Qt(e-s,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,t.updateOffset(this,!0),this._changeInProgress=null)),this):this._isUTC?s:It(this):null!=e?this:NaN}function At(t,e){return null!=t?("string"!=typeof t&&(t=-t),this.utcOffset(t,e),this):-this.utcOffset()}function Rt(t){return this.utcOffset(0,t)}function Et(t){return this._isUTC&&(this.utcOffset(0,t),this._isUTC=!1,t&&this.subtract(It(this),"m")),this}function zt(){return this._tzm?this.utcOffset(this._tzm):"string"==typeof this._i&&this.utcOffset(Vt(yi,this._i)),this}function Zt(t){return this.isValid()?(t=t?xt(t).utcOffset():0,(this.utcOffset()-t)%60===0):!1}function jt(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function $t(){if(!c(this._isDSTShifted))return this._isDSTShifted;var t={};if(f(t,this),t=bt(t),t._a){var e=t._isUTC?o(t._a):xt(t._a);this._isDSTShifted=this.isValid()&&p(t._a,e.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function qt(){return this.isValid()?!this._isUTC:!1}function Jt(){return this.isValid()?this._isUTC:!1}function Bt(){return this.isValid()?this._isUTC&&0===this._offset:!1}function Qt(t,e){var n,i,s,a=t,o=null;return Ft(t)?a={ms:t._milliseconds,d:t._days,M:t._months}:"number"==typeof t?(a={},e?a[e]=t:a.milliseconds=t):(o=qi.exec(t))?(n="-"===o[1]?-1:1,a={y:0,d:g(o[wi])*n,h:g(o[ki])*n,m:g(o[Ti])*n,s:g(o[bi])*n,ms:g(o[Oi])*n}):(o=Ji.exec(t))?(n="-"===o[1]?-1:1,a={y:Xt(o[2],n),M:Xt(o[3],n),d:Xt(o[4],n),h:Xt(o[5],n),m:Xt(o[6],n),s:Xt(o[7],n),w:Xt(o[8],n)}):null==a?a={}:"object"==typeof a&&("from"in a||"to"in a)&&(s=te(xt(a.from),xt(a.to)),a={},a.ms=s.milliseconds,a.M=s.months),i=new Ct(a),Ft(t)&&r(t,"_locale")&&(i._locale=t._locale),i}function Xt(t,e){var n=t&&parseFloat(t.replace(",","."));return(isNaN(n)?0:n)*e}function Kt(t,e){var n={milliseconds:0,months:0};return n.months=e.month()-t.month()+12*(e.year()-t.year()),t.clone().add(n.months,"M").isAfter(e)&&--n.months,n.milliseconds=+e-+t.clone().add(n.months,"M"),n}function te(t,e){var n;return t.isValid()&&e.isValid()?(e=Lt(e,t),t.isBefore(e)?n=Kt(t,e):(n=Kt(e,t),n.milliseconds=-n.milliseconds,n.months=-n.months),n):{milliseconds:0,months:0}}function ee(t,e){return function(n,i){var s,r;return null===i||isNaN(+i)||(at(e,"moment()."+e+"(period, number) is deprecated. Please use moment()."+e+"(number, period)."),r=n,n=i,i=r),n="string"==typeof n?+n:n,s=Qt(n,i),ne(this,s,t),this}}function ne(e,n,i,s){var r=n._milliseconds,a=n._days,o=n._months;e.isValid()&&(s=null==s?!0:s,r&&e._d.setTime(+e._d+r*i),a&&G(e,"Date",U(e,"Date")+a*i),o&&Q(e,U(e,"Month")+o*i),s&&t.updateOffset(e,a||o))}function ie(t,e){var n=t||xt(),i=Lt(n,this).startOf("day"),s=this.diff(i,"days",!0),r=-6>s?"sameElse":-1>s?"lastWeek":0>s?"lastDay":1>s?"sameDay":2>s?"nextDay":7>s?"nextWeek":"sameElse",a=e&&(W(e[r])?e[r]():e[r]);return this.format(a||this.localeData().calendar(r,this,xt(n)))}function se(){return new m(this)}function re(t,e){var n=_(t)?t:xt(t);return this.isValid()&&n.isValid()?(e=b(c(e)?"millisecond":e),"millisecond"===e?+this>+n:+n<+this.clone().startOf(e)):!1}function ae(t,e){var n=_(t)?t:xt(t);return this.isValid()&&n.isValid()?(e=b(c(e)?"millisecond":e),"millisecond"===e?+n>+this:+this.clone().endOf(e)<+n):!1}function oe(t,e,n){return this.isAfter(t,n)&&this.isBefore(e,n)}function ue(t,e){var n,i=_(t)?t:xt(t);return this.isValid()&&i.isValid()?(e=b(e||"millisecond"),"millisecond"===e?+this===+i:(n=+i,+this.clone().startOf(e)<=n&&n<=+this.clone().endOf(e))):!1}function de(t,e){return this.isSame(t,e)||this.isAfter(t,e)}function he(t,e){return this.isSame(t,e)||this.isBefore(t,e)}function le(t,e,n){var i,s,r,a;return this.isValid()?(i=Lt(t,this),i.isValid()?(s=6e4*(i.utcOffset()-this.utcOffset()),e=b(e),"year"===e||"month"===e||"quarter"===e?(a=ce(this,i),"quarter"===e?a/=3:"year"===e&&(a/=12)):(r=this-i,a="second"===e?r/1e3:"minute"===e?r/6e4:"hour"===e?r/36e5:"day"===e?(r-s)/864e5:"week"===e?(r-s)/6048e5:r),n?a:y(a)):NaN):NaN}function ce(t,e){var n,i,s=12*(e.year()-t.year())+(e.month()-t.month()),r=t.clone().add(s,"months");return 0>e-r?(n=t.clone().add(s-1,"months"),i=(e-r)/(r-n)):(n=t.clone().add(s+1,"months"),i=(e-r)/(n-r)),-(s+i)}function fe(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function me(){var t=this.clone().utc();return 0<t.year()&&t.year()<=9999?W(Date.prototype.toISOString)?this.toDate().toISOString():L(t,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):L(t,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}function _e(e){var n=L(this,e||t.defaultFormat);return this.localeData().postformat(n)}function ye(t,e){return this.isValid()&&(_(t)&&t.isValid()||xt(t).isValid())?Qt({to:this,from:t}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function ge(t){return this.from(xt(),t)}function pe(t,e){return this.isValid()&&(_(t)&&t.isValid()||xt(t).isValid())?Qt({from:this,to:t}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function ve(t){return this.to(xt(),t)}function De(t){var e;return void 0===t?this._locale._abbr:(e=k(t),null!=e&&(this._locale=e),this)}function Me(){return this._locale}function Ye(t){switch(t=b(t)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===t&&this.weekday(0),"isoWeek"===t&&this.isoWeekday(1),"quarter"===t&&this.month(3*Math.floor(this.month()/3)),this}function Se(t){return t=b(t),void 0===t||"millisecond"===t?this:this.startOf(t).add(1,"isoWeek"===t?"week":t).subtract(1,"ms")}function we(){return+this._d-6e4*(this._offset||0)}function ke(){return Math.floor(+this/1e3)}function Te(){return this._offset?new Date(+this):this._d}function be(){var t=this;return[t.year(),t.month(),t.date(),t.hour(),t.minute(),t.second(),t.millisecond()]}function Oe(){var t=this;return{years:t.year(),months:t.month(),date:t.date(),hours:t.hours(),minutes:t.minutes(),seconds:t.seconds(),milliseconds:t.milliseconds()}}function We(){return this.isValid()?this.toISOString():"null"}function xe(){return h(this)}function Ue(){return a({},d(this))}function Ge(){return d(this).overflow}function Pe(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}function Ce(t,e){F(0,[t,t.length],0,e)}function Fe(t){return Ie.call(this,t,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)}function He(t){return Ie.call(this,t,this.isoWeek(),this.isoWeekday(),1,4)}function Ve(){return gt(this.year(),1,4)}function Le(){var t=this.localeData()._week;return gt(this.year(),t.dow,t.doy)}function Ie(t,e,n,i,s){var r;return null==t?yt(this,i,s).year:(r=gt(t,i,s),e>r&&(e=r),Ne.call(this,t,e,n,i,s))}function Ne(t,e,n,i,s){var r=_t(t,e,n,i,s),a=ht(r.year,0,r.dayOfYear);return this.year(a.getUTCFullYear()),this.month(a.getUTCMonth()),this.date(a.getUTCDate()),this}function Ae(t){return null==t?Math.ceil((this.month()+1)/3):this.month(3*(t-1)+this.month()%3)}function Re(t){return yt(t,this._week.dow,this._week.doy).week}function Ee(){return this._week.dow}function ze(){return this._week.doy}function Ze(t){var e=this.localeData().week(this);return null==t?e:this.add(7*(t-e),"d")}function je(t){var e=yt(this,1,4).week;return null==t?e:this.add(7*(t-e),"d")}function $e(t,e){return"string"!=typeof t?t:isNaN(t)?(t=e.weekdaysParse(t),"number"==typeof t?t:null):parseInt(t,10)}function qe(t,e){return n(this._weekdays)?this._weekdays[t.day()]:this._weekdays[this._weekdays.isFormat.test(e)?"format":"standalone"][t.day()]}function Je(t){return this._weekdaysShort[t.day()]}function Be(t){return this._weekdaysMin[t.day()]}function Qe(t,e,n){var i,s,r;for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),i=0;7>i;i++){if(s=xt([2e3,1]).day(i),n&&!this._fullWeekdaysParse[i]&&(this._fullWeekdaysParse[i]=new RegExp("^"+this.weekdays(s,"").replace(".",".?")+"$","i"),this._shortWeekdaysParse[i]=new RegExp("^"+this.weekdaysShort(s,"").replace(".",".?")+"$","i"),this._minWeekdaysParse[i]=new RegExp("^"+this.weekdaysMin(s,"").replace(".",".?")+"$","i")),this._weekdaysParse[i]||(r="^"+this.weekdays(s,"")+"|^"+this.weekdaysShort(s,"")+"|^"+this.weekdaysMin(s,""),this._weekdaysParse[i]=new RegExp(r.replace(".",""),"i")),n&&"dddd"===e&&this._fullWeekdaysParse[i].test(t))return i;if(n&&"ddd"===e&&this._shortWeekdaysParse[i].test(t))return i;if(n&&"dd"===e&&this._minWeekdaysParse[i].test(t))return i;if(!n&&this._weekdaysParse[i].test(t))return i}}function Xe(t){if(!this.isValid())return null!=t?this:NaN;var e=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=t?(t=$e(t,this.localeData()),this.add(t-e,"d")):e}function Ke(t){if(!this.isValid())return null!=t?this:NaN;var e=(this.day()+7-this.localeData()._week.dow)%7;return null==t?e:this.add(t-e,"d")}function tn(t){return this.isValid()?null==t?this.day()||7:this.day(this.day()%7?t:t-7):null!=t?this:NaN}function en(t){var e=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==t?e:this.add(t-e,"d")}function nn(){return this.hours()%12||12}function sn(t,e){F(t,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),e)})}function rn(t,e){return e._meridiemParse}function an(t){return"p"===(t+"").toLowerCase().charAt(0)}function on(t,e,n){return t>11?n?"pm":"PM":n?"am":"AM"}function un(t,e){e[Oi]=g(1e3*("0."+t))}function dn(){return this._isUTC?"UTC":""}function hn(){return this._isUTC?"Coordinated Universal Time":""}function ln(t){return xt(1e3*t)}function cn(){return xt.apply(null,arguments).parseZone()}function fn(t,e,n){var i=this._calendar[t];return W(i)?i.call(e,n):i}function mn(t){var e=this._longDateFormat[t],n=this._longDateFormat[t.toUpperCase()];return e||!n?e:(this._longDateFormat[t]=n.replace(/MMMM|MM|DD|dddd/g,function(t){return t.slice(1)}),this._longDateFormat[t])}function _n(){return this._invalidDate}function yn(t){return this._ordinal.replace("%d",t)}function gn(t){return t}function pn(t,e,n,i){var s=this._relativeTime[n];return W(s)?s(t,e,n,i):s.replace(/%d/i,t)}function vn(t,e){var n=this._relativeTime[t>0?"future":"past"];return W(n)?n(e):n.replace(/%s/i,e)}function Dn(t){var e,n;for(n in t)e=t[n],W(e)?this[n]=e:this["_"+n]=e;this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function Mn(t,e,n,i){var s=k(),r=o().set(i,e);return s[n](r,t)}function Yn(t,e,n,i,s){if("number"==typeof t&&(e=t,t=void 0),t=t||"",null!=e)return Mn(t,e,n,s);var r,a=[];for(r=0;i>r;r++)a[r]=Mn(t,r,n,s);return a}function Sn(t,e){return Yn(t,e,"months",12,"month")}function wn(t,e){return Yn(t,e,"monthsShort",12,"month")}function kn(t,e){return Yn(t,e,"weekdays",7,"day")}function Tn(t,e){return Yn(t,e,"weekdaysShort",7,"day")}function bn(t,e){return Yn(t,e,"weekdaysMin",7,"day")}function On(){var t=this._data;return this._milliseconds=vs(this._milliseconds),this._days=vs(this._days),this._months=vs(this._months),t.milliseconds=vs(t.milliseconds),t.seconds=vs(t.seconds),t.minutes=vs(t.minutes),t.hours=vs(t.hours),t.months=vs(t.months),t.years=vs(t.years),this}function Wn(t,e,n,i){var s=Qt(e,n);return t._milliseconds+=i*s._milliseconds,t._days+=i*s._days,t._months+=i*s._months,t._bubble()}function xn(t,e){return Wn(this,t,e,1)}function Un(t,e){return Wn(this,t,e,-1)}function Gn(t){return 0>t?Math.floor(t):Math.ceil(t)}function Pn(){var t,e,n,i,s,r=this._milliseconds,a=this._days,o=this._months,u=this._data;return r>=0&&a>=0&&o>=0||0>=r&&0>=a&&0>=o||(r+=864e5*Gn(Fn(o)+a),a=0,o=0),u.milliseconds=r%1e3,t=y(r/1e3),u.seconds=t%60,e=y(t/60),u.minutes=e%60,n=y(e/60),u.hours=n%24,a+=y(n/24),s=y(Cn(a)),o+=s,a-=Gn(Fn(s)),i=y(o/12),o%=12,u.days=a,u.months=o,u.years=i,this}function Cn(t){return 4800*t/146097}function Fn(t){return 146097*t/4800}function Hn(t){var e,n,i=this._milliseconds;if(t=b(t),"month"===t||"year"===t)return e=this._days+i/864e5,n=this._months+Cn(e),"month"===t?n:n/12;switch(e=this._days+Math.round(Fn(this._months)),t){case"week":return e/7+i/6048e5;case"day":return e+i/864e5;case"hour":return 24*e+i/36e5;case"minute":return 1440*e+i/6e4;case"second":return 86400*e+i/1e3;case"millisecond":return Math.floor(864e5*e)+i;default:throw new Error("Unknown unit "+t)}}function Vn(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*g(this._months/12)}function Ln(t){return function(){return this.as(t)}}function In(t){return t=b(t),this[t+"s"]()}function Nn(t){return function(){return this._data[t]}}function An(){return y(this.days()/7)}function Rn(t,e,n,i,s){return s.relativeTime(e||1,!!n,t,i)}function En(t,e,n){var i=Qt(t).abs(),s=Fs(i.as("s")),r=Fs(i.as("m")),a=Fs(i.as("h")),o=Fs(i.as("d")),u=Fs(i.as("M")),d=Fs(i.as("y")),h=s<Hs.s&&["s",s]||1>=r&&["m"]||r<Hs.m&&["mm",r]||1>=a&&["h"]||a<Hs.h&&["hh",a]||1>=o&&["d"]||o<Hs.d&&["dd",o]||1>=u&&["M"]||u<Hs.M&&["MM",u]||1>=d&&["y"]||["yy",d];return h[2]=e,h[3]=+t>0,h[4]=n,Rn.apply(null,h)}function zn(t,e){return void 0===Hs[t]?!1:void 0===e?Hs[t]:(Hs[t]=e,!0)}function Zn(t){var e=this.localeData(),n=En(this,!t,e);return t&&(n=e.pastFuture(+this,n)),e.postformat(n)}function jn(){var t,e,n,i=Vs(this._milliseconds)/1e3,s=Vs(this._days),r=Vs(this._months);t=y(i/60),e=y(t/60),i%=60,t%=60,n=y(r/12),r%=12;var a=n,o=r,u=s,d=e,h=t,l=i,c=this.asSeconds();return c?(0>c?"-":"")+"P"+(a?a+"Y":"")+(o?o+"M":"")+(u?u+"D":"")+(d||h||l?"T":"")+(d?d+"H":"")+(h?h+"M":"")+(l?l+"S":""):"P0D"}var $n,qn,Jn=t.momentProperties=[],Bn=!1,Qn={},Xn={},Kn=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,ti=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,ei={},ni={},ii=/\d/,si=/\d\d/,ri=/\d{3}/,ai=/\d{4}/,oi=/[+-]?\d{6}/,ui=/\d\d?/,di=/\d\d\d\d?/,hi=/\d\d\d\d\d\d?/,li=/\d{1,3}/,ci=/\d{1,4}/,fi=/[+-]?\d{1,6}/,mi=/\d+/,_i=/[+-]?\d+/,yi=/Z|[+-]\d\d:?\d\d/gi,gi=/Z|[+-]\d\d(?::?\d\d)?/gi,pi=/[+-]?\d+(\.\d{1,3})?/,vi=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Di={},Mi={},Yi=0,Si=1,wi=2,ki=3,Ti=4,bi=5,Oi=6,Wi=7,xi=8;F("M",["MM",2],"Mo",function(){return this.month()+1}),F("MMM",0,0,function(t){return this.localeData().monthsShort(this,t)}),F("MMMM",0,0,function(t){return this.localeData().months(this,t)}),T("month","M"),N("M",ui),N("MM",ui,si),N("MMM",function(t,e){return e.monthsShortRegex(t)}),N("MMMM",function(t,e){return e.monthsRegex(t)}),z(["M","MM"],function(t,e){e[Si]=g(t)-1}),z(["MMM","MMMM"],function(t,e,n,i){var s=n._locale.monthsParse(t,i,n._strict);null!=s?e[Si]=s:d(n).invalidMonth=t});var Ui=/D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/,Gi="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),Pi="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),Ci=vi,Fi=vi,Hi={};t.suppressDeprecationWarnings=!1;var Vi=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?/,Li=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?/,Ii=/Z|[+-]\d\d(?::?\d\d)?/,Ni=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],Ai=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Ri=/^\/?Date\((\-?\d+)/i;t.createFromInputFallback=rt("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(t){t._d=new Date(t._i+(t._useUTC?" UTC":""))}),F("Y",0,0,function(){var t=this.year();return 9999>=t?""+t:"+"+t}),F(0,["YY",2],0,function(){return this.year()%100}),F(0,["YYYY",4],0,"year"),F(0,["YYYYY",5],0,"year"),F(0,["YYYYYY",6,!0],0,"year"),T("year","y"),N("Y",_i),N("YY",ui,si),N("YYYY",ci,ai),N("YYYYY",fi,oi),N("YYYYYY",fi,oi),z(["YYYYY","YYYYYY"],Yi),z("YYYY",function(e,n){n[Yi]=2===e.length?t.parseTwoDigitYear(e):g(e)}),z("YY",function(e,n){n[Yi]=t.parseTwoDigitYear(e)}),z("Y",function(t,e){e[Yi]=parseInt(t,10)}),t.parseTwoDigitYear=function(t){return g(t)+(g(t)>68?1900:2e3)};var Ei=x("FullYear",!1);t.ISO_8601=function(){};var zi=rt("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(){var t=xt.apply(null,arguments);return this.isValid()&&t.isValid()?this>t?this:t:l()}),Zi=rt("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(){var t=xt.apply(null,arguments);return this.isValid()&&t.isValid()?t>this?this:t:l()}),ji=function(){return Date.now?Date.now():+new Date};Ht("Z",":"),Ht("ZZ",""),N("Z",gi),N("ZZ",gi),z(["Z","ZZ"],function(t,e,n){n._useUTC=!0,n._tzm=Vt(gi,t)});var $i=/([\+\-]|\d\d)/gi;t.updateOffset=function(){};var qi=/^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?\d*)?$/,Ji=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;
Qt.fn=Ct.prototype;var Bi=ee(1,"add"),Qi=ee(-1,"subtract");t.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";var Xi=rt("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(t){return void 0===t?this.localeData():this.locale(t)});F(0,["gg",2],0,function(){return this.weekYear()%100}),F(0,["GG",2],0,function(){return this.isoWeekYear()%100}),Ce("gggg","weekYear"),Ce("ggggg","weekYear"),Ce("GGGG","isoWeekYear"),Ce("GGGGG","isoWeekYear"),T("weekYear","gg"),T("isoWeekYear","GG"),N("G",_i),N("g",_i),N("GG",ui,si),N("gg",ui,si),N("GGGG",ci,ai),N("gggg",ci,ai),N("GGGGG",fi,oi),N("ggggg",fi,oi),Z(["gggg","ggggg","GGGG","GGGGG"],function(t,e,n,i){e[i.substr(0,2)]=g(t)}),Z(["gg","GG"],function(e,n,i,s){n[s]=t.parseTwoDigitYear(e)}),F("Q",0,"Qo","quarter"),T("quarter","Q"),N("Q",ii),z("Q",function(t,e){e[Si]=3*(g(t)-1)}),F("w",["ww",2],"wo","week"),F("W",["WW",2],"Wo","isoWeek"),T("week","w"),T("isoWeek","W"),N("w",ui),N("ww",ui,si),N("W",ui),N("WW",ui,si),Z(["w","ww","W","WW"],function(t,e,n,i){e[i.substr(0,1)]=g(t)});var Ki={dow:0,doy:6};F("D",["DD",2],"Do","date"),T("date","D"),N("D",ui),N("DD",ui,si),N("Do",function(t,e){return t?e._ordinalParse:e._ordinalParseLenient}),z(["D","DD"],wi),z("Do",function(t,e){e[wi]=g(t.match(ui)[0],10)});var ts=x("Date",!0);F("d",0,"do","day"),F("dd",0,0,function(t){return this.localeData().weekdaysMin(this,t)}),F("ddd",0,0,function(t){return this.localeData().weekdaysShort(this,t)}),F("dddd",0,0,function(t){return this.localeData().weekdays(this,t)}),F("e",0,0,"weekday"),F("E",0,0,"isoWeekday"),T("day","d"),T("weekday","e"),T("isoWeekday","E"),N("d",ui),N("e",ui),N("E",ui),N("dd",vi),N("ddd",vi),N("dddd",vi),Z(["dd","ddd","dddd"],function(t,e,n,i){var s=n._locale.weekdaysParse(t,i,n._strict);null!=s?e.d=s:d(n).invalidWeekday=t}),Z(["d","e","E"],function(t,e,n,i){e[i]=g(t)});var es="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),ns="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),is="Su_Mo_Tu_We_Th_Fr_Sa".split("_");F("DDD",["DDDD",3],"DDDo","dayOfYear"),T("dayOfYear","DDD"),N("DDD",li),N("DDDD",ri),z(["DDD","DDDD"],function(t,e,n){n._dayOfYear=g(t)}),F("H",["HH",2],0,"hour"),F("h",["hh",2],0,nn),F("hmm",0,0,function(){return""+nn.apply(this)+C(this.minutes(),2)}),F("hmmss",0,0,function(){return""+nn.apply(this)+C(this.minutes(),2)+C(this.seconds(),2)}),F("Hmm",0,0,function(){return""+this.hours()+C(this.minutes(),2)}),F("Hmmss",0,0,function(){return""+this.hours()+C(this.minutes(),2)+C(this.seconds(),2)}),sn("a",!0),sn("A",!1),T("hour","h"),N("a",rn),N("A",rn),N("H",ui),N("h",ui),N("HH",ui,si),N("hh",ui,si),N("hmm",di),N("hmmss",hi),N("Hmm",di),N("Hmmss",hi),z(["H","HH"],ki),z(["a","A"],function(t,e,n){n._isPm=n._locale.isPM(t),n._meridiem=t}),z(["h","hh"],function(t,e,n){e[ki]=g(t),d(n).bigHour=!0}),z("hmm",function(t,e,n){var i=t.length-2;e[ki]=g(t.substr(0,i)),e[Ti]=g(t.substr(i)),d(n).bigHour=!0}),z("hmmss",function(t,e,n){var i=t.length-4,s=t.length-2;e[ki]=g(t.substr(0,i)),e[Ti]=g(t.substr(i,2)),e[bi]=g(t.substr(s)),d(n).bigHour=!0}),z("Hmm",function(t,e,n){var i=t.length-2;e[ki]=g(t.substr(0,i)),e[Ti]=g(t.substr(i))}),z("Hmmss",function(t,e,n){var i=t.length-4,s=t.length-2;e[ki]=g(t.substr(0,i)),e[Ti]=g(t.substr(i,2)),e[bi]=g(t.substr(s))});var ss=/[ap]\.?m?\.?/i,rs=x("Hours",!0);F("m",["mm",2],0,"minute"),T("minute","m"),N("m",ui),N("mm",ui,si),z(["m","mm"],Ti);var as=x("Minutes",!1);F("s",["ss",2],0,"second"),T("second","s"),N("s",ui),N("ss",ui,si),z(["s","ss"],bi);var os=x("Seconds",!1);F("S",0,0,function(){return~~(this.millisecond()/100)}),F(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),F(0,["SSS",3],0,"millisecond"),F(0,["SSSS",4],0,function(){return 10*this.millisecond()}),F(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),F(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),F(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),F(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),F(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),T("millisecond","ms"),N("S",li,ii),N("SS",li,si),N("SSS",li,ri);var us;for(us="SSSS";us.length<=9;us+="S")N(us,mi);for(us="S";us.length<=9;us+="S")z(us,un);var ds=x("Milliseconds",!1);F("z",0,0,"zoneAbbr"),F("zz",0,0,"zoneName");var hs=m.prototype;hs.add=Bi,hs.calendar=ie,hs.clone=se,hs.diff=le,hs.endOf=Se,hs.format=_e,hs.from=ye,hs.fromNow=ge,hs.to=pe,hs.toNow=ve,hs.get=P,hs.invalidAt=Ge,hs.isAfter=re,hs.isBefore=ae,hs.isBetween=oe,hs.isSame=ue,hs.isSameOrAfter=de,hs.isSameOrBefore=he,hs.isValid=xe,hs.lang=Xi,hs.locale=De,hs.localeData=Me,hs.max=Zi,hs.min=zi,hs.parsingFlags=Ue,hs.set=P,hs.startOf=Ye,hs.subtract=Qi,hs.toArray=be,hs.toObject=Oe,hs.toDate=Te,hs.toISOString=me,hs.toJSON=We,hs.toString=fe,hs.unix=ke,hs.valueOf=we,hs.creationData=Pe,hs.year=Ei,hs.isLeapYear=ft,hs.weekYear=Fe,hs.isoWeekYear=He,hs.quarter=hs.quarters=Ae,hs.month=X,hs.daysInMonth=K,hs.week=hs.weeks=Ze,hs.isoWeek=hs.isoWeeks=je,hs.weeksInYear=Le,hs.isoWeeksInYear=Ve,hs.date=ts,hs.day=hs.days=Xe,hs.weekday=Ke,hs.isoWeekday=tn,hs.dayOfYear=en,hs.hour=hs.hours=rs,hs.minute=hs.minutes=as,hs.second=hs.seconds=os,hs.millisecond=hs.milliseconds=ds,hs.utcOffset=Nt,hs.utc=Rt,hs.local=Et,hs.parseZone=zt,hs.hasAlignedHourOffset=Zt,hs.isDST=jt,hs.isDSTShifted=$t,hs.isLocal=qt,hs.isUtcOffset=Jt,hs.isUtc=Bt,hs.isUTC=Bt,hs.zoneAbbr=dn,hs.zoneName=hn,hs.dates=rt("dates accessor is deprecated. Use date instead.",ts),hs.months=rt("months accessor is deprecated. Use month instead",X),hs.years=rt("years accessor is deprecated. Use year instead",Ei),hs.zone=rt("moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779",At);var ls=hs,cs={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},fs={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},ms="Invalid date",_s="%d",ys=/\d{1,2}/,gs={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ps=v.prototype;ps._calendar=cs,ps.calendar=fn,ps._longDateFormat=fs,ps.longDateFormat=mn,ps._invalidDate=ms,ps.invalidDate=_n,ps._ordinal=_s,ps.ordinal=yn,ps._ordinalParse=ys,ps.preparse=gn,ps.postformat=gn,ps._relativeTime=gs,ps.relativeTime=pn,ps.pastFuture=vn,ps.set=Dn,ps.months=q,ps._months=Gi,ps.monthsShort=J,ps._monthsShort=Pi,ps.monthsParse=B,ps._monthsRegex=Fi,ps.monthsRegex=et,ps._monthsShortRegex=Ci,ps.monthsShortRegex=tt,ps.week=Re,ps._week=Ki,ps.firstDayOfYear=ze,ps.firstDayOfWeek=Ee,ps.weekdays=qe,ps._weekdays=es,ps.weekdaysMin=Be,ps._weekdaysMin=is,ps.weekdaysShort=Je,ps._weekdaysShort=ns,ps.weekdaysParse=Qe,ps.isPM=an,ps._meridiemParse=ss,ps.meridiem=on,S("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(t){var e=t%10,n=1===g(t%100/10)?"th":1===e?"st":2===e?"nd":3===e?"rd":"th";return t+n}}),t.lang=rt("moment.lang is deprecated. Use moment.locale instead.",S),t.langData=rt("moment.langData is deprecated. Use moment.localeData instead.",k);var vs=Math.abs,Ds=Ln("ms"),Ms=Ln("s"),Ys=Ln("m"),Ss=Ln("h"),ws=Ln("d"),ks=Ln("w"),Ts=Ln("M"),bs=Ln("y"),Os=Nn("milliseconds"),Ws=Nn("seconds"),xs=Nn("minutes"),Us=Nn("hours"),Gs=Nn("days"),Ps=Nn("months"),Cs=Nn("years"),Fs=Math.round,Hs={s:45,m:45,h:22,d:26,M:11},Vs=Math.abs,Ls=Ct.prototype;Ls.abs=On,Ls.add=xn,Ls.subtract=Un,Ls.as=Hn,Ls.asMilliseconds=Ds,Ls.asSeconds=Ms,Ls.asMinutes=Ys,Ls.asHours=Ss,Ls.asDays=ws,Ls.asWeeks=ks,Ls.asMonths=Ts,Ls.asYears=bs,Ls.valueOf=Vn,Ls._bubble=Pn,Ls.get=In,Ls.milliseconds=Os,Ls.seconds=Ws,Ls.minutes=xs,Ls.hours=Us,Ls.days=Gs,Ls.weeks=An,Ls.months=Ps,Ls.years=Cs,Ls.humanize=Zn,Ls.toISOString=jn,Ls.toString=jn,Ls.toJSON=jn,Ls.locale=De,Ls.localeData=Me,Ls.toIsoString=rt("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",jn),Ls.lang=Xi,F("X",0,0,"unix"),F("x",0,0,"valueOf"),N("x",_i),N("X",pi),z("X",function(t,e,n){n._d=new Date(1e3*parseFloat(t,10))}),z("x",function(t,e,n){n._d=new Date(g(t))}),t.version="2.11.2",e(xt),t.fn=ls,t.min=Gt,t.max=Pt,t.now=ji,t.utc=o,t.unix=ln,t.months=Sn,t.isDate=i,t.locale=S,t.invalid=l,t.duration=Qt,t.isMoment=_,t.weekdays=kn,t.parseZone=cn,t.localeData=k,t.isDuration=Ft,t.monthsShort=wn,t.weekdaysMin=bn,t.defineLocale=w,t.weekdaysShort=Tn,t.normalizeUnits=b,t.relativeTimeThreshold=zn,t.prototype=ls;var Is=t;return Is});


},{}],141:[function(require,module,exports){
"use strict";var InvoicingFakeServer=null;try{InvoicingFakeServer=require("./lib/InvoicingFakeServer")}catch(x){}module.exports={setupFakeServer:function(e){if(!InvoicingFakeServer||!InvoicingFakeServer.getFakeResponses)throw new Error("Fake server module is not available.");e.addFakeResponses(InvoicingFakeServer.getFakeResponses())},BaseService:require("./lib/BaseClasses/BaseService"),InvoicingService:require("./lib/InvoicingService"),Currency:require("./lib/Currency"),InvoicePayment:require("./lib/Payment"),InvoicePaymentTerm:require("./lib/PaymentTerm"),InvoiceRefund:require("./lib/Refund"),InvoiceCCInfo:require("./lib/CCInfo"),InvoiceAddress:require("./lib/Address"),InvoiceBillingInfo:require("./lib/BillingInfo"),InvoiceMerchantInfo:require("./lib/MerchantInfo"),InvoiceShippingInfo:require("./lib/ShippingInfo"),InvoiceItem:require("./lib/Item"),InvoiceNotification:require("./lib/Notification"),InvoicePaymentInfo:require("./lib/PaymentInfo"),InvoiceRefundInfo:require("./lib/RefundInfo"),InvoicingRequester:require("./lib/Requester"),InvoiceActions:require("./lib/InvoiceActions"),Invoice:require("./lib/Invoice"),InvoiceListRequest:require("./lib/InvoiceListRequest"),InvoiceListResponse:require("./lib/InvoiceListResponse"),InvoiceSearchRequest:require("./lib/SearchRequest"),AccountSummary:require("./lib/AccountSummary"),AccountSummarySection:require("./lib/AccountSummarySection"),Countries:require("./lib/Countries"),Country:require("./lib/Country")};


},{"./lib/AccountSummary":142,"./lib/AccountSummarySection":143,"./lib/Address":144,"./lib/BaseClasses/BaseService":146,"./lib/BillingInfo":147,"./lib/CCInfo":148,"./lib/Countries":149,"./lib/Country":150,"./lib/Currency":152,"./lib/Invoice":153,"./lib/InvoiceActions":154,"./lib/InvoiceListRequest":156,"./lib/InvoiceListResponse":157,"./lib/InvoicingFakeServer":undefined,"./lib/InvoicingService":159,"./lib/Item":161,"./lib/MerchantInfo":162,"./lib/Notification":163,"./lib/Payment":164,"./lib/PaymentInfo":165,"./lib/PaymentTerm":166,"./lib/Refund":167,"./lib/RefundInfo":168,"./lib/Requester":169,"./lib/SearchRequest":170,"./lib/ShippingInfo":171}],142:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}(),Currency=require("./Currency"),Invoice=require("./Invoice"),BN=require("./InvoiceBigNumber"),$$=BN.$$,AccountSummarySection=require("./AccountSummarySection"),AccountSummary=function(){function t(e,n){_classCallCheck(this,t),this.pastDueSection=this.sectionFromSummaries(n.summaries),this.awaitingPaymentSection=this.sectionForStatuses([Invoice.Status.SENT,Invoice.Status.PARTIALLY_PAID,Invoice.Status.UNPAID],e),this.draftSection=this.sectionForStatuses([Invoice.Status.DRAFT],e),this.paidSection=this.sectionForStatuses([Invoice.Status.MARKED_AS_PAID,Invoice.Status.PAID],e),this.outstandingAmount=this.awaitingPaymentSection.totalAmount}return _createClass(t,[{key:"sectionForStatuses",value:function(t,e){return this.sectionFromSummaries(this.summariesForStatuses(t,e))}},{key:"summariesForStatuses",value:function(t,e){var n=[],a=!0,u=!1,o=void 0;try{for(var r,i=e.summaries[Symbol.iterator]();!(a=(r=i.next()).done);a=!0){var s=r.value;t.indexOf(Invoice.Status[s.status])>=0&&n.push(s)}}catch(c){u=!0,o=c}finally{try{!a&&i["return"]&&i["return"]()}finally{if(u)throw o}}return n}},{key:"sectionFromSummaries",value:function(t){var e=0,n=$$("0"),a=$$("0"),u=$$("0"),o=!0,r=!1,i=void 0;try{for(var s,c=t[Symbol.iterator]();!(o=(s=c.next()).done);o=!0){var m=s.value;if(e+=m.count,m.amount_summary&&m.amount_summary.length){var l=m.amount_summary[0];l.total_amount&&(n=n.add($$(l.total_amount.value))),l.paid_amount&&(l.paid_amount.other&&(a=a.add($$(l.paid_amount.other.value))),l.paid_amount.paypal&&(a=a.add($$(l.paid_amount.paypal.value)))),l.refunded_amount&&(l.refunded_amount.other&&(u=u.add($$(l.refunded_amount.other.value))),l.refunded_amount.paypal&&(u=u.add($$(l.refunded_amount.paypal.value))))}}}catch(d){r=!0,i=d}finally{try{!o&&c["return"]&&c["return"]()}finally{if(r)throw i}}return new AccountSummarySection(e,n,a,u)}},{key:"subtractSection",value:function(t,e){return new AccountSummarySection(t.totalCount-e.totalCount,t.totalAmount.minus(e.totalAmount),t.paidAmount.minus(e.paidAmount),t.refundedAmount.minus(e.refundedAmount))}}]),t}();module.exports=AccountSummary;


},{"./AccountSummarySection":143,"./Currency":152,"./Invoice":153,"./InvoiceBigNumber":155}],143:[function(require,module,exports){
"use strict";function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var Currency=require("./Currency"),BN=require("./InvoiceBigNumber"),$$=BN.$$,AccountSummarySection=function t(n,c,e,o){_classCallCheck(this,t),this.totalCount=n,this.totalAmount=c,this.paidAmount=e,this.refundedAmount=o};module.exports=AccountSummarySection;


},{"./Currency":152,"./InvoiceBigNumber":155}],144:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),InvoiceAddress=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"readFromJson",value:function(t){t&&(this.line1=t.line1,this.line2=t.line2,this.city=t.city,this.state=t.state,this.postalCode=t.postal_code,this.country=t.country_code,this.phone=t.phone)}},{key:"toJSON",value:function(){var t={};return t.line1=this.line1,t.line2=this.line2,t.city=this.city,t.state=this.state,t.postal_code=this.postalCode,t.country_code=this.country,t.phone=this.phone,t}},{key:"hasAnyValue",value:function(){return!!(this.line1||this.line2||this.city||this.state||this.postalCode||this.country||this.phone)}}]),t}();module.exports=InvoiceAddress;


},{}],145:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),InvoicingUtil=require("./InvoicingUtil"),InvoiceAttachment=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"readFromJson",value:function(n){var t=new e;return t.name=n.name,t.url=n.url,t}}]),e}();module.exports=InvoiceAttachment;


},{"./InvoicingUtil":160}],146:[function(require,module,exports){
"use strict";function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}var manticore=require("manticore"),BaseService=function e(){_classCallCheck(this,e)};module.exports=BaseService;


},{"manticore":125}],147:[function(require,module,exports){
"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(n,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(n,a.key,a)}}return function(e,i,a){return i&&n(e.prototype,i),a&&n(e,a),e}}(),InvoiceAddress=require("./Address"),util=require("manticore-util"),InvoiceBillingInfo=function(){function n(){_classCallCheck(this,n),this.address=new InvoiceAddress}return _createClass(n,[{key:"readFromJson",value:function(n){n&&(this.address.readFromJson(n.address),this.firstName=n.first_name,this.lastName=n.last_name,this.businessName=n.business_name,this.email=n.email,this.language=n.language,this.additionalInfo=n.additional_info,this.notificationChannel=n.notification_channel,n.phone&&(this.countryCode=n.phone.country_code,this.nationalNumber=n.phone.national_number))}},{key:"toJSON",value:function(){var n={};return Object.keys(this.address).length&&(n.address=this.address),n.first_name=this.firstName,n.last_name=this.lastName,n.email=this.email,n.business_name=this.businessName,n.language=this.language,n.additional_info=this.additionalInfo,n.notification_channel=this.notificationChannel,this.nationalNumber&&(n.phone={},n.phone.country_code=this.countryCode,n.phone.national_number=this.nationalNumber),n}},{key:"hasAnyValue",value:function(){return!!(this.email||this.firstName||this.lastName||this.businessName||this.address.hasAnyValue()||this.language||this.additionalInfo||this.notificationChannel||this.countryCode||this.nationalNumber)}}]),n}();module.exports=InvoiceBillingInfo;


},{"./Address":144,"manticore-util":124}],148:[function(require,module,exports){
"use strict";function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,s){for(var i=0;i<s.length;i++){var t=s[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(s,i,t){return i&&e(s.prototype,i),t&&e(s,t),s}}(),Address=require("./Address"),util=require("manticore-util"),InvoiceCCInfo=function(){function e(){_classCallCheck(this,e),this.address=new Address}return _createClass(e,[{key:"readFromJson",value:function(e){e&&(this.address.readFromJson(e.address),this.firstName=e.first_name,this.lastName=e.last_name,this.businessName=e.business_name,this.email=e.email,this.phone=e.phone,this.fax=e.fax,this.website=e.website,this.additionalInfo=e.additional_info)}},{key:"toJSON",value:function(){var e={};return e.email=this.email,e.first_name=this.firstName,e.last_name=this.lastName,e.business_name=this.businessName,e.phone=this.phone,e.fax=this.fax,e.website=this.website,e.additional_info=this.additionalInfo,e}}]),e}();module.exports=InvoiceCCInfo;


},{"./Address":144,"manticore-util":124}],149:[function(require,module,exports){
"use strict";function _classCallCheck(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function r(r,e){for(var n=0;n<e.length;n++){var t=e[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(r,t.key,t)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}(),Country=require("./Country"),countryMap=require("./CountryMap"),Countries=function(){function r(){_classCallCheck(this,r)}return _createClass(r,null,[{key:"countries",value:function(){if(!r._countries){r._countries=[];var e=!0,n=!1,t=void 0;try{for(var o,u=Object.keys(countryMap)[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var a=o.value;r._countries.push(new Country(a,countryMap[a]))}}catch(i){n=!0,t=i}finally{try{!e&&u["return"]&&u["return"]()}finally{if(n)throw t}}}return r._countries}},{key:"countryForCountryCode",value:function(r){if(r){r=r.toUpperCase();var e=!0,n=!1,t=void 0;try{for(var o,u=this.countries()[Symbol.iterator]();!(e=(o=u.next()).done);e=!0){var a=o.value;if(a.code===r&&a.name)return a.name}}catch(i){n=!0,t=i}finally{try{!e&&u["return"]&&u["return"]()}finally{if(n)throw t}}}}}]),r}();module.exports=Countries;


},{"./Country":150,"./CountryMap":151}],150:[function(require,module,exports){
"use strict";function _classCallCheck(n,s){if(!(n instanceof s))throw new TypeError("Cannot call a class as a function")}var Country=function n(s,t){_classCallCheck(this,n),this.code=s,this.name=t};module.exports=Country;


},{}],151:[function(require,module,exports){
"use strict";module.exports={AL:"Albania",DZ:"Algeria",AD:"Andorra",AO:"Angola",AI:"Anguilla",AG:"Antigua & Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia & Herzegovina",BW:"Botswana",BR:"Brazil",VG:"British Virgin Islands",BN:"Brunei",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",TD:"Chad",CL:"Chile",CN:"China",C2:"China World Wide",CO:"Colombia",KM:"Comoros",CG:"Congo - Brazzaville",CD:"Congo - Kinshasa",CK:"Cook Islands",CR:"Costa Rica",CI:"Côte d’Ivoire",HR:"Croatia",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GT:"Guatemala",GN:"Guinea",GW:"Guinea - Bissau",GY:"Guyana",HN:"Honduras",HK:"Hong Kong SAR China",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Laos",LV:"Latvia",LS:"Lesotho",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",NO:"Norway",OM:"Oman",PW:"Palau",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn Islands",PL:"Poland",PT:"Portugal",QA:"Qatar",RE:"Réunion",RO:"Romania",RU:"Russia",RW:"Rwanda",WS:"Samoa",SM:"San Marino",ST:"São Tomé & Príncipe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SH:"St. Helena",KN:"St. Kitts & Nevis",LC:"St. Lucia",PM:"St. Pierre & Miquelon",VC:"St. Vincent & Grenadines",SR:"Suriname",SJ:"Svalbard & Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TG:"Togo",TO:"Tonga",TT:"Trinidad & Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks & Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UY:"Uruguay",VU:"Vanuatu",VA:"Vatican City",VE:"Venezuela",VN:"Vietnam",WF:"Wallis & Futuna",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"};


},{}],152:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),BN=require("./InvoiceBigNumber"),$$=BN.$$,currencies,Currency=function(){function e(r){_classCallCheck(this,e),this.decimals=r.decimals||2,this.symbol=r.symbol||"$",this.roundMode=r.roundMode||BN.ROUND_HALF_UP,this.iso4217=r.iso4217}return _createClass(e,[{key:"round",value:function(e){return $$(e).round(this.decimals,this.roundMode)}},{key:"toCents",value:function(e){return $$(10).pow(this.decimals).times(e)}},{key:"format",value:function(e){return this.symbol+$$(e).toFormat(this.decimals,this.roundMode)}}],[{key:"getCurrency",value:function(e){return currencies[e]}},{key:"setCurrency",value:function(e,r){currencies[e]=r}},{key:"round",value:function(r,n){return e.getCurrency(r).round(n)}},{key:"toCents",value:function(r,n){return e.getCurrency(r).toCents(n)}},{key:"format",value:function(r,n){return e.getCurrency(r).format(n)}}]),e}();currencies={AUD:new Currency({iso4217:36}),GBP:new Currency({symbol:"£",iso4217:826}),USD:new Currency({iso4217:840}),HKD:new Currency({iso4217:344,decimals:1}),EUR:new Currency({symbol:"€",iso4217:978}),CAD:new Currency({iso4217:124})},module.exports=Currency;


},{"./InvoiceBigNumber":155}],153:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function statusFromServer(t){return t?Invoice.Status[t]?Invoice.Status[t]:(Log.warn("Received unknown server invoice status "+t),Invoice.Status.DRAFT):Invoice.Status.NEW}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),_get=function(t,e,n){for(var i=!0;i;){var a=t,s=e,r=n;i=!1,null===a&&(a=Function.prototype);var o=Object.getOwnPropertyDescriptor(a,s);if(void 0!==o){if("value"in o)return o.value;var u=o.get;if(void 0===u)return;return u.call(r)}var h=Object.getPrototypeOf(a);if(null===h)return;t=h,e=s,n=r,i=!0,o=h=void 0}},EventEmitter=require("events").EventEmitter,deepEqual=require("deep-equal"),Log=require("manticore-log")("invoicing"),BN=require("./InvoiceBigNumber"),$$=BN.$$,moment=require("moment"),Currency=require("./Currency"),assert=require("assert"),util=require("manticore-util"),InvoicingUtil=require("./InvoicingUtil"),request=require("./Requester").request,InvoiceItem=require("./Item"),InvoiceMerchantInfo=require("./MerchantInfo"),InvoiceBillingInfo=require("./BillingInfo"),InvoiceShippingInfo=require("./ShippingInfo"),totalCalculator=require("./totalCalculator"),InvoiceCCInfo=require("./CCInfo"),InvoicePayment=require("./Payment"),InvoicePaymentTerm=require("./PaymentTerm"),InvoiceRefund=require("./Refund"),InvoiceAttachment=require("./Attachment"),Invoice=function(t){function e(t){if(_classCallCheck(this,e),_get(Object.getPrototypeOf(e.prototype),"constructor",this).call(this),this.hasDetails=!0,!t){if(!e.DefaultCurrency)throw new Error("Creating an invoice without a specified currency requires Invoice.DefaultCurrency to be set.");t=e.DefaultCurrency}if(!Currency.getCurrency(t))throw new Error("Unsupported currency: "+t);this.currency=t,this.merchantInfo=new InvoiceMerchantInfo,this.billingInfo=new InvoiceBillingInfo,this.taxInclusive=!1,this.taxCalculatedAfterDiscount=!1,this.items=[],this.allowPartialPayment=!1,this.paymentTerms=new InvoicePaymentTerm,this.status=e.Status.NEW,e.DefaultMerchant&&(this.merchantInfo.email=e.DefaultMerchant.emailAddress,this.merchantInfo.businessName=e.DefaultMerchant.businessName,this.merchantInfo.address=e.DefaultMerchant.address)}return _inherits(e,t),_createClass(e,[{key:"copy",value:function(){var t=new e(this.currency);return t.readJSON(util.deepToJSON(this.toFullJSON())),t.wasDeleted=this.wasDeleted,t}},{key:"setCleanFromServer",value:function(){this._lastKnownServerValue=util.deepToJSON(this)}},{key:"addItem",value:function(t,e,n,i,a){var s=this,r=this.findItem(i,a);if(r)return r.quantity=r.quantity.plus(e),this._totalMayHaveChanged("itemUpdated"),r;var o=new InvoiceItem(t,e,n,i,a||null);return o.on("amountChanged",function(){return s._totalMayHaveChanged("itemAmountChanged")}),this.items.push(o),this._totalMayHaveChanged("itemAdded"),o}},{key:"removeAllItems",value:function(){this.items=[],this._totalMayHaveChanged("allItemsRemoved")}},{key:"removeItem",value:function(t){if(!t)return!1;var e=this.items.indexOf(t);return 0>e?!1:(this.items.splice(e,1),this._totalMayHaveChanged("itemRemoved"),!0)}},{key:"findItem",value:function(t,e){if(!t)return null;e=e||null,"string"!=typeof t&&(e=t.detailId,t=t.itemId);var n=!0,i=!1,a=void 0;try{for(var s,r=this.items[Symbol.iterator]();!(n=(s=r.next()).done);n=!0){var o=s.value;if(o.itemId===t&&o.detailId===e)return o}}catch(u){i=!0,a=u}finally{try{!n&&r["return"]&&r["return"]()}finally{if(i)throw a}}return null}},{key:"getItem",value:function(t){return this.items[t]}},{key:"ensureTotals",value:function(){this._cleanTotals||(totalCalculator(this),this._cleanTotals=!0)}},{key:"_totalMayHaveChanged",value:function(t,n){var i=this.listeners(e.Event.TotalChanged);if(i&&i.length)if(this._total){var a=new BN(this._total);totalCalculator(this),a.equals(this._total)||this.emit(e.Event.TotalChanged,t,n)}else totalCalculator(this),this.emit(e.Event.TotalChanged,t,n);else this._cleanTotals=!1}},{key:"getDetails",value:function(t){var e=this;assert(this.payPalId,"Can't get details of an invoice without an id."),assert(!this.wasDeleted,"Can't get details on an invoice that was deleted."),request({method:"GET",op:"invoices/"+this.payPalId},function(n,i){n||(e.readJSON(i.body),e.setCleanFromServer()),t&&t(n)})}},{key:"save",value:function(t){var e=this;return assert(this.hasDetails,"Can't save an invoice without details"),assert(!this.wasDeleted,"Can't save an invoice that was deleted."),this.isDirtyFromServer?void request({method:this.payPalId?"PUT":"POST",op:this.payPalId?"invoices/"+this.payPalId:"invoices",body:JSON.stringify(this)},function(n,i){if(!n&&i.body){var a=i.body;e.payPalId=e.payPalId||a.id,e.number=e.number||a.number,e.invoiceDate=InvoicingUtil.parseServerDateString(a.invoice_date),e.status=statusFromServer(a.status),e.setCleanFromServer()}t&&t(n)}):void(t&&t())}},{key:"send",value:function(t,n){var i=this;assert(this.payPalId,"Can't send an invoice without an id."),assert(!this.wasDeleted,"Can't send an invoice that was deleted."),request({method:"POST",op:"invoices/"+this.payPalId+"/send?notify_merchant="+!!t},function(t,a){t||(i.status=e.Status.SENT),n&&n(t,a)})}},{key:"deleteFromServer",value:function(t){var n=this;assert(this.payPalId,"Can't delete an invoice without an id."),assert(!this.wasDeleted,"Can't delete an invoice that was deleted."),request({method:"DELETE",op:"invoices/"+this.payPalId},function(i,a){i||(n.status=e.Status.NEW,n.wasDeleted=!0),t&&t(i,a)})}},{key:"remind",value:function(t,e){assert(this.payPalId,"Can't remind an invoice without an id."),assert(t.send_to_payer!==!1,"Can't send a reminder that doesn't go to the payer."),assert(!this.wasDeleted,"Can't remind an invoice that was deleted."),request({method:"POST",op:"invoices/"+this.payPalId+"/remind",body:JSON.stringify(t)},e)}},{key:"cancel",value:function(t,n){var i=this;assert(this.payPalId,"Can't cancel an invoice without an id."),assert(!this.wasDeleted,"Can't cancel an invoice that was deleted."),request({method:"POST",op:"invoices/"+this.payPalId+"/cancel",body:JSON.stringify(t)},function(t,a){t||(i.status=e.Status.CANCELLED),n&&n(t,a)})}},{key:"recordPayment",value:function(t,n){var i=this;assert(this.payPalId,"Can't record payment on an invoice without an id."),assert(t,"Can't record payment on an invoice without paymentInfo."),assert(!this.wasDeleted,"Can't record payment on an invoice that was deleted."),t.validate(),request({method:"POST",op:"invoices/"+this.payPalId+"/record-payment",body:JSON.stringify(t)},function(a,s){a||(t.type===e.PaymentType.EXTERNAL?i.status=e.Status.MARKED_AS_PAID:t.type===e.PaymentType.PAYPAL&&(i.status=e.Status.PAID)),n&&n(a,s)})}},{key:"recordRefund",value:function(t,n){var i=this;assert(this.payPalId,"Can't record refund on an invoice without an id."),assert(!this.wasDeleted,"Can't record refund on an invoice that was deleted."),assert(this.status===e.Status.MARKED_AS_PAID||this.status===e.Status.PAID||this.status===e.Status.PARTIALLY_REFUNDED,"Can't record refund on an invoice that hasn't been paid yet."),assert(t,"Can't record refund on an invoice without refundInfo."),request({method:"POST",op:"invoices/"+this.payPalId+"/record-refund",body:JSON.stringify(t)},function(a,s){a||(t.type===e.PaymentType.EXTERNAL?i.status=e.Status.MARKED_AS_REFUNDED:t.type===e.PaymentType.PAYPAL&&(i.status=e.Status.REFUNDED)),n&&n(a,s)})}},{key:"toJSON",value:function(){var t={};return t.note=this.note,t.number=this.number,t.invoice_date=InvoicingUtil.toServerDateString(this.invoiceDate,!1),t.merchant_info=this.merchantInfo,t.shipping_info=this.shippingInfo,t.tax_inclusive=this.taxInclusive,t.tax_calculated_after_discount=this.taxCalculatedAfterDiscount,t.allow_partial_payment=this.allowPartialPayment,t.cc_info=this.CCInfo,t.custom=this.custom,t.metadata=this.metadata,t.uri=this.uri,t.logo_url=this.logoURL,t.additional_data=this.additionalData,t.attachments=this.attachments,this.termsAndConditions&&(t.terms=this.termsAndConditions.substring(0,3999)),this.merchantMemo&&(t.merchant_memo=this.merchantMemo.substring(0,149)),this._shippingToJson(t),this.minimumAmountDue&&(t.minimum_amount_due={currency:this.currency,value:this.minimumAmountDue}),t.id=this.payPalId,t.billing_info=[this.billingInfo],this.status&&(t.status=e.Status.toString[this.status]),this.gratuityAmount&&(t.gratuity={currency:this.currency,value:this.gratuityAmount}),(this.discountAmount||this.discountPercentage)&&(t.discount=this.discountObject()),(this.paymentTerms.dueDate||this.paymentTerms.paymentTerms)&&(t.payment_term=this.paymentTerms.toJSONHack(t.invoice_date)),this._itemsToJson(t),t}},{key:"toFullJSON",value:function(){var t=this.toJSON();return t.payments=this.payments,t.refunds=this.refunds,this.paidAmount&&(t.paid_amount={},this.paidAmountIsPayPal?t.paid_amount.paypal={currency:this.currency,value:this.paidAmount}:t.paid_amount.other={currency:this.currency,value:this.paidAmount}),this.refundedAmount&&(t.refunded_amount={},this.refundedAmountIsPayPal?t.refunded_amount.paypal={currency:this.currency,value:this.refundedAmount}:t.refunded_amount.other={currency:this.currency,value:this.refundedAmount}),t.payment_term=this.paymentTerms,t}},{key:"_shippingToJson",value:function(t){this.shippingAmount&&(t.shipping_cost={},t.shipping_cost.amount={currency:this.currency,value:this.shippingAmount},this.shippingTaxRate&&(t.shipping_cost.tax={name:"Shipping Tax",percent:this.shippingTaxRate}))}},{key:"_itemsToJson",value:function(t){if(this.items&&this.items.length){t.items=[];var e=!0,n=!1,i=void 0;try{for(var a,s=this.items[Symbol.iterator]();!(e=(a=s.next()).done);e=!0){var r=a.value;t.items.push(r.toJSON(this.currency))}}catch(o){n=!0,i=o}finally{try{!e&&s["return"]&&s["return"]()}finally{if(n)throw i}}}}},{key:"discountObject",value:function(){var t={};return this.discountAmount?(t.amount={},t.amount.value=this.discountAmount,t.amount.currency=this.currency):this.discountPercentage&&(t.percent=this.discountPercentage),t}},{key:"readJSON",value:function(t){if(this.invoiceDate=InvoicingUtil.parseServerDateString(t.invoice_date),this.status=statusFromServer(t.status),this.number=t.number,this.payPalId=t.id,this.note=t.note,this.merchantInfo.readFromJson(t.merchant_info),this.allowPartialPayment=t.allow_partial_payment,this.CCInfo=t.cc_info,this.custom=t.custom,this.metadata=t.metadata,this.uri=t.uri,this.logoURL=t.logo_url,this.additionalData=t.additional_data,t.payments){this.payments=[];var e=!0,n=!1,i=void 0;try{for(var a,s=t.payments[Symbol.iterator]();!(e=(a=s.next()).done);e=!0){var r=a.value;this.payments.push(InvoicePayment.readFromJson(r))}}catch(o){n=!0,i=o}finally{try{!e&&s["return"]&&s["return"]()}finally{if(n)throw i}}}if(t.refunds){this.refunds=[];var u=!0,h=!1,l=void 0;try{for(var c,d=t.refunds[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var m=c.value;this.refunds.push(InvoiceRefund.readFromJson(m))}}catch(o){h=!0,l=o}finally{try{!u&&d["return"]&&d["return"]()}finally{if(h)throw l}}}if(t.attachments){this.attachments=[];var y=!0,v=!1,f=void 0;try{for(var p,_=t.attachments[Symbol.iterator]();!(y=(p=_.next()).done);y=!0){var g=p.value;this.attachments.push(InvoiceAttachment.readFromJson(g))}}catch(o){v=!0,f=o}finally{try{!y&&_["return"]&&_["return"]()}finally{if(v)throw f}}}if(t.terms&&(this.termsAndConditions=t.terms),t.merchant_memo&&(this.merchantMemo=t.merchant_memo),t.shipping_cost&&(this.shippingAmount=$$(t.shipping_cost.amount.value),t.shipping_cost.tax&&(this.shippingTaxRate=$$(t.shipping_cost.tax.percent))),t.minimum_amount_due&&(this.minimumAmountDue=$$(t.minimum_amount_due.value)),t.refunded_amount&&(t.refunded_amount.paypal?(this.refundedAmount=$$(t.refunded_amount.paypal.value),this.refundedAmountIsPayPal=!0):t.refunded_amount.other&&(this.refundedAmount=$$(t.refunded_amount.other.value),this.refundedAmountIsPayPal=!1)),t.paid_amount&&(t.paid_amount.paypal?(this.paidAmount=$$(t.paid_amount.paypal.value),this.paidAmountIsPayPal=!0):t.paid_amount.other&&(this.paidAmount=$$(t.paid_amount.other.value),this.paidAmountIsPayPal=!1)),t.billing_info&&t.billing_info.length&&this.billingInfo.readFromJson(t.billing_info[0]),t.shipping_info&&(this.shippingInfo=new InvoiceShippingInfo,this.shippingInfo.readFromJson(t.shipping_info)),t.items){this.items=[];var I=!0,P=!1,A=void 0;try{for(var C,S=t.items[Symbol.iterator]();!(I=(C=S.next()).done);I=!0){var D=C.value;this.items.push(InvoiceItem.fromJson(D))}}catch(o){P=!0,A=o}finally{try{!I&&S["return"]&&S["return"]()}finally{if(P)throw A}}this.hasDetails=!0}else this._total=$$(t.total_amount?t.total_amount.value:"0"),this._total.isZero()?(this.hasDetails=!0,this.items=[]):(this.hasDetails=!1,this.items=void 0);if(t.gratuity&&(this.gratuityAmount=$$(t.gratuity.value)),this.paymentTerms=InvoicePaymentTerm.fromJson(t.payment_term),t.hasOwnProperty("tax_inclusive")&&(this.taxInclusive=t.tax_inclusive),t.hasOwnProperty("tax_calculated_after_discount")&&(this.taxCalculatedAfterDiscount=t.tax_calculated_after_discount),t.hasOwnProperty("discount")){var w=t.discount;w.hasOwnProperty("percent")&&(this.discountPercentage=$$(w.percent)),t.discount.hasOwnProperty("amount")&&(this.discountAmount=$$(t.discount.amount.value))}}},{key:"isDirtyFromServer",get:function(){return!this._lastKnownServerValue||!deepEqual(this._lastKnownServerValue,util.deepToJSON(this))}},{key:"itemCount",get:function(){return this.items.length}},{key:"gratuityAmount",get:function(){return this._gratuityAmount},set:function(t){this._gratuityAmount=t,this._totalMayHaveChanged("field","gratuityAmount")}},{key:"discountAmount",get:function(){return this._discountAmount},set:function(t){this._discountAmount=t,this._totalMayHaveChanged("field","discountAmount")}},{key:"discountPercentage",get:function(){return this._discountPercentage},set:function(t){this._discountPercentage=t,this._totalMayHaveChanged("field","discountPercentage")}},{key:"shippingAmount",get:function(){return this._shippingAmount},set:function(t){this._shippingAmount=$$(t),this._totalMayHaveChanged("field","shippingAmount")}},{key:"shippingTaxRate",get:function(){return this._shippingTaxRate},set:function(t){this._shippingTaxRate=$$(t),this._totalMayHaveChanged("field","shippingTaxRate")}},{key:"total",get:function(){return this.hasDetails&&this.ensureTotals(),this._total}},{key:"subTotal",get:function(){return assert(this.hasDetails,"Can't calculate the subtotal without details"),this.ensureTotals(),this._subTotal}},{key:"itemTax",get:function(){return assert(this.hasDetails,"Can't calculate the item tax without details"),this.ensureTotals(),this._itemTax}},{key:"totalDiscount",get:function(){return assert(this.hasDetails,"Can't calculate the total discount without details"),this.ensureTotals(),this._totalDiscount}},{key:"taxBreakdown",get:function(){return assert(this.hasDetails,"Can't calculate the tax breakdown without details"),this.ensureTotals(),this._taxBreakdown}}],[{key:"withInvoice",value:function(t){assert(t.hasDetails,"Can't use an invoice as a template if the details aren't loaded.");var n=new e(t.currency);return n.readJSON(util.deepToJSON(t)),n.status=e.Status.NEW,n.number=void 0,n.payPalId=void 0,n.paymentTerms=new InvoicePaymentTerm,n}},{key:"fromJson",value:function(t){if(!t.total_amount)throw new Error("Invoice JSON has no total_amount.");var n=new e(t.total_amount.currency);return n.readJSON(t),n}}]),e}(EventEmitter);Invoice.Status={NEW:0,DRAFT:1,SENT:2,PAID:3,MARKED_AS_PAID:4,CANCELLED:5,REFUNDED:6,PARTIALLY_REFUNDED:7,MARKED_AS_REFUNDED:8,PARTIALLY_PAID:9,UNPAID:10},Invoice.Status.toString=util.reverseKeysAndValues(Invoice.Status),Invoice.PaymentType={NONE:0,EXTERNAL:1,PAYPAL:2},Invoice.PaymentType.toString=util.reverseKeysAndValues(Invoice.PaymentType),Invoice.PaymentMethod={NONE:0,BANK_TRANSFER:1,CASH:2,CHECK:3,CREDIT_CARD:4,DEBIT_CARD:5,PAYPAL:6,WIRE_TRANSFER:7,OTHER:8},Invoice.PaymentMethod.toString=util.reverseKeysAndValues(Invoice.PaymentMethod),Invoice.Action={None:0,Delete:1,Send:2,Remind:3,RecordPayment:4,RecordRefund:5,Copy:6,Edit:7,Call:8,Cancel:9,More:10},Invoice.Event={TotalChanged:"totalChanged"},module.exports=Invoice;


},{"./Attachment":145,"./BillingInfo":147,"./CCInfo":148,"./Currency":152,"./InvoiceBigNumber":155,"./InvoicingUtil":160,"./Item":161,"./MerchantInfo":162,"./Payment":164,"./PaymentTerm":166,"./Refund":167,"./Requester":169,"./ShippingInfo":171,"./totalCalculator":173,"assert":40,"deep-equal":114,"events":117,"manticore-log":123,"manticore-util":124,"moment":140}],154:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Invoice=require("./Invoice"),assert=require("assert"),InvoiceActions=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"availableActions",value:function(e){var t=Invoice.Action;switch(e.status){case Invoice.Status.NEW:assert(!1,"This should never happen");break;case Invoice.Status.DRAFT:return[t.Send,t.Edit,t.Delete,t.RecordPayment,t.Copy];case Invoice.Status.SENT:case Invoice.Status.PARTIALLY_PAID:return[t.Remind,t.RecordPayment,t.Call,t.Edit,t.Cancel,t.Copy];case Invoice.Status.PAID:case Invoice.Status.MARKED_AS_PAID:case Invoice.Status.PARTIALLY_REFUNDED:return[t.RecordRefund,t.Call,t.Copy];case Invoice.Status.CANCELLED:case Invoice.Status.REFUNDED:case Invoice.Status.MARKED_AS_REFUNDED:return[t.Call,t.Copy];case Invoice.Status.UNPAID:return[t.RecordPayment,t.Edit,t.Cancel,t.Copy]}}}]),e}();module.exports=InvoiceActions;


},{"./Invoice":153,"assert":40}],155:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,i=t,u=r;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,i);if(void 0!==c){if("value"in c)return c.value;var a=c.get;if(void 0===a)return;return a.call(u)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,t=i,r=u,n=!0,c=l=void 0}},BN=require("bignumber.js"),InvoiceBigNumber=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,[{key:"toJSON",value:function(){return this.toFixed(2)}}],[{key:"$$",value:function(e){return e?new t(e):null}}]),t}(BN);module.exports=InvoiceBigNumber;


},{"bignumber.js":174}],156:[function(require,module,exports){
"use strict";function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var InvoiceListRequest=function t(){_classCallCheck(this,t),this.startIndex=0,this.pageSize=20,this.totalCountRequired=!1};module.exports=InvoiceListRequest;


},{}],157:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}(),Invoice=require("./Invoice"),InvoiceListResponse=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"fromJSON",value:function(n){var r=new e;r.invoices=[];var t=!0,o=!1,a=void 0;try{for(var i,c=n.invoices[Symbol.iterator]();!(t=(i=c.next()).done);t=!0){var l=i.value,s=Invoice.fromJson(l);s.setCleanFromServer(),r.invoices.push(s)}}catch(u){o=!0,a=u}finally{try{!t&&c["return"]&&c["return"]()}finally{if(o)throw a}}return r.totalCount=n.total_count?n.total_count:0,r}}]),e}();module.exports=InvoiceListResponse;


},{"./Invoice":153}],158:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(n,t,a){return t&&e(n.prototype,t),a&&e(n,a),n}}(),Invoice=require("./Invoice"),Template=require("./Template"),InvoiceTemplatesResponse=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"fromJSON",value:function(n){var t;return n.templates&&(t=new e,t.defaultTemplate=Template.fromJSON(n.templates[0])),t}}]),e}();module.exports=InvoiceTemplatesResponse;


},{"./Invoice":153,"./Template":172}],159:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),_get=function(e,t,o){for(var r=!0;r;){var n=e,i=t,u=o;r=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,i);if(void 0!==s){if("value"in s)return s.value;var c=s.get;if(void 0===c)return;return c.call(u)}var a=Object.getPrototypeOf(n);if(null===a)return;e=a,t=i,o=u,r=!0,s=a=void 0}},manticore=require("manticore"),BaseService=require("./BaseClasses/BaseService"),request=require("./Requester").request,Invoice=require("./Invoice"),InvoiceListResponse=require("./InvoiceListResponse"),InvoiceTemplatesResponse=require("./InvoiceTemplatesResponse"),InvoiceListRequest=require("./InvoiceListRequest"),AccountSummary=require("./AccountSummary"),InvoicingService=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,null,[{key:"getInvoices",value:function(e,t){request({method:"GET",op:"invoices?page="+e.startIndex+"&page_size="+e.pageSize+"&total_count_required="+e.totalCountRequired},function(o,r){if(o)t(o);else{var n=InvoiceListResponse.fromJSON(r.body);n.hasMore=e.startIndex+e.pageSize<n.totalCount,t(o,n)}})}},{key:"searchInvoices",value:function(e,t){request({method:"POST",op:"search",body:JSON.stringify(e)},function(o,r){if(o)t(o);else{var n=InvoiceListResponse.fromJSON(r.body);n.hasMore=e.startIndex+e.pageSize<n.totalCount,t(o,n)}})}},{key:"getAccountSummary",value:function(e){var t,o,r,n,i=this,u=function(){(t||r)&&(o||n)&&i.continueGetAccountSummary(t,r,o,n,e)};request({method:"GET",op:"summaries?overdue=false"},function(e,o){t=e,r=o,u()}),request({method:"GET",op:"summaries?overdue=true"},function(e,t){o=e,n=t,u()})}},{key:"continueGetAccountSummary",value:function(e,t,o,r,n){var i=e||o;i&&n(i),n(i,new AccountSummary(t.body,r.body))}},{key:"getTemplates",value:function(e){request({method:"GET",op:"templates"},function(t,o){t?e(t):e(t,InvoiceTemplatesResponse.fromJSON(o.body))})}}]),t}(BaseService);module.exports=InvoicingService;


},{"./AccountSummary":142,"./BaseClasses/BaseService":146,"./Invoice":153,"./InvoiceListRequest":156,"./InvoiceListResponse":157,"./InvoiceTemplatesResponse":158,"./Requester":169,"manticore":125}],160:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),moment=require("moment"),util=require("manticore-util"),InvoicingUtils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"parseServerDateString",value:function(e){return e?(e=e.replace(/(\d{4}-\d{2}-\d{2}) (PST|PDT)/,"$1 00:00:00 $2"),e=e.replace("PST","-0800").replace("PDT","-0700"),moment(e,"YYYY-MM-DD hh:mm:ss Z")):e}},{key:"toServerDateString",value:function(e,t){return e?(e=moment(e),t?(e.utcOffset(-480),e.format("YYYY-MM-DD HH:mm:ss")+" PST"):e.format("YYYY-MM-DD")+" PST"):e}}]),e}();module.exports=InvoicingUtils;


},{"manticore-util":124,"moment":140}],161:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),_get=function(t,e,i){for(var n=!0;n;){var r=t,u=e,o=i;n=!1,null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,u);if(void 0!==a){if("value"in a)return a.value;var c=a.get;if(void 0===c)return;return c.call(o)}var s=Object.getPrototypeOf(r);if(null===s)return;t=s,e=u,i=o,n=!0,a=s=void 0}},EventEmitter=require("events").EventEmitter,Currency=require("./Currency"),util=require("manticore-util"),InvoicingUtil=require("./InvoicingUtil"),BN=require("./InvoiceBigNumber"),$$=BN.$$,staticIdAllocator=1,ZERO=$$(0),InvoiceItem=function(t){function e(t,i,n,r,u){if(_classCallCheck(this,e),_get(Object.getPrototypeOf(e.prototype),"constructor",this).call(this),this.name=t,!i||!t||!n)throw new Error("You must specify a quantity, name and unitPrice when adding an item.");this._quantity=$$(""+i),this.unitPrice=$$(n||0),this.itemId=r||staticIdAllocator++,this.detailId=u||null}return _inherits(e,t),_createClass(e,[{key:"totalForInvoice",value:function(t){var e=this.quantity.times(this.unitPrice||ZERO);if(this.discountPercentage){var i=Currency.round(t.currency,e.times(this.discountPercentage));e=e.minus(i)}else this.discountAmount&&(e=e.minus(this.discountAmount));return Currency.round(t.currency,e)}},{key:"toJSON",value:function(t){var e={name:this.name,description:this.itemDescription,quantity:this.quantity.toNumber(),image_url:this.imageURL,unit_of_measure:this.unitOfMeasure};return this.date&&(e.date=InvoicingUtil.toServerDateString(this.date,!1)),e.unit_price={value:this.unitPrice,currency:t},e}},{key:"quantity",get:function(){return this._quantity},set:function(t){this._quantity=$$(t),this.emit("amountChanged","quantity")}},{key:"taxRate",get:function(){return this._taxRate},set:function(t){this._taxRate=$$(t),this.emit("taxRateChanged"),this.changed}},{key:"discountAmount",get:function(){return this._discountAmount},set:function(t){this._discountAmount=$$(t),this.emit("discountAmountChanged"),this.changed}},{key:"discountPercentage",get:function(){return this._discountPercentage},set:function(t){this._discountPercentage=$$(t),this.emit("discountPercentageChanged"),this.changed}},{key:"unitPrice",get:function(){return this._unitPrice},set:function(t){this._unitPrice=$$(t),this.emit("amountChanged","unitPrice")}}],[{key:"fromJson",value:function(t){var i=new e(t.name,t.quantity,t.unit_price.value,t.itemId||staticIdAllocator++,t.detailId);return t.description&&(i.itemDescription=t.description),t.unit_price&&(i.unitPrice=t.unit_price.value),t.tax&&(i.taxName=t.tax.name,i.taxRate=$$(t.tax.percent)),t.discount&&(t.discount.amount&&(i.discountAmount=$$(t.discount.amount.value)),t.discount.percent&&(i.discountPercentage=$$(t.discount.percent))),t.date&&(i.date=InvoicingUtil.parseServerDateString(t.date)),i.imageURL=t.image_url,i.unitOfMeasure=t.unit_of_measure,i}}]),e}(EventEmitter);module.exports=InvoiceItem;


},{"./Currency":152,"./InvoiceBigNumber":155,"./InvoicingUtil":160,"events":117,"manticore-util":124}],162:[function(require,module,exports){
"use strict";function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,s){for(var a=0;a<s.length;a++){var i=s[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(s,a,i){return a&&e(s.prototype,a),i&&e(s,i),s}}(),Address=require("./Address"),util=require("manticore-util"),InvoiceMerchantInfo=function(){function e(){_classCallCheck(this,e),this.address=new Address}return _createClass(e,[{key:"readFromJson",value:function(e){e&&(this.address.readFromJson(e.address),e.address&&(this.address=new Address,this.address.readFromJson(e.address)),this.email=e.email,this.phone=e.phone,this.fax=e.fax,this.website=e.website,this.firstName=e.first_name,this.lastName=e.last_name,this.businessName=e.business_name,this.taxId=e.tax_id,this.additionalInfo=e.additional_info,this.additionalInfoLabel=e.additional_info_label)}},{key:"toJSON",value:function(){var e={};return e.email=this.email,e.phone=this.phone,e.fax=this.fax,e.website=this.website,e.address=this.address,e.first_name=this.firstName,e.last_name=this.lastName,e.business_name=this.businessName,e.tax_id=this.taxId,e.additional_info=this.additionalInfo,e.additional_info_label=this.additionalInfoLabel,e}}]),e}();module.exports=InvoiceMerchantInfo;


},{"./Address":144,"manticore-util":124}],163:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),InvoiceNotification=function(){function e(t,n,o,s,i){_classCallCheck(this,e),this.subject=t,this.note=n,this.shouldSendToMerchant=o,this.shouldSendToPayer=i,this.ccEmails=s}return _createClass(e,[{key:"toJSON",value:function(){var e={};return e.subject=this.subject,e.note=this.note,e.send_to_merchant=this.shouldSendToMerchant,e.send_to_payer=this.shouldSendToPayer,e.cc_emails=this.ccEmails,e}}]),e}();module.exports=InvoiceNotification;


},{}],164:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}(),util=require("manticore-util"),InvoicingUtil=require("./InvoicingUtil"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoicePayment=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"toJSON",value:function(){var t={};return this.amount&&(t.amount={},t.amount={currency:this.currency,value:this.amount}),t.type=this.type,t.transaction_id=this.transactionID,t.transaction_type=this.transactionType,t.method=this.method,t.date=this.date,t.date=InvoicingUtil.toServerDateString(this.date,!1),t.note=this.note,t}}],[{key:"readFromJson",value:function(e){var n=new t;return e&&(n.type=e.type,n.transactionID=e.transaction_id,n.transactionType=e.transaction_type,n.date=InvoicingUtil.parseServerDateString(e.date),n.method=e.method,n.note=e.note),e.amount&&(n.amount=$$(e.amount.value),n.currency=e.amount.currency),n}}]),t}();module.exports=InvoicePayment;


},{"./InvoiceBigNumber":155,"./InvoicingUtil":160,"manticore-util":124}],165:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),InvoicingUtil=require("./InvoicingUtil"),assert=require("assert"),Invoice=require("./Invoice"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoicePaymentInfo=function(){function t(){_classCallCheck(this,t),this.type=Invoice.PaymentType.EXTERNAL,this.transactionId=void 0,this.transactionType=void 0,this.date=void 0,this.note=void 0,this.method=void 0,this.currency=void 0,this.amount=void 0}return _createClass(t,[{key:"readFromJson",value:function(t){t&&(this.type=t.type,this.transactionID=t.transaction_id,this.transactionType=t.transaction_type,this.date=InvoicingUtil.parseServerDateString(t.date),this.method=t.method,this.note=t.note),t.amount&&(this.amount=$$(t.amount.value),this.currency=t.amount.currency)}},{key:"toJSON",value:function(){var t={};return t.transaction_id=this.transactionId,t.transaction_type=this.transactionType,t.date=InvoicingUtil.toServerDateString(this.date,!0),t.method=Invoice.PaymentMethod.toString[this.method],t.note=this.note,this.amount&&(t.amount={currency:this.currency,value:this.amount}),t}},{key:"validate",value:function(){switch(this.type||assert(!1,"InvoicePaymentInfo must have a payment type."),this.type){case Invoice.PaymentType.EXTERNAL:assert(this.method,"InvoicePaymentInfo with payment type=EXTERNAL must have a method.");break;case Invoice.PaymentType.PAYPAL:assert(!1,"The invoicing service doesn't currently support setting the payment type to PAYPAL :(."),assert(this.transactionId,"InvoicePaymentInfo with payment type=PAYPAL must have a method.")}}}]),t}();module.exports=InvoicePaymentInfo;


},{"./Invoice":153,"./InvoiceBigNumber":155,"./InvoicingUtil":160,"assert":40}],166:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),util=require("manticore-util"),InvoicingUtil=require("./InvoicingUtil"),moment=require("moment"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoicePaymentTerm=function(){function e(){_classCallCheck(this,e),this.reset()}return _createClass(e,[{key:"reset",value:function(){this._paymentTerms=e.PaymentTerms.NoPaymentTerms,this._dueDate=void 0}},{key:"toJSON",value:function(){var t={};return this.dueDate?t.due_date=InvoicingUtil.toServerDateString(this.dueDate,!1):this.paymentTerms&&(t.term_type=e.PaymentTerms.toServer[this.paymentTerms]),t}},{key:"toJSONHack",value:function(t){var r=this.toJSON();return r.due_date===t&&(r.due_date=void 0,r.term_type=e.PaymentTerms.toServer[e.PaymentTerms.DueOnReceipt]),r}},{key:"paymentTerms",set:function(e){e&&this.reset(),this._paymentTerms=e},get:function(){return this._paymentTerms}},{key:"dueDate",set:function(e){e&&this.reset(),this._dueDate=e},get:function(){return this._dueDate&&this._dueDate.constructor===(new moment).constructor?this._dueDate.toDate():this._dueDate}}],[{key:"fromJson",value:function(t){var r=new e;return t?(r.dueDate=InvoicingUtil.parseServerDateString(t.due_date),r.paymentTerms=e.PaymentTerms.fromServer[t.term_type]):r.reset(),r}}]),e}();InvoicePaymentTerm.PaymentTerms={NoPaymentTerms:0,DueOnReceipt:1,Net15:2,Net30:3,Net45:4},InvoicePaymentTerm.PaymentTerms.fromServer={DUE_ON_RECEIPT:InvoicePaymentTerm.PaymentTerms.DueOnReceipt,NET_15:InvoicePaymentTerm.PaymentTerms.Net15,NET_30:InvoicePaymentTerm.PaymentTerms.Net30,NET_45:InvoicePaymentTerm.PaymentTerms.Net45},InvoicePaymentTerm.PaymentTerms.toServer=util.reverseKeysAndValues(InvoicePaymentTerm.PaymentTerms.fromServer),module.exports=InvoicePaymentTerm;


},{"./InvoiceBigNumber":155,"./InvoicingUtil":160,"manticore-util":124,"moment":140}],167:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),util=require("manticore-util"),InvoicingUtil=require("./InvoicingUtil"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoiceRefund=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"toJSON",value:function(){var e={};return this.amount&&(e.amount={},e.amount={currency:this.currency,value:this.amount}),e.type=this.type,e.date=InvoicingUtil.toServerDateString(this.date,!1),e.note=this.note,e}}],[{key:"readFromJson",value:function(n){var t=new e;return n&&(t.type=n.type,t.date=InvoicingUtil.parseServerDateString(n.date),t.note=n.note),n.amount&&(t.amount=$$(n.amount.value),t.currency=n.amount.currency),t}}]),e}();module.exports=InvoiceRefund;


},{"./InvoiceBigNumber":155,"./InvoicingUtil":160,"manticore-util":124}],168:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),InvoicingUtil=require("./InvoicingUtil"),assert=require("assert"),Invoice=require("./Invoice"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoiceRefundInfo=function(){function e(){_classCallCheck(this,e),this.type=Invoice.PaymentType.EXTERNAL,this.date=void 0,this.note=void 0,this.currency=void 0,this.amount=void 0}return _createClass(e,[{key:"readFromJson",value:function(e){e&&(this.type=e.type,this.date=InvoicingUtil.parseServerDateString(e.date),this.note=e.note),e.amount&&(this.amount=$$(e.amount.value),this.currency=e.amount.currency)}},{key:"toJSON",value:function(){var e={};return e.date=InvoicingUtil.toServerDateString(this.date,!0),e.note=this.note,this.amount&&(e.amount={currency:this.currency,value:this.amount}),e}}]),e}();module.exports=InvoiceRefundInfo;


},{"./Invoice":153,"./InvoiceBigNumber":155,"./InvoicingUtil":160,"assert":40}],169:[function(require,module,exports){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),util=require("manticore-util"),InvoicingRequester=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"request",value:function(r,t){if(!e.api)throw new Error("There is no service interface. Please set the InvoicingRequester.api property.");e.api.request(util.extend(r,{service:"invoicing",format:"json",headers:{"Content-Type":"application/json"}}),function(r,n){e.decorateError(r),t(r,n)})}},{key:"decorateError",value:function(e){if(!e)return e;var r="",t=/(.*?)\..*/,n=/.*\.(.*)/;e.details&&Array.isArray(e.details)&&e.details.length>0&&e.details.forEach(function(e){r.length&&(r+=" ");var a=e.field.match(t),i=e.field;if(Array.isArray(a)&&a.length){i=a[1],i=i.replace(/(.*?)\[.*/,"$1"),i=i.replace("_"," "),i=i.charAt(0).toUpperCase()+i.slice(1);var s=e.field.match(n);Array.isArray(s)&&s.length&&(i+=" "+s[1])}else i=i.charAt(0).toUpperCase()+i.slice(1);r+=i+" "+e.issue}),r.length&&(e.message=r)}}]),e}();module.exports=InvoicingRequester;


},{"manticore-util":124}],170:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),Invoice=require("./Invoice"),moment=require("moment"),InvoicingUtil=require("./InvoicingUtil"),BN=require("./InvoiceBigNumber"),$$=BN.$$,InvoiceSearchRequest=function(){function t(){_classCallCheck(this,t),this.startIndex=0,this.pageSize=20,this.totalCountRequired=!1,this._statuses=[]}return _createClass(t,[{key:"toJSON",value:function(){var t={};this.assignDatesToJSON(t),t.email=this.email,t.recipientFirstName=this.recipientFirstName,t.recipientLastName=this.recipientLastName,t.recipientBusinessName=this.recipientBusinessName,t.number=this.number;var e=!0,a=!1,i=void 0;try{for(var n,r=this._statuses[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var o=n.value;t.status||(t.status=[]),t.status.push(Invoice.Status.toString[o])}}catch(s){a=!0,i=s}finally{try{!e&&r["return"]&&r["return"]()}finally{if(a)throw i}}return t.lower_total_amount=this.lowerTotalAmount,t.upper_total_amount=this.upperTotalAmount,t.page=this.startIndex,t.page_size=this.pageSize,t.total_count_required=this.totalCountRequired,t.archived=this.archived,t}},{key:"addStatus",value:function(t){this._statuses.push(t)}},{key:"assignDatesToJSON",value:function(t){var e=[["startInvoiceDate","endInvoiceDate","start_invoice_date","end_invoice_date"],["startDueDate","endDueDate","start_due_date","end_due_date"],["startPaymentDate","endPaymentDate","start_payment_date","end_payment_date"],["startCreationDate","endCreationDate","start_creation_date","end_creation_date"]],a=!0,i=!1,n=void 0;try{for(var r,o=e[Symbol.iterator]();!(a=(r=o.next()).done);a=!0){var s=r.value;(this[s[0]]||this[s[1]])&&(t[s[2]]=this[s[0]]?InvoicingUtil.toServerDateString(this[s[0]],!1):"1970-01-01 PST",t[s[3]]=this[s[1]]?InvoicingUtil.toServerDateString(this[s[1]],!1):"2100-01-01 PST")}}catch(u){i=!0,n=u}finally{try{!a&&o["return"]&&o["return"]()}finally{if(i)throw n}}}},{key:"lowerTotalAmount",get:function(){return this._lowerTotalAmount},set:function(t){this._lowerTotalAmount=$$(t)}},{key:"upperTotalAmount",get:function(){return this._upperTotalAmount},set:function(t){this._upperTotalAmount=$$(t)}}]),t}();module.exports=InvoiceSearchRequest;


},{"./Invoice":153,"./InvoiceBigNumber":155,"./InvoicingUtil":160,"moment":140}],171:[function(require,module,exports){
"use strict";function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(s,a,t){return a&&e(s.prototype,a),t&&e(s,t),s}}(),Address=require("./Address"),util=require("manticore-util"),InvoiceShippingInfo=function(){function e(){_classCallCheck(this,e),this.address=new Address}return _createClass(e,[{key:"readFromJson",value:function(e){e&&(this.address.readFromJson(e.address),this.firstName=e.first_name,this.lastName=e.last_name,this.businessName=e.business_name)}},{key:"toJSON",value:function(){var e={};return Object.keys(this.address).length&&(e.address=this.address),e.first_name=this.firstName,e.last_name=this.lastName,e.business_name=this.businessName,e}},{key:"hasAnyValue",value:function(){return!!(this.email||this.firstName||this.lastName||this.businessName||this.address.hasAnyValue())}}]),e}();module.exports=InvoiceShippingInfo;


},{"./Address":144,"manticore-util":124}],172:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,a=t,i=r;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,a);if(void 0!==c){if("value"in c)return c.value;var l=c.get;if(void 0===l)return;return l.call(i)}var u=Object.getPrototypeOf(o);if(null===u)return;e=u,t=a,r=i,n=!0,c=u=void 0}},InvoicingUtil=require("./InvoicingUtil"),Invoice=require("./Invoice"),InvoiceTemplate=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments)}return _inherits(t,e),_createClass(t,null,[{key:"fromJSON",value:function(e){if(e.templateData&&e.templateData.currencyCode){var r;return r=new t(e.templateData.currencyCode),r.readJSON(e.templateData),r.isDefault=e["default"],r.name=e.name,r}}}]),t}(Invoice);module.exports=InvoiceTemplate;


},{"./Invoice":153,"./InvoicingUtil":160}],173:[function(require,module,exports){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function nonZero(t){return t&&!ZERO.equals(t)}function valOrZero(t){return t||ZERO}function compare(t,e){return t===e?0:e>t?-1:1}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),Currency=require("./Currency"),BN=require("./InvoiceBigNumber"),$$=BN.$$,Log=require("manticore-log")("invoicing"),ZERO=new BN(0),ONE=new BN(1);module.exports=function(t){var e=new InvoiceTotals(t);e.calculate()};var InvoiceTotals=function(){function t(e){_classCallCheck(this,t),this.invoice=e}return _createClass(t,[{key:"round",value:function(t){return Currency.round(this.invoice.currency,t)}},{key:"calculate",value:function(){var t=this.invoice,e=this.sortedInvoiceItems();t._subTotal=this.calculateItemSubtotals(e),t.taxCalculatedAfterDiscount||t.taxInclusive?(t._discountTotal=this.calculatePreTaxDiscountForItemSubtotal(t._subTotal),t.taxCalculatedAfterDiscount?t._taxBreakdown=this.calculateTaxesForItemsWithPreTaxDiscountTotal(e,t._discountTotal,t._subTotal):t._taxBreakdown=this.calculateTaxesForItemsWithDiscountAfterTax(e),t._shippingTaxTotal=this.calculateShippingTax(t._taxBreakdown),t._itemTax=this.calculateTotalTaxFromTaxes(t._taxBreakdown),t._itemTax=$$(t._itemTax.minus(t._shippingTaxTotal)),t._taxBreakdown=this.generateRoundedTaxDetailsFromTaxes(t._taxBreakdown)):(t._taxBreakdown=this.calculateTaxesForItemsWithDiscountAfterTax(e),t._shippingTaxTotal=this.calculateShippingTax(t._taxBreakdown),t._itemTax=this.calculateTotalTaxFromTaxes(t._taxBreakdown),t._itemTax=$$(t._itemTax.minus(t._shippingTaxTotal)),t._taxBreakdown=this.generateRoundedTaxDetailsFromTaxes(t._taxBreakdown),t._discountTotal=this.calculateDiscountWithItemSubTotal(t._subTotal,t._itemTax)),this.setDerivedTotals()}},{key:"sortedInvoiceItems",value:function(){var t=this.invoice.items.slice(0);return t.sort(function(t,e){return t.taxRate?e.taxRate?e.taxRate.equals(t.taxRate)?compare(t.name,e.name):-1*t.taxRate.comparedTo(e.taxRate):-1:e.taxRate?1:compare(t.name,e.name)}),t}},{key:"generateRoundedTaxDetailsFromTaxes",value:function(t){var e={};for(var a in t)e[a]=this.round(t[a]);return e}},{key:"calculateTotalTaxFromTaxes",value:function(t){var e=ZERO;for(var a in t)e=e.plus(t[a]);return e}},{key:"calculateTaxesForItemsWithPreTaxDiscountTotal",value:function(t,e,a){var i={},n=!0,o=!1,r=void 0;try{for(var u,s=t[Symbol.iterator]();!(n=(u=s.next()).done);n=!0){var c=u.value,l=this.calculateItemDiscount(c,e,a),v=ZERO;if(nonZero(c.unitPrice)&&(v=c.totalForInvoice(this.invoice)),nonZero(c.taxRate)){var d,x=[c.taxName," (",c.taxRate.toString(),"%)"].join("");if(this.invoice.taxInclusive){var h=v.minus(l);d=this.round(h.dividedBy(ONE.plus(c.taxRate.dividedBy(100))))}else d=this.round(v.minus(l).times(c.taxRate.dividedBy(100)));d&&!ZERO.equals(d)&&(i[x]=(i[x]||ZERO).plus(d))}}}catch(T){o=!0,r=T}finally{try{!n&&s["return"]&&s["return"]()}finally{if(o)throw r}}return i}},{key:"calculateItemDiscount",value:function(t,e,a){if(nonZero(e)){var i=t.totalForInvoice(this.invoice);if(nonZero(a))return this.invoice.discountPercentage&&!ZERO.equals(this.invoice.discountPercentage)?i.times(this.invoice.discountPercentage).dividedBy(100):i.dividedBy(a).times(e)}return ZERO}},{key:"calculateTaxesForItemsWithDiscountAfterTax",value:function(t){var e={},a=!0,i=!1,n=void 0;try{for(var o,r=t[Symbol.iterator]();!(a=(o=r.next()).done);a=!0){var u=o.value,s=ZERO;if(nonZero(u.unitPrice)&&(s=this.round(u.quantity.times(u.unitPrice))),nonZero(u.taxRate)){var c,l=[u.taxName," (",u.taxRate.toString(),"%)"].join("");if(this.invoice.taxInclusive){var v=s.dividedBy(ONE.plus(u.taxRate.dividedBy(100)));c=this.round(s.minus(v))}else c=this.round(s.times(u.taxRate.dividedBy(100)));c&&!ZERO.equals(c)&&(e[l]=(e[l]||ZERO).plus(c))}}}catch(d){i=!0,n=d}finally{try{!a&&r["return"]&&r["return"]()}finally{if(i)throw n}}return e}},{key:"calculateShippingTax",value:function(t){var e=this.invoice;if(nonZero(e.shippingTaxRate)&&nonZero(e.shippingAmount)){var a=["Shipping Tax"," (",e.shippingTaxRate.toString(),"%)"].join(""),i=e.shippingAmount.times(e.shippingTaxRate.dividedBy(100));return nonZero(i)&&(t[a]=valOrZero(t[a]).plus(i)),i}return ZERO}},{key:"calculateItemSubtotals",value:function(t){var e=ZERO,a=!0,i=!1,n=void 0;try{for(var o,r=t[Symbol.iterator]();!(a=(o=r.next()).done);a=!0){var u=o.value;e=e.plus(u.totalForInvoice(this.invoice))}}catch(s){i=!0,n=s}finally{try{!a&&r["return"]&&r["return"]()}finally{if(i)throw n}}return $$(e)}},{key:"calculateDiscountWithItemSubTotal",value:function(t,e){return nonZero(this.invoice.discountAmount)?this.invoice.discountAmount:nonZero(this.invoice.discountPercentage)?this.round(t.plus(e).times(this.invoice.discountPercentage).dividedBy(100)):ZERO}},{key:"calculatePreTaxDiscountForItemSubtotal",value:function(t){return nonZero(this.invoice.discountAmount)?$$(this.invoice.discountAmount):nonZero(this.invoice.discountPercentage)?this.round(this.invoice.discountPercentage.dividedBy(100).times(t)):ZERO}},{key:"setDerivedTotals",value:function(){var t=this.invoice;t._total=valOrZero(t._subTotal).plus(valOrZero(t.gratuityAmount)).plus(valOrZero(t.shippingAmount)),t.taxInclusive||(t._total=t._total.plus(valOrZero(t._itemTax)).plus(valOrZero(t._shippingTaxTotal))),nonZero(t._discountTotal)&&(t._total=t._total.minus(t._discountTotal)),t._total=$$(t._total)}}]),t}();


},{"./Currency":152,"./InvoiceBigNumber":155,"manticore-log":123}],174:[function(require,module,exports){
!function(e){"use strict";function n(e){function a(e,n){var t,r,i,o,u,s,f=this;if(!(f instanceof a))return j&&L(26,"constructor call without new",e),new a(e,n);if(null!=n&&H(n,2,64,M,"base")){if(n=0|n,s=e+"",10==n)return f=new a(e instanceof a?e:s),U(f,P+f.e+1,k);if((o="number"==typeof e)&&0*e!=0||!new RegExp("^-?"+(t="["+b.slice(0,n)+"]+")+"(?:\\."+t+")?$",37>n?"i":"").test(s))return g(f,s,o,n);o?(f.s=0>1/e?(s=s.slice(1),-1):1,j&&s.replace(/^0\.0*|\./,"").length>15&&L(M,N,e),o=!1):f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1,s=D(s,10,n,f.s)}else{if(e instanceof a)return f.s=e.s,f.e=e.e,f.c=(e=e.c)?e.slice():e,void(M=0);if((o="number"==typeof e)&&0*e==0){if(f.s=0>1/e?(e=-e,-1):1,e===~~e){for(r=0,i=e;i>=10;i/=10,r++);return f.e=r,f.c=[e],void(M=0)}s=e+""}else{if(!p.test(s=e+""))return g(f,s,o);f.s=45===s.charCodeAt(0)?(s=s.slice(1),-1):1}}for((r=s.indexOf("."))>-1&&(s=s.replace(".","")),(i=s.search(/e/i))>0?(0>r&&(r=i),r+=+s.slice(i+1),s=s.substring(0,i)):0>r&&(r=s.length),i=0;48===s.charCodeAt(i);i++);for(u=s.length;48===s.charCodeAt(--u););if(s=s.slice(i,u+1))if(u=s.length,o&&j&&u>15&&L(M,N,f.s*e),r=r-i-1,r>z)f.c=f.e=null;else if(G>r)f.c=[f.e=0];else{if(f.e=r,f.c=[],i=(r+1)%y,0>r&&(i+=y),u>i){for(i&&f.c.push(+s.slice(0,i)),u-=y;u>i;)f.c.push(+s.slice(i,i+=y));s=s.slice(i),i=y-s.length}else i-=u;for(;i--;s+="0");f.c.push(+s)}else f.c=[f.e=0];M=0}function D(e,n,t,i){var o,u,f,c,h,g,p,d=e.indexOf("."),m=P,w=k;for(37>t&&(e=e.toLowerCase()),d>=0&&(f=J,J=0,e=e.replace(".",""),p=new a(t),h=p.pow(e.length-d),J=f,p.c=s(l(r(h.c),h.e),10,n),p.e=p.c.length),g=s(e,t,n),u=f=g.length;0==g[--f];g.pop());if(!g[0])return"0";if(0>d?--u:(h.c=g,h.e=u,h.s=i,h=C(h,p,m,w,n),g=h.c,c=h.r,u=h.e),o=u+m+1,d=g[o],f=n/2,c=c||0>o||null!=g[o+1],c=4>w?(null!=d||c)&&(0==w||w==(h.s<0?3:2)):d>f||d==f&&(4==w||c||6==w&&1&g[o-1]||w==(h.s<0?8:7)),1>o||!g[0])e=c?l("1",-m):"0";else{if(g.length=o,c)for(--n;++g[--o]>n;)g[o]=0,o||(++u,g.unshift(1));for(f=g.length;!g[--f];);for(d=0,e="";f>=d;e+=b.charAt(g[d++]));e=l(e,u)}return e}function _(e,n,t,i){var o,u,s,c,h;if(t=null!=t&&H(t,0,8,i,v)?0|t:k,!e.c)return e.toString();if(o=e.c[0],s=e.e,null==n)h=r(e.c),h=19==i||24==i&&B>=s?f(h,s):l(h,s);else if(e=U(new a(e),n,t),u=e.e,h=r(e.c),c=h.length,19==i||24==i&&(u>=n||B>=u)){for(;n>c;h+="0",c++);h=f(h,u)}else if(n-=s,h=l(h,u),u+1>c){if(--n>0)for(h+=".";n--;h+="0");}else if(n+=u-c,n>0)for(u+1==c&&(h+=".");n--;h+="0");return e.s<0&&o?"-"+h:h}function x(e,n){var t,r,i=0;for(u(e[0])&&(e=e[0]),t=new a(e[0]);++i<e.length;){if(r=new a(e[i]),!r.s){t=r;break}n.call(t,r)&&(t=r)}return t}function F(e,n,t,r,i){return(n>e||e>t||e!=c(e))&&L(r,(i||"decimal places")+(n>e||e>t?" out of range":" not an integer"),e),!0}function I(e,n,t){for(var r=1,i=n.length;!n[--i];n.pop());for(i=n[0];i>=10;i/=10,r++);return(t=r+t*y-1)>z?e.c=e.e=null:G>t?e.c=[e.e=0]:(e.e=t,e.c=n),e}function L(e,n,t){var r=new Error(["new BigNumber","cmp","config","div","divToInt","eq","gt","gte","lt","lte","minus","mod","plus","precision","random","round","shift","times","toDigits","toExponential","toFixed","toFormat","toFraction","pow","toPrecision","toString","BigNumber"][e]+"() "+n+": "+t);throw r.name="BigNumber Error",M=0,r}function U(e,n,t,r){var i,o,u,s,f,l,c,a=e.c,h=R;if(a){e:{for(i=1,s=a[0];s>=10;s/=10,i++);if(o=n-i,0>o)o+=y,u=n,f=a[l=0],c=f/h[i-u-1]%10|0;else if(l=d((o+1)/y),l>=a.length){if(!r)break e;for(;a.length<=l;a.push(0));f=c=0,i=1,o%=y,u=o-y+1}else{for(f=s=a[l],i=1;s>=10;s/=10,i++);o%=y,u=o-y+i,c=0>u?0:f/h[i-u-1]%10|0}if(r=r||0>n||null!=a[l+1]||(0>u?f:f%h[i-u-1]),r=4>t?(c||r)&&(0==t||t==(e.s<0?3:2)):c>5||5==c&&(4==t||r||6==t&&(o>0?u>0?f/h[i-u]:0:a[l-1])%10&1||t==(e.s<0?8:7)),1>n||!a[0])return a.length=0,r?(n-=e.e+1,a[0]=h[(y-n%y)%y],e.e=-n||0):a[0]=e.e=0,e;if(0==o?(a.length=l,s=1,l--):(a.length=l+1,s=h[y-o],a[l]=u>0?m(f/h[i-u]%h[u])*s:0),r)for(;;){if(0==l){for(o=1,u=a[0];u>=10;u/=10,o++);for(u=a[0]+=s,s=1;u>=10;u/=10,s++);o!=s&&(e.e++,a[0]==O&&(a[0]=1));break}if(a[l]+=s,a[l]!=O)break;a[l--]=0,s=1}for(o=a.length;0===a[--o];a.pop());}e.e>z?e.c=e.e=null:e.e<G&&(e.c=[e.e=0])}return e}var C,M=0,T=a.prototype,q=new a(1),P=20,k=4,B=-7,$=21,G=-1e7,z=1e7,j=!0,H=F,V=!1,W=1,J=100,X={decimalSeparator:".",groupSeparator:",",groupSize:3,secondaryGroupSize:0,fractionGroupSeparator:" ",fractionGroupSize:0};return a.another=n,a.ROUND_UP=0,a.ROUND_DOWN=1,a.ROUND_CEIL=2,a.ROUND_FLOOR=3,a.ROUND_HALF_UP=4,a.ROUND_HALF_DOWN=5,a.ROUND_HALF_EVEN=6,a.ROUND_HALF_CEIL=7,a.ROUND_HALF_FLOOR=8,a.EUCLID=9,a.config=function(){var e,n,t=0,r={},i=arguments,s=i[0],f=s&&"object"==typeof s?function(){return s.hasOwnProperty(n)?null!=(e=s[n]):void 0}:function(){return i.length>t?null!=(e=i[t++]):void 0};return f(n="DECIMAL_PLACES")&&H(e,0,E,2,n)&&(P=0|e),r[n]=P,f(n="ROUNDING_MODE")&&H(e,0,8,2,n)&&(k=0|e),r[n]=k,f(n="EXPONENTIAL_AT")&&(u(e)?H(e[0],-E,0,2,n)&&H(e[1],0,E,2,n)&&(B=0|e[0],$=0|e[1]):H(e,-E,E,2,n)&&(B=-($=0|(0>e?-e:e)))),r[n]=[B,$],f(n="RANGE")&&(u(e)?H(e[0],-E,-1,2,n)&&H(e[1],1,E,2,n)&&(G=0|e[0],z=0|e[1]):H(e,-E,E,2,n)&&(0|e?G=-(z=0|(0>e?-e:e)):j&&L(2,n+" cannot be zero",e))),r[n]=[G,z],f(n="ERRORS")&&(e===!!e||1===e||0===e?(M=0,H=(j=!!e)?F:o):j&&L(2,n+w,e)),r[n]=j,f(n="CRYPTO")&&(e===!!e||1===e||0===e?(V=!(!e||!h||"object"!=typeof h),e&&!V&&j&&L(2,"crypto unavailable",h)):j&&L(2,n+w,e)),r[n]=V,f(n="MODULO_MODE")&&H(e,0,9,2,n)&&(W=0|e),r[n]=W,f(n="POW_PRECISION")&&H(e,0,E,2,n)&&(J=0|e),r[n]=J,f(n="FORMAT")&&("object"==typeof e?X=e:j&&L(2,n+" not an object",e)),r[n]=X,r},a.max=function(){return x(arguments,T.lt)},a.min=function(){return x(arguments,T.gt)},a.random=function(){var e=9007199254740992,n=Math.random()*e&2097151?function(){return m(Math.random()*e)}:function(){return 8388608*(1073741824*Math.random()|0)+(8388608*Math.random()|0)};return function(e){var t,r,i,o,u,s=0,f=[],l=new a(q);if(e=null!=e&&H(e,0,E,14)?0|e:P,o=d(e/y),V)if(h&&h.getRandomValues){for(t=h.getRandomValues(new Uint32Array(o*=2));o>s;)u=131072*t[s]+(t[s+1]>>>11),u>=9e15?(r=h.getRandomValues(new Uint32Array(2)),t[s]=r[0],t[s+1]=r[1]):(f.push(u%1e14),s+=2);s=o/2}else if(h&&h.randomBytes){for(t=h.randomBytes(o*=7);o>s;)u=281474976710656*(31&t[s])+1099511627776*t[s+1]+4294967296*t[s+2]+16777216*t[s+3]+(t[s+4]<<16)+(t[s+5]<<8)+t[s+6],u>=9e15?h.randomBytes(7).copy(t,s):(f.push(u%1e14),s+=7);s=o/7}else j&&L(14,"crypto unavailable",h);if(!s)for(;o>s;)u=n(),9e15>u&&(f[s++]=u%1e14);for(o=f[--s],e%=y,o&&e&&(u=R[y-e],f[s]=m(o/u)*u);0===f[s];f.pop(),s--);if(0>s)f=[i=0];else{for(i=-1;0===f[0];f.shift(),i-=y);for(s=1,u=f[0];u>=10;u/=10,s++);y>s&&(i-=y-s)}return l.e=i,l.c=f,l}}(),C=function(){function e(e,n,t){var r,i,o,u,s=0,f=e.length,l=n%A,c=n/A|0;for(e=e.slice();f--;)o=e[f]%A,u=e[f]/A|0,r=c*o+u*l,i=l*o+r%A*A+s,s=(i/t|0)+(r/A|0)+c*u,e[f]=i%t;return s&&e.unshift(s),e}function n(e,n,t,r){var i,o;if(t!=r)o=t>r?1:-1;else for(i=o=0;t>i;i++)if(e[i]!=n[i]){o=e[i]>n[i]?1:-1;break}return o}function r(e,n,t,r){for(var i=0;t--;)e[t]-=i,i=e[t]<n[t]?1:0,e[t]=i*r+e[t]-n[t];for(;!e[0]&&e.length>1;e.shift());}return function(i,o,u,s,f){var l,c,h,g,p,d,w,v,N,b,S,R,A,E,D,_,x,F=i.s==o.s?1:-1,I=i.c,L=o.c;if(!(I&&I[0]&&L&&L[0]))return new a(i.s&&o.s&&(I?!L||I[0]!=L[0]:L)?I&&0==I[0]||!L?0*F:F/0:NaN);for(v=new a(F),N=v.c=[],c=i.e-o.e,F=u+c+1,f||(f=O,c=t(i.e/y)-t(o.e/y),F=F/y|0),h=0;L[h]==(I[h]||0);h++);if(L[h]>(I[h]||0)&&c--,0>F)N.push(1),g=!0;else{for(E=I.length,_=L.length,h=0,F+=2,p=m(f/(L[0]+1)),p>1&&(L=e(L,p,f),I=e(I,p,f),_=L.length,E=I.length),A=_,b=I.slice(0,_),S=b.length;_>S;b[S++]=0);x=L.slice(),x.unshift(0),D=L[0],L[1]>=f/2&&D++;do{if(p=0,l=n(L,b,_,S),0>l){if(R=b[0],_!=S&&(R=R*f+(b[1]||0)),p=m(R/D),p>1)for(p>=f&&(p=f-1),d=e(L,p,f),w=d.length,S=b.length;1==n(d,b,w,S);)p--,r(d,w>_?x:L,w,f),w=d.length,l=1;else 0==p&&(l=p=1),d=L.slice(),w=d.length;if(S>w&&d.unshift(0),r(b,d,S,f),S=b.length,-1==l)for(;n(L,b,_,S)<1;)p++,r(b,S>_?x:L,S,f),S=b.length}else 0===l&&(p++,b=[0]);N[h++]=p,b[0]?b[S++]=I[A]||0:(b=[I[A]],S=1)}while((A++<E||null!=b[0])&&F--);g=null!=b[0],N[0]||N.shift()}if(f==O){for(h=1,F=N[0];F>=10;F/=10,h++);U(v,u+(v.e=h+c*y-1)+1,s,g)}else v.e=c,v.r=+g;return v}}(),g=function(){var e=/^(-?)0([xbo])(?=\w[\w.]*$)/i,n=/^([^.]+)\.$/,t=/^\.([^.]+)$/,r=/^-?(Infinity|NaN)$/,i=/^\s*\+(?=[\w.])|^\s+|\s+$/g;return function(o,u,s,f){var l,c=s?u:u.replace(i,"");if(r.test(c))o.s=isNaN(c)?null:0>c?-1:1;else{if(!s&&(c=c.replace(e,function(e,n,t){return l="x"==(t=t.toLowerCase())?16:"b"==t?2:8,f&&f!=l?e:n}),f&&(l=f,c=c.replace(n,"$1").replace(t,"0.$1")),u!=c))return new a(c,l);j&&L(M,"not a"+(f?" base "+f:"")+" number",u),o.s=null}o.c=o.e=null,M=0}}(),T.absoluteValue=T.abs=function(){var e=new a(this);return e.s<0&&(e.s=1),e},T.ceil=function(){return U(new a(this),this.e+1,2)},T.comparedTo=T.cmp=function(e,n){return M=1,i(this,new a(e,n))},T.decimalPlaces=T.dp=function(){var e,n,r=this.c;if(!r)return null;if(e=((n=r.length-1)-t(this.e/y))*y,n=r[n])for(;n%10==0;n/=10,e--);return 0>e&&(e=0),e},T.dividedBy=T.div=function(e,n){return M=3,C(this,new a(e,n),P,k)},T.dividedToIntegerBy=T.divToInt=function(e,n){return M=4,C(this,new a(e,n),0,1)},T.equals=T.eq=function(e,n){return M=5,0===i(this,new a(e,n))},T.floor=function(){return U(new a(this),this.e+1,3)},T.greaterThan=T.gt=function(e,n){return M=6,i(this,new a(e,n))>0},T.greaterThanOrEqualTo=T.gte=function(e,n){return M=7,1===(n=i(this,new a(e,n)))||0===n},T.isFinite=function(){return!!this.c},T.isInteger=T.isInt=function(){return!!this.c&&t(this.e/y)>this.c.length-2},T.isNaN=function(){return!this.s},T.isNegative=T.isNeg=function(){return this.s<0},T.isZero=function(){return!!this.c&&0==this.c[0]},T.lessThan=T.lt=function(e,n){return M=8,i(this,new a(e,n))<0},T.lessThanOrEqualTo=T.lte=function(e,n){return M=9,-1===(n=i(this,new a(e,n)))||0===n},T.minus=T.sub=function(e,n){var r,i,o,u,s=this,f=s.s;if(M=10,e=new a(e,n),n=e.s,!f||!n)return new a(NaN);if(f!=n)return e.s=-n,s.plus(e);var l=s.e/y,c=e.e/y,h=s.c,g=e.c;if(!l||!c){if(!h||!g)return h?(e.s=-n,e):new a(g?s:NaN);if(!h[0]||!g[0])return g[0]?(e.s=-n,e):new a(h[0]?s:3==k?-0:0)}if(l=t(l),c=t(c),h=h.slice(),f=l-c){for((u=0>f)?(f=-f,o=h):(c=l,o=g),o.reverse(),n=f;n--;o.push(0));o.reverse()}else for(i=(u=(f=h.length)<(n=g.length))?f:n,f=n=0;i>n;n++)if(h[n]!=g[n]){u=h[n]<g[n];break}if(u&&(o=h,h=g,g=o,e.s=-e.s),n=(i=g.length)-(r=h.length),n>0)for(;n--;h[r++]=0);for(n=O-1;i>f;){if(h[--i]<g[i]){for(r=i;r&&!h[--r];h[r]=n);--h[r],h[i]+=O}h[i]-=g[i]}for(;0==h[0];h.shift(),--c);return h[0]?I(e,h,c):(e.s=3==k?-1:1,e.c=[e.e=0],e)},T.modulo=T.mod=function(e,n){var t,r,i=this;return M=11,e=new a(e,n),!i.c||!e.s||e.c&&!e.c[0]?new a(NaN):!e.c||i.c&&!i.c[0]?new a(i):(9==W?(r=e.s,e.s=1,t=C(i,e,0,3),e.s=r,t.s*=r):t=C(i,e,0,W),i.minus(t.times(e)))},T.negated=T.neg=function(){var e=new a(this);return e.s=-e.s||null,e},T.plus=T.add=function(e,n){var r,i=this,o=i.s;if(M=12,e=new a(e,n),n=e.s,!o||!n)return new a(NaN);if(o!=n)return e.s=-n,i.minus(e);var u=i.e/y,s=e.e/y,f=i.c,l=e.c;if(!u||!s){if(!f||!l)return new a(o/0);if(!f[0]||!l[0])return l[0]?e:new a(f[0]?i:0*o)}if(u=t(u),s=t(s),f=f.slice(),o=u-s){for(o>0?(s=u,r=l):(o=-o,r=f),r.reverse();o--;r.push(0));r.reverse()}for(o=f.length,n=l.length,0>o-n&&(r=l,l=f,f=r,n=o),o=0;n;)o=(f[--n]=f[n]+l[n]+o)/O|0,f[n]%=O;return o&&(f.unshift(o),++s),I(e,f,s)},T.precision=T.sd=function(e){var n,t,r=this,i=r.c;if(null!=e&&e!==!!e&&1!==e&&0!==e&&(j&&L(13,"argument"+w,e),e!=!!e&&(e=null)),!i)return null;if(t=i.length-1,n=t*y+1,t=i[t]){for(;t%10==0;t/=10,n--);for(t=i[0];t>=10;t/=10,n++);}return e&&r.e+1>n&&(n=r.e+1),n},T.round=function(e,n){var t=new a(this);return(null==e||H(e,0,E,15))&&U(t,~~e+this.e+1,null!=n&&H(n,0,8,15,v)?0|n:k),t},T.shift=function(e){var n=this;return H(e,-S,S,16,"argument")?n.times("1e"+c(e)):new a(n.c&&n.c[0]&&(-S>e||e>S)?n.s*(0>e?0:1/0):n)},T.squareRoot=T.sqrt=function(){var e,n,i,o,u,s=this,f=s.c,l=s.s,c=s.e,h=P+4,g=new a("0.5");if(1!==l||!f||!f[0])return new a(!l||0>l&&(!f||f[0])?NaN:f?s:1/0);if(l=Math.sqrt(+s),0==l||l==1/0?(n=r(f),(n.length+c)%2==0&&(n+="0"),l=Math.sqrt(n),c=t((c+1)/2)-(0>c||c%2),l==1/0?n="1e"+c:(n=l.toExponential(),n=n.slice(0,n.indexOf("e")+1)+c),i=new a(n)):i=new a(l+""),i.c[0])for(c=i.e,l=c+h,3>l&&(l=0);;)if(u=i,i=g.times(u.plus(C(s,u,h,1))),r(u.c).slice(0,l)===(n=r(i.c)).slice(0,l)){if(i.e<c&&--l,n=n.slice(l-3,l+1),"9999"!=n&&(o||"4999"!=n)){+n&&(+n.slice(1)||"5"!=n.charAt(0))||(U(i,i.e+P+2,1),e=!i.times(i).eq(s));break}if(!o&&(U(u,u.e+P+2,0),u.times(u).eq(s))){i=u;break}h+=4,l+=4,o=1}return U(i,i.e+P+1,k,e)},T.times=T.mul=function(e,n){var r,i,o,u,s,f,l,c,h,g,p,d,m,w,v,N=this,b=N.c,S=(M=17,e=new a(e,n)).c;if(!(b&&S&&b[0]&&S[0]))return!N.s||!e.s||b&&!b[0]&&!S||S&&!S[0]&&!b?e.c=e.e=e.s=null:(e.s*=N.s,b&&S?(e.c=[0],e.e=0):e.c=e.e=null),e;for(i=t(N.e/y)+t(e.e/y),e.s*=N.s,l=b.length,g=S.length,g>l&&(m=b,b=S,S=m,o=l,l=g,g=o),o=l+g,m=[];o--;m.push(0));for(w=O,v=A,o=g;--o>=0;){for(r=0,p=S[o]%v,d=S[o]/v|0,s=l,u=o+s;u>o;)c=b[--s]%v,h=b[s]/v|0,f=d*c+h*p,c=p*c+f%v*v+m[u]+r,r=(c/w|0)+(f/v|0)+d*h,m[u--]=c%w;m[u]=r}return r?++i:m.shift(),I(e,m,i)},T.toDigits=function(e,n){var t=new a(this);return e=null!=e&&H(e,1,E,18,"precision")?0|e:null,n=null!=n&&H(n,0,8,18,v)?0|n:k,e?U(t,e,n):t},T.toExponential=function(e,n){return _(this,null!=e&&H(e,0,E,19)?~~e+1:null,n,19)},T.toFixed=function(e,n){return _(this,null!=e&&H(e,0,E,20)?~~e+this.e+1:null,n,20)},T.toFormat=function(e,n){var t=_(this,null!=e&&H(e,0,E,21)?~~e+this.e+1:null,n,21);if(this.c){var r,i=t.split("."),o=+X.groupSize,u=+X.secondaryGroupSize,s=X.groupSeparator,f=i[0],l=i[1],c=this.s<0,a=c?f.slice(1):f,h=a.length;if(u&&(r=o,o=u,u=r,h-=r),o>0&&h>0){for(r=h%o||o,f=a.substr(0,r);h>r;r+=o)f+=s+a.substr(r,o);u>0&&(f+=s+a.slice(r)),c&&(f="-"+f)}t=l?f+X.decimalSeparator+((u=+X.fractionGroupSize)?l.replace(new RegExp("\\d{"+u+"}\\B","g"),"$&"+X.fractionGroupSeparator):l):f}return t},T.toFraction=function(e){var n,t,i,o,u,s,f,l,c,h=j,g=this,p=g.c,d=new a(q),m=t=new a(q),w=f=new a(q);if(null!=e&&(j=!1,s=new a(e),j=h,(h=s.isInt())&&!s.lt(q)||(j&&L(22,"max denominator "+(h?"out of range":"not an integer"),e),e=!h&&s.c&&U(s,s.e+1,1).gte(q)?s:null)),!p)return g.toString();for(c=r(p),o=d.e=c.length-g.e-1,d.c[0]=R[(u=o%y)<0?y+u:u],e=!e||s.cmp(d)>0?o>0?d:m:s,u=z,z=1/0,s=new a(c),f.c[0]=0;l=C(s,d,0,1),i=t.plus(l.times(w)),1!=i.cmp(e);)t=w,w=i,m=f.plus(l.times(i=m)),f=i,d=s.minus(l.times(i=d)),s=i;return i=C(e.minus(t),w,0,1),f=f.plus(i.times(m)),t=t.plus(i.times(w)),f.s=m.s=g.s,o*=2,n=C(m,w,o,k).minus(g).abs().cmp(C(f,t,o,k).minus(g).abs())<1?[m.toString(),w.toString()]:[f.toString(),t.toString()],z=u,n},T.toNumber=function(){return+this},T.toPower=T.pow=function(e){var n,t,r=m(0>e?-e:+e),i=this;if(!H(e,-S,S,23,"exponent")&&(!isFinite(e)||r>S&&(e/=0)||parseFloat(e)!=e&&!(e=NaN)))return new a(Math.pow(+i,e));for(n=J?d(J/y+2):0,t=new a(q);;){if(r%2){if(t=t.times(i),!t.c)break;n&&t.c.length>n&&(t.c.length=n)}if(r=m(r/2),!r)break;i=i.times(i),n&&i.c&&i.c.length>n&&(i.c.length=n)}return 0>e&&(t=q.div(t)),n?U(t,J,k):t},T.toPrecision=function(e,n){return _(this,null!=e&&H(e,1,E,24,"precision")?0|e:null,n,24)},T.toString=function(e){var n,t=this,i=t.s,o=t.e;return null===o?i?(n="Infinity",0>i&&(n="-"+n)):n="NaN":(n=r(t.c),n=null!=e&&H(e,2,64,25,"base")?D(l(n,o),0|e,10,i):B>=o||o>=$?f(n,o):l(n,o),0>i&&t.c[0]&&(n="-"+n)),n},T.truncated=T.trunc=function(){return U(new a(this),this.e+1,1)},T.valueOf=T.toJSON=function(){var e,n=this,t=n.e;return null===t?n.toString():(e=r(n.c),e=B>=t||t>=$?f(e,t):l(e,t),n.s<0?"-"+e:e)},null!=e&&a.config(e),a}function t(e){var n=0|e;return e>0||e===n?n:n-1}function r(e){for(var n,t,r=1,i=e.length,o=e[0]+"";i>r;){for(n=e[r++]+"",t=y-n.length;t--;n="0"+n);o+=n}for(i=o.length;48===o.charCodeAt(--i););return o.slice(0,i+1||1)}function i(e,n){var t,r,i=e.c,o=n.c,u=e.s,s=n.s,f=e.e,l=n.e;if(!u||!s)return null;if(t=i&&!i[0],r=o&&!o[0],t||r)return t?r?0:-s:u;if(u!=s)return u;if(t=0>u,r=f==l,!i||!o)return r?0:!i^t?1:-1;if(!r)return f>l^t?1:-1;for(s=(f=i.length)<(l=o.length)?f:l,u=0;s>u;u++)if(i[u]!=o[u])return i[u]>o[u]^t?1:-1;return f==l?0:f>l^t?1:-1}function o(e,n,t){return(e=c(e))>=n&&t>=e}function u(e){return"[object Array]"==Object.prototype.toString.call(e)}function s(e,n,t){for(var r,i,o=[0],u=0,s=e.length;s>u;){for(i=o.length;i--;o[i]*=n);for(o[r=0]+=b.indexOf(e.charAt(u++));r<o.length;r++)o[r]>t-1&&(null==o[r+1]&&(o[r+1]=0),o[r+1]+=o[r]/t|0,o[r]%=t)}return o.reverse()}function f(e,n){return(e.length>1?e.charAt(0)+"."+e.slice(1):e)+(0>n?"e":"e+")+n}function l(e,n){var t,r;if(0>n){for(r="0.";++n;r+="0");e=r+e}else if(t=e.length,++n>t){for(r="0",n-=t;--n;r+="0");e+=r}else t>n&&(e=e.slice(0,n)+"."+e.slice(n));return e}function c(e){return e=parseFloat(e),0>e?d(e):m(e)}var a,h,g,p=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,d=Math.ceil,m=Math.floor,w=" not a boolean or binary digit",v="rounding mode",N="number type has more than 15 significant digits",b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_",O=1e14,y=14,S=9007199254740991,R=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],A=1e7,E=1e9;if(a=n(),"function"==typeof define&&define.amd)define(function(){return a});else if("undefined"!=typeof module&&module.exports){if(module.exports=a,!h)try{h=require("crypto")}catch(D){}}else e.BigNumber=a}(this);


},{"crypto":undefined}],175:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(r,t,o){return t&&e(r.prototype,t),o&&e(r,o),r}}(),manticore=require("manticore"),Log=require("manticore-log")("paypalrest"),PayPalREST=function(){function e(r,t,o){var s=this;_classCallCheck(this,e),this.resolvers={token:function(r,t){return s.env===e.Env.LIVE?"https://api.paypal.com/v1/oauth2/"+t.op:s.env===e.Env.SANDBOX?"https://api.sandbox.paypal.com/v1/oauth2/"+t.op:s.env===e.Env.MSMASTER?"https://www.msmaster.qa.paypal.com/v1/oauth2/"+t.op:"https://www."+s.env+".stage.paypal.com:11888/v1/oauth2/"+t.op},invoicing:function(r,t){return s.env===e.Env.LIVE?"https://api.paypal.com/v1/invoicing/"+t.op:s.env===e.Env.SANDBOX?"https://api.sandbox.paypal.com/v1/invoicing/"+t.op:s.env===e.Env.MSMASTER?"https://www.msmaster.qa.paypal.com/v1/invoicing/"+t.op:"https://www."+s.env+".stage.paypal.com:11888/v1/invoicing/"+t.op},contactserv:function(r,t){return s.env===e.Env.LIVE?"https://api.paypal.com/v1/customer/contacts/"+t.op:s.env===e.Env.SANDBOX?"https://api.sandbox.paypal.com/v1/customer/contacts/"+t.op:s.env===e.Env.MSMASTER?"https://www.msmaster.qa.paypal.com/v1/customer/contacts/"+t.op:"https://www."+s.env+".stage.paypal.com:11888/v1/customer/contacts/"+t.op}},this.env=e.Env.LIVE,this.cbs=[],this.at=r,this.refreshUrl=t,this.exp=o}return _createClass(e,null,[{key:"fromToken",value:function(r){var t;try{if(r&&"{"===r[0])t=JSON.parse(r);else{var o=(r||"").split(":",2);if(2!==o.length)throw new Error("Invalid token presented (off by "+(o.length-2)+")");var s=new Buffer(o[1],"base64"),n=JSON.parse(s.toString("utf8"));t={env:o[0],access_token:n[0],expires_in:n[1],refresh_url:n[2]},!n[2]&&"live"!==o[0]&&n.length>=5&&(t.app={auth:n[4]},t.rt=n[3])}var a=new e(t.access_token,t.refresh_url,t.expires_in);return a.env=t.env,t.app&&t.rt&&(a.app=t.app,a.rt=t.rt),a}catch(i){throw Log.error("Could not read token: "+i.message+"\n"+i.stack),new Error("Invalid token presented ("+i.message+")")}}}]),_createClass(e,[{key:"addResolver",value:function(e,r){this.resolvers[e]=r}},{key:"request",value:function(r,t){var o=this;if(!r){var s=new Error("Empty options!");return Log.error("Empty options: "+s.stack),t(s,null)}if(!r.url){if(!r.service||!this.resolvers[r.service]){var n=new Error("Options has no url and no resolvable service.");return Log.error("Bad options: "+n.stack),t(n,null)}r.url=this.resolvers[r.service](this,r)}if(!this.at&&!this.refreshUrl)return t(new Error("The access token is invalid and does not include an access token or refresh url"),null);if(!this.at)return this.refresh(function(e){return e?t(e,null):void o.request(r,t)});r.headers=r.headers||{},r.headers.Authorization="Bearer "+this.at;var a=(new Date).getTime();manticore.http(r,function(s,n){try{var i=(new Date).getTime(),c=i-a;if(Log.debug(function(){return(r.method||"GET")+" "+r.url+" ("+c+"ms): "+(n?n.statusCode:s)}),s)return Log.error("Authenticated request error: "+s.message+"\n"+s.stack),t(s,null);var l=n&&(401===n.statusCode||403===n.statusCode)&&!r._tried;if(l)return r._tried=!0,o.refresh(function(e){return e?t(e,null):void o.request(r,t)});"json"!==r.format||r.rawError||(n&&n.body&&(n.body.errorCode?(s=new Error(n.body.message),s.code=n.body.errorCode,s.debugId=n.body.correlationId):n.statusCode&&n.statusCode>=300&&(s=new Error(n.body.message),s.code=n.body.name||n.statusCode,s.debugId=n.body.debug_id,n.body.details&&(s.details=n.body.details))),n.statusCode>=400&&!s&&(s=new Error,s.code=n.statusCode),s&&(s.domain=r.service,e.generateDevMessage(s),Log.error("Received error ("+s.developerMessage+")")))}catch(u){Log.error("Merchant request failure: "+(u.message||u)+"\n"+u.stack),s=u}t&&t(s,n)})}},{key:"refresh",value:function(e){var r=this;if(this.cbs.length)return this.cbs.push(e);if(this.cbs.push(e),!this.refreshUrl&&this.rt&&this.app){Log.debug("Attempting a direct token refresh");var t="grant_type=refresh_token&response_type=token&refresh_token="+encodeURIComponent(this.rt);return void manticore.http({url:this.resolvers.token(this,{op:"token"}),headers:{Authorization:"Basic "+this.app.auth,"Content-Type":"application/x-www-form-urlencoded"},method:"POST",format:"json",body:t,timeout:15e3},function(e,t){if(t&&t.body&&t.body.access_token?(r.at=t.body.access_token,Log.debug("Successfully refreshed token.")):e||(Log.error("Invalid response from token refresh"),e=new Error("Invalid response from token refresh")),e){var o=JSON.stringify(t||{});Log.error("Failed to directly refresh token: "+e.message+": "+o)}var s=!0,n=!1,a=void 0;try{for(var i,c=r.cbs[Symbol.iterator]();!(s=(i=c.next()).done);s=!0){var l=i.value;try{l(e)}catch(u){}}}catch(h){n=!0,a=h}finally{try{!s&&c["return"]&&c["return"]()}finally{if(n)throw a}}r.cbs=[]})}if(this.refreshUrl)Log.debug("Attempting a token refresh"),manticore.http({url:this.refreshUrl,format:"json"},function(e,t){if(t&&t.body&&t.body.access_token?(r.at=t.body.access_token,r.refreshUrl=t.body.refresh_url||r.refreshUrl,Log.debug("Successfully refreshed token.")):e||(e=new Error("Invalid response from refreshUrl")),e){var o=JSON.stringify(t||{});Log.error("Failed to refresh token: "+e.message+": "+o)}var s=!0,n=!1,a=void 0;try{for(var i,c=r.cbs[Symbol.iterator]();!(s=(i=c.next()).done);s=!0){var l=i.value;try{l(e)}catch(u){}}}catch(h){n=!0,a=h}finally{try{!s&&c["return"]&&c["return"]()}finally{if(n)throw a}}r.cbs=[]});else{var o=new Error('Merchant token had no "refreshUrl" property, cannot refresh access token.'),s=!0,n=!1,a=void 0;try{for(var i,c=this.cbs[Symbol.iterator]();!(s=(i=c.next()).done);s=!0){var l=i.value;try{l(o)}catch(u){}this.cbs=[]}}catch(h){n=!0,a=h}finally{try{!s&&c["return"]&&c["return"]()}finally{if(n)throw a}}}}}],[{key:"generateDevMessage",value:function(e){function r(e,r){t.length&&(t+=", "),t+=e+": ",r&&r.length&&(t+=r)}if(!e)return e;var t="";r("domain",e.domain),r("code",e.code),r("message",e.message),r("debugId",e.debugId);var o="";return e.details&&Array.isArray(e.details)&&e.details.length>0&&e.details.forEach(function(e){o.length&&(o+=" "),o+=e.field+" "+e.issue}),r("details",o),e.developerMessage=t,e}}]),e}();PayPalREST.Env={LIVE:"live",SANDBOX:"sandbox",MSMASTER:"msmaster"},module.exports=PayPalREST;


}).call(this,require("buffer").Buffer)
},{"buffer":44,"manticore":125,"manticore-log":123}],176:[function(require,module,exports){
function drainQueue(){if(!draining){draining=!0;for(var e,o=queue.length;o;){e=queue,queue=[];for(var r=-1;++r<o;)e[r]();o=queue.length}draining=!1}}function noop(){}var process=module.exports={},queue=[],draining=!1;process.nextTick=function(e){queue.push(e),draining||setTimeout(drainQueue,0)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};


},{}],177:[function(require,module,exports){
var Utils=require("./utils"),internals={delimiter:"&",arrayPrefixGenerators:{brackets:function(r,e){return r+"[]"},indices:function(r,e){return r+"["+e+"]"},repeat:function(r,e){return r}},strictNullHandling:!1};internals.stringify=function(r,e,n,i,t){if("function"==typeof t)r=t(e,r);else if(Utils.isBuffer(r))r=r.toString();else if(r instanceof Date)r=r.toISOString();else if(null===r){if(i)return Utils.encode(e);r=""}if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)return[Utils.encode(e)+"="+Utils.encode(r)];var a=[];if("undefined"==typeof r)return a;for(var l=Array.isArray(t)?t:Object.keys(r),s=0,f=l.length;f>s;++s){var o=l[s];a=Array.isArray(r)?a.concat(internals.stringify(r[o],n(e,o),n,i,t)):a.concat(internals.stringify(r[o],e+"["+o+"]",n,i,t))}return a},module.exports=function(r,e){e=e||{};var n,i,t="undefined"==typeof e.delimiter?internals.delimiter:e.delimiter,a="boolean"==typeof e.strictNullHandling?e.strictNullHandling:internals.strictNullHandling;"function"==typeof e.filter?(i=e.filter,r=i("",r)):Array.isArray(e.filter)&&(n=i=e.filter);var l=[];if("object"!=typeof r||null===r)return"";var s;s=e.arrayFormat in internals.arrayPrefixGenerators?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":"indices";var f=internals.arrayPrefixGenerators[s];n||(n=Object.keys(r));for(var o=0,c=n.length;c>o;++o){var u=n[o];l=l.concat(internals.stringify(r[u],u,f,a,i))}return l.join(t)};


},{"./utils":178}],178:[function(require,module,exports){
var internals={};internals.hexTable=new Array(256);for(var h=0;256>h;++h)internals.hexTable[h]="%"+((16>h?"0":"")+h.toString(16)).toUpperCase();exports.arrayToObject=function(e,r){for(var t=r.plainObjects?Object.create(null):{},n=0,a=e.length;a>n;++n)"undefined"!=typeof e[n]&&(t[n]=e[n]);return t},exports.merge=function(e,r,t){if(!r)return e;if("object"!=typeof r)return Array.isArray(e)?e.push(r):"object"==typeof e?e[r]=!0:e=[e,r],e;if("object"!=typeof e)return e=[e].concat(r);Array.isArray(e)&&!Array.isArray(r)&&(e=exports.arrayToObject(e,t));for(var n=Object.keys(r),a=0,o=n.length;o>a;++a){var c=n[a],i=r[c];Object.prototype.hasOwnProperty.call(e,c)?e[c]=exports.merge(e[c],i,t):e[c]=i}return e},exports.decode=function(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(r){return e}},exports.encode=function(e){if(0===e.length)return e;"string"!=typeof e&&(e=""+e);for(var r="",t=0,n=e.length;n>t;++t){var a=e.charCodeAt(t);45===a||46===a||95===a||126===a||a>=48&&57>=a||a>=65&&90>=a||a>=97&&122>=a?r+=e[t]:128>a?r+=internals.hexTable[a]:2048>a?r+=internals.hexTable[192|a>>6]+internals.hexTable[128|63&a]:55296>a||a>=57344?r+=internals.hexTable[224|a>>12]+internals.hexTable[128|a>>6&63]+internals.hexTable[128|63&a]:(++t,a=65536+((1023&a)<<10|1023&e.charCodeAt(t)),r+=internals.hexTable[240|a>>18]+internals.hexTable[128|a>>12&63]+internals.hexTable[128|a>>6&63]+internals.hexTable[128|63&a])}return r},exports.compact=function(e,r){if("object"!=typeof e||null===e)return e;r=r||[];var t=r.indexOf(e);if(-1!==t)return r[t];if(r.push(e),Array.isArray(e)){for(var n=[],a=0,o=e.length;o>a;++a)"undefined"!=typeof e[a]&&n.push(e[a]);return n}var c=Object.keys(e);for(a=0,o=c.length;o>a;++a){var i=c[a];e[i]=exports.compact(e[i],r)}return e},exports.isRegExp=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},exports.isBuffer=function(e){return null===e||"undefined"==typeof e?!1:!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))};


},{}],179:[function(require,module,exports){
"use strict";module.exports={PaymentDevice:require("./lib/PaymentDevice"),BatteryInfo:require("./lib/BatteryInfo"),Card:require("./lib/Card"),CardDataUtil:require("./lib/CardDataUtil"),EmvDevice:require("./lib/EmvDevice"),MagneticCard:require("./lib/MagneticCard"),MagneticReaderDevice:require("./lib/MagneticReaderDevice"),DecisionRequired:require("./lib/DecisionRequired"),PinEvent:require("./lib/PinEvent")};


},{"./lib/BatteryInfo":180,"./lib/Card":181,"./lib/CardDataUtil":182,"./lib/DecisionRequired":183,"./lib/EmvDevice":184,"./lib/MagneticCard":185,"./lib/MagneticReaderDevice":186,"./lib/PaymentDevice":187,"./lib/PinEvent":188}],180:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),BatteryInfo=function(){function e(t,n,r){_classCallCheck(this,e),this._percentage=parseInt(t),this._isCharging=n,this._measuredOn=r}return _createClass(e,[{key:"toString",value:function(){return"Battery Info: Percentage: "+this.percentage+", isCharging: "+this.isCharging+", level: "+this.level+", measuredOn: "+this.measuredOn}},{key:"percentage",get:function(){return this._percentage}},{key:"isCharging",get:function(){return this._isCharging}},{key:"measuredOn",get:function(){return this._measuredOn}},{key:"level",get:function(){return this._percentage<=15?e.Level.Critical:this._percentage<=20?e.Level.UpdateCritical:this._percentage<=30?e.Level.Low:this._percentage<=60?e.Level.Medium:this._percentage<=100?e.Level.High:e.Level.Unknown}}]),e}();BatteryInfo.Level={Unknown:1,Critical:2,UpdateCritical:3,Low:4,Medium:5,High:6},module.exports=BatteryInfo;


},{}],181:[function(require,module,exports){
"use strict";function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var moment=require("moment"),Card=function t(){_classCallCheck(this,t),this.timestamp=moment().format()};module.exports=Card;


},{"moment":140}],182:[function(require,module,exports){
"use strict";function _classCallCheck(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function r(r,e){for(var s=0;s<e.length;s++){var a=e[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(r,a.key,a)}}return function(e,s,a){return s&&r(e.prototype,s),a&&r(e,a),e}}(),Log=require("manticore-log")("card-issuer"),CardIssuer=require("./PaymentDevice").CardIssuer,maestroRegexMatcher=void 0,digitsOnlyRegexMatcher=void 0,CardDataUtil=function(){function r(){_classCallCheck(this,r)}return _createClass(r,null,[{key:"getCardIssuerFromEmvAppLabel",value:function(r){return r?(r=r.toUpperCase(),r.includes("VISA")?CardIssuer.Visa:r.includes("MASTERCARD")?CardIssuer.MasterCard:r.includes("MAESTRO")?CardIssuer.Maestro:r.includes("AMERICAN")?CardIssuer.Amex:r.includes("DISCOVER")?CardIssuer.Discover:r.includes("PAYPAL")?CardIssuer.PayPal:(Log.warn("Unable to parse Card issuer from Application Label: "+r),CardIssuer.Unknown)):CardIssuer.Unknown}},{key:"getCardIssuerFromCardNumber",value:function(e){digitsOnlyRegexMatcher||(digitsOnlyRegexMatcher=/\D+/);var s=e.replace(digitsOnlyRegexMatcher,"");if(s.length>0&&s[0]===r._controlNumber.Visa)return CardIssuer.Visa;if(s.length>=2){var a=parseInt(s.substr(0,2));if(a>50&&56>a)return CardIssuer.MasterCard}if(maestroRegexMatcher||(maestroRegexMatcher=/(^50[0-9]{0,17}$)|(^5[6-9][0-9]{0,17}$)|(^6[0-9]{0,18}$)/),maestroRegexMatcher.exec(s))return CardIssuer.Maestro;if(s.length>=2){var t=s.substr(0,2);if(t===r._controlNumber.Amex1||t===r._controlNumber.Amex2)return CardIssuer.Amex}return s.length>=4&&s.substr(0,4)===r._controlNumber.Discover1?CardIssuer.Discover:s.length>=2&&s.substr(0,2)===r._controlNumber.Discover2?CardIssuer.Discover:s.length>=2&&s.substr(0,2)===r._controlNumber.PayPal?CardIssuer.PayPal:CardIssuer.Unknown}},{key:"getCardIssuerDisplayName",value:function(r){for(var e in CardIssuer)if(CardIssuer.hasOwnProperty(e)&&"function"!=typeof CardIssuer&&CardIssuer[e]===r)return e}}]),r}();CardDataUtil._controlNumber={Visa:"4",MasterCard:"5",Amex1:"34",Amex2:"37",Discover1:"6011",Discover2:"65",PayPal:"62"},module.exports=CardDataUtil;


},{"./PaymentDevice":187,"manticore-log":123}],183:[function(require,module,exports){
"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),DecisionRequired=function(){function e(n){_classCallCheck(this,e),this.deviceResponse=n,this.apps=[]}return _createClass(e,[{key:"toString",value:function(){return"DecisionRequired: "+this.apps.length+" apps\nRaw Response: "+this.deviceResponse.toString()}}]),e}();module.exports=DecisionRequired;


},{}],184:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,i=t,c=r;n=!1,null===o&&(o=Function.prototype);var a=Object.getOwnPropertyDescriptor(o,i);if(void 0!==a){if("value"in a)return a.value;var u=a.get;if(void 0===u)return;return u.call(c)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,t=i,r=c,n=!0,a=l=void 0}},PaymentDevice=require("./PaymentDevice"),EmvDevice=function(e){function t(e,r){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r),this.nativeClass="EmvDevice"}return _inherits(t,e),_createClass(t,[{key:"promptForNumericEntry",value:function(e,t,r,n){throw new Error("Should be implemented by the derived class.")}},{key:"promptForSecureAccountNumber",value:function(e,t){throw new Error("Should be implemented by the derived class.")}},{key:"startContactTransaction",value:function(e,t){throw new Error("Should be implemented by the derived class.")}}]),t}(PaymentDevice);EmvDevice.CardStatus={None:0,NonEmvCard:1,EmvCard:3},module.exports=EmvDevice;


},{"./PaymentDevice":187}],185:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_get=function(e,t,r){for(var n=!0;n;){var o=e,a=t,i=r;n=!1,null===o&&(o=Function.prototype);var c=Object.getOwnPropertyDescriptor(o,a);if(void 0!==c){if("value"in c)return c.value;var u=c.get;if(void 0===u)return;return u.call(i)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,t=a,r=i,n=!0,c=l=void 0}},Log=require("manticore-log")("payment"),Card=require("./Card"),MagneticCard=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.nativeClass="MagneticCard"}return _inherits(t,e),_createClass(t,[{key:"parseName",value:function(e){Log.debug("Not parsing "+e)}}]),t}(Card);module.exports=MagneticCard;


},{"./Card":181,"manticore-log":123}],186:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var o=e,i=t,c=n;r=!1,null===o&&(o=Function.prototype);var a=Object.getOwnPropertyDescriptor(o,i);if(void 0!==a){if("value"in a)return a.value;var u=a.get;if(void 0===u)return;return u.call(c)}var l=Object.getPrototypeOf(o);if(null===l)return;e=l,t=i,n=c,r=!0,a=l=void 0}},Log=require("manticore-log")("payment"),PaymentDevice=require("./PaymentDevice"),MagneticReaderDevice=function(e){function t(e,n){var r=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,n);var o=this;this.connect(function(e){r.activated||o.disconnect()})}return _inherits(t,e),_createClass(t,[{key:"connect",value:function(e){var t=this;return this["native"].isConnected()?(Log.debug(function(){return"Connect called, but "+t.id+" is already connected."}),e?e():null):(Log.debug(function(){return"Connecting to Magnetic Reader "+t.id}),void this["native"].connect(function(n){return Log.debug(function(){return"Connected to Magnetic Reader "+t.id}),e?e(n):null}))}},{key:"disconnect",value:function(e){this["native"].disconnect(e)}},{key:"received",value:function(e){e&&"start"===e.type||e&&"fail"===e.type||e.formFactor&&(e.reader||(e.reader=this),this.emit("cardPresented",e))}},{key:"formFactors",get:function(){return[PaymentDevice.FormFactor.MagneticCardSwipe]}}]),t}(PaymentDevice);module.exports=MagneticReaderDevice;


},{"./PaymentDevice":187,"manticore-log":123}],187:[function(require,module,exports){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_get=function(e,t,n){for(var r=!0;r;){var a=e,i=t,o=n;r=!1,null===a&&(a=Function.prototype);var c=Object.getOwnPropertyDescriptor(a,i);if(void 0!==c){if("value"in c)return c.value;var s=c.get;if(void 0===s)return;return s.call(o)}var d=Object.getPrototypeOf(a);if(null===d)return;e=d,t=i,n=o,r=!0,c=d=void 0}},Log=require("manticore-log")("payment"),EventEmitter=require("events").EventEmitter,BatteryInfo=require("./BatteryInfo"),manticore=require("manticore"),PaymentDevice=function(e){function t(e,n){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.id=e,this["native"]=n,this.activated=!1}return _inherits(t,e),_createClass(t,[{key:"removed",value:function(){this.isConnected()&&this.disconnect();var e=t.devices.indexOf(this);e>=0&&t.devices.splice(e,1),this.emit("deviceRemoved",this)}},{key:"ready",value:function(){Log.debug(this.id+" is ready."),this.isReady=!0,this._continuallyPollForBattery(),this.emit(t.Event.connected)}},{key:"_continuallyPollForBattery",value:function(){var e=this;this.getBatteryInfo(function(n,r){r&&(e.batteryStatus=new BatteryInfo(r.batteryPercentage,r.connectedToPower,new Date),e.emit(t.Event.batteryStatusUpdate,e.batteryStatus)),manticore.setTimeout(function(){return e._continuallyPollForBattery.call(e)},3e4)})}},{key:"updateRequired",value:function(e){Log.debug(this.id+" needs an update."),this.pendingUpdate=e,this.emit(t.Event.updateRequired,e)}},{key:"activate",value:function(e){this.activated=!0,this.context=e,this.isConnected()||this.connect()}},{key:"deactivate",value:function(e,t,n){this.context===e&&(this.activated=!1,this.context=null,t&&(this.disconnect(n),n=null)),n&&n()}},{key:"connect",value:function(e){throw new Error("Subclass must implement connect.")}},{key:"disconnect",value:function(e){throw new Error("Subclass must implement disconnect.")}},{key:"formFactors",value:function(){throw new Error("Subclass must implement formFactors.")}},{key:"clearTransaction",value:function(e){throw new Error("Subclass must implement clearTransaction.")}},{key:"destroy",value:function(){this["native"]=null}},{key:"isConnected",value:function(){return this["native"].isConnected()}},{key:"send",value:function(e,t){throw new Error("Specific interface must implement send.")}},{key:"received",value:function(e){}},{key:"getBatteryInfo",value:function(e){throw new Error("Subclass must implement getBatteryInfo.")}},{key:"display",value:function(e,t,n){n(null)}},{key:"onDisconnected",value:function(e){var n=this;Log.debug(function(){return"Device "+n.id+" was disconnected"}),this.emit(t.Event.disconnected,e)}},{key:"invoice",get:function(){return this.context?this.context.invoice:null}}],[{key:"discovered",value:function(e){t.devices.push(e),t.Events.emit("deviceDiscovered",e)}},{key:"isSupported",value:function(e){return e.protocols.indexOf("com.paypal.here.reader")>=0?"MiuraDevice":null}}]),t}(EventEmitter);PaymentDevice.devices=[],PaymentDevice.FormFactor={None:0,MagneticCardSwipe:5,Chip:10,EmvCertifiedContactless:15},PaymentDevice.CardIssuer={Unknown:0,Visa:1,MasterCard:2,Maestro:3,Amex:4,Discover:5,PayPal:6},PaymentDevice.Event={connected:"connected",disconnected:"disconnected",updateRequired:"updateRequired",cardDataRead:"cardDataRead",cardRemoved:"cardRemoved",cardPresented:"cardPresented",cancelled:"cancelled",cancelRequested:"cancelRequested",error:"error",batteryStatusUpdate:"batteryStatusUpdate",decisionRequired:"decisionRequired"},PaymentDevice.errorCode={genericError:"Error",nfcTimeout:"NfcTimeout",nfcNotAllowed:"NfcNotAllowed",tryDifferentCard:"TryDifferentCard",mustInsertCard:"MustInsertCard",mustSwipeCard:"MustSwipeCard",hardwareError:"HardwareError",cardBlocked:"CardBlocked",contactIssuer:"ContactIssuer",invalidChip:"InvalidChipCard",cannotSwipeChipCard:"cannotSwipeChipCard",smartCardNotInSlot:"SmartCardNotInSlot",paymentCancelled:"PaymentCancelled",contactlessPaymentAbortedByCardInsert:"ContactlessPaymentAbortedByCardInsert",contactlessPaymentAbortedByCardSwipe:"ContactlessPaymentAbortedByCardSwipe",badEmvData:"badEmvData",deviceNotConnected:"deviceNotConnected"},PaymentDevice.constant={InvalidChipRetryCount:2},PaymentDevice.authCode={TransactionFailure:"8A023035",TransactionSuccess:"8A023030",NoNetwork:"8A025A33"},module.exports=PaymentDevice,PaymentDevice.Events=new EventEmitter,PaymentDevice.Message={Connecting:"Connecting",OrderInProgress:"Order.InProgress",WaitForPayment:"Order.Ready",ProcessingContact:"Processing.Contact",PaidRemoveCard:"Paid.RemoveCard",Paid:"Paid.Successful",RefundRemoveCard:"Refund.RemoveCard",Refund:"Refund.Successful",Processing:"Processing.Tap",ProcessingWithPin:"Processing.PinOk",Complete:"Complete",SignContact:"Sign.Contact",SignTap:"Sign.Tap",SoftwareUpdateRequired:"SwUpdate.Required",SoftwareUpdateAvailable:"SwUpdate.Available",SoftwareUpdateProgress:"SwUpdate.Progress",SoftwareUpdateFailed:"SwUpdate.Failed",Ready:"Ready",NfcTimeOut:"NfcTimeout",GeneralNfcFallback:"GeneralNfcFallback",TransactionCancelled:"TransactionCancelled",UnableToReadNfcCard:"Declined.UnableToReadNfcCard",InvalidChipCard:"Declined.InvalidChipCard",BlockedCardInserted:"Declined.BlockedCardInserted",NfcDecline:"Declined.NfcDecline",IncorrectPin:"Declined.IncorrectPin",ContactIssuer:"ContactIssuer",RechargeNow:"RechargeNow",ReadyForInsertAndSwipePayment:"ReadyForInsertAndSwipePayment",ReadyForInsertPayment:"ReadyForInsertPayment",ReadyForSwipePayment:"ReadyForSwipePayment",SignatureForContact:"Signature.Contact",SignatureForContactless:"Signature.Contactless",InvoiceTotal:"InvoiceTotal"};


},{"./BatteryInfo":180,"events":117,"manticore":125,"manticore-log":123}],188:[function(require,module,exports){
"use strict";function _classCallCheck(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}var PinEvent=function n(){_classCallCheck(this,n)};module.exports=PinEvent;


},{}],189:[function(require,module,exports){
"use strict";module.exports={Tlv:require("./lib/Tlv"),TlvList:require("./lib/TlvList"),Tags:require("./lib/Tags"),ValueFormat:require("./lib/ValueFormat"),DefinedTag:require("./lib/DefinedTag"),ApduCommand:require("./lib/apdu/Command"),ApduResponse:require("./lib/apdu/Response")};


},{"./lib/DefinedTag":190,"./lib/Tags":191,"./lib/Tlv":192,"./lib/TlvList":193,"./lib/ValueFormat":194,"./lib/apdu/Command":195,"./lib/apdu/Response":196}],190:[function(require,module,exports){
"use strict";function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,a){for(var t=0;t<a.length;t++){var n=a[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(a,t,n){return t&&e(a.prototype,t),n&&e(a,n),a}}(),ValueFormat=require("./ValueFormat"),allTags={},DefinedTag=function(){function e(a,t,n,r,l){_classCallCheck(this,e),this.name=a,this.number=t,this.format=n,this.length=r,l!==!1&&(allTags[t]?allTags[t].push(this):allTags[t]=[this])}return _createClass(e,[{key:"valueFromBytes",value:function(e){return this.format?this.format.fromBytes(e,this.length):e}},{key:"valueToBytes",value:function(e){return this.format.toBytes(e,this.length)}}],[{key:"findTags",value:function(a){return allTags[a]?allTags[a]:[new e("UnknownTag",a,ValueFormat.Binary,!1)]}},{key:"findTag",value:function(a){return e.findTags(a)[0]}}]),e}();module.exports=DefinedTag;


},{"./ValueFormat":194}],191:[function(require,module,exports){
"use strict";var DefinedTag=require("./DefinedTag"),ValueFormat=require("./ValueFormat");module.exports={AmountAuthorized:new DefinedTag("AmountAuthorized",40706,ValueFormat.CompressedNumeric),AmountOther:new DefinedTag("AmountOther",40707,ValueFormat.CompressedNumeric),ApplicationCryptogram:new DefinedTag("ApplicationCryptogram",40742,ValueFormat.Binary),ApplicationExpirationDate:new DefinedTag("ApplicationExpirationDate",24356,ValueFormat.Date),ApplicationFileLocator:new DefinedTag("ApplicationFileLocator",148,ValueFormat.Binary),ApplicationIdentifier:new DefinedTag("ApplicationIdentifier",79,ValueFormat.Binary),ApplicationInterchangeProfile:new DefinedTag("ApplicationInterchangeProfile",130,ValueFormat.Binary,2),ApplicationLabel:new DefinedTag("ApplicationLabel",80,ValueFormat.AlphaWithSpace),ApplicationPanSequenceCode:new DefinedTag("ApplicationPanSequenceCode",24372,ValueFormat.Numeric,2),ApplicationPreferredName:new DefinedTag("ApplicationPreferredName",40722,ValueFormat.AlphaWithSpace),ApplicationPriorityIndicator:new DefinedTag("ApplicationPriorityIndicator",135,ValueFormat.Binary,1),ApplicationTemplate:new DefinedTag("ApplicationTemplate",97,ValueFormat.Tlv),ApplicationTransactionCounter:new DefinedTag("ApplicationTransactionCounter",40758,ValueFormat.Binary,2),ApplicationVersionNumber:new DefinedTag("ApplicationVersionNumber",40713,ValueFormat.Binary,2),AuthorizationResponseCode:new DefinedTag("AuthorizationResponseCode",138,ValueFormat.AlphaNumeric,2),CardAuthenticationRelatedData:new DefinedTag("CardAuthenticationRelatedData",40809,ValueFormat.Dol),CardCvmLimit:new DefinedTag("CardCvmLimit",40811,ValueFormat.Binary),CardholderName:new DefinedTag("CardholderName",24352,ValueFormat.AlphaWithSpace),CardholderNameExtended:new DefinedTag("CardholderNameExtended",40715,ValueFormat.AlphaWithSpace),CardholderVerificationMethodResults:new DefinedTag("CardholderVerificationMethodResults",40756,ValueFormat.Binary),CardTransactionQualifiers:new DefinedTag("CardTransactionQualifiers",40812,ValueFormat.Binary,2),CryptogramInformationData:new DefinedTag("CryptogramInformationData",40743,ValueFormat.Binary,1),DfNameAscii:new DefinedTag("DfNameAscii",132,ValueFormat.Alpha),DfNameRaw:new DefinedTag("DfNameRaw",132,ValueFormat.Binary),FciProprietaryTemplate:new DefinedTag("FciProprietaryTemplate",165,ValueFormat.Tlv),FciProprietaryData:new DefinedTag("FciProprietaryData",48908,ValueFormat.Tlv),InterfaceDeviceSerialNumber:new DefinedTag("InterfaceDeviceSerialNumber",40734,ValueFormat.AlphaNumeric),IssuerAuthenticationData:new DefinedTag("IssuerAuthenticationData",145,ValueFormat.Binary),IssuerApplicationData:new DefinedTag("IssuerApplicationData",40720,ValueFormat.Binary),IssuerCodeTableIndex:new DefinedTag("IssuerCodeTableIndex",40721,ValueFormat.Numeric),IssuerCountryCode:new DefinedTag("IssuerCountryCode",24360,ValueFormat.Numeric),LanguagePreference:new DefinedTag("LanguagePreference",24365,ValueFormat.Alpha),MobileSupportIndicator:new DefinedTag("MobileSupportIndicator",40830,ValueFormat.Binary,1),MsdOffset:new DefinedTag("MsdOffset",40807,ValueFormat.Binary),ProcessingDataObjectList:new DefinedTag("ProcessingDataObjectList",40760,ValueFormat.Dol),ServiceCode:new DefinedTag("ServiceCode",24368,ValueFormat.Numeric),TerminalApplicationIdentifier:new DefinedTag("TerminalApplicationIdentifier",40710,ValueFormat.Binary),TerminalCapabilities:new DefinedTag("TerminalCapabilities",40755,ValueFormat.Binary),TerminalCountryCode:new DefinedTag("TerminalCountryCode",40730,ValueFormat.Numeric),TerminalIdentification:new DefinedTag("TerminalIdentification",40732,ValueFormat.Alpha),TerminalTransactionQualifiers:new DefinedTag("TerminalTransactionQualifiers",40806,ValueFormat.Binary),TerminalType:new DefinedTag("TerminalType",40757,ValueFormat.Numeric),TerminalVerificationResults:new DefinedTag("TerminalVerificationResults",149,ValueFormat.Binary),Track1:new DefinedTag("Track1",86,ValueFormat.Alpha),Track1Cvc3:new DefinedTag("Track1Cvc3",40800,ValueFormat.Binary,2),Track1Cvc3Position:new DefinedTag("Track1Cvc3Position",40802,ValueFormat.Binary),Track1NumberOfATCDigits:new DefinedTag("Track1NumberOfATCDigits",40804,ValueFormat.Binary,1),Track1UnpredictableNumberAndAttackCounterPosition:new DefinedTag("Track1UnpredictableNumberAndAttackCounterPosition",40803,ValueFormat.Binary),Track2:new DefinedTag("Track2",40811,ValueFormat.Numeric),Track2Cvc3:new DefinedTag("Track2Cvc3",40801,ValueFormat.Binary,2),Track2Cvc3Position:new DefinedTag("Track2Cvc3Position",40805,ValueFormat.Binary),Track2NumberOfATCDigits:new DefinedTag("Track2NumberOfATCDigits",40807,ValueFormat.Binary,1),Track2UnpredictableNumberAndAttackCounterPosition:new DefinedTag("Track2UnpredictableNumberAndAttackCounterPosition",40806,ValueFormat.Binary),TransactionCurrencyCode:new DefinedTag("TransactionCurrencyCode",24362,ValueFormat.CompressedNumeric,2),TransactionDate:new DefinedTag("TransactionDate",154,ValueFormat.Date),TransactionTime:new DefinedTag("TransactionTime",40737,ValueFormat.Time),TransactionType:new DefinedTag("TransactionType",156,ValueFormat.CompressedNumeric),TransactionSequenceCounter:new DefinedTag("TransactionSequenceCounter",40769,ValueFormat.Numeric,4),TransactionStatusInformation:new DefinedTag("TransactionStatusInformation",155,ValueFormat.Binary,2),UnpredictableNumber:new DefinedTag("UnpredictableNumber",40759,ValueFormat.Binary),UnpredictableNumberAlternate:new DefinedTag("UnpredictableNumberAlternate",40810,ValueFormat.Binary),UnknownTag:new DefinedTag("UnknownTag",2147483647,ValueFormat.Binary)};


},{"./DefinedTag":190,"./ValueFormat":194}],192:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),ber=require("./ber"),DefinedTag=require("./DefinedTag"),Tlv=function(){function e(t,s){_classCallCheck(this,e),t instanceof DefinedTag?(this.tag=t,this.tagNumber=t.number):(this.tagNumber=t,this.tag=DefinedTag.findTag(t)),Buffer.isBuffer(s)?this.bytes=s:this.bytes=this.tag.valueToBytes(s)}return _createClass(e,[{key:"parse",value:function(){return this.hasOwnProperty("value")||(this.value=this.tag.valueFromBytes(this.bytes)),this.value}},{key:"toBytes",value:function(){var e=[ber.encodeTag(this.tagNumber),ber.encodeLength(this.bytes?this.bytes.length:0)];return this.bytes&&e.push(this.bytes),Buffer.concat(e)}},{key:"toString",value:function(e){var t=["  Tag 0x",this.tagNumber.toString(16)];return this.tag&&this.tag.name&&(t.push(" "),t.push(this.tag.name)),t.push(": "),this.value||e?Buffer.isBuffer(this.parse())?(t.push("0x"),t.push(this.value.toString("hex"))):t.push(this.value.toString()):this.bytes?(t.push("0x"),t.push(this.bytes.toString("hex"))):t.push("<empty>"),t.join("")}}]),e}();module.exports=Tlv;


}).call(this,require("buffer").Buffer)
},{"./DefinedTag":190,"./ber":197,"buffer":44}],193:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function lengthCheck(e,r,n,t){if(e>r+n)throw new Error(t)}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),Tlv=require("./Tlv"),DefinedTag=require("./DefinedTag"),ber=require("./ber"),TlvList=function(){function e(r,n,t){_classCallCheck(this,e),this.values=[],r&&this._parse(r,n,t)}return _createClass(e,[{key:"_parse",value:function(e,r,n){void 0===r&&(r=0),void 0===n&&(n=e.length-r);for(var t=r;r+n>t;){var a=ber.readTag(e,t);t+=a.length,lengthCheck(t,r,n,"Invalid TLV - tag ends buffer.");var l=ber.readLength(e,t);t+=l.lengthOfEncoding,lengthCheck(t,r,n,"Invalid TLV - tag value length ends buffer.");var u;l.lengthValue&&(lengthCheck(t+l.lengthValue,r,n,"Invalid TLV - value overruns buffer."),u=e.slice(t,t+l.lengthValue),t+=l.lengthValue);var i=DefinedTag.findTags(a.number),f=!0,o=!1,s=void 0;try{for(var v,h=i[Symbol.iterator]();!(f=(v=h.next()).done);f=!0){var c=v.value;this.values.push(new Tlv(c,u))}}catch(d){o=!0,s=d}finally{try{!f&&h["return"]&&h["return"]()}finally{if(o)throw s}}}}},{key:"add",value:function(e,r){if(e instanceof DefinedTag)this.values.push(new Tlv(e,r));else if(e instanceof Tlv)this.values.push(e);else{if(!Buffer.isBuffer(r))throw new Error("Add must be called with a tag and value, or a tag number and buffer.");this.values.push(new Tlv(DefinedTag.findTag(e),r))}}},{key:"find",value:function(e,r){e.number&&(e=e.number);var n=!0,t=!1,a=void 0;try{for(var l,u=this.values[Symbol.iterator]();!(n=(l=u.next()).done);n=!0){var i=l.value;if(i.tagNumber===e){if(!(r>0))return i;r--}}}catch(f){t=!0,a=f}finally{try{!n&&u["return"]&&u["return"]()}finally{if(t)throw a}}return null}},{key:"toBytes",value:function(){var e=[],r=!0,n=!1,t=void 0;try{for(var a,l=this.values[Symbol.iterator]();!(r=(a=l.next()).done);r=!0){var u=a.value;e.push(u.toBytes())}}catch(i){n=!0,t=i}finally{try{!r&&l["return"]&&l["return"]()}finally{if(n)throw t}}return Buffer.concat(e)}},{key:"toString",value:function(e){var r=["TLV:"],n=!0,t=!1,a=void 0;try{for(var l,u=this.values[Symbol.iterator]();!(n=(l=u.next()).done);n=!0){var i=l.value;Buffer.isBuffer(i)?r.push(i.toString("hex")):r.push(i.toString(e))}}catch(f){t=!0,a=f}finally{try{!n&&u["return"]&&u["return"]()}finally{if(t)throw a}}return r.join("\n")}},{key:"length",get:function(){return this.values.length}}]),e}();module.exports=TlvList;


}).call(this,require("buffer").Buffer)
},{"./DefinedTag":190,"./Tlv":192,"./ber":197,"buffer":44}],194:[function(require,module,exports){
(function (Buffer){
"use strict";function fromBytes(t,e){if(e&&t&&t.length!==e){var r=new Buffer(e);return t.copy(r),r}return t}function toBytes(t,e){if(e&&(!t||t.length!==e)){var r=new Buffer(e);return t&&t.copy(r),r}return t}function fromUtf8(t){return t.toString("utf8")}function toUtf8(t){return new Buffer(t,"utf8")}function toValidHexBytes(t,e){if(Buffer.isBuffer(t))return t;for(t=String(t),t.length%2===1&&(t="0"+t);e&&t.length<2*e;)t="00"+t;return new Buffer(t,"hex")}var TlvList;module.exports={Alpha:{fromBytes:fromUtf8,toBytes:toUtf8},AlphaNumeric:{fromBytes:fromUtf8,toBytes:toUtf8},AlphaWithSpace:{fromBytes:fromUtf8,toBytes:toUtf8},Binary:{fromBytes:fromBytes,toBytes:toBytes},Date:{fromBytes:function(t){if(t.length<3)throw new Error("Invalid date format.");var e=t.toString("hex");return new Date(2e3+parseInt(e.substring(0,2)),parseInt(e.substring(2,4)-1),parseInt(e.substring(4,6)))},toBytes:function(t){var e=[];return[t.getFullYear()-2e3,t.getMonth()+1,t.getDate()].forEach(function(t){10>t&&e.push("0"),e.push(String(t))}),new Buffer(e.join(""),"hex")}},Time:{fromBytes:function(t){if(t.length<3)throw new Error("Invalid time format.");var e=t.toString("hex");return new Date(2e3,1,1,parseInt(e.substring(0,2)),parseInt(e.substring(2,4)),parseInt(e.substring(4,6)))},toBytes:function(t){var e=[];return[t.getHours(),t.getMinutes(),t.getSeconds()].forEach(function(t){10>t&&e.push("0"),e.push(String(t))}),new Buffer(e.join(""),"hex")}},CompressedNumeric:{fromBytes:function(t){return parseInt(t.toString("hex"))},toBytes:toValidHexBytes},CompressedAlpha:{fromBytes:function(t){return t.toString("hex")},toBytes:toValidHexBytes},Numeric:{fromBytes:function(t){for(var e=0,r=0;r<t.length;r++)e<<=8,e+=t[r];return e},toBytes:function(t,e){e=e||4;for(var r=new Buffer(e),n=0;e>n;n++)r[e-n-1]=255&t,t>>=8;return r}},TypeLengthValueList:{fromBytes:function(t){return TlvList||(TlvList=require("./TlvList")),new TlvList(t)},toBytes:function(t){return t.toBytes()}},DataObjectList:{}};


}).call(this,require("buffer").Buffer)
},{"./TlvList":193,"buffer":44}],195:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),ber=require("../ber"),TlvList=require("../TlvList"),ApduCommand=function(){function t(e,n,i,a,r,s){_classCallCheck(this,t),this.preamble=new Buffer(4),r?Buffer.isBuffer(r)?this.data=[r]:this.data=r:this.data=null,this.le=0,Buffer.isBuffer(e)||(this.commandClass=e,this.instruction=n,this.p1=i||0,this.p2=a||0,void 0!==s&&(this.le=s))}return _createClass(t,[{key:"expectNoBytes",value:function(){this.le=null}},{key:"appendHex",value:function(t){this.data=this.data||[],this.data.push(new Buffer(t,"hex"))}},{key:"appendBytes",value:function(t){this.data=this.data||[],this.data.push(t)}},{key:"appendString",value:function(t){this.data=this.data||[],this.data.push(new Buffer(t,"utf8"))}},{key:"toBytes",value:function(){var t=[this.preamble],e=0;if(this.data){if(t.push(null),this.data.forEach(function(n){e+=n.length,t.push(n)}),e>65535)throw new Error("ApduCommand buffer is too long");e>255?t[1]=new Buffer([0,e>>8,255&e]):t[1]=new Buffer([e])}if(null!==this.le){if(this.le>65535)throw new Error("Le value must be between 0 and 65535");this.le<=256?t.push(new Buffer([255&this.le])):(1===t.length&&t.push(new Buffer([0])),t.push(new Buffer([this.le>>8,255&this.le])))}return Buffer.concat(t)}},{key:"toString",value:function(){var t=["ApduCommand class 0x",this.commandClass.toString(16),", instruction 0x",this.instruction.toString(16),", P1 0x",this.p1.toString(16),", P2 0x",this.p2.toString(16),"\n"];if(this.data&&this.data.length){var e=Buffer.concat(this.data);t.push(e.length+" bytes: "+e.toString("hex"))}return t.join("")}},{key:"commandClass",get:function(){return this.preamble[0]},set:function(t){this.preamble.writeUInt8(t,0)}},{key:"instruction",get:function(){return this.preamble[1]},set:function(t){this.preamble.writeUInt8(t,1)}},{key:"p1",get:function(){return this.preamble[2]},set:function(t){this.preamble.writeUInt8(t,2)}},{key:"p2",get:function(){return this.preamble[3]},set:function(t){this.preamble.writeUInt8(t,3)}}]),t}();module.exports=ApduCommand;


}).call(this,require("buffer").Buffer)
},{"../TlvList":193,"../ber":197,"buffer":44}],196:[function(require,module,exports){
(function (Buffer){
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,s,i){return s&&t(e.prototype,s),i&&t(e,i),e}}(),ber=require("../ber"),TlvList=require("../TlvList"),ApduResponse=function(){function t(e,s,i,n){if(_classCallCheck(this,t),Buffer.isBuffer(e)){if(void 0===s&&(s=0),void 0===i&&(i=e.length-s),this.sw1=e[s+i-2],this.sw2=e[s+i-1],2===i)return;if(n)this.data=e.slice(s,s+i-2);else{this.template=e[s];var r=ber.readLength(e,s+1);if(r.lengthValue!==i-3-r.lengthOfEncoding)throw new Error("Invalid ApduResponse length "+r.lengthValue+" vs buffer length of "+(i-3-r.lengthOfEncoding));this.data=e.slice(s+1+r.lengthOfEncoding,s+i-2)}}else{if(!(e instanceof TlvList))throw new Error("You must provide a Buffer or TlvList to create an APDU response.");this._tlvs=e,this.data=e.toBytes(),this.sw1=144,this.sw2=0}}return _createClass(t,[{key:"toString",value:function(t){var e=[];return this.template&&e.push("Template: 0x"+this.template.toString(16)),this.data&&e.push("Data ("+this.data.length+" bytes): 0x"+this.data.toString("hex")),(this._tlvs||t&&this.tlvs)&&e.push(this.tlvs.toString(t)),e.push("SW1: 0x"+this.sw1.toString(16)+" SW2: 0x"+this.sw2.toString(16)),e.join("\n")}},{key:"isSuccess",get:function(){return 144===this.sw1&&0===this.sw2}},{key:"tlvs",get:function(){return this._tlvs||(this._tlvs=new TlvList(this.data)),this._tlvs}}]),t}();module.exports=ApduResponse;


}).call(this,{"isBuffer":require("../../../is-buffer/index.js")})
},{"../../../is-buffer/index.js":120,"../TlvList":193,"../ber":197}],197:[function(require,module,exports){
(function (Buffer){
"use strict";module.exports={readTag:function(e,r){for(var n={length:1,number:0},t=r;t<e.length;t++,n.length++){var f=255&e[t];if(n.number=(n.number<<8)+f,t===r&&31!==(31&f))break;if(t!==r&&0===(128&f))break}return n},encodeTag:function(e){for(var r=e.number||e,n=0,t=0;r>0;)t++,n=(n<<8)+(255&r),r>>=8;for(var f=new Buffer(t),l=0;n>0;)f.writeUInt8(255&n,l++),n>>=8;return f},readLength:function(e,r){var n={lengthOfEncoding:1,lengthValue:0},t=e[r++];if(128===(128&t)){var f=127&t;if(r+f>e.length)throw new Error("Malformed length value - not enough bytes.");n.lengthOfEncoding=f+1;for(var l=0;f>l;l++)n.lengthValue=(n.lengthValue<<8)+e[r++];if(n.lengthValue<0)throw new Error("Overflow in length value.")}else n.lengthValue=t;return n},encodeLength:function(e){if(e>65535)throw new Error("Invalid length for tlv format: "+e);var r;return 127>=e?(r=new Buffer(1),r.writeUInt8(e,0)):e>255?(r=new Buffer(3),r.writeUInt8(130,0),r.writeUInt8(e>>8&255,1),r.writeUInt8(255&e,2)):(r=new Buffer(2),r.writeUInt8(129,0),r.writeUInt8(255&e,1)),r}};


}).call(this,require("buffer").Buffer)
},{"buffer":44}],198:[function(require,module,exports){
module.exports=function(o){return o&&"object"==typeof o&&"function"==typeof o.copy&&"function"==typeof o.fill&&"function"==typeof o.readUInt8};


},{}],199:[function(require,module,exports){
(function (process,global){
function inspect(e,r){var t={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(t.depth=arguments[2]),arguments.length>=4&&(t.colors=arguments[3]),isBoolean(r)?t.showHidden=r:r&&exports._extend(t,r),isUndefined(t.showHidden)&&(t.showHidden=!1),isUndefined(t.depth)&&(t.depth=2),isUndefined(t.colors)&&(t.colors=!1),isUndefined(t.customInspect)&&(t.customInspect=!0),t.colors&&(t.stylize=stylizeWithColor),formatValue(t,e,t.depth)}function stylizeWithColor(e,r){var t=inspect.styles[r];return t?"["+inspect.colors[t][0]+"m"+e+"["+inspect.colors[t][1]+"m":e}function stylizeNoColor(e,r){return e}function arrayToHash(e){var r={};return e.forEach(function(e,t){r[e]=!0}),r}function formatValue(e,r,t){if(e.customInspect&&r&&isFunction(r.inspect)&&r.inspect!==exports.inspect&&(!r.constructor||r.constructor.prototype!==r)){var n=r.inspect(t,e);return isString(n)||(n=formatValue(e,n,t)),n}var i=formatPrimitive(e,r);if(i)return i;var o=Object.keys(r),s=arrayToHash(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),isError(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return formatError(r);if(0===o.length){if(isFunction(r)){var u=r.name?": "+r.name:"";return e.stylize("[Function"+u+"]","special")}if(isRegExp(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(isDate(r))return e.stylize(Date.prototype.toString.call(r),"date");if(isError(r))return formatError(r)}var c="",a=!1,l=["{","}"];if(isArray(r)&&(a=!0,l=["[","]"]),isFunction(r)){var p=r.name?": "+r.name:"";c=" [Function"+p+"]"}if(isRegExp(r)&&(c=" "+RegExp.prototype.toString.call(r)),isDate(r)&&(c=" "+Date.prototype.toUTCString.call(r)),isError(r)&&(c=" "+formatError(r)),0===o.length&&(!a||0==r.length))return l[0]+c+l[1];if(0>t)return isRegExp(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special");e.seen.push(r);var f;return f=a?formatArray(e,r,t,s,o):o.map(function(n){return formatProperty(e,r,t,s,n,a)}),e.seen.pop(),reduceToSingleString(f,c,l)}function formatPrimitive(e,r){if(isUndefined(r))return e.stylize("undefined","undefined");if(isString(r)){var t="'"+JSON.stringify(r).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(t,"string")}return isNumber(r)?e.stylize(""+r,"number"):isBoolean(r)?e.stylize(""+r,"boolean"):isNull(r)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,r,t,n,i){for(var o=[],s=0,u=r.length;u>s;++s)hasOwnProperty(r,String(s))?o.push(formatProperty(e,r,t,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(formatProperty(e,r,t,n,i,!0))}),o}function formatProperty(e,r,t,n,i,o){var s,u,c;if(c=Object.getOwnPropertyDescriptor(r,i)||{value:r[i]},c.get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),hasOwnProperty(n,i)||(s="["+i+"]"),u||(e.seen.indexOf(c.value)<0?(u=isNull(t)?formatValue(e,c.value,null):formatValue(e,c.value,t-1),u.indexOf("\n")>-1&&(u=o?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n"))):u=e.stylize("[Circular]","special")),isUndefined(s)){if(o&&i.match(/^\d+$/))return u;s=JSON.stringify(""+i),s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function reduceToSingleString(e,r,t){var n=0,i=e.reduce(function(e,r){return n++,r.indexOf("\n")>=0&&n++,e+r.replace(/\u001b\[\d\d?m/g,"").length+1},0);return i>60?t[0]+(""===r?"":r+"\n ")+" "+e.join(",\n  ")+" "+t[1]:t[0]+r+" "+e.join(", ")+" "+t[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||"undefined"==typeof e}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return 10>e?"0"+e.toString(10):e.toString(10)}function timestamp(){var e=new Date,r=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],r].join(" ")}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var formatRegExp=/%[sdj%]/g;exports.format=function(e){if(!isString(e)){for(var r=[],t=0;t<arguments.length;t++)r.push(inspect(arguments[t]));return r.join(" ")}for(var t=1,n=arguments,i=n.length,o=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(t>=i)return e;switch(e){case"%s":return String(n[t++]);case"%d":return Number(n[t++]);case"%j":try{return JSON.stringify(n[t++])}catch(r){return"[Circular]"}default:return e}}),s=n[t];i>t;s=n[++t])o+=isNull(s)||!isObject(s)?" "+s:" "+inspect(s);return o},exports.deprecate=function(e,r){function t(){if(!n){if(process.throwDeprecation)throw new Error(r);process.traceDeprecation?console.trace(r):console.error(r),n=!0}return e.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(e,r).apply(this,arguments)};if(process.noDeprecation===!0)return e;var n=!1;return t};var debugs={},debugEnviron;exports.debuglog=function(e){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){var r=process.pid;debugs[e]=function(){var t=exports.format.apply(exports,arguments);console.error("%s %d: %s",e,r,t)}}else debugs[e]=function(){};return debugs[e]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(e,r){if(!r||!isObject(r))return e;for(var t=Object.keys(r),n=t.length;n--;)e[t[n]]=r[t[n]];return e};


}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./support/isBuffer":198,"_process":176,"inherits":119}],200:[function(require,module,exports){
module.exports={
  "VERSION":"1.0",
  "US":{
    "MCC_CODES":{
      "4121":"*",
      "5812":"*",
      "5813":"*",
      "5814":"*",
      "7230":"*",
      "7298":"*",
      "4411":"*",
      "7519":"*",
      "7011":"*",
      "7512":"*"
    },
    "CONTACTLESS_LIMIT":"10000"
  },
  "GB":{
    "CONTACTLESS_LIMIT":"20"
  },
  "AU":{
    "CONTACTLESS_LIMIT":"*"
  }
}
},{}]},{},[1]);
